- name: ğŸš€ Deploy to Server via SSH (Password)
  uses: appleboy/ssh-action@v0.1.5
  with:
    host: ${{ secrets.HOST }}
    username: ${{ secrets.USERNAME }}
    password: ${{ secrets.PASSWORD }}
    port: 22
    script_stop: false   # <---- THIS IS THE FIX
    timeout: 2000s
    envs: GITHUB_SHA
    script: |
      set -e

      echo "ğŸ“‚ Moving to home directory..."
      cd ~

      echo "ğŸ›‘ Stopping existing application (if running)..."
      pkill -f "./main" >/dev/null 2>&1 || true

      echo "ğŸ“¥ Updating project..."
      if [ -d "swadiq-schools" ]; then
        cd swadiq-schools
        git pull origin main
      else
        git clone https://github.com/ImaadDean/swadiq-schools.git
        cd swadiq-schools
      fi

      echo "ğŸ“¦ Installing Go dependencies..."
      go mod tidy

      echo "ğŸ”¨ Building Go binary..."
      go build -o main .

      echo "ğŸš€ Starting Go app..."
      nohup ./main > app.log 2>&1 &
      disown

      echo "â³ Waiting 3 seconds..."
      sleep 3

      if pgrep -f "./main" > /dev/null; then
        echo "âœ… Deployment successful"
      else
        echo "âŒ App failed to start"
        tail -20 app.log
        exit 1
      fi
