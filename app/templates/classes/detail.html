<div class="min-h-screen bg-gray-50">

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-4 lg:px-6 lg:py-5">
        <!-- Header -->
        <div class="mb-5">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-black text-slate-900 tracking-tight uppercase">{{.class.Name}}</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">CODE:
                            {{.class.Code}}</span>
                        <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span class="text-emerald-600 text-[10px] font-bold uppercase tracking-wider">ACTIVE NODE</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="classSubjectsBtn"
                        class="px-4 py-1.5 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[11px] font-bold shadow-sm flex items-center gap-2">
                        <i class="fas fa-book text-indigo-500 opacity-70"></i>
                        <span>Subjects</span>
                    </button>
                    <a href="/timetable/class/{{.classID}}"
                        class="px-4 py-1.5 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[11px] font-bold shadow-sm flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-purple-500 opacity-70"></i>
                        <span>Timetable</span>
                    </a>
                    <button id="editClassBtn"
                        class="px-4 py-1.5 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[11px] font-bold shadow-sm flex items-center gap-2">
                        <i class="fas fa-edit opacity-70"></i>
                        <span>Edit</span>
                    </button>
                    <button id="addStudentBtn"
                        class="px-4 py-1.5 premium-gradient text-white rounded-xl hover:opacity-90 transition-all duration-200 text-[11px] font-bold shadow-sm ring-2 ring-indigo-50 flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span>Add Student</span>
                    </button>
                </div>
            </div>
        </div>



        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Total Students -->
            <div
                class="group bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold text-indigo-100 uppercase tracking-wide mb-1">Total Students</p>
                        <h3 id="totalStudents" class="text-xl font-extrabold text-white mb-1">-</h3>
                        <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300">
                        </div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-users text-white text-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Male Students -->
            <div
                class="group bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold text-cyan-100 uppercase tracking-wide mb-1">Male Students</p>
                        <h3 id="maleStudents" class="text-xl font-extrabold text-white mb-1">-</h3>
                        <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300">
                        </div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-mars text-white text-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Female Students -->
            <div
                class="group bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold text-pink-100 uppercase tracking-wide mb-1">Female Students</p>
                        <h3 id="femaleStudents" class="text-xl font-extrabold text-white mb-1">-</h3>
                        <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300">
                        </div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-venus text-white text-lg"></i>
                    </div>
                </div>
            </div>

            <!-- Class Teacher -->
            <div
                class="group bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0 mr-2">
                        <p class="text-xs font-semibold text-purple-100 uppercase tracking-wide mb-1">Class Teacher</p>
                        <h3 id="classTeacher" class="text-sm font-bold text-white mt-1 truncate">
                            {{if .class.Teacher}}
                            {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                            <span class="opacity-70">UNASSIGNED</span>
                            {{end}}
                        </h3>
                        <div
                            class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2">
                        </div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300 flex-shrink-0">
                        <i class="fas fa-chalkboard-teacher text-white text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Section -->
        <div class="mb-8">
            <!-- Instructional Modules Header -->
            <div id="instructional-modules" class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-1 h-6 bg-indigo-500 rounded-full"></div>
                    <h2 class="text-sm font-black text-slate-700 uppercase tracking-wide">Instructional Modules</h2>
                </div>
                <button id="addSubjectsBtn2" onclick="openSubjectsModal()"
                    class="px-3 py-1.5 bg-indigo-50 text-indigo-600 text-[11px] font-bold uppercase tracking-wider rounded-lg border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-200 transition-all flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span>Add Modules</span>
                </button>
            </div>

            <!-- Skeleton Loading -->
            <div id="subjectsLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
                <!-- Skeleton Item 1 -->
                <div
                    class="animate-pulse bg-white rounded-2xl p-4 border border-slate-200 shadow-sm h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-200 rounded-xl"></div>
                        <div class="flex-1">
                            <div class="h-3 bg-slate-200 rounded w-24 mb-2"></div>
                            <div class="h-2 bg-slate-100 rounded w-12"></div>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2 mb-4">
                        <div class="h-8 bg-slate-50 rounded-lg border border-slate-100 w-full"></div>
                    </div>
                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="h-2 bg-slate-200 rounded w-20"></div>
                        <div class="h-2 bg-slate-200 rounded w-12"></div>
                    </div>
                </div>
                <!-- Skeleton Item 2 -->
                <div
                    class="animate-pulse bg-white rounded-2xl p-4 border border-slate-200 shadow-sm h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-200 rounded-xl"></div>
                        <div class="flex-1">
                            <div class="h-3 bg-slate-200 rounded w-20 mb-2"></div>
                            <div class="h-2 bg-slate-100 rounded w-10"></div>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2 mb-4">
                        <div class="h-8 bg-slate-50 rounded-lg border border-slate-100 w-full"></div>
                    </div>
                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="h-2 bg-slate-200 rounded w-20"></div>
                        <div class="h-2 bg-slate-200 rounded w-12"></div>
                    </div>
                </div>
                <!-- Skeleton Item 3 -->
                <div
                    class="animate-pulse bg-white rounded-2xl p-4 border border-slate-200 shadow-sm h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-200 rounded-xl"></div>
                        <div class="flex-1">
                            <div class="h-3 bg-slate-200 rounded w-28 mb-2"></div>
                            <div class="h-2 bg-slate-100 rounded w-14"></div>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2 mb-4">
                        <div class="h-8 bg-slate-50 rounded-lg border border-slate-100 w-full"></div>
                    </div>
                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="h-2 bg-slate-200 rounded w-20"></div>
                        <div class="h-2 bg-slate-200 rounded w-12"></div>
                    </div>
                </div>
                <!-- Skeleton Item 4 -->
                <div
                    class="animate-pulse bg-white rounded-2xl p-4 border border-slate-200 shadow-sm h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-200 rounded-xl"></div>
                        <div class="flex-1">
                            <div class="h-3 bg-slate-200 rounded w-24 mb-2"></div>
                            <div class="h-2 bg-slate-100 rounded w-12"></div>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2 mb-4">
                        <div class="h-8 bg-slate-50 rounded-lg border border-slate-100 w-full"></div>
                    </div>
                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="h-2 bg-slate-200 rounded w-20"></div>
                        <div class="h-2 bg-slate-200 rounded w-12"></div>
                    </div>
                </div>
            </div>
            <div id="subjectsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10"
                style="display: none;">
                <!-- Subjects will be loaded here -->
            </div>

            <div id="noSubjects"
                class="bg-white rounded-2xl border border-slate-200 border-dashed p-12 text-center mb-10"
                style="display: none;">
                <div
                    class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center border border-slate-100 mx-auto mb-4">
                    <i class="fas fa-book-open text-3xl text-slate-300"></i>
                </div>
                <h4 class="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-1">Module Registry
                    Empty
                </h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-6">No instructional
                    modules
                    assigned to this node</p>
                <button onclick="openSubjectsModal()"
                    class="px-4 py-2 bg-indigo-600 text-white text-[11px] font-bold uppercase tracking-wider rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-100 hover:shadow-indigo-200 transition-all inline-flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span>Assign Modules</span>
                </button>
            </div>

            <!-- Students List -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/30">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-[11px] font-black text-slate-900 uppercase tracking-widest">Student
                                Roster</h2>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Class
                                Enrollment
                                Registry</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative group">
                                <i
                                    class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" id="searchStudents" placeholder="SEARCH ROSTER..."
                                    class="pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-[11px] font-bold uppercase tracking-tight focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all w-full sm:w-64 placeholder:text-slate-300">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50/50 border-b border-slate-100">
                            <tr>
                                <th class="px-5 py-3 text-left">
                                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Student
                                        Profile</span>
                                </th>
                                <th class="px-5 py-3 text-left">
                                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">ID
                                        Ref</span>
                                </th>
                                <th class="px-5 py-3 text-left">
                                    <span
                                        class="text-[9px] font-black text-slate-400 uppercase tracking-widest">DOB</span>
                                </th>
                                <th class="px-5 py-3 text-left">
                                    <span
                                        class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Gender</span>
                                </th>
                                <th class="px-5 py-3 text-left">
                                    <span
                                        class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Residence</span>
                                </th>
                                <th class="px-5 py-3 text-right">
                                    <span
                                        class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Actions</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-slate-100">
                            <!-- Loading skeleton -->
                            <tr class="skeleton-row animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-slate-100 rounded-lg mr-3"></div>
                                        <div class="h-3 bg-slate-100 rounded w-24"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-32"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="flex justify-end gap-2">
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="skeleton-row animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-slate-100 rounded-lg mr-3"></div>
                                        <div class="h-3 bg-slate-100 rounded w-28"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-24"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="flex justify-end gap-2">
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="skeleton-row animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-slate-100 rounded-lg mr-3"></div>
                                        <div class="h-3 bg-slate-100 rounded w-20"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-36"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="flex justify-end gap-2">
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="skeleton-row animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-slate-100 rounded-lg mr-3"></div>
                                        <div class="h-3 bg-slate-100 rounded w-24"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-28"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="flex justify-end gap-2">
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="skeleton-row animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-slate-100 rounded-lg mr-3"></div>
                                        <div class="h-3 bg-slate-100 rounded w-32"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-4 bg-slate-100 rounded-full w-16"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 bg-slate-100 rounded w-20"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="flex justify-end gap-2">
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                        <div class="w-7 h-7 bg-slate-100 rounded-lg"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl p-0 max-w-2xl w-full mx-4 overflow-hidden transform transition-all scale-100 ring-1 ring-slate-900/5">
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h2 class="text-sm font-black text-slate-700 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-id-card text-indigo-500"></i> Student Profile
                </h2>
                <button id="closeModal"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div id="studentModalContent" class="p-6">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Subjects Modal -->
    <div id="subjectsModal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden transform transition-all scale-100 ring-1 ring-slate-900/5 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h2 class="text-sm font-black text-slate-700 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-plus-circle text-indigo-500"></i> Assign Module
                </h2>
                <button onclick="closeSubjectsModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <div id="availableSubjects" class="space-y-4 mb-6">
                    <!-- Loading skeleton -->
                    <div id="subjectsLoading" class="space-y-3">
                        <div class="animate-pulse border border-slate-200 rounded-xl p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-4 h-4 bg-slate-200 rounded"></div>
                                <div class="flex-1">
                                    <div class="h-4 bg-slate-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-slate-200 rounded w-1/2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="selectedPapers" class="hidden animate-fade-in">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-6 h-6 rounded bg-indigo-50 flex items-center justify-center text-indigo-600">
                            <i class="fas fa-file-alt text-xs"></i>
                        </div>
                        <h4 class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Select Papers</h4>
                    </div>

                    <div id="papersContainer"
                        class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto custom-scrollbar border border-slate-200 rounded-xl p-2 bg-slate-50/50">
                        <!-- Papers will be loaded here -->
                    </div>

                    <div id="papersLoading"
                        class="hidden space-y-2 max-h-40 overflow-y-auto border border-slate-200 rounded-xl p-3">
                        <div class="animate-pulse flex items-center space-x-3 p-2">
                            <div class="w-4 h-4 bg-slate-200 rounded"></div>
                            <div class="flex-1">
                                <div class="h-3 bg-slate-200 rounded w-3/4 mb-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="flex items-center justify-end gap-3 pt-6 border-t border-slate-100 mt-6 lg:mt-0 lg:absolute lg:bottom-0 lg:left-0 lg:right-0 lg:bg-white lg:p-6 lg:z-10">
                <button onclick="document.getElementById('subjectsModal').classList.add('hidden')"
                    class="px-4 py-2 rounded-xl text-[11px] font-bold uppercase tracking-wider text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-colors">
                    Cancel
                </button>
                <button id="addSubjectsBtn2" onclick="addSelectedSubjects()"
                    class="px-6 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-[11px] font-bold uppercase tracking-wider hover:shadow-lg hover:shadow-indigo-500/30 transition-all transform hover:-translate-y-0.5">
                    Assign to Class
                </button>
            </div>
        </div>
    </div>

    <!-- Subject Papers Modal -->
    <div id="subjectPapersModal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden transform transition-all scale-100 ring-1 ring-slate-900/5 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 border border-indigo-100 shadow-sm">
                        <i class="fas fa-layer-group text-sm"></i>
                    </div>
                    <h2 id="subjectPapersTitle" class="text-sm font-black text-slate-700 uppercase tracking-wide">
                        Module
                        Papers</h2>
                </div>
                <button onclick="closeSubjectPapersModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div id="subjectPapersContent" class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-4">
                <!-- Papers will be loaded here -->
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeSubjectPapersModal()"
                    class="px-4 py-2 text-[11px] font-bold text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-800 uppercase tracking-wider transition-all shadow-sm">
                    Close
                </button>
                <button id="savePapersBtn" onclick="saveSubjectPapers()"
                    class="px-5 py-2 bg-indigo-600 text-white text-[11px] font-bold uppercase tracking-wider rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-100 hover:shadow-indigo-200 transition-all flex items-center gap-2">
                    <span id="saveBtnText">Save Changes</span>
                    <i id="saveBtnSpinner" class="hidden fas fa-spinner fa-spin"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Teacher Selection Modal -->
    <div id="teacherModal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[60] transition-all duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform transition-all scale-100 ring-1 ring-slate-900/5 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-chalkboard-teacher text-indigo-500"></i> Select Faculty
                </h3>
                <button onclick="closeTeacherModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div class="p-4 border-b border-slate-100 bg-white">
                <div class="relative group">
                    <input type="text" id="teacherSearchInput" placeholder="SEARCH FACULTY..."
                        class="w-full pl-9 pr-4 py-2 text-xs font-bold uppercase tracking-wider bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-400">
                    <i
                        class="fas fa-search text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-xs group-focus-within:text-indigo-500 transition-colors"></i>
                </div>
            </div>

            <div id="teachersList" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1 bg-slate-50/30">
                <!-- Teachers will be loaded here -->
            </div>

            <div id="teachersLoading" class="hidden text-center py-4">
                <i class="fas fa-spinner fa-spin text-indigo-500"></i>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeTeacherModal()"
                    class="px-4 py-2 text-[11px] font-bold text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-800 uppercase tracking-wider transition-all shadow-sm">
                    Cancel
                </button>
                <button onclick="clearTeacher()"
                    class="px-4 py-2 bg-red-50 text-red-600 text-[11px] font-bold uppercase tracking-wider rounded-lg border border-red-100 hover:bg-red-100 hover:border-red-200 transition-all shadow-sm">
                    Clear Selection
                </button>
            </div>
        </div>
    </div>

    <script>
        const classID = '{{.classID}}';
        let classData = {
            students: [],
            statistics: {},
            promotionSettings: null,
            availableClasses: []
        };

        // Load class details on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Class detail page loaded for class:', classID);
            loadClassDetails();

            const closeModal = document.getElementById('closeModal');
            const studentModal = document.getElementById('studentModal');
            closeModal.addEventListener('click', () => {
                studentModal.classList.add('hidden');
            });

            // Load class subjects immediately to check if there are any
            loadClassSubjects();
        });

        // Load detailed class information
        async function loadClassDetails() {
            try {
                // Fetch statistics
                const statsResponse = await fetch(`/api/classes/${classID}/statistics`, {
                    credentials: 'include'
                });

                // Fetch students
                const studentsResponse = await fetch(`/api/classes/${classID}/students`, {
                    credentials: 'include'
                });

                if (!statsResponse.ok || !studentsResponse.ok) {
                    throw new Error('Failed to fetch class data');
                }

                const statsResult = await statsResponse.json();
                const studentsResult = await studentsResponse.json();

                if (statsResult.success && studentsResult.success) {
                    updateStatistics(statsResult.data);
                    displayStudents(studentsResult.students);
                }
            } catch (error) {
                console.error('Error loading class details:', error);
                showErrorState();
            }
        }

        // Update statistics display
        function updateStatistics(stats) {
            document.getElementById('totalStudents').textContent = stats.total_students || 0;
            document.getElementById('maleStudents').textContent = stats.male_students || 0;
            document.getElementById('femaleStudents').textContent = stats.female_students || 0;
        }

        // Display students in table
        function displayStudents(students) {
            const tableBody = document.getElementById('studentsTableBody');

            // Hide skeleton rows
            document.querySelectorAll('.skeleton-row').forEach(row => row.style.display = 'none');

            if (!students || students.length === 0) {
                tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-5 py-8 text-center border-b border-slate-50">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center mb-3">
                                <i class="fas fa-users-slash text-slate-300 text-xl"></i>
                            </div>
                            <p class="text-[11px] font-black text-slate-500 uppercase tracking-wide mb-1">No Students Enrolled</p>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Initialize student roster to begin</p>
                        </div>
                    </td>
                </tr>
            `;
                return;
            }

            tableBody.innerHTML = students.map(student => `
            <tr class="hover:bg-indigo-50/30 transition-colors group border-b border-slate-50 last:border-b-0 cursor-pointer" onclick="viewStudent('${student.id}')">
                <td class="px-5 py-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center border border-indigo-100 mr-3 group-hover:scale-105 transition-transform shadow-sm">
                            <span class="text-[10px] font-black text-indigo-600 uppercase">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${student.first_name} ${student.last_name}</p>
                        </div>
                    </div>
                </td>
                <td class="px-5 py-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold text-slate-600 bg-slate-100 border border-slate-200 uppercase tracking-wider group-hover:bg-white transition-colors">
                        ${student.student_id}
                    </span>
                </td>
                <td class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wide">
                    ${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : '<span class="text-slate-300">N/A</span>'}
                </td>
                <td class="px-5 py-3">
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-black uppercase tracking-wider border ${student.gender === 'male' ? 'bg-blue-50 text-blue-600 border-blue-100' :
                    student.gender === 'female' ? 'bg-pink-50 text-pink-600 border-pink-100' :
                        'bg-slate-50 text-slate-500 border-slate-200'
                }">
                        ${student.gender === 'male' ? '<i class="fas fa-mars mr-1"></i>MALE' :
                    student.gender === 'female' ? '<i class="fas fa-venus mr-1"></i>FEMALE' :
                        'NOT SPECIFIED'}
                    </span>
                </td>
                <td class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wide max-w-xs truncate">
                    ${student.address || '<span class="text-slate-300">N/A</span>'}
                </td>
                <td class="px-5 py-3">
                    <div class="flex items-center justify-end gap-2" onclick="event.stopPropagation()">
                        <button onclick="viewStudent('${student.id}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-indigo-50 text-indigo-500 hover:bg-indigo-100 hover:text-indigo-700 border border-indigo-100 transition-all shadow-sm" title="View Profile">
                            <i class="fas fa-eye text-[10px]"></i>
                        </button>
                        <button onclick="removeStudent('${student.id}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-all shadow-sm" title="Remove Student">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        function showErrorState() {
            const tableBody = document.getElementById('studentsTableBody');
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="px-5 py-8 text-center border-b border-slate-50">
                    <div class="flex flex-col items-center justify-center">
                        <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center mb-3 border border-red-100">
                            <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                        </div>
                        <p class="text-[11px] font-black text-slate-500 uppercase tracking-wide mb-1">Data Retrieval Error</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Failed to load student roster</p>
                    </div>
                </td>
            </tr>
        `;
        }

        // Student actions
        async function viewStudent(studentId) {
            const studentModal = document.getElementById('studentModal');
            const studentModalContent = document.getElementById('studentModalContent');

            // Compact Skeleton Loader
            studentModalContent.innerHTML = `
            <div class="animate-pulse">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-slate-200 rounded-xl"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-slate-200 rounded w-40 mb-2"></div>
                        <div class="flex gap-2">
                            <div class="h-5 bg-slate-200 rounded w-20"></div>
                            <div class="h-5 bg-slate-200 rounded w-16"></div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="h-16 bg-slate-100 rounded-xl"></div>
                    <div class="h-16 bg-slate-100 rounded-xl"></div>
                </div>
                <div class="border-t border-slate-100 pt-4">
                    <div class="h-4 bg-slate-200 rounded w-32 mb-4"></div>
                    <div class="bg-slate-50 rounded-xl p-4 h-32 border border-slate-100"></div>
                </div>
            </div>
        `;
            studentModal.classList.remove('hidden');

            try {
                const response = await fetch(`/api/students/${studentId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch student details');
                }
                const data = await response.json();
                const student = data.student;
                const parent = data.parent;

                let parentInfo = `
                <div class="mt-5 pt-4 border-t border-slate-100">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-5 h-5 rounded bg-purple-50 flex items-center justify-center text-purple-600">
                            <i class="fas fa-user-shield text-[10px]"></i>
                        </div>
                        <h4 class="text-[10px] font-black text-slate-700 uppercase tracking-wide">Parent / Guardian Information</h4>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                        <div class="flex flex-col items-center justify-center py-3 text-center">
                            <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center mb-1.5">
                                <i class="fas fa-user-slash text-slate-300 text-xs"></i>
                            </div>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">No Guardian Linked</p>
                        </div>
                    </div>
                </div>`;

                if (parent) {
                    parentInfo = `
                    <div class="mt-5 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-5 h-5 rounded bg-purple-50 flex items-center justify-center text-purple-600">
                                <i class="fas fa-user-shield text-[10px]"></i>
                            </div>
                            <h4 class="text-[10px] font-black text-slate-700 uppercase tracking-wide">Parent / Guardian Information</h4>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Full Name</p>
                                    <p class="text-xs font-bold text-slate-700">${parent.first_name} ${parent.last_name}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Relationship</p>
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold bg-purple-100 text-purple-700 border border-purple-200 uppercase tracking-wide">
                                        ${parent.relationship || 'Guardian'}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Contact Email</p>
                                    <div class="flex items-center gap-1.5 overflow-hidden">
                                        <i class="fas fa-envelope text-slate-400 text-[9px]"></i>
                                        <p class="text-[11px] font-semibold text-slate-600 truncate">${parent.email || 'N/A'}</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Phone Number</p>
                                    <div class="flex items-center gap-1.5">
                                        <i class="fas fa-phone text-slate-400 text-[9px]"></i>
                                        <p class="text-[11px] font-semibold text-slate-600 font-mono">${parent.phone || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }

                // Compact Header Design
                studentModalContent.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center border border-indigo-100 shadow-sm flex-shrink-0">
                        <span class="text-base font-black text-indigo-600 uppercase">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight mb-1">${student.first_name} ${student.last_name}</h3>
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[9px] font-bold text-slate-600 bg-slate-100 border border-slate-200 uppercase tracking-wider">
                                <i class="fas fa-id-badge mr-1 opacity-50"></i>${student.student_id}
                            </span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[9px] font-bold ${student.gender === 'male' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-pink-50 text-pink-600 border-pink-100'} uppercase tracking-wider border">
                                ${student.gender === 'male' ? '<i class="fas fa-mars mr-1"></i>Male' : '<i class="fas fa-venus mr-1"></i>Female'}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-5">
                    <div class="p-2.5 rounded-xl bg-slate-50 border border-slate-100">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Date of Birth</p>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-birthday-cake text-indigo-400 text-[10px]"></i>
                            <p class="text-[11px] font-bold text-slate-700">${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                    <div class="p-2.5 rounded-xl bg-slate-50 border border-slate-100">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Residency</p>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-red-400 text-[10px]"></i>
                            <p class="text-[11px] font-bold text-slate-700 truncate">${student.address || 'N/A'}</p>
                        </div>
                    </div>
                </div>

                ${parentInfo}
            `;
            } catch (error) {
                studentModalContent.innerHTML = '<p class="text-red-500">Failed to load student details.</p>';
                console.error('Error fetching student details:', error);
            }
        }

        function removeStudent(studentId) {
            if (confirm('Are you sure you want to remove this student from the class?')) {
                // TODO: Implement remove student API call
                console.log('Remove student:', studentId);
            }
        }

        // Search functionality
        document.getElementById('searchStudents').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTableBody tr');

            rows.forEach(row => {
                const studentName = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
                const studentId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

                if (studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                    'bg-blue-500'
                }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Subjects functionality
        let availableSubjects = [];

        let assignedSubjectIds = new Set();

        async function loadClassSubjects() {
            console.log('Loading class subjects...');
            try {
                const response = await fetch(`/api/classes/${classID}/subjects`);
                console.log('Subjects response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Subjects data:', data);
                    const subjects = data.subjects || [];

                    // Update assigned IDs
                    assignedSubjectIds = new Set(subjects.map(s => s.id));

                    console.log('Subjects length:', subjects.length);
                    await displaySubjects(subjects);

                    // Update modal list if it's populated
                    if (typeof availableSubjects !== 'undefined' && availableSubjects.length > 0) {
                        displayAvailableSubjects();
                    }
                } else {
                    console.error('Failed to load subjects, status:', response.status);
                    // Show empty state instead of error
                    document.getElementById('subjectsLoading').style.display = 'none';
                    document.getElementById('noSubjects').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
                // Show empty state instead of error
                document.getElementById('subjectsLoading').style.display = 'none';
                document.getElementById('noSubjects').style.display = 'block';
            }
        }

        async function displaySubjects(subjects) {
            const container = document.getElementById('subjectsContainer');
            const noSubjects = document.getElementById('noSubjects');
            const loading = document.getElementById('subjectsLoading');

            // Hide loading
            loading.style.display = 'none';

            if (!subjects || subjects.length === 0) {
                container.style.display = 'none';
                noSubjects.style.display = 'block';
            } else {
                container.style.display = 'grid';
                noSubjects.style.display = 'none';

                container.innerHTML = subjects.map(subject => {
                    const papers = subject.papers || [];
                    return `
                <div class="bg-white rounded-2xl p-4 border border-slate-200 hover:border-indigo-300 hover:shadow-lg transition-all group flex flex-col h-full cursor-pointer relative overflow-hidden" onclick="openSubjectPapersModal('${subject.id}', '${subject.name}')">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500 transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-50 to-white border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm group-hover:scale-105 transition-transform group-hover:shadow-md">
                                <i class="fas fa-book text-sm"></i>
                            </div>
                            <div>
                                <h4 class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${subject.name}</h4>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold text-slate-500 bg-slate-50 border border-slate-100 uppercase tracking-wider mt-1">${subject.code}</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); removeSubject('${subject.id}')" class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-50 text-slate-300 hover:text-white hover:bg-red-500 transition-all">
                            <i class="fas fa-times text-[10px]"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1">
                        ${papers.length > 0 ? `
                            <div class="space-y-2 mt-2">
                                ${papers.map(paper => `
                                    <div class="flex items-center justify-between p-2 rounded-lg bg-slate-50 border border-slate-100 hover:border-indigo-100 transition-colors">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-file-alt text-indigo-400 text-[10px]"></i>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold text-slate-600 bg-white border border-slate-200 uppercase tracking-wide">${paper.code}</span>
                                        </div>
                                        <span class="text-[9px] font-bold uppercase tracking-wider ${paper.teacher ? 'text-indigo-500' : 'text-slate-400'}">
                                            ${paper.teacher ? `${paper.teacher.first_name} ${paper.teacher.last_name}` : 'UNASSIGNED'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-4 bg-slate-50/50 rounded-lg border border-dashed border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">No Papers Assigned</p>
                            </div>
                        `}
                    </div>

                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center relative z-10">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${papers.length} PAPERS LINKED</span>
                        <div class="text-indigo-500 text-[10px] font-bold uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                            Manage <i class="fas fa-arrow-right text-[9px]"></i>
                        </div>
                    </div>
                </div>
                `;
                }).join('');
            }
        }

        async function openSubjectsModal() {
            document.getElementById('subjectsModal').classList.remove('hidden');
            document.getElementById('subjectsLoading').style.display = 'block';

            try {
                const response = await fetch('/api/subjects');
                if (response.ok) {
                    const data = await response.json();
                    availableSubjects = data.subjects || [];
                    displayAvailableSubjects();
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
                document.getElementById('subjectsLoading').innerHTML = '<p class="text-gray-500 p-3">No subjects available</p>';
            }
        }

        function displayAvailableSubjects() {
            const container = document.getElementById('availableSubjects');
            const loading = document.getElementById('subjectsLoading');

            loading.style.display = 'none';
            container.innerHTML = availableSubjects.map(subject => {
                const isAssigned = assignedSubjectIds.has(subject.id);
                // Reduce opacity but keep pointer events active for the button inside
                const assignedClass = isAssigned ? 'opacity-75 bg-slate-50' : 'hover:bg-slate-50 cursor-pointer';
                const buttonHtml = isAssigned ?
                    `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); removeSubject('${subject.id}')" 
                        class="text-[9px] font-bold text-red-500 bg-red-50 border border-red-100 px-2 py-0.5 rounded uppercase tracking-wider ml-auto hover:bg-red-100 hover:text-red-700 transition-colors cursor-pointer pointer-events-auto z-10 relative">
                        Remove
                    </button>` : '';

                return `
            <div class="border border-slate-200 rounded-xl p-3 transition-colors group ${assignedClass}">
                <label class="flex items-center space-x-3 w-full ${isAssigned ? 'pointer-events-none' : 'cursor-pointer'}">
                    <div class="relative flex items-center">
                         <input type="radio" name="subject" value="${subject.id}" 
                            class="subject-radio peer h-4 w-4 cursor-pointer appearance-none rounded-full border border-slate-300 shadow-sm transition-all checked:border-indigo-500 checked:bg-indigo-500 hover:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-500/20" 
                            onchange="handleSubjectSelection()"
                            ${isAssigned ? 'disabled' : ''}>
                         <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity">
                            <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex items-center justify-between gap-2">
                            <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors truncate">${subject.name}</div>
                            ${buttonHtml}
                        </div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${subject.code}</div>
                    </div>
                </label>
                <div class="mt-3 ml-7 flex gap-4 ${isAssigned ? 'opacity-50 pointer-events-none' : ''}">
                    <label class="flex items-center gap-2 ${isAssigned ? '' : 'cursor-pointer'} group/type">
                        <input type="radio" name="compulsory_${subject.id}" value="true" checked 
                            class="compulsory-radio peer h-3 w-3 cursor-pointer appearance-none rounded-full border border-slate-300 transition-all checked:border-indigo-500 checked:bg-indigo-500"
                            ${isAssigned ? 'disabled' : ''}>
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider peer-checked:text-indigo-600 transition-colors">Compulsory</span>
                    </label>
                    <label class="flex items-center gap-2 ${isAssigned ? '' : 'cursor-pointer'} group/type">
                        <input type="radio" name="compulsory_${subject.id}" value="false" 
                            class="compulsory-radio peer h-3 w-3 cursor-pointer appearance-none rounded-full border border-slate-300 transition-all checked:border-amber-500 checked:bg-amber-500"
                            ${isAssigned ? 'disabled' : ''}>
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider peer-checked:text-amber-600 transition-colors">Optional</span>
                    </label>
                </div>
            </div>
            `}).join('');
        }

        async function handleSubjectSelection() {
            const selectedSubject = document.querySelector('.subject-radio:checked')?.value;
            const papersSection = document.getElementById('selectedPapers');
            const papersContainer = document.getElementById('papersContainer');
            const papersLoading = document.getElementById('papersLoading');

            if (selectedSubject) {
                papersSection.style.display = 'block';
                papersContainer.style.display = 'none';
                papersLoading.style.display = 'block';

                try {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await loadPapersForSubjects([selectedSubject]);
                } catch (error) {
                    console.error('Error loading papers:', error);
                    papersLoading.style.display = 'none';
                    papersContainer.innerHTML = '<div class="text-sm text-red-500">Failed to load papers</div>';
                    papersContainer.style.display = 'block';
                }
            } else {
                papersSection.style.display = 'none';
            }
        }

        async function loadPapersForSubjects(subjectIds) {
            const container = document.getElementById('papersContainer');
            const loading = document.getElementById('papersLoading');

            try {
                const papers = [];
                for (const subjectId of subjectIds) {
                    const response = await fetch(`/api/papers/by-subject/${subjectId}`);
                    if (response.ok) {
                        const data = await response.json();
                        papers.push(...(data.papers || []));
                    }
                }

                loading.style.display = 'none';
                container.style.display = 'block';

                if (papers.length > 0) {
                    container.innerHTML = papers.map(paper => `
                    <div class="border border-slate-200 rounded-xl p-3 mb-2 bg-white hover:border-indigo-200 transition-colors">
                        <label class="flex items-center space-x-3 mb-3 cursor-pointer">
                            <div class="relative flex items-center">
                                <input type="checkbox" value="${paper.id}" class="paper-checkbox peer h-4 w-4 cursor-pointer appearance-none rounded border border-slate-300 shadow-sm transition-all checked:border-indigo-500 checked:bg-indigo-500 hover:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-500/20" ${paper.is_compulsory ? 'checked' : ''}>
                                <i class="fas fa-check absolute pointer-events-none opacity-0 peer-checked:opacity-100 text-white text-[10px] left-[3px]"></i>
                            </div>
                            <div class="flex-1">
                                <span class="text-[11px] font-black text-slate-700 uppercase tracking-wide">${paper.code}</span>
                                ${paper.is_compulsory
                            ? '<span class="ml-2 text-[9px] font-bold text-indigo-500 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-wider">Compulsory</span>'
                            : '<span class="ml-2 text-[9px] font-bold text-amber-500 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 uppercase tracking-wider">Optional</span>'}
                            </div>
                        </label>
                        <div class="ml-7">
                            <button type="button" onclick="openPaperTeacherModal('${paper.id}')" 
                                    class="paper-teacher-btn w-full text-left text-[10px] font-bold uppercase tracking-wider border border-slate-200 rounded-lg px-3 py-2 hover:bg-slate-50 transition-all flex items-center justify-between group" 
                                    data-paper-id="${paper.id}" data-teacher-id="">
                                <span class="text-slate-500 group-hover:text-slate-700">ASSIGN FACULTY</span>
                                <i class="fas fa-chevron-right text-slate-300 text-xs group-hover:text-indigo-400 transition-colors"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                } else {
                    container.innerHTML = '<div class="text-[10px] font-bold text-slate-400 text-center py-4 uppercase tracking-wider">No papers available for selected module</div>';
                }
            } catch (error) {
                loading.style.display = 'none';
                container.innerHTML = '<div class="text-[10px] font-bold text-red-400 text-center py-4 uppercase tracking-wider">Failed to load papers</div>';
                container.style.display = 'block';
            }
        }

        async function addSelectedSubjects() {
            const addBtn = document.getElementById('addSubjectBtn');
            const btnText = document.getElementById('addSubjectBtnText');
            const spinner = document.getElementById('addSubjectSpinner');

            addBtn.disabled = true;
            btnText.textContent = 'Adding...';
            spinner.classList.remove('hidden');

            try {
                const selectedSubject = document.querySelector('.subject-radio:checked')?.value;

                if (!selectedSubject) {
                    showNotification('Please select a subject', 'error');
                    return;
                }

                const compulsoryRadio = document.querySelector(`input[name="compulsory_${selectedSubject}"]:checked`);
                const isCompulsory = compulsoryRadio ? compulsoryRadio.value === 'true' : true;

                const paperAssignments = [];
                const paperCheckboxes = document.querySelectorAll('#papersContainer .paper-checkbox:checked');
                paperCheckboxes.forEach(checkbox => {
                    const paperId = checkbox.value;
                    const teacherBtn = document.querySelector(`.paper-teacher-btn[data-paper-id="${paperId}"]`);
                    const teacherId = teacherBtn ? teacherBtn.getAttribute('data-teacher-id') : null;
                    paperAssignments.push({
                        paper_id: paperId,
                        teacher_id: teacherId && teacherId !== '' ? teacherId : null,
                    });
                });

                const response = await fetch(`/api/classes/${classID}/subjects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subjects: [{
                            subject_id: selectedSubject,
                            is_compulsory: isCompulsory,
                            paper_assignments: paperAssignments,
                        }]
                    })
                });

                if (response.ok) {
                    showNotification('Subject added successfully', 'success');
                    closeSubjectsModal();
                    loadClassSubjects();
                } else {
                    const error = await response.json();
                    showNotification('Error: ' + (error.error || 'Failed to add subject'), 'error');
                }
            } catch (error) {
                console.error('Error adding subject:', error);
                showNotification('Error: Failed to add subject', 'error');
            } finally {
                addBtn.disabled = false;
                btnText.textContent = 'Add Subject';
                spinner.classList.add('hidden');
            }
        }

        function closeSubjectsModal() {
            document.getElementById('subjectsModal').classList.add('hidden');
        }

        function openPaperTeacherModal(paperId) {
            currentPaperId = paperId;
            openTeacherModal(paperId);
        }

        // Subject Papers Modal Functions
        let currentSubjectId = null;
        let classPapersCache = [];

        async function openSubjectPapersModal(subjectId, subjectName) {
            currentSubjectId = subjectId;
            document.getElementById('subjectPapersTitle').textContent = `${subjectName} Papers`;
            document.getElementById('subjectPapersModal').classList.remove('hidden');

            // Load all papers for this subject and class papers
            await loadSubjectPapers(subjectId);
        }

        function closeSubjectPapersModal() {
            document.getElementById('subjectPapersModal').classList.add('hidden');
            currentSubjectId = null;
        }

        async function loadSubjectPapers(subjectId) {
            const content = document.getElementById('subjectPapersContent');
            content.innerHTML = '<div class="text-center text-gray-500">Loading papers...</div>';

            try {
                // Load all papers for the subject
                const subjectResponse = await fetch(`/api/papers/by-subject/${subjectId}`);
                if (!subjectResponse.ok) {
                    const errorData = await subjectResponse.json();
                    console.error('Papers API error:', errorData);
                    throw new Error(errorData.error || 'Failed to load papers');
                }
                const subjectData = await subjectResponse.json();
                const allPapers = subjectData.papers || [];
                console.log('Loaded papers for subject:', subjectId, allPapers);

                // Load class papers
                const classResponse = await fetch(`/api/classes/${classID}/papers`);
                classPapersCache = classResponse.ok ? await classResponse.json() : [];

                // Load teachers
                const teachersResponse = await fetch('/api/teachers');
                const teachersData = await teachersResponse.json();
                const teachers = teachersData.teachers || [];

                // Get assigned paper IDs for this subject
                const assignedPaperIds = classPapersCache
                    .filter(p => p.subject_id === subjectId)
                    .map(p => p.id);

                if (allPapers.length === 0) {
                    content.innerHTML = `
                    <div class="text-center py-8 bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">
                        <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center border border-slate-100 mx-auto mb-3">
                            <i class="fas fa-file-excel text-slate-300 text-xl"></i>
                        </div>
                        <p class="text-[11px] font-black text-slate-500 uppercase tracking-wide mb-1">No Papers Available</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">This module has no papers created yet.</p>
                    </div>
                `;
                    return;
                }

                content.innerHTML = allPapers.map(paper => {
                    const assignedPaper = classPapersCache.find(cp => cp.id === paper.id);
                    const assignedTeacher = assignedPaper && teachers.find(t => t.id === assignedPaper.teacher_id);
                    return `
                <div class="border border-slate-200 rounded-xl p-4 bg-white hover:border-indigo-200 transition-colors shadow-sm">
                    <label class="flex items-center space-x-3 cursor-pointer mb-4">
                        <div class="relative flex items-center">
                            <input type="checkbox" value="${paper.id}" class="paper-assignment-checkbox peer h-5 w-5 cursor-pointer appearance-none rounded border border-slate-300 shadow-sm transition-all checked:border-indigo-500 checked:bg-indigo-500 hover:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-500/20" 
                                   ${assignedPaper ? 'checked' : ''}>
                            <i class="fas fa-check absolute pointer-events-none opacity-0 peer-checked:opacity-100 text-white text-xs left-[4px]"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-[12px] font-black text-slate-700 uppercase tracking-wide">${paper.code}</div>
                        </div>
                    </label>
                    <div class="pl-8">
                        <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">Assigned Faculty:</label>
                        <button type="button" onclick="openTeacherModal('${paper.id}')" 
                                class="teacher-btn w-full text-left text-[11px] font-bold uppercase tracking-wider border border-slate-200 rounded-lg px-4 py-2.5 hover:bg-slate-50 transition-all flex items-center justify-between group bg-slate-50/50" 
                                data-paper-id="${paper.id}" data-teacher-id="${assignedPaper ? assignedPaper.teacher_id || '' : ''}">
                            <span class="${assignedTeacher ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'} transition-colors">
                                ${assignedTeacher ? `${assignedTeacher.first_name} ${assignedTeacher.last_name}` : 'SELECT FACULTY'}
                            </span>
                             <div class="w-6 h-6 rounded bg-white border border-slate-100 flex items-center justify-center text-slate-300 group-hover:text-indigo-400 group-hover:border-indigo-100 transition-all">
                                <i class="fas fa-chalkboard-teacher text-xs"></i>
                            </div>
                        </button>
                    </div>
                </div>
                `;
                }).join('');

            } catch (error) {
                content.innerHTML = `
                <div class="text-center py-8">
                     <i class="fas fa-exclamation-triangle text-red-400 text-xl mb-3"></i>
                     <p class="text-[11px] font-bold text-red-500 uppercase tracking-wider">Failed to load papers</p>
                </div>
            `;
            }
        }

        // Teacher Selection Modal
        // currentPaperId and other state moved to lower section to avoid duplication


        async function openTeacherModal(paperId) {
            currentPaperId = paperId;
            document.getElementById('teacherModal').classList.remove('hidden');

            // Reset data
            teachersData = {
                teachers: [],
                currentPage: 1,
                hasMore: true,
                isLoading: false,
                searchQuery: ''
            };

            document.getElementById('teacherSearchInput').value = '';
            await loadTeachers();
            setupTeacherModalEvents();
        }

        async function loadTeachers(reset = false) {
            if (teachersData.isLoading || (!teachersData.hasMore && !reset)) return;

            teachersData.isLoading = true;
            const loadingEl = document.getElementById('teachersLoading');
            const teachersList = document.getElementById('teachersList');

            if (reset) {
                teachersData.currentPage = 1;
                teachersData.teachers = [];
                teachersList.innerHTML = '';
            }

            loadingEl.classList.remove('hidden');

            try {
                const params = new URLSearchParams({
                    q: teachersData.searchQuery,
                    limit: 10,
                    offset: (teachersData.currentPage - 1) * 10
                });

                const response = await fetch(`/api/teachers/search?${params}`);
                const data = await response.json();

                if (data.teachers) {
                    teachersData.teachers.push(...data.teachers);
                    teachersData.hasMore = data.has_more || false;
                    teachersData.currentPage++;

                    renderTeachers();
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
                if (teachersData.teachers.length === 0) {
                    teachersList.innerHTML = '<p class="text-red-500 p-3">Error loading teachers</p>';
                }
            } finally {
                teachersData.isLoading = false;
                loadingEl.classList.add('hidden');
            }
        }

        function renderTeachers() {
            const teachersList = document.getElementById('teachersList');
            teachersList.innerHTML = teachersData.teachers.map(teacher => `
            <button data-teacher-id="${teacher.id}" data-teacher-name="${teacher.first_name} ${teacher.last_name}" 
                    class="teacher-select-btn w-full text-left p-3 border border-slate-200 rounded-xl hover:bg-slate-50 hover:border-indigo-200 transition-all group mb-2">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-lg bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-500 mr-3 group-hover:bg-indigo-100 transition-colors">
                        <i class="fas fa-user-tie text-sm"></i>
                    </div>
                    <div>
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${teacher.first_name} ${teacher.last_name}</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">${teacher.email}</div>
                    </div>
                    <div class="ml-auto transition-opacity">
                         <i class="fas fa-check text-indigo-500 text-xs"></i>
                    </div>
                </div>
            </button>
        `).join('');
        }

        function setupTeacherModalEvents() {
            const searchInput = document.getElementById('teacherSearchInput');
            const teachersList = document.getElementById('teachersList');

            // Search functionality
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    teachersData.searchQuery = e.target.value;
                    loadTeachers(true);
                }, 300);
            });

            // Teacher selection using event delegation
            teachersList.addEventListener('click', (e) => {
                const btn = e.target.closest('.teacher-select-btn');
                if (btn) {
                    const teacherId = btn.getAttribute('data-teacher-id');
                    const teacherName = btn.getAttribute('data-teacher-name');
                    selectTeacher(teacherId, teacherName);
                }
            });

            // Infinite scroll
            teachersList.addEventListener('scroll', () => {
                if (teachersList.scrollTop + teachersList.clientHeight >= teachersList.scrollHeight - 5) {
                    loadTeachers();
                }
            });
        }

        let currentPaperId = null;
        let selectionType = 'head'; // 'head', 'assistant', 'paper'
        let selectedPaperTeachers = {}; // Map paperId -> teacherId

        function openTeacherModal(paperId = null) {
            currentPaperId = paperId;
            selectionType = paperId ? 'paper' : 'head';

            const modal = document.getElementById('teacherModal');
            modal.classList.remove('hidden');

            // Reset search and load teachers
            teachersData.searchQuery = '';
            teachersData.teachers = [];
            teachersData.currentPage = 1;
            teachersData.hasMore = true;

            document.getElementById('teacherSearchInput').value = '';
            loadTeachers();
        }

        async function selectTeacher(teacherId, teacherName) {
            if (selectionType === 'paper' && currentPaperId) {
                // Update specific paper's teacher button
                const btn = document.querySelector(`.paper-teacher-btn[data-paper-id="${currentPaperId}"]`);
                if (btn) {
                    btn.setAttribute('data-teacher-id', teacherId);
                    btn.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <span class="text-indigo-600 font-bold truncate mr-2">${teacherName}</span>
                            <i class="fas fa-check-circle text-indigo-500"></i>
                        </div>
                    `;
                    btn.classList.add('bg-indigo-50', 'border-indigo-200');
                    selectedPaperTeachers[currentPaperId] = teacherId;
                }
            } else if (selectionType === 'class_teacher') {
                // ... existing class teacher logic ...
                document.getElementById('classTeacherId').value = teacherId;
                // Update UI for class teacher
            }
            // ... strict head/assistant logic if needed ...

            closeTeacherModal();
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').classList.add('hidden');
            setTimeout(() => {
                currentPaperId = null;
                selectionType = 'head';
            }, 200);
        }

        function openPaperTeacherModal(paperId) {
            currentPaperId = paperId;
            openTeacherModal(paperId);
        }

        function clearTeacher() {
            if (currentPaperId) {
                const btn = document.querySelector(`[data-paper-id="${currentPaperId}"]`);
                if (btn) {
                    btn.textContent = 'Select Teacher';
                    btn.setAttribute('data-teacher-id', '');
                }
            }
            closeTeacherModal();
        }

        async function saveSubjectPapers() {
            if (!currentSubjectId) return;

            // Show loading state
            const btn = document.getElementById('savePapersBtn');
            const btnText = document.getElementById('saveBtnText');
            const spinner = document.getElementById('saveBtnSpinner');

            btn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            const checkboxes = document.querySelectorAll('.paper-assignment-checkbox');
            const paperAssignments = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const teacherBtn = document.querySelector(`[data-paper-id="${cb.value}"]`);
                    const teacherId = teacherBtn ? teacherBtn.getAttribute('data-teacher-id') : null;
                    paperAssignments.push({
                        paper_id: cb.value,
                        teacher_id: teacherId && teacherId !== '' ? teacherId : null
                    });
                }
            });

            try {
                const response = await fetch(`/api/classes/${classID}/papers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paper_assignments: paperAssignments
                    })
                });

                if (response.ok) {
                    showNotification('Papers updated successfully', 'success');
                    closeSubjectPapersModal();
                    await loadClassSubjects(); // Refresh the display
                } else {
                    const errorData = await response.json();
                    showNotification('Failed to update papers: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving papers:', error);
                showNotification('Error updating papers', 'error');
            } finally {
                // Reset button state
                btn.disabled = false;
                btnText.textContent = 'Save Changes';
                spinner.classList.add('hidden');
            }
        }

        async function removeSubject(subjectId) {
            if (!confirm('Are you sure you want to remove this subject from the class?')) return;

            try {
                const response = await fetch(`/api/classes/${classID}/subjects/${subjectId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Subject removed successfully', 'success');
                    loadClassSubjects();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to remove subject'));
                }
            } catch (error) {
                console.error('Error removing subject:', error);
                alert('Error: Failed to remove subject');
            }
        }



        // Event listeners
        document.getElementById('classSubjectsBtn').addEventListener('click', openSubjectsModal);
        document.getElementById('editClassBtn').addEventListener('click', openEditClassModal);
        document.getElementById('addStudentBtn').addEventListener('click', openAddStudentModal);

        // Edit Class Modal Functions
        function openEditClassModal() {
            document.getElementById('editClassModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Get data from page elements
            const className = document.querySelector('h1').textContent.trim();

            // Get class code from the paragraph element that contains "Code: P-1"
            const codeElement = document.querySelector('h1').nextElementSibling;
            const classCode = codeElement ? codeElement.textContent.replace('Code: ', '').trim() : '';

            const teacherElement = document.getElementById('classTeacher');
            const teacherText = teacherElement ? teacherElement.textContent.trim() : '';

            console.log('Class Name:', className);
            console.log('Class Code:', classCode);
            console.log('Teacher Text:', teacherText);

            // Populate form fields
            document.getElementById('className').value = className;
            document.getElementById('classCode').value = classCode;

            // Handle teacher assignment
            if (teacherText && teacherText !== 'Not assigned') {
                document.getElementById('selectedClassTeacherDisplay').value = teacherText;
                document.getElementById('classTeacherId').value = '{{if .class.Teacher}}{{.class.Teacher.ID}}{{end}}';
            } else {
                document.getElementById('selectedClassTeacherDisplay').value = '';
                document.getElementById('classTeacherId').value = '';
            }
        }

        function closeEditClassModal() {
            document.getElementById('editClassModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('editClassForm').reset();
        }

        // Update class display without page reload
        async function updateClassDisplay(data) {
            // Update class name in header
            const classNameElement = document.querySelector('h1');
            if (classNameElement) {
                classNameElement.textContent = data.name;
            }

            // Update teacher display in the stats section
            const teacherElement = document.getElementById('classTeacher');
            if (teacherElement) {
                const teacherDisplay = document.getElementById('selectedClassTeacherDisplay').value;
                if (data.teacher_id && teacherDisplay) {
                    teacherElement.textContent = teacherDisplay;
                } else {
                    teacherElement.textContent = 'Not assigned';
                }
            }

            // Optionally refresh the class details from API to ensure consistency
            try {
                const response = await fetch(`/api/classes/${classID}/details`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const result = await response.json();
                    // Update any other elements that might need refreshing
                    console.log('Class details refreshed');
                }
            } catch (error) {
                console.error('Error refreshing class details:', error);
            }
        }

        function openClassTeacherModal() {
            // Set selection type for class teacher
            selectionType = 'class_teacher';
            isEditMode = true; // Reuse edit mode logic

            // Open the existing teacher modal (it will load teachers automatically)
            openTeacherModal(null);
        }

        // Edit Class Form Submission
        const editClassForm = document.getElementById('editClassForm');
        if (editClassForm) {
            editClassForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Updating...';

                const formData = new FormData(this);
                const data = {
                    name: formData.get('className'),
                    code: formData.get('classCode'),
                    teacher_id: formData.get('classTeacherId') || null
                };

                console.log('Submitting data:', data); // Debug log

                try {
                    const response = await fetch(`/api/classes/${classID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    console.log('Response status:', response.status); // Debug log

                    if (response.ok) {
                        alert('Class updated successfully');
                        // Don't close modal - keep form open
                        // Update the page display without reload
                        updateClassDisplay(data);
                    } else {
                        const error = await response.json();
                        console.error('API Error:', error); // Debug log
                        alert('Error: ' + (error.error || 'Failed to update class'));
                    }
                } catch (error) {
                    console.error('Error updating class:', error);
                    alert('Error: Failed to update class');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }

        // No Subjects Modal Functions
        function openNoSubjectsModal() {
            document.getElementById('noSubjectsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeNoSubjectsModal() {
            document.getElementById('noSubjectsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Load subjects on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing class subjects...');
            if (typeof loadClassSubjects === 'function') {
                loadClassSubjects();
            } else {
                console.error('loadClassSubjects function is not defined');
            }
        });

        // Add Student Modal Functions
        function openAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'flex';
            loadAvailableStudents();
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentSearchResults').innerHTML = '';
        }

        async function loadAvailableStudents(query = '') {
            const resultsContainer = document.getElementById('studentSearchResults');

            // Show loading skeleton
            resultsContainer.innerHTML = `
            <div class="space-y-2">
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/3"></div>
                        </div>
                    </div>
                </div>
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-4/5 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-2/5"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

            try {
                const url = `/api/students/search${query ? `?q=${query}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();

                resultsContainer.innerHTML = '';

                if (data.students && data.students.length > 0) {
                    data.students.forEach(student => {
                        const studentElement = document.createElement('div');
                        studentElement.className = 'p-3 border border-gray-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 cursor-pointer transition-colors duration-200';
                        studentElement.onclick = () => addStudentToClass(student);
                        studentElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
            </div>
                        </div>
                    `;
                        resultsContainer.appendChild(studentElement);
                    });
                } else {
                    resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No students found</p>';
                }
            } catch (error) {
                console.error('Error loading students:', error);
                resultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading students</p>';
            }
        }

        async function addStudentToClass(student) {
            try {
                const response = await fetch(`/api/classes/${classID}/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: student.id })
                });

                if (response.ok) {
                    showNotification('Student added successfully', 'success');
                    closeAddStudentModal();
                    loadClassDetails(); // Refresh the page data
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to add student'));
                }
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error: Failed to add student');
            }
        }

        async function addSelectedSubjects() {
            const selectedSubjectId = document.querySelector('.subject-radio:checked')?.value;
            if (!selectedSubjectId) {
                alert('Please select a subject');
                return;
            }

            const btn = document.getElementById('addSubjectsBtn2');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            try {
                // Get selected papers
                const selectedPapers = [];
                const paperCheckboxes = document.querySelectorAll('.paper-checkbox:checked');

                paperCheckboxes.forEach(cb => {
                    const paperId = cb.value;
                    const teacherId = selectedPaperTeachers[paperId] || null;
                    selectedPapers.push({
                        paper_id: paperId,
                        teacher_id: teacherId
                    });
                });

                const payload = {
                    subjects: [{
                        subject_id: selectedSubjectId,
                        is_compulsory: document.querySelector(`input[name="compulsory_${selectedSubjectId}"]:checked`)?.value === 'true',
                        papers: selectedPapers
                    }]
                };

                const response = await fetch(`/api/classes/${classID}/subjects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showNotification('Subjects added successfully', 'success');
                    closeNoSubjectsModal(); // Also closes subjectsModal if they share structure or logic
                    document.getElementById('subjectsModal').classList.add('hidden'); // Ensure closed
                    loadClassSubjects();

                    // Reset state
                    selectedPaperTeachers = {};
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to add subjects'));
                }
            } catch (error) {
                console.error('Error adding subjects:', error);
                alert('Error: Failed to add subjects');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

    </script>

    <!-- No Subjects Modal -->
    <div id="noSubjectsModal"
        class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all scale-100">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest">Module Registry</h3>
                <button onclick="closeNoSubjectsModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-8 text-center">
                <div
                    class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center border border-indigo-100 mx-auto mb-5 shadow-sm">
                    <i class="fas fa-book-reader text-2xl text-indigo-400"></i>
                </div>
                <h4 class="text-sm font-black text-slate-700 uppercase tracking-wide mb-2">Class Subjects Empty</h4>
                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider leading-relaxed mb-8">
                    No instructional modules have been assigned to this class node yet.
                </p>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeNoSubjectsModal()"
                        class="px-4 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-50 transition-all duration-200 text-[11px] font-bold uppercase tracking-wider">
                        Dismiss
                    </button>
                    <button onclick="openSubjectsModal(); closeNoSubjectsModal();"
                        class="px-4 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all duration-200 text-[11px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span>Add Modules</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div id="editClassModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Edit Class</h3>
                <button onclick="closeEditClassModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="editClassForm" class="p-6 space-y-4">
                <div>
                    <label for="className" class="block text-sm font-medium text-gray-700 mb-2">Class Name</label>
                    <input type="text" id="className" name="className" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                        placeholder="e.g., Primary-1, Secondary-3">
                </div>

                <div>
                    <label for="classCode" class="block text-sm font-medium text-gray-700 mb-2">Class Code</label>
                    <input type="text" id="classCode" name="classCode" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                        placeholder="e.g., P-1, S-1">
                </div>

                <div>
                    <label for="classTeacher" class="block text-sm font-medium text-gray-700 mb-2">Class Teacher
                        (Optional)</label>
                    <div class="relative">
                        <input type="text" id="selectedClassTeacherDisplay" name="selectedClassTeacherDisplay" readonly
                            onclick="openClassTeacherModal()"
                            class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white cursor-pointer"
                            placeholder="Select a teacher">
                        <button type="button" onclick="openClassTeacherModal()"
                            class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                        <input type="hidden" id="classTeacherId" name="classTeacherId" value="">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeEditClassModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors duration-200">
                        Update Class
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Add Student to Class</h3>
                <button onclick="closeAddStudentModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 pb-4">
                <div class="relative">
                    <input type="text" id="studentSearchInput" placeholder="Search students by name or ID..."
                        class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-6">
                <div id="studentSearchResults" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">Start typing to search for students</p>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button type="button" onclick="closeAddStudentModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Add event listener after modal is defined
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    loadAvailableStudents(e.target.value);
                });
            }
        });
    </script>