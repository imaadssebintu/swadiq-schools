<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/classes" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">{{.class.Name}}</h1>
                        <p class="text-xs text-gray-400 mb-1">Code: {{.class.Code}}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="editClassBtn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Edit Class
                    </button>
                    <a href="/timetable/class/{{.classID}}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Timetable
                    </a>
                    <button id="classSubjectsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Class Subjects
                    </button>
                    <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Students</p>
                        <p id="totalStudents" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Male Students</p>
                        <p id="maleStudents" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Female Students</p>
                        <p id="femaleStudents" class="text-2xl font-bold text-pink-600">-</p>
                    </div>
                    <div class="bg-pink-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Class Teacher</p>
                        <p id="classTeacher" class="text-sm font-medium text-gray-900">
                            {{if .class.Teacher}}
                                {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                                Not assigned
                            {{end}}
                        </p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Section -->
        <div class="mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Class Subjects</h2>
                        <button id="addSubjectsBtn2" onclick="openSubjectsModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors duration-200">
                            Add Subjects
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Skeleton Loading -->
                    <div id="subjectsLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="animate-pulse bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                                </div>
                                <div class="w-4 h-4 bg-gray-300 rounded"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                                </div>
                                <div class="w-4 h-4 bg-gray-300 rounded"></div>
                            </div>
                        </div>
                    </div>
                    <div id="subjectsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" style="display: none;">
                        <!-- Subjects will be loaded here -->
                    </div>
                    <div id="noSubjects" class="text-center py-8 text-gray-500" style="display: none;">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">No subjects assigned</p>
                        <p class="text-sm text-gray-500 mb-4">Add subjects to get started with this class.</p>
                        <button onclick="openSubjectsModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            Add Subjects
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Students</h2>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <input type="text" id="searchStudents" placeholder="Search students..." 
                                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Loading skeleton -->
                                <tr class="skeleton-row">
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                                            <div class="flex flex-col">
                                                <div class="h-4 bg-gray-200 rounded w-32 mb-2"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-24"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-5 bg-gray-200 rounded-full w-16"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-28"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex gap-2">
                                            <div class="h-4 bg-gray-200 rounded w-8"></div>
                                            <div class="h-4 bg-gray-200 rounded w-12"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                                            <div class="flex flex-col">
                                                <div class="h-4 bg-gray-200 rounded w-36 mb-2"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-28"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-24"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-5 bg-gray-200 rounded-full w-16"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-32"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex gap-2">
                                            <div class="h-4 bg-gray-200 rounded w-8"></div>
                                            <div class="h-4 bg-gray-200 rounded w-12"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex items-center">
                                            <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                                            <div class="flex flex-col">
                                                <div class="h-4 bg-gray-200 rounded w-28 mb-2"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-26"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-22"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-5 bg-gray-200 rounded-full w-16"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded w-24"></div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="animate-pulse flex gap-2">
                                            <div class="h-4 bg-gray-200 rounded w-8"></div>
                                            <div class="h-4 bg-gray-200 rounded w-12"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div id="studentModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900">Student Details</h2>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="studentModalContent">
            <!-- Student details will be loaded here -->
        </div>
    </div>
</div>

<!-- Subjects Modal -->
<div id="subjectsModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900">Add Subject to Class</h2>
            <button onclick="closeSubjectsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="availableSubjects" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
            <!-- Loading skeleton -->
            <div id="subjectsLoading" class="space-y-2">
                <div class="animate-pulse border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 bg-gray-300 rounded"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
                <div class="animate-pulse border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 bg-gray-300 rounded"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                            <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="selectedPapers" class="mb-4" style="display: none;">
            <h4 class="font-medium text-gray-900 mb-2">Select Papers for Selected Subject:</h4>
            <div id="papersContainer" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                <!-- Papers will be loaded here -->
            </div>
            <div id="papersLoading" class="hidden space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                <div class="animate-pulse flex items-center space-x-3 p-2">
                    <div class="w-4 h-4 bg-gray-300 rounded"></div>
                    <div class="flex-1">
                        <div class="h-3 bg-gray-300 rounded w-3/4 mb-1"></div>
                        <div class="h-2 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeSubjectsModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </button>
            <button id="addSubjectBtn" onclick="addSelectedSubjects()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                <span id="addSubjectBtnText">Add Subject</span>
                <svg id="addSubjectSpinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Subject Papers Modal -->
<div id="subjectPapersModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="subjectPapersTitle" class="text-xl font-bold text-gray-900">Subject Papers</h2>
            <button onclick="closeSubjectPapersModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="subjectPapersContent" class="space-y-3">
            <!-- Papers will be loaded here -->
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button onclick="closeSubjectPapersModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Close
            </button>
            <button id="savePapersBtn" onclick="saveSubjectPapers()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                <span id="saveBtnText">Save Changes</span>
                <svg id="saveBtnSpinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Teacher Selection Modal -->
<div id="teacherModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[60]">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Select Teacher</h3>
            <button onclick="closeTeacherModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="mb-4">
            <div class="relative">
                <input type="text" id="teacherSearchInput" placeholder="Search teachers..." 
                       class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
        </div>
        <div id="teachersList" class="space-y-2 flex-1 overflow-y-auto">
            <!-- Teachers will be loaded here -->
        </div>
        <div id="teachersLoading" class="hidden text-center py-2 text-gray-500">
            Loading more teachers...
        </div>
        <div class="flex justify-end space-x-3 mt-4">
            <button onclick="closeTeacherModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </button>
            <button onclick="clearTeacher()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Clear
            </button>
        </div>
    </div>
</div>

<script>
    const classID = '{{.classID}}';
    let classData = {
        students: [],
        statistics: {},
        promotionSettings: null,
        availableClasses: []
    };

    // Load class details on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Class detail page loaded for class:', classID);
        loadClassDetails();
        
        const closeModal = document.getElementById('closeModal');
        const studentModal = document.getElementById('studentModal');
        closeModal.addEventListener('click', () => {
            studentModal.classList.add('hidden');
        });
        
        // Load class subjects immediately to check if there are any
        loadClassSubjects();
    });

    // Load detailed class information
    async function loadClassDetails() {
        try {
            // Fetch statistics
            const statsResponse = await fetch(`/api/classes/${classID}/statistics`, {
                credentials: 'include'
            });
            
            // Fetch students
            const studentsResponse = await fetch(`/api/classes/${classID}/students`, {
                credentials: 'include'
            });
            
            if (!statsResponse.ok || !studentsResponse.ok) {
                throw new Error('Failed to fetch class data');
            }
            
            const statsResult = await statsResponse.json();
            const studentsResult = await studentsResponse.json();
            
            if (statsResult.success && studentsResult.success) {
                updateStatistics(statsResult.data);
                displayStudents(studentsResult.students);
            }
        } catch (error) {
            console.error('Error loading class details:', error);
            showErrorState();
        }
    }

    // Update statistics display
    function updateStatistics(stats) {
        document.getElementById('totalStudents').textContent = stats.total_students || 0;
        document.getElementById('maleStudents').textContent = stats.male_students || 0;
        document.getElementById('femaleStudents').textContent = stats.female_students || 0;
    }

    // Display students in table
    function displayStudents(students) {
        const tableBody = document.getElementById('studentsTableBody');
        
        // Hide skeleton rows
        document.querySelectorAll('.skeleton-row').forEach(row => row.style.display = 'none');
        
        if (!students || students.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                            <p class="text-lg font-medium text-gray-900 mb-1">No students found</p>
                            <p class="text-sm text-gray-500">Add students to this class to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = students.map(student => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-primary-600 font-medium text-sm">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${student.first_name} ${student.last_name}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${student.student_id}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : 'Not provided'}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        student.gender === 'male' ? 'bg-blue-100 text-blue-800' : 
                        student.gender === 'female' ? 'bg-pink-100 text-pink-800' : 
                        'bg-gray-100 text-gray-800'
                    }">
                        ${student.gender ? student.gender.charAt(0).toUpperCase() + student.gender.slice(1) : 'Not specified'}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate">${student.address || 'Not provided'}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <button onclick="viewStudent('${student.id}')" class="text-primary-600 hover:text-primary-800 text-sm font-medium">View</button>
                        <button onclick="removeStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showErrorState() {
        const tableBody = document.getElementById('studentsTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">No students found</p>
                        <p class="text-sm text-gray-500">This class doesn't have any students yet</p>
                    </div>
                </td>
            </tr>
        `;
    }

    // Student actions
    async function viewStudent(studentId) {
        const studentModal = document.getElementById('studentModal');
        const studentModalContent = document.getElementById('studentModalContent');
        studentModalContent.innerHTML = '<p>Loading...</p>';
        studentModal.classList.remove('hidden');

        try {
            const response = await fetch(`/api/students/${studentId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch student details');
            }
            const data = await response.json();
            const student = data.student;
            const parent = data.parent;

            let parentInfo = '<p>No parent information available.</p>';
            if (parent) {
                parentInfo = `
                    <h4 class="text-lg font-semibold mt-4">Parent Information</h4>
                    <p><strong>Name:</strong> ${parent.first_name} ${parent.last_name}</p>
                    <p><strong>Email:</strong> ${parent.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${parent.phone || 'N/A'}</p>
                    <p><strong>Relationship:</strong> ${parent.relationship || 'N/A'}</p>
                `;
            }

            studentModalContent.innerHTML = `
                <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                <p><strong>Student ID:</strong> ${student.student_id}</p>
                <p><strong>Date of Birth:</strong> ${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : 'N/A'}</p>
                <p><strong>Gender:</strong> ${student.gender || 'N/A'}</p>
                <p><strong>Address:</strong> ${student.address || 'N/A'}</p>
                ${parentInfo}
            `;
        } catch (error) {
            studentModalContent.innerHTML = '<p class="text-red-500">Failed to load student details.</p>';
            console.error('Error fetching student details:', error);
        }
    }

    function removeStudent(studentId) {
        if (confirm('Are you sure you want to remove this student from the class?')) {
            // TODO: Implement remove student API call
            console.log('Remove student:', studentId);
        }
    }

    // Search functionality
    document.getElementById('searchStudents').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#studentsTableBody tr');

        rows.forEach(row => {
            const studentName = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            const studentId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

            if (studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Subjects functionality
    let availableSubjects = [];

    async function loadClassSubjects() {
        console.log('Loading class subjects...');
        try {
            const response = await fetch(`/api/classes/${classID}/subjects`);
            console.log('Subjects response status:', response.status);
            if (response.ok) {
                const data = await response.json();
                console.log('Subjects data:', data);
                const subjects = data.subjects || [];
                console.log('Subjects length:', subjects.length);
                await displaySubjects(subjects);
            } else {
                console.error('Failed to load subjects, status:', response.status);
                // Show empty state instead of error
                document.getElementById('subjectsLoading').style.display = 'none';
                document.getElementById('noSubjects').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading subjects:', error);
            // Show empty state instead of error
            document.getElementById('subjectsLoading').style.display = 'none';
            document.getElementById('noSubjects').style.display = 'block';
        }
    }

    async function displaySubjects(subjects) {
        const container = document.getElementById('subjectsContainer');
        const noSubjects = document.getElementById('noSubjects');
        const loading = document.getElementById('subjectsLoading');

        // Hide loading
        loading.style.display = 'none';

        if (!subjects || subjects.length === 0) {
            container.style.display = 'none';
            noSubjects.style.display = 'block';
        } else {
            container.style.display = 'grid';
            noSubjects.style.display = 'none';
            
            container.innerHTML = subjects.map(subject => {
                const papers = subject.papers || [];
                return `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 cursor-pointer" onclick="openSubjectPapersModal('${subject.id}', '${subject.name}')">
                            <h4 class="font-medium text-gray-900">${subject.name}</h4>
                            <p class="text-sm text-gray-600">${subject.code}</p>
                            ${papers.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-xs text-gray-500 mb-1">Papers & Teachers:</p>
                                    <div class="space-y-1">
                                        ${papers.map(paper => `
                                            <div class="flex items-center justify-between bg-white rounded px-2 py-1 text-xs">
                                                <span class="font-medium text-blue-800">${paper.code}</span>
                                                <span class="text-gray-600">
                                                    ${paper.teacher ? `${paper.teacher.first_name} ${paper.teacher.last_name}` : 'No teacher assigned'}
                                                </span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div class="mt-2">
                                    <p class="text-xs text-gray-500">No papers assigned</p>
                                </div>
                            `}
                        </div>
                        <button onclick="removeSubject('${subject.id}')" class="text-red-600 hover:text-red-800 ml-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
    }

    async function openSubjectsModal() {
        document.getElementById('subjectsModal').classList.remove('hidden');
        document.getElementById('subjectsLoading').style.display = 'block';
        
        try {
            const response = await fetch('/api/subjects');
            if (response.ok) {
                const data = await response.json();
                availableSubjects = data.subjects || [];
                displayAvailableSubjects();
            }
        } catch (error) {
            console.error('Error loading subjects:', error);
            document.getElementById('subjectsLoading').innerHTML = '<p class="text-gray-500 p-3">No subjects available</p>';
        }
    }

    function displayAvailableSubjects() {
        const container = document.getElementById('availableSubjects');
        const loading = document.getElementById('subjectsLoading');
        
        loading.style.display = 'none';
        container.innerHTML = availableSubjects.map(subject => `
            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="radio" name="subject" value="${subject.id}" class="subject-radio" onchange="handleSubjectSelection()">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${subject.name}</div>
                        <div class="text-sm text-gray-600">${subject.code}</div>
                    </div>
                </label>
                <div class="mt-2 ml-6">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="compulsory_${subject.id}" value="true" checked class="compulsory-radio">
                        <span class="text-sm text-blue-600">Compulsory</span>
                    </label>
                    <label class="flex items-center space-x-2 mt-1">
                        <input type="radio" name="compulsory_${subject.id}" value="false" class="compulsory-radio">
                        <span class="text-sm text-orange-600">Optional</span>
                    </label>
                </div>
            </div>
        `).join('');
    }

    async function handleSubjectSelection() {
        const selectedSubject = document.querySelector('.subject-radio:checked')?.value;
        const papersSection = document.getElementById('selectedPapers');
        const papersContainer = document.getElementById('papersContainer');
        const papersLoading = document.getElementById('papersLoading');
        
        if (selectedSubject) {
            papersSection.style.display = 'block';
            papersContainer.style.display = 'none';
            papersLoading.style.display = 'block';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 300));
                await loadPapersForSubjects([selectedSubject]);
            } catch (error) {
                console.error('Error loading papers:', error);
                papersLoading.style.display = 'none';
                papersContainer.innerHTML = '<div class="text-sm text-red-500">Failed to load papers</div>';
                papersContainer.style.display = 'block';
            }
        } else {
            papersSection.style.display = 'none';
        }
    }

    async function loadPapersForSubjects(subjectIds) {
        const container = document.getElementById('papersContainer');
        const loading = document.getElementById('papersLoading');
        
        try {
            const papers = [];
            for (const subjectId of subjectIds) {
                const response = await fetch(`/api/papers/by-subject/${subjectId}`);
                if (response.ok) {
                    const data = await response.json();
                    papers.push(...(data.papers || []));
                }
            }
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (papers.length > 0) {
                container.innerHTML = papers.map(paper => `
                    <div class="border border-gray-200 rounded p-3 mb-2">
                        <label class="flex items-center space-x-2 text-sm mb-2">
                            <input type="checkbox" value="${paper.id}" class="paper-checkbox" ${paper.is_compulsory ? 'checked' : ''}>
                            <span class="font-medium">${paper.code}</span>
                            ${paper.is_compulsory ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Compulsory</span>' : '<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Optional</span>'}
                        </label>
                        <div class="ml-6">
                            <label class="block text-xs text-gray-600 mb-1">Teacher:</label>
                            <button type="button" onclick="openPaperTeacherModal('${paper.id}')" 
                                    class="paper-teacher-btn w-full text-left text-sm border border-gray-300 rounded px-2 py-1 hover:bg-gray-50" 
                                    data-paper-id="${paper.id}" data-teacher-id="">
                                Select Teacher
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-sm text-gray-500">No papers available for selected subject</div>';
            }
        } catch (error) {
            loading.style.display = 'none';
            container.innerHTML = '<div class="text-sm text-red-500">Failed to load papers</div>';
            container.style.display = 'block';
        }
    }

    async function addSelectedSubjects() {
        const addBtn = document.getElementById('addSubjectBtn');
        const btnText = document.getElementById('addSubjectBtnText');
        const spinner = document.getElementById('addSubjectSpinner');
        
        addBtn.disabled = true;
        btnText.textContent = 'Adding...';
        spinner.classList.remove('hidden');
        
        try {
            const selectedSubject = document.querySelector('.subject-radio:checked')?.value;
            
            if (!selectedSubject) {
                showNotification('Please select a subject', 'error');
                return;
            }

            const compulsoryRadio = document.querySelector(`input[name="compulsory_${selectedSubject}"]:checked`);
            const isCompulsory = compulsoryRadio ? compulsoryRadio.value === 'true' : true;

            const paperAssignments = [];
            const paperCheckboxes = document.querySelectorAll('#papersContainer .paper-checkbox:checked');
            paperCheckboxes.forEach(checkbox => {
                const paperId = checkbox.value;
                const teacherBtn = document.querySelector(`.paper-teacher-btn[data-paper-id="${paperId}"]`);
                const teacherId = teacherBtn ? teacherBtn.getAttribute('data-teacher-id') : null;
                paperAssignments.push({
                    paper_id: paperId,
                    teacher_id: teacherId && teacherId !== '' ? teacherId : null,
                });
            });

            const response = await fetch(`/api/classes/${classID}/subjects`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    subjects: [{
                        subject_id: selectedSubject,
                        is_compulsory: isCompulsory,
                        paper_assignments: paperAssignments,
                    }]
                })
            });

            if (response.ok) {
                showNotification('Subject added successfully', 'success');
                closeSubjectsModal();
                loadClassSubjects();
            } else {
                const error = await response.json();
                showNotification('Error: ' + (error.error || 'Failed to add subject'), 'error');
            }
        } catch (error) {
            console.error('Error adding subject:', error);
            showNotification('Error: Failed to add subject', 'error');
        } finally {
            addBtn.disabled = false;
            btnText.textContent = 'Add Subject';
            spinner.classList.add('hidden');
        }
    }

    function closeSubjectsModal() {
        document.getElementById('subjectsModal').classList.add('hidden');
    }

    function openPaperTeacherModal(paperId) {
        currentPaperId = paperId;
        openTeacherModal(paperId);
    }

    // Subject Papers Modal Functions
    let currentSubjectId = null;
    let classPapersCache = [];

    async function openSubjectPapersModal(subjectId, subjectName) {
        currentSubjectId = subjectId;
        document.getElementById('subjectPapersTitle').textContent = `${subjectName} Papers`;
        document.getElementById('subjectPapersModal').classList.remove('hidden');
        
        // Load all papers for this subject and class papers
        await loadSubjectPapers(subjectId);
    }

    function closeSubjectPapersModal() {
        document.getElementById('subjectPapersModal').classList.add('hidden');
        currentSubjectId = null;
    }

    async function loadSubjectPapers(subjectId) {
        const content = document.getElementById('subjectPapersContent');
        content.innerHTML = '<div class="text-center text-gray-500">Loading papers...</div>';
        
        try {
            // Load all papers for the subject
            const subjectResponse = await fetch(`/api/papers/by-subject/${subjectId}`);
            if (!subjectResponse.ok) {
                const errorData = await subjectResponse.json();
                console.error('Papers API error:', errorData);
                throw new Error(errorData.error || 'Failed to load papers');
            }
            const subjectData = await subjectResponse.json();
            const allPapers = subjectData.papers || [];
            console.log('Loaded papers for subject:', subjectId, allPapers);
            
            // Load class papers
            const classResponse = await fetch(`/api/classes/${classID}/papers`);
            classPapersCache = classResponse.ok ? await classResponse.json() : [];
            
            // Load teachers
            const teachersResponse = await fetch('/api/teachers');
            const teachersData = await teachersResponse.json();
            const teachers = teachersData.teachers || [];
            
            // Get assigned paper IDs for this subject
            const assignedPaperIds = classPapersCache
                .filter(p => p.subject_id === subjectId)
                .map(p => p.id);
            
            if (allPapers.length === 0) {
                content.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">No papers available</p>
                        <p class="text-sm text-gray-500">This subject doesn't have any papers created yet.</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = allPapers.map(paper => {
                const assignedPaper = classPapersCache.find(cp => cp.id === paper.id);
                const assignedTeacher = assignedPaper && teachers.find(t => t.id === assignedPaper.teacher_id);
                return `
                <div class="border border-gray-200 rounded-lg p-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" value="${paper.id}" class="paper-assignment-checkbox" 
                               ${assignedPaper ? 'checked' : ''}>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${paper.code}</div>
                        </div>
                    </label>
                    <div class="mt-2 ml-6">
                        <label class="block text-xs text-gray-600 mb-1">Teacher:</label>
                        <button type="button" onclick="openTeacherModal('${paper.id}')" 
                                class="teacher-btn w-full text-left text-sm border border-gray-300 rounded px-2 py-1 hover:bg-gray-50" 
                                data-paper-id="${paper.id}" data-teacher-id="${assignedPaper ? assignedPaper.teacher_id || '' : ''}">
                            ${assignedTeacher ? `${assignedTeacher.first_name} ${assignedTeacher.last_name}` : 'Select Teacher'}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
        } catch (error) {
            content.innerHTML = '<div class="text-center text-red-500">Failed to load papers</div>';
        }
    }

    // Teacher Selection Modal
    let currentPaperId = null;
    let teachersData = {
        teachers: [],
        currentPage: 1,
        hasMore: true,
        isLoading: false,
        searchQuery: ''
    };

    async function openTeacherModal(paperId) {
        currentPaperId = paperId;
        document.getElementById('teacherModal').classList.remove('hidden');
        
        // Reset data
        teachersData = {
            teachers: [],
            currentPage: 1,
            hasMore: true,
            isLoading: false,
            searchQuery: ''
        };
        
        document.getElementById('teacherSearchInput').value = '';
        await loadTeachers();
        setupTeacherModalEvents();
    }

    async function loadTeachers(reset = false) {
        if (teachersData.isLoading || (!teachersData.hasMore && !reset)) return;
        
        teachersData.isLoading = true;
        const loadingEl = document.getElementById('teachersLoading');
        const teachersList = document.getElementById('teachersList');
        
        if (reset) {
            teachersData.currentPage = 1;
            teachersData.teachers = [];
            teachersList.innerHTML = '';
        }
        
        loadingEl.classList.remove('hidden');
        
        try {
            const params = new URLSearchParams({
                q: teachersData.searchQuery,
                limit: 10,
                offset: (teachersData.currentPage - 1) * 10
            });
            
            const response = await fetch(`/api/teachers/search?${params}`);
            const data = await response.json();
            
            if (data.teachers) {
                teachersData.teachers.push(...data.teachers);
                teachersData.hasMore = data.has_more || false;
                teachersData.currentPage++;
                
                renderTeachers();
            }
        } catch (error) {
            console.error('Error loading teachers:', error);
            if (teachersData.teachers.length === 0) {
                teachersList.innerHTML = '<p class="text-red-500 p-3">Error loading teachers</p>';
            }
        } finally {
            teachersData.isLoading = false;
            loadingEl.classList.add('hidden');
        }
    }

    function renderTeachers() {
        const teachersList = document.getElementById('teachersList');
        teachersList.innerHTML = teachersData.teachers.map(teacher => `
            <button data-teacher-id="${teacher.id}" data-teacher-name="${teacher.first_name} ${teacher.last_name}" 
                    class="teacher-select-btn w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                <div class="font-medium">${teacher.first_name} ${teacher.last_name}</div>
                <div class="text-sm text-gray-600">${teacher.email}</div>
            </button>
        `).join('');
    }

    function setupTeacherModalEvents() {
        const searchInput = document.getElementById('teacherSearchInput');
        const teachersList = document.getElementById('teachersList');
        
        // Search functionality
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                teachersData.searchQuery = e.target.value;
                loadTeachers(true);
            }, 300);
        });
        
        // Teacher selection using event delegation
        teachersList.addEventListener('click', (e) => {
            const btn = e.target.closest('.teacher-select-btn');
            if (btn) {
                const teacherId = btn.getAttribute('data-teacher-id');
                const teacherName = btn.getAttribute('data-teacher-name');
                selectTeacher(teacherId, teacherName);
            }
        });
        
        // Infinite scroll
        teachersList.addEventListener('scroll', () => {
            if (teachersList.scrollTop + teachersList.clientHeight >= teachersList.scrollHeight - 5) {
                loadTeachers();
            }
        });
    }

    function closeTeacherModal() {
        document.getElementById('teacherModal').classList.add('hidden');
        
        // Reset after modal is hidden
        setTimeout(() => {
            currentPaperId = null;
            selectionType = 'head';
        }, 200);
        
        // Clean up event listeners
        const searchInput = document.getElementById('teacherSearchInput');
        const teachersList = document.getElementById('teachersList');
        if (searchInput) searchInput.removeEventListener('input', () => {});
        if (teachersList) teachersList.removeEventListener('scroll', () => {});
    }

    function selectTeacher(teacherId, teacherName) {
        console.log('Selecting teacher:', teacherId, teacherName, 'for paper:', currentPaperId);
        
        if (currentPaperId) {
            const btn = document.querySelector(`[data-paper-id="${currentPaperId}"]`);
            console.log('Found button:', btn);
            if (btn) {
                btn.textContent = teacherName;
                btn.setAttribute('data-teacher-id', teacherId);
                console.log('Updated button text to:', teacherName);
            }
        }
        
        // Close modal after a short delay to ensure the update is processed
        setTimeout(() => {
            closeTeacherModal();
        }, 100);
    }

    function openPaperTeacherModal(paperId) {
        currentPaperId = paperId;
        openTeacherModal(paperId);
    }

    function clearTeacher() {
        if (currentPaperId) {
            const btn = document.querySelector(`[data-paper-id="${currentPaperId}"]`);
            if (btn) {
                btn.textContent = 'Select Teacher';
                btn.setAttribute('data-teacher-id', '');
            }
        }
        closeTeacherModal();
    }

    async function saveSubjectPapers() {
        if (!currentSubjectId) return;
        
        // Show loading state
        const btn = document.getElementById('savePapersBtn');
        const btnText = document.getElementById('saveBtnText');
        const spinner = document.getElementById('saveBtnSpinner');
        
        btn.disabled = true;
        btnText.textContent = 'Saving...';
        spinner.classList.remove('hidden');
        
        const checkboxes = document.querySelectorAll('.paper-assignment-checkbox');
        const paperAssignments = [];
        
        checkboxes.forEach(cb => {
            if (cb.checked) {
                const teacherBtn = document.querySelector(`[data-paper-id="${cb.value}"]`);
                const teacherId = teacherBtn ? teacherBtn.getAttribute('data-teacher-id') : null;
                paperAssignments.push({
                    paper_id: cb.value,
                    teacher_id: teacherId && teacherId !== '' ? teacherId : null
                });
            }
        });
        
        try {
            const response = await fetch(`/api/classes/${classID}/papers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    paper_assignments: paperAssignments
                })
            });
            
            if (response.ok) {
                showNotification('Papers updated successfully', 'success');
                closeSubjectPapersModal();
                await loadClassSubjects(); // Refresh the display
            } else {
                const errorData = await response.json();
                showNotification('Failed to update papers: ' + (errorData.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error saving papers:', error);
            showNotification('Error updating papers', 'error');
        } finally {
            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Save Changes';
            spinner.classList.add('hidden');
        }
    }

    async function removeSubject(subjectId) {
        if (!confirm('Are you sure you want to remove this subject from the class?')) return;

        try {
            const response = await fetch(`/api/classes/${classID}/subjects/${subjectId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Subject removed successfully', 'success');
                loadClassSubjects();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to remove subject'));
            }
        } catch (error) {
            console.error('Error removing subject:', error);
            alert('Error: Failed to remove subject');
        }
    }



    // Event listeners
    document.getElementById('classSubjectsBtn').addEventListener('click', openNoSubjectsModal);
    document.getElementById('editClassBtn').addEventListener('click', openEditClassModal);
    document.getElementById('addStudentBtn').addEventListener('click', openAddStudentModal);

    // Edit Class Modal Functions
    function openEditClassModal() {
        document.getElementById('editClassModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Get data from page elements
        const className = document.querySelector('h1').textContent.trim();
        
        // Get class code from the paragraph element that contains "Code: P-1"
        const codeElement = document.querySelector('h1').nextElementSibling;
        const classCode = codeElement ? codeElement.textContent.replace('Code: ', '').trim() : '';
        
        const teacherElement = document.getElementById('classTeacher');
        const teacherText = teacherElement ? teacherElement.textContent.trim() : '';
        
        console.log('Class Name:', className);
        console.log('Class Code:', classCode);
        console.log('Teacher Text:', teacherText);
        
        // Populate form fields
        document.getElementById('className').value = className;
        document.getElementById('classCode').value = classCode;
        
        // Handle teacher assignment
        if (teacherText && teacherText !== 'Not assigned') {
            document.getElementById('selectedClassTeacherDisplay').value = teacherText;
            document.getElementById('classTeacherId').value = '{{if .class.Teacher}}{{.class.Teacher.ID}}{{end}}';
        } else {
            document.getElementById('selectedClassTeacherDisplay').value = '';
            document.getElementById('classTeacherId').value = '';
        }
    }

    function closeEditClassModal() {
        document.getElementById('editClassModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('editClassForm').reset();
    }

    // Update class display without page reload
    async function updateClassDisplay(data) {
        // Update class name in header
        const classNameElement = document.querySelector('h1');
        if (classNameElement) {
            classNameElement.textContent = data.name;
        }
        
        // Update teacher display in the stats section
        const teacherElement = document.getElementById('classTeacher');
        if (teacherElement) {
            const teacherDisplay = document.getElementById('selectedClassTeacherDisplay').value;
            if (data.teacher_id && teacherDisplay) {
                teacherElement.textContent = teacherDisplay;
            } else {
                teacherElement.textContent = 'Not assigned';
            }
        }
        
        // Optionally refresh the class details from API to ensure consistency
        try {
            const response = await fetch(`/api/classes/${classID}/details`, {
                credentials: 'include'
            });
            if (response.ok) {
                const result = await response.json();
                // Update any other elements that might need refreshing
                console.log('Class details refreshed');
            }
        } catch (error) {
            console.error('Error refreshing class details:', error);
        }
    }

    function openClassTeacherModal() {
        // Set selection type for class teacher
        selectionType = 'class_teacher';
        isEditMode = true; // Reuse edit mode logic
        
        // Open the existing teacher modal (it will load teachers automatically)
        openTeacherModal(null);
    }

    // Edit Class Form Submission
    const editClassForm = document.getElementById('editClassForm');
    if (editClassForm) {
        editClassForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Updating...';

            const formData = new FormData(this);
            const data = {
                name: formData.get('className'),
                code: formData.get('classCode'),
                teacher_id: formData.get('classTeacherId') || null
            };

            console.log('Submitting data:', data); // Debug log

            try {
                const response = await fetch(`/api/classes/${classID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status); // Debug log

                if (response.ok) {
                    alert('Class updated successfully');
                    // Don't close modal - keep form open
                    // Update the page display without reload
                    updateClassDisplay(data);
                } else {
                    const error = await response.json();
                    console.error('API Error:', error); // Debug log
                    alert('Error: ' + (error.error || 'Failed to update class'));
                }
            } catch (error) {
                console.error('Error updating class:', error);
                alert('Error: Failed to update class');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }

    // No Subjects Modal Functions
    function openNoSubjectsModal() {
        document.getElementById('noSubjectsModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeNoSubjectsModal() {
        document.getElementById('noSubjectsModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Load subjects on page load
    // loadClassSubjects(); // Removed - only load when modal opens

    // Add Student Modal Functions
    function openAddStudentModal() {
        document.getElementById('addStudentModal').style.display = 'flex';
        loadAvailableStudents();
    }

    function closeAddStudentModal() {
        document.getElementById('addStudentModal').style.display = 'none';
        document.getElementById('studentSearchInput').value = '';
        document.getElementById('studentSearchResults').innerHTML = '';
    }

    async function loadAvailableStudents(query = '') {
        const resultsContainer = document.getElementById('studentSearchResults');
        
        // Show loading skeleton
        resultsContainer.innerHTML = `
            <div class="space-y-2">
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/3"></div>
                        </div>
                    </div>
                </div>
                <div class="animate-pulse p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-4/5 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-2/5"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        try {
            const url = `/api/students/search${query ? `?q=${query}` : ''}`;
            const response = await fetch(url);
            const data = await response.json();
            
            resultsContainer.innerHTML = '';
            
            if (data.students && data.students.length > 0) {
                data.students.forEach(student => {
                    const studentElement = document.createElement('div');
                    studentElement.className = 'p-3 border border-gray-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 cursor-pointer transition-colors duration-200';
                    studentElement.onclick = () => addStudentToClass(student);
                    studentElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-sm font-medium text-primary-600">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${student.first_name} ${student.last_name}</p>
                                <p class="text-xs text-gray-500">ID: ${student.student_id}</p>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(studentElement);
                });
            } else {
                resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No students found</p>';
            }
        } catch (error) {
            console.error('Error loading students:', error);
            resultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading students</p>';
        }
    }

    async function addStudentToClass(student) {
        try {
            const response = await fetch(`/api/classes/${classID}/students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: student.id })
            });

            if (response.ok) {
                showNotification('Student added successfully', 'success');
                closeAddStudentModal();
                loadClassDetails(); // Refresh the page data
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to add student'));
            }
        } catch (error) {
            console.error('Error adding student:', error);
            alert('Error: Failed to add student');
        }
    }

</script>

<!-- No Subjects Modal -->
<div id="noSubjectsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Class Subjects</h3>
            <button onclick="closeNoSubjectsModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="p-6 text-center">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <p class="text-gray-600 mb-4">No subjects assigned to this class yet.</p>
            <p class="text-sm text-gray-500 mb-6">Add subjects to get started with this class.</p>
            
            <div class="flex justify-center gap-3">
                <button onclick="closeNoSubjectsModal()" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200">
                    Cancel
                </button>
                <button onclick="openSubjectsModal(); closeNoSubjectsModal();" 
                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors duration-200">
                    Add Subjects
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div id="editClassModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Edit Class</h3>
            <button onclick="closeEditClassModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="editClassForm" class="p-6 space-y-4">
            <div>
                <label for="className" class="block text-sm font-medium text-gray-700 mb-2">Class Name</label>
                <input type="text" id="className" name="className" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                       placeholder="e.g., Primary-1, Secondary-3">
            </div>

            <div>
                <label for="classCode" class="block text-sm font-medium text-gray-700 mb-2">Class Code</label>
                <input type="text" id="classCode" name="classCode" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                       placeholder="e.g., P-1, S-1">
            </div>

            <div>
                <label for="classTeacher" class="block text-sm font-medium text-gray-700 mb-2">Class Teacher (Optional)</label>
                <div class="relative">
                    <input type="text" 
                           id="selectedClassTeacherDisplay" 
                           name="selectedClassTeacherDisplay" 
                           readonly 
                           onclick="openClassTeacherModal()"
                           class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white cursor-pointer"
                           placeholder="Select a teacher">
                    <button type="button" 
                            onclick="openClassTeacherModal()"
                            class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                    <input type="hidden" id="classTeacherId" name="classTeacherId" value="">
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditClassModal()" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors duration-200">
                    Update Class
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Add Student to Class</h3>
            <button onclick="closeAddStudentModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="p-6 pb-4">
            <div class="relative">
                <input type="text" 
                       id="studentSearchInput" 
                       placeholder="Search students by name or ID..."
                       class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6">
            <div id="studentSearchResults" class="space-y-2">
                <p class="text-gray-500 text-center py-4">Start typing to search for students</p>
            </div>
        </div>

        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
            <button type="button" onclick="closeAddStudentModal()" 
                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors duration-200">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // Add event listener after modal is defined
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('studentSearchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                loadAvailableStudents(e.target.value);
            });
        }
    });
</script>
