<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/classes" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">{{.class.Name}}</h1>
                        <p class="text-sm text-gray-500">
                            {{if .class.Teacher}}
                                Class Teacher: {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                                Class Teacher: Not assigned
                            {{end}}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="editClassBtn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Edit Class
                    </button>
                    <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Students</p>
                        <p id="totalStudents" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Male Students</p>
                        <p id="maleStudents" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Female Students</p>
                        <p id="femaleStudents" class="text-2xl font-bold text-pink-600">-</p>
                    </div>
                    <div class="bg-pink-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Class Teacher</p>
                        <p id="classTeacher" class="text-sm font-medium text-gray-900">
                            {{if .class.Teacher}}
                                {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                                Not assigned
                            {{end}}
                        </p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Students List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Students</h2>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <input type="text" id="searchStudents" placeholder="Search students..." 
                                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Loading skeleton -->
                                <tr class="skeleton-row">
                                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                        <div class="flex items-center justify-center">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                                            <span class="ml-2">Loading students...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Class Settings Sidebar -->
            <div class="space-y-6">
                <!-- Promotion Settings -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Promotion Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Promote to Class</label>
                            <select id="promotionClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">Select target class...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Attendance (%)</label>
                            <input type="number" id="minAttendance" min="0" max="100" value="75" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Grade</label>
                            <select id="minGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="D">D</option>
                                <option value="C" selected>C</option>
                                <option value="B">B</option>
                                <option value="A">A</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="autoPromote" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label for="autoPromote" class="ml-2 block text-sm text-gray-900">Auto-promote eligible students</label>
                        </div>
                        
                        <button id="savePromotionSettings" class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            Save Settings
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                View Attendance Report
                            </div>
                        </button>
                        
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 00-2-2z"/>
                                </svg>
                                Performance Analytics
                            </div>
                        </button>
                        
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Export Student List
                            </div>
                        </button>
                        
                        <button id="promoteStudentsBtn" class="w-full text-left px-4 py-3 text-sm text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                Promote Students
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div id="studentModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900">Student Details</h2>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="studentModalContent">
            <!-- Student details will be loaded here -->
        </div>
    </div>
</div>

<script>
    const classID = '{{.classID}}';
    let classData = {
        students: [],
        statistics: {},
        promotionSettings: null,
        availableClasses: []
    };

    // Load class details on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Class detail page loaded for class:', classID);
        loadClassDetails();
        
        const closeModal = document.getElementById('closeModal');
        const studentModal = document.getElementById('studentModal');
        closeModal.addEventListener('click', () => {
            studentModal.classList.add('hidden');
        });
    });

    // Load detailed class information
    async function loadClassDetails() {
        try {
            const response = await fetch(`/api/classes/${classID}/details`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                classData = result;
                updateStatistics(result.statistics);
                displayStudents(result.students);
                loadPromotionSettings(result.promotion_settings, result.available_promotion_classes);
            }
        } catch (error) {
            console.error('Error loading class details:', error);
            showErrorState();
        }
    }

    // Update statistics display
    function updateStatistics(stats) {
        document.getElementById('totalStudents').textContent = stats.total_students || 0;
        document.getElementById('maleStudents').textContent = stats.male_students || 0;
        document.getElementById('femaleStudents').textContent = stats.female_students || 0;
    }

    // Display students in table
    function displayStudents(students) {
        const tableBody = document.getElementById('studentsTableBody');
        
        if (students.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                            <p class="text-lg font-medium text-gray-900 mb-1">No students found</p>
                            <p class="text-sm text-gray-500">Add students to this class to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = students.map(student => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-primary-600 font-medium text-sm">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${student.first_name} ${student.last_name}</p>
                            <p class="text-xs text-gray-500">${student.email || 'No email'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${student.student_id}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        student.gender === 'male' ? 'bg-blue-100 text-blue-800' : 
                        student.gender === 'female' ? 'bg-pink-100 text-pink-800' : 
                        'bg-gray-100 text-gray-800'
                    }">
                        ${student.gender ? student.gender.charAt(0).toUpperCase() + student.gender.slice(1) : 'Not specified'}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <button onclick="viewStudent('${student.id}')" class="text-primary-600 hover:text-primary-800 text-sm font-medium">View</button>
                        <button onclick="removeStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showErrorState() {
        const tableBody = document.getElementById('studentsTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">Error loading class details</p>
                        <p class="text-sm text-gray-500">Please try refreshing the page</p>
                    </div>
                </td>
            </tr>
        `;
    }

    // Load promotion settings
    function loadPromotionSettings(promotionSettings, availableClasses) {
        const promotionClassSelect = document.getElementById('promotionClass');

        // Populate available classes
        promotionClassSelect.innerHTML = '<option value="">Select target class...</option>';
        availableClasses.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.name;
            promotionClassSelect.appendChild(option);
        });

        // Load existing settings if available
        if (promotionSettings) {
            promotionClassSelect.value = promotionSettings.to_class_id;

            // Parse promotion criteria if it exists
            if (promotionSettings.promotion_criteria) {
                try {
                    const criteria = JSON.parse(promotionSettings.promotion_criteria);
                    document.getElementById('minAttendance').value = criteria.minimum_attendance || 75;
                    document.getElementById('minGrade').value = criteria.minimum_grade || 'C';
                    document.getElementById('autoPromote').checked = criteria.auto_promote || false;
                } catch (e) {
                    console.error('Error parsing promotion criteria:', e);
                }
            }
        }
    }

    // Save promotion settings
    document.getElementById('savePromotionSettings').addEventListener('click', async function() {
        const promotionClassId = document.getElementById('promotionClass').value;
        const minAttendance = document.getElementById('minAttendance').value;
        const minGrade = document.getElementById('minGrade').value;
        const autoPromote = document.getElementById('autoPromote').checked;

        if (!promotionClassId) {
            alert('Please select a target class for promotion');
            return;
        }

        const criteria = {
            minimum_attendance: parseFloat(minAttendance),
            minimum_grade: minGrade,
            auto_promote: autoPromote,
            required_subjects: [] // Can be expanded later
        };

        try {
            const response = await fetch(`/api/classes/${classID}/promotion`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    to_class_id: promotionClassId,
                    promotion_criteria: JSON.stringify(criteria)
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // Show success message
                showNotification('Promotion settings saved successfully!', 'success');
            } else {
                throw new Error(result.error || 'Failed to save promotion settings');
            }
        } catch (error) {
            console.error('Error saving promotion settings:', error);
            showNotification('Error saving promotion settings: ' + error.message, 'error');
        }
    });

    // Student actions
    async function viewStudent(studentId) {
        const studentModal = document.getElementById('studentModal');
        const studentModalContent = document.getElementById('studentModalContent');
        studentModalContent.innerHTML = '<p>Loading...</p>';
        studentModal.classList.remove('hidden');

        try {
            const response = await fetch(`/api/students/${studentId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch student details');
            }
            const data = await response.json();
            const student = data.student;
            const parent = data.parent;

            let parentInfo = '<p>No parent information available.</p>';
            if (parent) {
                parentInfo = `
                    <h4 class="text-lg font-semibold mt-4">Parent Information</h4>
                    <p><strong>Name:</strong> ${parent.first_name} ${parent.last_name}</p>
                    <p><strong>Email:</strong> ${parent.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${parent.phone || 'N/A'}</p>
                    <p><strong>Relationship:</strong> ${parent.relationship || 'N/A'}</p>
                `;
            }

            studentModalContent.innerHTML = `
                <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                <p><strong>Student ID:</strong> ${student.student_id}</p>
                <p><strong>Date of Birth:</strong> ${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : 'N/A'}</p>
                <p><strong>Gender:</strong> ${student.gender || 'N/A'}</p>
                <p><strong>Address:</strong> ${student.address || 'N/A'}</p>
                ${parentInfo}
            `;
        } catch (error) {
            studentModalContent.innerHTML = '<p class="text-red-500">Failed to load student details.</p>';
            console.error('Error fetching student details:', error);
        }
    }

    function removeStudent(studentId) {
        if (confirm('Are you sure you want to remove this student from the class?')) {
            // TODO: Implement remove student API call
            console.log('Remove student:', studentId);
        }
    }

    // Search functionality
    document.getElementById('searchStudents').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#studentsTableBody tr');

        rows.forEach(row => {
            const studentName = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            const studentId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

            if (studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
</script>
