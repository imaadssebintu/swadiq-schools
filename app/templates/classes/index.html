<!-- Classes Management Content -->
<div class="px-4 py-4 lg:px-6 lg:py-5">
    <!-- Header Section -->
    <div class="mb-5">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-lg font-black text-slate-900 tracking-tight uppercase">Classes Management</h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Academic Nodes & Assignment
                    Coordination</p>
            </div>
            <div class="flex items-center space-x-2">
                <button
                    class="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition-all duration-200 text-[11px] font-bold">
                    <i class="fas fa-arrow-up-from-bracket mr-1.5 opacity-50"></i>Export
                </button>
                <button id="addClassBtn"
                    class="px-4 py-1.5 premium-gradient text-white rounded-xl hover:opacity-90 transition-all duration-200 text-[11px] font-bold shadow-sm ring-2 ring-indigo-50">
                    <i class="fas fa-plus mr-1.5"></i>Add Class
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards (Gradient Style) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5" id="statsCards">
        <!-- Total Classes -->
        <div
            class="group bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-indigo-100 uppercase tracking-wide mb-1">Total Classes</p>
                    <p id="totalClasses" class="text-2xl font-black text-white leading-none">-</p>
                    <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-school text-white text-lg"></i>
                </div>
            </div>
        </div>
        <!-- Active Classes -->
        <div
            class="group bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-emerald-100 uppercase tracking-wide mb-1">Active Classes
                    </p>
                    <p id="activeClasses" class="text-2xl font-black text-white leading-none">-</p>
                    <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-check-circle text-white text-lg"></i>
                </div>
            </div>
        </div>
        <!-- With Students -->
        <div
            class="group bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-purple-100 uppercase tracking-wide mb-1">With Students</p>
                    <p id="classesWithStudents" class="text-2xl font-black text-white leading-none">-</p>
                    <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-users text-white text-lg"></i>
                </div>
            </div>
        </div>
        <!-- Without Teachers -->
        <div
            class="group bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-orange-100 uppercase tracking-wide mb-1">No Teacher</p>
                    <p id="classesWithoutTeachers" class="text-2xl font-black text-white leading-none">-</p>
                    <div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Administrative Grid -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden mb-5">
        <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/30">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 class="text-[11px] font-black text-slate-900 uppercase tracking-widest">Active Academic Nodes
                    </h2>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Deployment Registry
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative group">
                        <i
                            class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" id="searchInput" placeholder="LOCATE NODE..."
                            class="pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-[11px] font-bold uppercase tracking-tight focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all w-full sm:w-64 placeholder:text-slate-300">
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="border-b border-slate-100 bg-slate-50/50">
                        <th class="px-5 py-3 text-left">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Node Name &
                                Identity</span>
                        </th>
                        <th class="px-5 py-3 text-left">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Commanding
                                Officer</span>
                        </th>
                        <th class="px-5 py-3 text-center">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Personnel
                                Count</span>
                        </th>
                        <th class="px-5 py-3 text-center">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Status</span>
                        </th>
                        <th class="px-5 py-3 text-right">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Operations</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="classesTableBody" class="divide-y divide-slate-50">
                    <!-- Loading skeleton handled via script initially or placeholder -->
                    <tr class="skeleton-row">
                        <td colspan="5" class="px-5 py-12 text-center text-slate-400">
                            <div class="flex flex-col items-center justify-center space-y-3">
                                <i class="fas fa-spinner fa-spin text-2xl text-indigo-500 opacity-20"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest opacity-50">Synchronizing
                                    Data Nodes...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
</div>
</div>


<!-- Add Class Modal -->
<div id="addClassModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
        <div
            class="relative transform overflow-hidden rounded-[1.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-100">
            <div class="bg-white px-6 py-5 border-b border-slate-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-black text-slate-900 uppercase tracking-widest" id="modal-title">
                            Initialize Node</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Creating New
                            Academic Structure</p>
                    </div>
                    <button type="button" onclick="closeModal()"
                        class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addClassForm" class="p-6 space-y-5">
                <div>
                    <label for="className"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Class Identity
                        Name</label>
                    <input type="text" id="className" name="className" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide"
                        placeholder="e.g., GRADE 9-A, FORM 1 BLUE">
                </div>
                <div>
                    <label for="classCode"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">System
                        Code</label>
                    <input type="text" id="classCode" name="classCode" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide"
                        placeholder="e.g., P-1, S-1">
                </div>
                <div>
                    <label for="classTeacher"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Class
                        Supervisor (Optional)</label>
                    <div class="relative group">
                        <input type="text" id="selectedTeacherDisplay" name="selectedTeacherDisplay" readonly
                            onclick="openTeacherModal()"
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 cursor-pointer group-hover:bg-indigo-50/50"
                            placeholder="SELECT FACULTY MEMBER">
                        <button type="button" onclick="openTeacherModal()"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                        <input type="hidden" id="classTeacher" name="classTeacher">
                    </div>
                </div>
            </form>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100">
                <button type="submit" form="addClassForm"
                    class="w-full sm:w-auto px-6 py-2.5 premium-gradient text-white text-[11px] font-bold uppercase tracking-wider rounded-xl hover:opacity-90 shadow-lg shadow-indigo-500/20 transition-all">
                    Create Structure
                </button>
                <button type="button" onclick="closeModal()"
                    class="w-full sm:w-auto px-6 py-2.5 bg-white border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-wider rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Teacher Search Modal -->
<div id="teacherSearchModal" class="hidden fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title"
    role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
        <div
            class="relative transform overflow-hidden rounded-[1.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-100">
            <div class="bg-white px-6 py-5 border-b border-slate-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-black text-slate-900 uppercase tracking-widest">Select Faculty</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Assign
                            Responsibility</p>
                    </div>
                    <button onclick="closeTeacherModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="relative group">
                    <i
                        class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    <input type="text" id="teacherSearchInput" placeholder="SEARCH BY NAME OR ID..."
                        class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide">
                </div>
                <!-- Results Container -->
                <div class="border border-slate-100 rounded-xl overflow-hidden bg-slate-50/50 min-h-[200px] max-h-[300px] overflow-y-auto"
                    id="teacherSearchResults">
                    <!-- Loading State -->
                    <div id="teacherSearchLoading"
                        class="hidden flex flex-col items-center justify-center h-48 space-y-3">
                        <i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Searching
                            Database...</span>
                    </div>
                    <!-- Empty State -->
                    <div id="teacherSearchEmpty"
                        class="hidden flex flex-col items-center justify-center h-48 space-y-2">
                        <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center mb-1">
                            <i class="fas fa-user-slash text-slate-400"></i>
                        </div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">No Faculty
                            Found</span>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-between items-center border-t border-slate-100">
                <button type="button" onclick="isEditMode ? clearEditTeacherSelection() : clearTeacherSelection()"
                    class="text-[10px] font-bold text-red-500 uppercase tracking-wider hover:text-red-600 transition-colors">
                    Clear Selection
                </button>
                <button type="button" onclick="closeTeacherModal()"
                    class="px-5 py-2 bg-white border border-slate-200 text-slate-600 text-[10px] font-bold uppercase tracking-wider rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div id="editClassModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
        <div
            class="relative transform overflow-hidden rounded-[1.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-100">
            <div class="bg-white px-6 py-5 border-b border-slate-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-black text-slate-900 uppercase tracking-widest">Edit Node
                            Configuration</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Modify Academic
                            Parameters</p>
                    </div>
                    <button onclick="closeEditModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="editClassForm" class="p-6 space-y-5">
                <input type="hidden" id="editClassId" name="editClassId">
                <div>
                    <label for="editClassName"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Class Identity
                        Name</label>
                    <input type="text" id="editClassName" name="editClassName" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide">
                </div>
                <div>
                    <label for="editClassCode"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">System
                        Code</label>
                    <input type="text" id="editClassCode" name="editClassCode" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide">
                </div>
                <div>
                    <label for="editClassTeacher"
                        class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Class
                        Supervisor</label>
                    <div class="relative group">
                        <input type="text" id="editSelectedTeacherDisplay" name="editSelectedTeacherDisplay" readonly
                            onclick="openEditTeacherModal()"
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 cursor-pointer group-hover:bg-indigo-50/50"
                            placeholder="SELECT FACULTY MEMBER">
                        <button type="button" onclick="openEditTeacherModal()"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                        <input type="hidden" id="editClassTeacher" name="editClassTeacher">
                    </div>
                </div>
            </form>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100">
                <button type="submit" form="editClassForm"
                    class="w-full sm:w-auto px-6 py-2.5 premium-gradient text-white text-[11px] font-bold uppercase tracking-wider rounded-xl hover:opacity-90 shadow-lg shadow-indigo-500/20 transition-all">
                    Save Changes
                </button>
                <button type="button" onclick="closeEditModal()"
                    class="w-full sm:w-auto px-6 py-2.5 bg-white border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-wider rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Delete Class Modal -->
<div id="deleteClassModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
        <div
            class="relative transform overflow-hidden rounded-[1.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-slate-100">
            <div class="bg-white px-6 py-5 border-b border-slate-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-black text-slate-900 uppercase tracking-widest">Protocol: Deletion
                        </h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Permanent Node
                            Removal</p>
                    </div>
                    <button onclick="closeDeleteModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="flex items-center space-x-4 mb-5">
                    <div class="flex-shrink-0">
                        <div
                            class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center border border-red-100 shadow-sm">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-wide">Confirm Action</h4>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mt-0.5">This operation
                            is irreversible</p>
                    </div>
                </div>
                <div class="mb-5 bg-slate-50 rounded-xl p-4 border border-slate-100">
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wide leading-relaxed">
                        Are you sure you want to dismantle the academic node <span id="deleteClassName"
                            class="text-indigo-600 font-black"></span>?
                    </p>
                </div>
                <div id="deleteWarning"
                    class="hidden bg-amber-50 border border-amber-100 rounded-xl p-3 mb-5 flex items-start gap-3">
                    <i class="fas fa-exclamation-circle text-amber-500 mt-0.5 text-sm"></i>
                    <p class="text-[10px] font-bold text-amber-700 uppercase tracking-wide leading-relaxed pt-0.5"
                        id="deleteWarningText"></p>
                </div>
                <div class="flex flex-col-reverse sm:flex-row gap-3">
                    <button type="button" onclick="closeDeleteModal()"
                        class="w-full sm:w-auto px-6 py-2.5 bg-white border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-wider rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-all">
                        Cancel Protocol
                    </button>
                    <button id="confirmDeleteBtn" onclick="confirmDelete()"
                        class="w-full sm:w-auto px-6 py-2.5 bg-red-500 text-white text-[11px] font-bold uppercase tracking-wider rounded-xl hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all ml-auto">
                        Confirm Deletion
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subject & Paper Assignment Modal -->
<div id="subjectPaperModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
    role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
        <div
            class="relative transform overflow-hidden rounded-[1.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-100">
            <div class="bg-white px-6 py-5 border-b border-slate-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-black text-slate-900 uppercase tracking-widest">Assignment Matrix</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Link Modules &
                            Assessment Papers</p>
                    </div>
                    <button onclick="closeSubjectPaperModal()"
                        class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 max-h-[60vh]">
                <!-- Subject Selection -->
                <div class="mb-6">
                    <label class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Target
                        Module</label>
                    <div class="relative group">
                        <i
                            class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" id="subjectSearchInput" placeholder="SEARCH CURRICULUM..."
                            class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-300 uppercase tracking-wide">
                    </div>
                    <div id="subjectResults"
                        class="mt-2 max-h-40 overflow-y-auto border border-slate-100 rounded-xl hidden bg-white shadow-sm">
                        <!-- Subject search results -->
                    </div>
                </div>

                <!-- Selected Subject Info -->
                <div id="selectedSubjectInfo"
                    class="hidden mb-6 p-4 bg-indigo-50/50 border border-indigo-100 rounded-xl flex items-center justify-between">
                    <div>
                        <h4 class="text-[11px] font-black text-indigo-900 uppercase tracking-wide"
                            id="selectedSubjectName"></h4>
                        <p class="text-[9px] font-bold text-indigo-400 uppercase tracking-wider mt-0.5"
                            id="selectedSubjectCode"></p>
                    </div>
                    <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-book text-indigo-500 text-sm"></i>
                    </div>
                </div>

                <!-- Papers Selection -->
                <div id="papersSection" class="hidden mb-6">
                    <label class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Assessment
                        Papers</label>
                    <div id="availablePapers"
                        class="space-y-2 max-h-48 overflow-y-auto border border-slate-200 rounded-xl p-3 bg-slate-50/50">
                        <!-- Papers will be loaded here -->
                    </div>
                </div>

                <!-- Teacher Assignment for Selected Papers -->
                <div id="teacherAssignmentSection" class="hidden">
                    <label class="block text-[10px] font-bold uppercase text-slate-500 tracking-wider mb-2">Assign Paper
                        Instructors</label>
                    <div id="paperTeacherAssignments" class="space-y-3">
                        <!-- Teacher assignments will be shown here -->
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100">
                <button type="button" onclick="addSubjectAssignment()"
                    class="w-full sm:w-auto px-6 py-2.5 premium-gradient text-white text-[11px] font-bold uppercase tracking-wider rounded-xl hover:opacity-90 shadow-lg shadow-indigo-500/20 transition-all">
                    Link Matrix
                </button>
                <button type="button" onclick="closeSubjectPaperModal()"
                    class="w-full sm:w-auto px-6 py-2.5 bg-white border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-wider rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    const addClassModal = document.getElementById('addClassModal');
    const editClassModal = document.getElementById('editClassModal');
    const deleteClassModal = document.getElementById('deleteClassModal');
    const teacherSearchModal = document.getElementById('teacherSearchModal');
    const addClassForm = document.getElementById('addClassForm');
    const editClassForm = document.getElementById('editClassForm');
    const teacherSearchInput = document.getElementById('teacherSearchInput');
    const teacherSearchResults = document.getElementById('teacherSearchResults');
    const teacherSearchLoading = document.getElementById('teacherSearchLoading');
    const teacherSearchEmpty = document.getElementById('teacherSearchEmpty');

    let selectedTeacher = null;
    let searchTimeout = null;
    let isEditMode = false;
    let deleteClassId = null;
    let teachersData = {
        teachers: [],
        offset: 0,
        limit: 10,
        hasMore: true,
        loading: false,
        currentQuery: ''
    };

    // Subject and Paper Assignment Variables
    let selectedSubject = null;
    let selectedPapers = [];
    let paperTeacherAssignments = {};
    let classSubjectAssignments = [];

    // Modal functionality
    function openModal() {
        addClassModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        addClassModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        addClassForm.reset();
        clearTeacherSelection();
    }

    // Class Subjects Modal functionality
    function openClassSubjectsModal(classId, className) {
        window.currentClassId = classId;
        document.getElementById('subjectPaperModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Update modal title to show class name
        const modalTitle = document.querySelector('#subjectPaperModal h3');
        modalTitle.textContent = `Add Subjects to ${className}`;

        resetSubjectPaperModal();
    }

    // Teacher Search Modal functionality
    function openTeacherModal() {
        teacherSearchModal.classList.remove('hidden');
        teacherSearchInput.focus();
        loadInitialTeachers();
    }

    function closeTeacherModal() {
        teacherSearchModal.classList.add('hidden');
        teacherSearchInput.value = '';
        clearSearchResults();
    }

    function clearTeacherSelection() {
        selectedTeacher = null;
        document.getElementById('selectedTeacherDisplay').value = '';
        document.getElementById('classTeacher').value = '';
        closeTeacherModal();
    }

    function selectTeacher(teacher) {
        selectedTeacher = teacher;
        document.getElementById('selectedTeacherDisplay').value = `${teacher.first_name} ${teacher.last_name}`;
        document.getElementById('classTeacher').value = teacher.id;
        closeTeacherModal();
    }

    // Subject & Paper Assignment Modal functionality
    function openSubjectPaperModal() {
        document.getElementById('subjectPaperModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        resetSubjectPaperModal();
    }

    function closeSubjectPaperModal() {
        document.getElementById('subjectPaperModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        resetSubjectPaperModal();
    }

    function resetSubjectPaperModal() {
        selectedSubject = null;
        selectedPapers = [];
        paperTeacherAssignments = {};

        document.getElementById('subjectSearchInput').value = '';
        document.getElementById('subjectResults').classList.add('hidden');
        document.getElementById('selectedSubjectInfo').classList.add('hidden');
        document.getElementById('papersSection').classList.add('hidden');
        document.getElementById('teacherAssignmentSection').classList.add('hidden');
    }

    // Search subjects
    async function searchSubjects(query) {
        if (query.length < 2) {
            document.getElementById('subjectResults').classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/subjects/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            displaySubjectResults(data.subjects || []);
        } catch (error) {
            console.error('Error searching subjects:', error);
        }
    }

    function displaySubjectResults(subjects) {
        const resultsDiv = document.getElementById('subjectResults');

        if (subjects.length === 0) {
            resultsDiv.innerHTML = '<div class="p-4 text-center"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">No matching modules found</p></div>';
        } else {
            resultsDiv.innerHTML = subjects.map(subject => `
                <div class="p-3 hover:bg-indigo-50/50 cursor-pointer border-b border-slate-50 last:border-b-0 transition-colors group" 
                     onclick="selectSubject(${JSON.stringify(subject).replace(/"/g, '&quot;')})">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${subject.name}</div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">${subject.code}</div>
                        </div>
                        <i class="fas fa-plus text-slate-300 group-hover:text-indigo-400 text-xs transition-colors"></i>
                    </div>
                </div>
            `).join('');
        }

        resultsDiv.classList.remove('hidden');
    }

    function selectSubject(subject) {
        selectedSubject = subject;

        // Update selected subject info
        document.getElementById('selectedSubjectName').textContent = subject.name;
        document.getElementById('selectedSubjectCode').textContent = subject.code;
        document.getElementById('selectedSubjectInfo').classList.remove('hidden');
        document.getElementById('subjectResults').classList.add('hidden');

        // Load papers for this subject
        loadSubjectPapers(subject.id);
    }

    async function loadSubjectPapers(subjectId) {
        try {
            const response = await fetch(`/api/papers/by-subject/${subjectId}`);
            const data = await response.json();

            displayPapers(data.papers || []);
        } catch (error) {
            console.error('Error loading papers:', error);
        }
    }

    function displayPapers(papers) {
        const papersDiv = document.getElementById('availablePapers');

        if (papers.length === 0) {
            papersDiv.innerHTML = '<p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center py-2">No records found</p>';
        } else {
            papersDiv.innerHTML = papers.map(paper => `
                <label class="flex items-center p-2 hover:bg-white rounded-lg cursor-pointer border border-transparent hover:border-slate-200 transition-all group">
                    <div class="relative flex items-center">
                        <input type="checkbox" value="${paper.id}" onchange="togglePaper(${paper.id}, '${paper.code}')" 
                               class="peer h-4 w-4 cursor-pointer appearance-none rounded border border-slate-300 shadow-sm transition-all checked:border-indigo-500 checked:bg-indigo-500 hover:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-500/20">
                        <i class="fas fa-check absolute pointer-events-none opacity-0 peer-checked:opacity-100 text-white text-[10px] left-[3px]"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${paper.code}</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">${selectedSubject.name}</div>
                    </div>
                </label>
            `).join('');
        }

        document.getElementById('papersSection').classList.remove('hidden');
    }

    function togglePaper(paperId, paperCode) {
        const checkbox = event.target;
        const index = selectedPapers.findIndex(p => p.id == paperId);

        if (checkbox.checked && index === -1) {
            // Add paper
            selectedPapers.push({ id: paperId, code: paperCode });
        } else if (!checkbox.checked && index > -1) {
            // Remove paper
            selectedPapers.splice(index, 1);
            delete paperTeacherAssignments[paperId];
        }

        updateTeacherAssignments();
    }

    function updateTeacherAssignments() {
        const assignmentsDiv = document.getElementById('paperTeacherAssignments');

        if (selectedPapers.length === 0) {
            document.getElementById('teacherAssignmentSection').classList.add('hidden');
            return;
        }

        assignmentsDiv.innerHTML = selectedPapers.map(paper => `
            <div class="flex items-center justify-between p-3 border border-slate-200 rounded-xl bg-white shadow-sm hover:shadow-md transition-shadow">
                <div>
                    <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide">${paper.code}</div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">${selectedSubject.name}</div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="relative group">
                        <input type="text" 
                               id="teacher_${paper.id}" 
                               placeholder="ASSIGN FACULTY" 
                               readonly
                               onclick="openPaperTeacherModal(${paper.id})"
                               class="pl-3 pr-8 py-1.5 text-[10px] font-bold uppercase tracking-wider border border-slate-200 rounded-lg cursor-pointer bg-slate-50 hover:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all w-32 sm:w-40 placeholder:text-slate-300"
                               value="${paperTeacherAssignments[paper.id] ? paperTeacherAssignments[paper.id].name : ''}">
                         <i class="fas fa-chevron-down absolute right-2.5 top-1/2 -translate-y-1/2 text-[10px] text-slate-300 pointer-events-none group-hover:text-indigo-400 transition-colors"></i>
                    </div>
                    <button type="button" onclick="clearPaperTeacher(${paper.id})" 
                            class="w-7 h-7 flex items-center justify-center rounded-lg bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-all">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
        `).join('');

        document.getElementById('teacherAssignmentSection').classList.remove('hidden');
    }

    function openPaperTeacherModal(paperId) {
        // Store current paper ID for teacher selection
        window.currentPaperId = paperId;
        openTeacherModal();
    }

    function clearPaperTeacher(paperId) {
        delete paperTeacherAssignments[paperId];
        document.getElementById(`teacher_${paperId}`).value = '';
    }

    // Override selectTeacher to handle different contexts
    const originalSelectTeacher = selectTeacher;
    selectTeacher = function (teacher) {
        if (window.currentPaperId) {
            // Assigning teacher to a specific paper
            paperTeacherAssignments[window.currentPaperId] = {
                id: teacher.id,
                name: `${teacher.first_name} ${teacher.last_name}`
            };
            document.getElementById(`teacher_${window.currentPaperId}`).value = paperTeacherAssignments[window.currentPaperId].name;
            window.currentPaperId = null;
            closeTeacherModal();
        } else if (isEditMode) {
            // Edit mode teacher assignment
            document.getElementById('editSelectedTeacherDisplay').value = `${teacher.first_name} ${teacher.last_name}`;
            document.getElementById('editClassTeacher').value = teacher.id;
            closeTeacherModal();
        } else {
            // Regular class teacher assignment (create mode)
            originalSelectTeacher(teacher);
        }
    };

    function addSubjectAssignment() {
        if (!selectedSubject || selectedPapers.length === 0) {
            alert('Please select a subject and at least one paper');
            return;
        }

        // If we have a current class ID, save to that class
        if (window.currentClassId) {
            saveClassSubjectAssignment();
        } else {
            // Original behavior for class creation
            const assignment = {
                subject: selectedSubject,
                papers: selectedPapers.map(paper => ({
                    ...paper,
                    teacher: paperTeacherAssignments[paper.id] || null
                }))
            };

            classSubjectAssignments.push(assignment);
            updateAssignedSubjectsDisplay();
            closeSubjectPaperModal();
        }
    }

    async function saveClassSubjectAssignment() {
        const assignment = {
            class_id: window.currentClassId,
            subject_id: selectedSubject.id,
            papers: selectedPapers.map(paper => ({
                paper_id: paper.id,
                teacher_id: paperTeacherAssignments[paper.id] ? paperTeacherAssignments[paper.id].id : null
            }))
        };

        try {
            const response = await fetch('/api/classes/subjects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(assignment)
            });

            if (response.ok) {
                closeSubjectPaperModal();
                showNotification('Subjects added to class successfully', 'success');
                window.currentClassId = null;
            } else {
                const errorData = await response.json();
                alert('Error: ' + (errorData.error || 'Failed to add subjects to class'));
            }
        } catch (error) {
            console.error('Error adding subjects to class:', error);
            alert('Error: Failed to add subjects to class');
        }
    }

    function updateAssignedSubjectsDisplay() {
        const assignedDiv = document.getElementById('assignedSubjects');

        if (classSubjectAssignments.length === 0) {
            assignedDiv.innerHTML = '<p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center py-2">No subjects assigned yet</p>';
            return;
        }

        assignedDiv.innerHTML = classSubjectAssignments.map((assignment, index) => `
            <div class="p-3 border border-slate-200 rounded-xl bg-white shadow-sm hover:shadow-md transition-all group">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2">
                             <div class="w-6 h-6 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-500">
                                <i class="fas fa-book text-[10px]"></i>
                             </div>
                             <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${assignment.subject.name}</div>
                        </div>
                        <div class="ml-8 mt-1">
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${assignment.papers.length} paper(s)</div>
                            <div class="flex flex-wrap gap-1 mt-1.5">
                                ${assignment.papers.map(p => `
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-md bg-slate-50 border border-slate-200 text-[8px] font-bold text-slate-500 uppercase tracking-wider">
                                        ${p.code}${p.teacher ? ` <span class="text-indigo-400 ml-1">â€¢ ${p.teacher.name}</span>` : ''}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <button onclick="removeSubjectAssignment(${index})" 
                            class="w-6 h-6 flex items-center justify-center rounded-lg bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100">
                        <i class="fas fa-times text-[10px]"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function removeSubjectAssignment(index) {
        classSubjectAssignments.splice(index, 1);
        updateAssignedSubjectsDisplay();
    }

    // Subject search input event listener
    document.getElementById('subjectSearchInput').addEventListener('input', function () {
        const query = this.value.trim();

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        searchTimeout = setTimeout(() => {
            searchSubjects(query);
        }, 300);
    });

    // Load initial teachers (recent teachers)
    async function loadInitialTeachers() {
        resetTeachersData();
        await loadMoreTeachers();
    }

    // Search teachers
    async function searchTeachers(query) {
        resetTeachersData(query);
        await loadMoreTeachers();
    }

    // Reset teachers data for new search
    function resetTeachersData(query = '') {
        teachersData = {
            teachers: [],
            offset: 0,
            limit: 10,
            hasMore: true,
            loading: false,
            currentQuery: query
        };
        clearSearchResults();
    }

    // Load more teachers (for pagination/infinite scroll)
    async function loadMoreTeachers() {
        if (teachersData.loading || !teachersData.hasMore) {
            return;
        }

        teachersData.loading = true;
        showLoading(true);
        showEmpty(false);

        try {
            const url = teachersData.currentQuery ?
                `/api/teachers/search?q=${encodeURIComponent(teachersData.currentQuery)}&limit=${teachersData.limit}&offset=${teachersData.offset}` :
                `/api/teachers/search?limit=${teachersData.limit}&offset=${teachersData.offset}`;

            const response = await fetch(url, {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.teachers && data.teachers.length > 0) {
                teachersData.teachers = [...teachersData.teachers, ...data.teachers];
                teachersData.offset += data.teachers.length;
                teachersData.hasMore = data.has_more || false;

                displayTeachers(teachersData.teachers);

                // Add "Load More" button if there are more teachers
                if (teachersData.hasMore) {
                    addLoadMoreButton();
                }
            } else if (teachersData.teachers.length === 0) {
                showEmpty(true);
            }
        } catch (error) {
            console.error('Error loading teachers:', error);
            if (teachersData.teachers.length === 0) {
                showEmpty(true);
            }
        } finally {
            teachersData.loading = false;
            showLoading(false);
        }
    }

    // Display teachers in search results
    function displayTeachers(teachers) {
        // Clear only if this is a fresh search (offset = 0)
        if (teachersData.offset <= teachersData.limit) {
            clearSearchResults();
        }

        if (teachers.length === 0) {
            showEmpty(true);
            return;
        }

        // Remove existing load more button if present
        const existingLoadMore = document.getElementById('loadMoreTeachers');
        if (existingLoadMore) {
            existingLoadMore.remove();
        }

        teachers.forEach(teacher => {
            const teacherElement = document.createElement('div');
            teacherElement.className = 'p-3 border border-slate-200 rounded-xl hover:border-indigo-300 hover:bg-slate-50 cursor-pointer transition-all duration-200 group';
            teacherElement.onclick = () => selectTeacher(teacher);

            teacherElement.innerHTML = `
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center border border-indigo-100 group-hover:bg-indigo-100 transition-colors">
                        <i class="fas fa-user-tie text-indigo-500 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${teacher.first_name} ${teacher.last_name}</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5 flex items-center gap-2">
                            <span>${teacher.email}</span>
                            ${teacher.phone ? `<span class="w-1 h-1 rounded-full bg-slate-300"></span><span>${teacher.phone}</span>` : ''}
                        </p>
                    </div>
                    <div class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                         <i class="fas fa-check text-indigo-500 text-xs"></i>
                    </div>
                </div>
            `;

            teacherSearchResults.appendChild(teacherElement);
        });
    }

    // Add "Load More" button
    function addLoadMoreButton() {
        // Remove existing load more button if present
        const existingLoadMore = document.getElementById('loadMoreTeachers');
        if (existingLoadMore) {
            existingLoadMore.remove();
        }

        const loadMoreButton = document.createElement('div');
        loadMoreButton.id = 'loadMoreTeachers';
        loadMoreButton.className = 'p-3 text-center border-t border-gray-200 mt-2';
        loadMoreButton.innerHTML = `
            <button onclick="loadMoreTeachers()"
                    class="w-full px-4 py-2 text-sm text-primary-600 hover:text-primary-800 hover:bg-primary-50 rounded-lg transition-colors duration-200">
                Load More Teachers
            </button>
        `;

        teacherSearchResults.appendChild(loadMoreButton);
    }

    // Helper functions
    function clearSearchResults() {
        // Only clear teacher items, keep loading and empty states
        const teacherItems = teacherSearchResults.querySelectorAll('.p-3.border.border-gray-200');
        teacherItems.forEach(item => item.remove());

        // Remove load more button if present
        const loadMoreBtn = document.getElementById('loadMoreTeachers');
        if (loadMoreBtn) {
            loadMoreBtn.remove();
        }

        // Ensure loading and empty states exist
        if (!document.getElementById('teacherSearchLoading')) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'teacherSearchLoading';
            loadingDiv.className = 'text-center py-8 text-gray-500 hidden';
            loadingDiv.innerHTML = `
                <svg class="animate-spin h-8 w-8 text-primary-600 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Searching teachers...</p>
            `;
            teacherSearchResults.appendChild(loadingDiv);
        }

        if (!document.getElementById('teacherSearchEmpty')) {
            const emptyDiv = document.createElement('div');
            emptyDiv.id = 'teacherSearchEmpty';
            emptyDiv.className = 'text-center py-8 text-gray-500 hidden';
            emptyDiv.innerHTML = `
                <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <p>No teachers found</p>
                <p class="text-sm text-gray-400 mt-1">Try adjusting your search terms</p>
            `;
            teacherSearchResults.appendChild(emptyDiv);
        }
    }

    function showLoading(show) {
        const loading = document.getElementById('teacherSearchLoading');
        if (loading) {
            loading.classList.toggle('hidden', !show);
        }
    }

    function showEmpty(show) {
        const empty = document.getElementById('teacherSearchEmpty');
        if (empty) {
            empty.classList.toggle('hidden', !show);
        }
    }

    // Search input event listener with debounce
    teacherSearchInput.addEventListener('input', function () {
        const query = this.value.trim();

        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        // Set new timeout for search
        searchTimeout = setTimeout(() => {
            if (query.length === 0) {
                loadInitialTeachers();
            } else if (query.length >= 2) {
                searchTeachers(query);
            } else {
                resetTeachersData();
                clearSearchResults();
                showEmpty(false);
            }
        }, 300); // 300ms debounce
    });

    // Handle Enter key in search input
    teacherSearchInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if (query.length >= 2) {
                searchTeachers(query);
            }
        }
    });



    // Close modals when clicking outside
    addClassModal.addEventListener('click', function (e) {
        if (e.target === addClassModal) {
            closeModal();
        }
    });

    teacherSearchModal.addEventListener('click', function (e) {
        if (e.target === teacherSearchModal) {
            closeTeacherModal();
        }
    });

    // Handle Escape key to close modals
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            if (!teacherSearchModal.classList.contains('hidden')) {
                closeTeacherModal();
            } else if (!addClassModal.classList.contains('hidden')) {
                closeModal();
            } else if (!editClassModal.classList.contains('hidden')) {
                closeEditModal();
            } else if (!deleteClassModal.classList.contains('hidden')) {
                closeDeleteModal();
            }
        }
    });

    // Add Class button event listener
    document.getElementById('addClassBtn').addEventListener('click', openModal);

    // Search functionality
    let classSearchTimeout = null;
    document.getElementById('searchInput').addEventListener('input', function () {
        const query = this.value.trim();

        if (classSearchTimeout) {
            clearTimeout(classSearchTimeout);
        }

        classSearchTimeout = setTimeout(() => {
            loadClasses(query);
        }, 300);
    });

    // Load stats and classes on page load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Classes page script loaded');
        loadStats();
        loadClasses();
    });

    // Load statistics
    async function loadStats() {
        try {
            const response = await fetch('/api/classes/stats', {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success && result.data) {
                updateStatValue('totalClasses', result.data.total_classes);
                updateStatValue('activeClasses', result.data.active_classes);
                updateStatValue('classesWithStudents', result.data.classes_with_students);
                updateStatValue('classesWithoutTeachers', result.data.classes_without_teachers);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Update stat value with animation
    function updateStatValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.opacity = '0.5';
            setTimeout(() => {
                element.textContent = value;
                element.style.opacity = '1';
            }, 150);
        }
    }

    // Load classes table
    async function loadClasses(search = '') {
        const tableBody = document.getElementById('classesTableBody');

        // Show loading
        tableBody.innerHTML = `
            <tr class="skeleton-row">
                <td colspan="5" class="px-5 py-12 text-center text-slate-400">
                    <div class="flex flex-col items-center justify-center space-y-3">
                        <i class="fas fa-spinner fa-spin text-2xl text-indigo-500 opacity-20"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest opacity-50">Synchronizing Data Nodes...</span>
                    </div>
                </td>
            </tr>
        `;

        try {
            const url = search ? `/api/classes/table?search=${encodeURIComponent(search)}` : '/api/classes/table';
            const response = await fetch(url, {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success && result.classes) {
                displayClasses(result.classes);
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('Error loading classes:', error);
            showErrorState();
        }
    }

    // Display classes in table
    function displayClasses(classes) {
        const tableBody = document.getElementById('classesTableBody');

        if (classes.length === 0) {
            showEmptyState();
            return;
        }

        tableBody.innerHTML = classes.map(classItem => `
            <tr class="hover:bg-indigo-50/30 transition-colors group border-b border-slate-50 last:border-b-0">
                <td class="px-5 py-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-500 shadow-sm group-hover:scale-105 transition-transform mr-4">
                            <i class="fas fa-layer-group text-lg"></i>
                        </div>
                        <div>
                            <div class="text-[11px] font-black text-slate-700 uppercase tracking-wide group-hover:text-indigo-700 transition-colors">${classItem.name}</div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">
                                <span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded text-[8px] border border-slate-200">CODE: ${classItem.code || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-5 py-4 text-left">
                    ${classItem.teacher ? `
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 text-[10px] font-bold">
                                ${classItem.teacher.first_name.charAt(0)}${classItem.teacher.last_name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-700 uppercase tracking-wide">${classItem.teacher.first_name} ${classItem.teacher.last_name}</div>
                            </div>
                        </div>
                    ` : `
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1.5">
                            <i class="fas fa-user-slash"></i> Unassigned
                        </span>
                    `}
                </td>
                <td class="px-5 py-4 text-center">
                    ${classItem.student_count && classItem.student_count > 0 ? `
                        <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-slate-50 border border-slate-200">
                             <i class="fas fa-users text-slate-400 text-[10px]"></i>
                             <span class="text-[10px] font-black text-slate-600">${classItem.student_count}</span>
                        </div>
                    ` : `
                        <span class="text-[9px] font-bold text-slate-300 uppercase tracking-wider">Empty Node</span>
                    `}
                </td>
                <td class="px-5 py-4 text-center">
                   ${classItem.is_active ? `
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-emerald-50 border border-emerald-100 text-emerald-600">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[9px] font-black uppercase tracking-wider">Active</span>
                        </span>
                    ` : `
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-slate-50 border border-slate-200 text-slate-400">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                            <span class="text-[9px] font-black uppercase tracking-wider">Inactive</span>
                        </span>
                    `}
                </td>
                <td class="px-5 py-4 text-right">
                    <div class="flex items-center justify-end gap-2 transition-opacity">
                        <a href="/classes/${classItem.id}" 
                           class="w-7 h-7 flex items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-100 transition-colors"
                           title="View Class">
                            <i class="fas fa-eye text-xs"></i>
                        </a>
                        <button onclick="openEditModal('${classItem.id}', '${classItem.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${classItem.code || ''}', '${classItem.teacher ? classItem.teacher.id : ''}', '${classItem.teacher ? (classItem.teacher.first_name + ' ' + classItem.teacher.last_name).replace(/'/g, "\\'").replace(/"/g, '\\"') : ''}')"
                                class="w-7 h-7 flex items-center justify-center rounded-lg bg-amber-50 text-amber-600 hover:bg-amber-100 border border-amber-100 transition-colors"
                                title="Edit Class">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                         <button onclick="openClassSubjectsModal('${classItem.id}', '${classItem.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}')"
                                class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-100 transition-colors"
                                title="Manage Subjects">
                            <i class="fas fa-book text-xs"></i>
                        </button>
                        <button onclick="openDeleteModal('${classItem.id}', '${classItem.name}')"
                                class="w-7 h-7 flex items-center justify-center rounded-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-100 transition-colors"
                                title="Delete Class">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showEmptyState() {
        const tableBody = document.getElementById('classesTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-5 py-12 text-center text-slate-400">
                    <div class="flex flex-col items-center justify-center space-y-3">
                        <div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center border border-slate-100 mb-2">
                            <i class="fas fa-folder-open text-3xl text-slate-300"></i>
                         </div>
                        <h4 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Registry Empty</h4>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">No academic nodes established yet</p>
                    </div>
                </td>
            </tr>
        `;
    }

    function showErrorState() {
        const tableBody = document.getElementById('classesTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">Error loading classes</p>
                        <p class="text-sm text-gray-500">Please try refreshing the page</p>
                    </div>
                </td>
            </tr>
        `;
    }

    // Edit Modal functionality
    function openEditModal(classId, className, classCode, teacherId, teacherName) {
        isEditMode = true;
        document.getElementById('editClassId').value = classId;
        document.getElementById('editClassName').value = className;
        document.getElementById('editClassCode').value = classCode;

        // Set teacher if exists
        if (teacherId && teacherId !== 'undefined' && teacherId !== '') {
            document.getElementById('editClassTeacher').value = teacherId;
            document.getElementById('editSelectedTeacherDisplay').value = teacherName || `Teacher ID: ${teacherId}`;
        } else {
            document.getElementById('editClassTeacher').value = '';
            document.getElementById('editSelectedTeacherDisplay').value = '';
        }

        editClassModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        isEditMode = false;
        editClassModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        editClassForm.reset();
        // Clear teacher selection
        document.getElementById('editClassTeacher').value = '';
        document.getElementById('editSelectedTeacherDisplay').value = '';
    }

    function openEditTeacherModal() {
        isEditMode = true;
        openTeacherModal();
    }

    function clearEditTeacherSelection() {
        document.getElementById('editSelectedTeacherDisplay').value = '';
        document.getElementById('editClassTeacher').value = '';
        closeTeacherModal();
    }

    // Delete Modal functionality
    function openDeleteModal(classId, className) {
        deleteClassId = classId;
        document.getElementById('deleteClassName').textContent = className;
        deleteClassModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        deleteClassModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        deleteClassId = null;
    }

    async function confirmDelete() {
        if (!deleteClassId) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        setButtonLoading(confirmBtn, true, 'Delete Class');

        try {
            const response = await fetch(`/api/classes/${deleteClassId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                closeDeleteModal();
                loadStats(); // Refresh stats
                loadClasses(); // Refresh table
                // Show success message
                showNotification('Class deleted successfully', 'success');
            } else {
                const errorData = await response.json();
                alert('Error: ' + (errorData.error || 'Failed to delete class'));
            }
        } catch (error) {
            console.error('Error deleting class:', error);
            alert('Error: Failed to delete class');
        } finally {
            setButtonLoading(confirmBtn, false, 'Delete Class');
        }
    }

    // Edit form submission
    editClassForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, 'Update Class');

        const formData = new FormData(editClassForm);
        const data = {
            name: formData.get('editClassName'),
            code: formData.get('editClassCode'),
            teacher_id: formData.get('editClassTeacher') || null
        };

        try {
            const classId = document.getElementById('editClassId').value;
            const response = await fetch(`/api/classes/${classId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeEditModal();
                loadStats(); // Refresh stats
                loadClasses(); // Refresh table
                showNotification('Class updated successfully', 'success');
            } else {
                const errorData = await response.json();
                alert('Error: ' + (errorData.error || 'Failed to update class'));
            }
        } catch (error) {
            console.error('Error updating class:', error);
            alert('Error: Failed to update class');
        } finally {
            setButtonLoading(submitBtn, false, 'Update Class');
        }
    });

    // Update form submission to refresh data instead of reloading page
    addClassForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, 'Create Class');

        const formData = new FormData(addClassForm);
        const data = {
            name: formData.get('className'),
            code: formData.get('classCode'),
            teacher_id: formData.get('classTeacher') || null
        };

        try {
            const response = await fetch('/api/classes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal();
                loadStats(); // Refresh stats
                loadClasses(); // Refresh table
                showNotification('Class created successfully', 'success');
            } else {
                const errorData = await response.json();
                alert('Error: ' + (errorData.error || 'Failed to create class'));
            }
        } catch (error) {
            console.error('Error creating class:', error);
            alert('Error: Failed to create class');
        } finally {
            setButtonLoading(submitBtn, false, 'Create Class');
        }
    });

    // Simple notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Utility function for button loading state
    function setButtonLoading(button, loading, originalText) {
        if (loading) {
            button.disabled = true;
            button.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing...
            `;
        } else {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }
</script>