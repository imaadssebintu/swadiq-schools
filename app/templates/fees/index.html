<div class="px-4 py-4 lg:px-6 lg:py-5 space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div class="flex flex-col gap-1">
            <h1 class="text-xl font-black text-slate-900 tracking-tight uppercase">Fees Management</h1>
            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Track and manage student fees</p>
        </div>
        <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <a href="/fees/active"
                class="bg-emerald-50 text-emerald-600 px-3 py-2 sm:px-4 sm:py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-emerald-100 transition-colors shadow-sm flex items-center gap-2 border border-emerald-100">
                <i class="fas fa-check-circle"></i>
                <span class="hidden sm:inline">Active Fees</span>
            </a>
            <a href="/fee-types"
                class="bg-slate-100 text-slate-600 px-3 py-2 sm:px-4 sm:py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-200 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-tags"></i>
                <span class="hidden sm:inline">Fee Types</span>
            </a>
            <button id="addFeeBtn"
                class="bg-indigo-600 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span class="hidden sm:inline">Add Fee</span>
            </button>
            <button id="applyFeesBtn"
                class="bg-slate-900 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-layer-group"></i>
                <span class="hidden sm:inline">Apply Fees</span>
            </button>
        </div>
    </div>


    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Payable -->
        <div
            class="bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-2xl p-4 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/2 -translate-y-1/2 group-hover:scale-110 transition-transform">
                <i class="fas fa-coins text-8xl text-white"></i>
            </div>
            <p class="text-[10px] font-black text-indigo-200 uppercase tracking-widest relative z-10">Total Payable</p>
            <h3 id="totalAmount" class="text-2xl font-black text-white mt-1 relative z-10 tracking-tight">
                <div class="h-8 w-24 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Total Paid -->
        <div
            class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/2 -translate-y-1/2 group-hover:scale-110 transition-transform">
                <i class="fas fa-check-circle text-8xl text-white"></i>
            </div>
            <p class="text-[10px] font-black text-emerald-100 uppercase tracking-widest relative z-10">Total Paid</p>
            <h3 id="totalPaid" class="text-2xl font-black text-white mt-1 relative z-10 tracking-tight">
                <div class="h-8 w-24 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Total Balance -->
        <div
            class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-2xl p-4 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/2 -translate-y-1/2 group-hover:scale-110 transition-transform">
                <i class="fas fa-exclamation-circle text-8xl text-white"></i>
            </div>
            <p class="text-[10px] font-black text-rose-100 uppercase tracking-widest relative z-10">Total Balance</p>
            <h3 id="totalBalance" class="text-2xl font-black text-white mt-1 relative z-10 tracking-tight">
                <div class="h-8 w-24 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Students with Fees -->
        <div
            class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-4 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/2 -translate-y-1/2 group-hover:scale-110 transition-transform">
                <i class="fas fa-users text-8xl text-white"></i>
            </div>
            <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest relative z-10">Active Students</p>
            <h3 id="studentsWithFees" class="text-2xl font-black text-white mt-1 relative z-10 tracking-tight">
                <div class="h-8 w-12 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>
    </div>

    <!-- Layout Grid -->
    <div class="flex flex-col gap-6">
        <!-- Main Content (Table) -->
        <div class="space-y-4 order-2">
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100">
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                    Student</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                    Type</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right whitespace-nowrap">
                                    Financials</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center whitespace-nowrap">
                                    Status</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right whitespace-nowrap">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feesTableBody">
                            <!-- Initial Skeleton -->
                            <tr class="skeleton-row animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="h-8 w-8 bg-slate-100 rounded-lg inline-block align-middle mr-3"></div>
                                    <div class="h-3 w-24 bg-slate-100 rounded inline-block align-middle"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-12 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex flex-col items-end gap-1">
                                        <div class="h-3 w-16 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-12 bg-slate-100 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4 text-center">
                                    <div class="h-5 w-16 bg-slate-100 rounded-full mx-auto"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="h-6 w-6 bg-slate-100 rounded ml-auto"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar (Filters) -->
        <div class="space-y-6 order-1">
            <!-- Filter Widget -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 lg:p-5 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-[11px] font-black text-slate-800 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-filter text-slate-400"></i>
                        Display Options
                    </h3>
                    <button id="clearFilters"
                        class="text-[9px] font-bold text-indigo-600 hover:text-indigo-800 uppercase tracking-wide">
                        Reset
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Search
                            Student</label>
                        <div class="relative">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <input type="text" id="studentFilter" oninput="applyFilters()" placeholder="Name or Code..."
                                class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 pl-9 pr-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 placeholder:text-slate-300">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Academic
                            Year</label>
                        <select id="yearFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Years</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Term</label>
                        <select id="termFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Terms</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Status</label>
                        <select id="statusFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Statuses</option>
                            <option value="paid">Fully Paid</option>
                            <option value="unpaid">Unpaid/Partial</option>
                        </select>
                    </div>
                </div>

                <!-- Add Fee Modal -->
                <div id="addFeeModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('addFeeModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Add New Fee</h3>
                            <button onclick="closeModal('addFeeModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="addFeeForm" class="p-6 space-y-4">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Student</label>
                                <select id="studentSelect" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                    <option value="">Select a student</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Title</label>
                                <input type="text" id="feeTitle" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="feeAmount" required step="0.01" min="0"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="feeDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="saveFeeBtn"
                                    class="w-full bg-indigo-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                    <span>Save Fee</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Fee Modal -->
                <div id="editFeeModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('editFeeModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Edit Fee</h3>
                            <button onclick="closeModal('editFeeModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="editFeeForm" class="p-6 space-y-4">
                            <input type="hidden" id="editFeeId">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Title</label>
                                <input type="text" id="editFeeTitle" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="editFeeAmount" required step="0.01" min="0"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="editFeeDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="updateFeeBtn"
                                    class="w-full bg-indigo-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                    <span>Update Fee</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Record Payment Modal -->
                <div id="paymentModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('paymentModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Record Payment</h3>
                            <button onclick="closeModal('paymentModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="paymentForm" class="p-6 space-y-4">
                            <input type="hidden" id="paymentFeeId">

                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount to
                                    Pay</label>
                                <div class="relative">
                                    <span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">UGX</span>
                                    <input type="number" id="paymentAmount" required step="0.01" min="0" placeholder="0"
                                        class="w-full text-xs font-semibold pl-10 pr-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Payment
                                        Method</label>
                                    <select id="paymentMethod" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Mobile Money">Mobile Money</option>
                                        <option value="Cheque">Cheque</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Ref /
                                        TxID</label>
                                    <input type="text" id="paymentTxId" placeholder="Optional"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                </div>
                            </div>

                            <div class="pt-2">
                                <button type="submit" id="submitPaymentBtn"
                                    class="w-full bg-emerald-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                                    <span>Confirm Payment</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Apply Fees Modal -->
                <div id="applyFeesModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('applyFeesModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Apply Bulk Fees</h3>
                            <button onclick="closeModal('applyFeesModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="applyFeesForm" class="p-6 space-y-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Fee
                                    Type</label>
                                <select id="applyFeeTypeId" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                    <option value="">Select Fee Type</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Academic
                                        Year</label>
                                    <select id="applyYearId" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Term</label>
                                    <select id="applyTermId" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                        <option value="">Select Term</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="applyAmount" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="applyDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                </div>
                            </div>

                            <div class="pt-2">
                                <button type="submit" id="submitApplyFeesBtn"
                                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                                    <span>Apply to All Students</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <script>
                    // Global variables
                    let currentFilters = {
                        status: '',
                        student: '',
                        academic_year_id: '',
                        term_id: ''
                    };

                    // Pagination state
                    let currentPage = 1;
                    let hasMore = true;
                    let isLoadingFees = false;
                    const limit = 10;
                    let sentinelObserver = null;

                    // Helper: Animation Control
                    function animateModal(id, show) {
                        const modal = document.getElementById(id);
                        if (!modal) return;
                        if (show) {
                            modal.classList.remove('hidden');
                            void modal.offsetWidth; // Force reflow
                            modal.classList.remove('opacity-0', 'pointer-events-none');
                            modal.querySelector('div').classList.remove('scale-95');
                            document.body.style.overflow = 'hidden';
                        } else {
                            modal.classList.add('opacity-0', 'pointer-events-none');
                            modal.querySelector('div').classList.add('scale-95');
                            setTimeout(() => {
                                modal.classList.add('hidden');
                                document.body.style.overflow = 'auto';
                            }, 300);
                        }
                    }

                    function closeModal(id) {
                        animateModal(id, false);
                        const form = document.querySelector(`#${id} form`);
                        if (form) form.reset();
                    }

                    // Initialize the page
                    document.addEventListener('DOMContentLoaded', function () {
                        loadAcademicYears();
                        loadTerms();
                        loadFeeTypes();
                        loadFeeStats();
                        loadFees();
                        loadStudents();

                        // Event listeners
                        document.getElementById('clearFilters').addEventListener('click', clearFilters);
                        setupSentinelObserver();

                        document.getElementById('saveFeeBtn').addEventListener('click', (e) => {
                            // Form submission handled by 'submit' event on form, but keeping button listener mostly for semantics if needed
                        });
                        document.getElementById('addFeeForm').addEventListener('submit', saveFee);
                        document.getElementById('editFeeForm').addEventListener('submit', updateFee);
                        document.getElementById('paymentForm').addEventListener('submit', submitPayment);
                        document.getElementById('applyFeesForm').addEventListener('submit', submitApplyFees);

                        // Auto-fill amount when Fee Type changes
                        document.getElementById('applyFeeTypeId').addEventListener('change', function () {
                            const selectedOption = this.options[this.selectedIndex];
                            const amount = selectedOption.getAttribute('data-amount');
                            if (amount) {
                                document.getElementById('applyAmount').value = amount;
                            }
                        });

                        document.getElementById('addFeeBtn').addEventListener('click', () => animateModal('addFeeModal', true));
                        document.getElementById('applyFeesBtn').addEventListener('click', () => animateModal('applyFeesModal', true));
                    });

                    // Handle Escape key to close modals
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape') {
                            ['addFeeModal', 'editFeeModal', 'paymentModal', 'applyFeesModal'].forEach(id => {
                                if (!document.getElementById(id).classList.contains('hidden')) {
                                    closeModal(id);
                                }
                            });
                        }
                    });

                    // Load fee statistics
                    function loadFeeStats() {
                        fetch('/api/fees/stats')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const stats = data.data;
                                    document.getElementById('totalAmount').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_amount)}`;
                                    document.getElementById('totalPaid').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_paid)}`;
                                    document.getElementById('totalBalance').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_balance)}`;
                                    document.getElementById('studentsWithFees').textContent = stats.students_with_fees;
                                }
                            })
                            .catch(error => console.error('Error loading fee stats:', error));
                    }

                    function getSkeletonRows(count = 5) {
                        let html = '';
                        for (let i = 0; i < count; i++) {
                            html += `
                        <tr class="skeleton-row animate-pulse border-b border-slate-50 last:border-0">
                            <td class="px-5 py-4"><div class="h-8 w-8 bg-slate-100 rounded-lg inline-block align-middle mr-3"></div><div class="h-3 w-24 bg-slate-100 rounded inline-block align-middle"></div></td>
                            <td class="px-5 py-4"><div class="h-3 w-12 bg-slate-100 rounded"></div></td>
                            <td class="px-5 py-4 text-right"><div class="flex flex-col items-end gap-1"><div class="h-3 w-16 bg-slate-100 rounded"></div><div class="h-2 w-12 bg-slate-100 rounded"></div></div></td>
                            <td class="px-5 py-4 text-center"><div class="h-5 w-16 bg-slate-100 rounded-full mx-auto"></div></td>
                            <td class="px-5 py-4 text-right"><div class="h-6 w-6 bg-slate-100 rounded ml-auto"></div></td>
                        </tr>
                    `;
                        }
                        return html;
                    }
                    // Load fees
                    function loadFees(isAppend = false) {
                        if (isLoadingFees && isAppend) return;

                        if (!isAppend) {
                            currentPage = 1;
                            hasMore = true;
                            isLoadingFees = false;
                        }

                        if (!hasMore && isAppend) return;
                        isLoadingFees = true;

                        let url = `/api/fees?limit=${limit}&page=${currentPage}`;
                        const params = new URLSearchParams();

                        if (currentFilters.status) params.append('status', currentFilters.status);
                        if (currentFilters.student) params.append('student', currentFilters.student);
                        if (currentFilters.academic_year_id) params.append('academic_year_id', currentFilters.academic_year_id);
                        if (currentFilters.term_id) params.append('term_id', currentFilters.term_id);

                        const queryString = params.toString();
                        if (queryString) {
                            url += '&' + queryString;
                        }

                        const tableBody = document.getElementById('feesTableBody');
                        if (!isAppend) {
                            tableBody.innerHTML = getSkeletonRows(6);
                        } else {
                            // For appending, we don't strictly need a skeleton since proper infinite scroll hides it, but useful for slow connections
                            // Skipping for visual cleanliness unless desired
                        }

                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                isLoadingFees = false;

                                // Clear skeleton rows
                                const skeletons = tableBody.querySelectorAll('.skeleton-row');
                                skeletons.forEach(s => s.remove());

                                if (data.success && data.data && data.data.length > 0) {
                                    if (isAppend) {
                                        appendFeesToTable(data.data);
                                    } else {
                                        renderFeesTable(data.data);
                                    }
                                    if (data.data.length < limit) {
                                        hasMore = false;
                                    } else {
                                        currentPage++;
                                    }
                                } else {
                                    if (!isAppend) {
                                        showEmptyState();
                                    }
                                    hasMore = false;
                                }
                            })
                            .catch(error => {
                                isLoadingFees = false;
                                console.error('Error loading fees:', error);
                                if (!isAppend) {
                                    tableBody.innerHTML = `<tr><td colspan="6" class="px-5 py-12 text-center text-[10px] font-bold text-rose-400 uppercase tracking-widest">Error loading data</td></tr>`;
                                }
                            });
                    }

                    function setupSentinelObserver() {
                        const tableBody = document.getElementById('feesTableBody');
                        const sentinelRow = document.createElement('tr');
                        sentinelRow.id = 'loadMoreSentinel';
                        sentinelRow.innerHTML = `<td colspan="6" style="height: 1px; padding: 0; border: none;"></td>`;
                        tableBody.parentNode.appendChild(sentinelRow);

                        sentinelObserver = new IntersectionObserver((entries) => {
                            if (entries[0].isIntersecting && !isLoadingFees && hasMore) {
                                console.log('Sentinel visible, loading more fees...');
                                loadFees(true);
                            }
                        }, {
                            rootMargin: '200px',
                            threshold: 0.1
                        });

                        sentinelObserver.observe(sentinelRow);
                    }

                    function renderFeesTable(fees) {
                        const tbody = document.getElementById('feesTableBody');
                        tbody.innerHTML = '';
                        appendFeesToTable(fees);
                    }

                    function showEmptyState() {
                        const tbody = document.getElementById('feesTableBody');
                        tbody.innerHTML = `<tr><td colspan="6" class="px-5 py-12 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">No fees found</td></tr>`;
                    }

                    function appendFeesToTable(fees) {
                        const tbody = document.getElementById('feesTableBody');
                        fees.forEach(fee => {
                            const row = createFeeRow(fee);
                            tbody.appendChild(row);
                        });
                    }

                    function createFeeRow(fee) {
                        const balance = parseFloat(fee.balance || 0);
                        const amount = parseFloat(fee.amount);
                        const isFullyPaid = fee.paid || balance === 0;

                        // Status Badge Logic
                        let statusBadge = '';
                        if (isFullyPaid) {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-emerald-500 mr-1.5"></span>Paid</span>`;
                        } else if (balance < amount) {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-amber-50 text-amber-700 border border-amber-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-amber-500 mr-1.5"></span>Partial</span>`;
                        } else {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-rose-50 text-rose-700 border border-rose-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-rose-500 mr-1.5"></span>Unpaid</span>`;
                        }

                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors group';
                        tr.innerHTML = `
                        <td class="px-5 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 font-bold text-xs uppercase shadow-sm">
                                    ${fee.student_name ? fee.student_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?'}
                                </div>
                                <div>
                                    <a href="/students/${fee.student_id}" class="text-[11px] font-black text-slate-800 uppercase tracking-wide group-hover:text-indigo-600 transition-colors whitespace-nowrap block">${fee.student_name || 'N/A'}</a>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${fee.student_code || 'N/A'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-3 whitespace-nowrap">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wide bg-slate-100 px-1.5 py-0.5 rounded">${fee.fee_type_code || 'MISC'}</span>
                        </td>
                        <td class="px-5 py-3 text-right whitespace-nowrap">
                            <div class="flex flex-col items-end gap-0.5">
                                <span class="text-[11px] font-black text-slate-700">UGX ${new Intl.NumberFormat().format(amount)}</span>
                                ${balance > 0 ? `<span class="text-[9px] font-bold text-rose-500 uppercase tracking-wide">Bal: ${new Intl.NumberFormat().format(balance)}</span>` : '<span class="text-[9px] font-bold text-emerald-500 uppercase tracking-wide">Settled</span>'}
                            </div>
                        </td>
                        <td class="px-5 py-3 text-center">
                            ${statusBadge}
                        </td>
                        <td class="px-5 py-3 text-right">
                             <div class="flex items-center justify-end gap-2">
                                <button onclick="openPaymentModal('${fee.id}', '${fee.student_id}', '${fee.student_name}', '${fee.title}', ${balance})" 
                                    class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center hover:bg-emerald-100 transition-colors border border-emerald-100" title="Record Payment">
                                    <i class="fas fa-hand-holding-dollar text-[10px]"></i>
                                </button>
                                <button onclick="openEditFeeModal('${fee.id}', '${fee.title}', ${fee.amount}, '${fee.due_date}')" 
                                    class="w-6 h-6 rounded-lg bg-slate-50 text-slate-500 flex items-center justify-center hover:bg-slate-100 transition-colors border border-slate-100" title="Edit">
                                    <i class="fas fa-pen text-[10px]"></i>
                                </button>
                                <button onclick="deleteFee('${fee.id}')" 
                                    class="w-6 h-6 rounded-lg bg-rose-50 text-rose-600 flex items-center justify-center hover:bg-rose-100 transition-colors border border-rose-100" title="Delete">
                                    <i class="fas fa-trash-alt text-[10px]"></i>
                                </button>
                            </div>
                        </td>
                    `;
                        return tr;
                    }

                    function applyFilters() {
                        currentFilters.status = document.getElementById('statusFilter').value;
                        currentFilters.student = document.getElementById('studentFilter').value;
                        currentFilters.academic_year_id = document.getElementById('yearFilter').value;
                        currentFilters.term_id = document.getElementById('termFilter').value;
                        loadFees();
                    }

                    function clearFilters() {
                        document.getElementById('statusFilter').value = '';
                        document.getElementById('studentFilter').value = '';
                        document.getElementById('yearFilter').value = '';
                        document.getElementById('termFilter').value = '';
                        applyFilters();
                    }

                    // --- Loading Selects ---

                    function loadAcademicYears() {
                        fetch('/api/settings/academic-years')
                            .then(res => res.json())
                            .then(data => {
                                const yearSelect = document.getElementById('yearFilter');
                                const applyYearSelect = document.getElementById('applyYearId');

                                data.forEach(year => {
                                    // Filter select
                                    const option = document.createElement('option');
                                    option.value = year.id;
                                    option.textContent = year.name;
                                    yearSelect.appendChild(option);

                                    // Apply select
                                    const applyOption = option.cloneNode(true);
                                    applyYearSelect.appendChild(applyOption);
                                });
                            })
                            .catch(console.error);
                    }

                    function loadTerms() {
                        fetch('/api/settings/terms')
                            .then(res => res.json())
                            .then(data => {
                                const termSelect = document.getElementById('termFilter');
                                const applyTermSelect = document.getElementById('applyTermId');

                                data.forEach(term => {
                                    // Filter select
                                    const option = document.createElement('option');
                                    option.value = term.id;
                                    option.textContent = term.name;
                                    termSelect.appendChild(option);

                                    // Apply select
                                    const applyOption = option.cloneNode(true);
                                    applyTermSelect.appendChild(applyOption);
                                });
                            })
                            .catch(console.error);
                    }

                    function loadFeeTypes() {
                        fetch('/api/fee-types')
                            .then(res => res.json())
                            .then(data => {
                                const select = document.getElementById('applyFeeTypeId');
                                if (data.data) {
                                    data.data.forEach(type => {
                                        const option = document.createElement('option');
                                        option.value = type.id;
                                        option.textContent = `${type.name} (${type.code})`;
                                        option.setAttribute('data-amount', type.default_amount);
                                        select.appendChild(option);
                                    });
                                }
                            })
                            .catch(console.error);
                    }

                    function loadStudents() {
                        // Optimizing: Using an endpoint that returns compact student list if available, or relying on search input.
                        // For the dropdown in Add Fee, we fetch students.
                        fetch('/api/students')
                            .then(res => res.json())
                            .then(data => {
                                const select = document.getElementById('studentSelect');
                                if (data.data) {
                                    data.data.forEach(student => {
                                        const option = document.createElement('option');
                                        option.value = student.id;
                                        option.textContent = `${student.first_name} ${student.last_name} (${student.code})`;
                                        select.appendChild(option);
                                    });
                                }
                            })
                            .catch(console.error);
                    }

                    // --- Actions ---

                    function openPaymentModal(feeId, studentId, studentName, feeTitle, balance) {
                        document.getElementById('paymentFeeId').value = feeId;
                        document.getElementById('paymentStudentId').value = studentId;
                        document.getElementById('paymentStudentName').textContent = studentName || 'N/A';
                        document.getElementById('paymentFeeTitle').textContent = feeTitle || 'School Fee';
                        document.getElementById('paymentCurrentBalance').textContent = `UGX ${new Intl.NumberFormat().format(balance)} `;
                        document.getElementById('paymentAmount').value = balance > 0 ? balance : '';
                        animateModal('paymentModal', true);
                    }

                    function openEditFeeModal(id, title, amount, dueDate) {
                        document.getElementById('editFeeId').value = id;
                        document.getElementById('editFeeTitle').value = title;
                        document.getElementById('editFeeAmount').value = amount;
                        document.getElementById('editFeeDueDate').value = dueDate ? dueDate.substring(0, 10) : '';
                        animateModal('editFeeModal', true);
                    }

                    async function submitPayment(e) {
                        e.preventDefault();
                        const btn = document.getElementById('submitPaymentBtn');
                        const originalText = btn.innerHTML;
                        const feeId = document.getElementById('paymentFeeId').value;
                        const amount = parseFloat(document.getElementById('paymentAmount').value);
                        const method = document.getElementById('paymentMethod').value;
                        const txId = document.getElementById('paymentTxId').value;

                        if (!amount || amount <= 0) return alert('Please enter a valid amount');

                        try {
                            btn.innerHTML = '<span>Processing...</span>';
                            btn.disabled = true;

                            const res = await fetch(`/ api / fees / ${feeId}/pay`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ amount: amount, method: method, transaction_id: txId })
                            });

                            const data = await res.json();
                            if (res.ok) {
                                closeModal('paymentModal');
                                loadFees();
                                loadFeeStats();
                                // success msg could use a toast
                            } else {
                                alert(data.error || 'Failed to record payment');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('An error occurred');
                        } finally {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }

                    async function submitApplyFees(e) {
                        e.preventDefault();
                        const btn = document.getElementById('submitApplyFeesBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            fee_type_id: parseInt(document.getElementById('applyFeeTypeId').value),
                            academic_year_id: parseInt(document.getElementById('applyYearId').value),
                            term_id: parseInt(document.getElementById('applyTermId').value),
                            amount: parseFloat(document.getElementById('applyAmount').value),
                            due_date: document.getElementById('applyDueDate').value,
                        };

                        try {
                            btn.innerHTML = '<span>Applying...</span>';
                            btn.disabled = true;

                            const res = await fetch('/api/fees/apply', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const data = await res.json();

                            if (res.ok) {
                                closeModal('applyFeesModal');
                                loadFees();
                                loadFeeStats();
                                alert(`Successfully applied fees to ${data.applied_count || 'students'}`);
                            } else {
                                alert(data.error || 'Failed to apply fees');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Server error');
                        } finally {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }

                    async function saveFee(e) {
                        e.preventDefault();
                        // Logic for creating single fee
                        const btn = document.getElementById('saveFeeBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            student_id: parseInt(document.getElementById('studentSelect').value),
                            title: document.getElementById('feeTitle').value,
                            amount: parseFloat(document.getElementById('feeAmount').value),
                            due_date: document.getElementById('feeDueDate').value,
                            // Default category for now or random
                            fee_type_id: 1 // Assuming 1 exists or is optional, backend might require it carefully
                        };

                        // Add Fee endpoint check? Existing API says `POST /api/fees`.
                        try {
                            btn.innerHTML = '<span>Saving...</span>';
                            btn.disabled = true;
                            const res = await fetch('/api/fees', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                closeModal('addFeeModal');
                                loadFees();
                                loadFeeStats();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Failed to create fee');
                            }
                        } catch (err) { console.error(err); } finally { btn.innerHTML = originalText; btn.disabled = false; }
                    }

                    async function updateFee(e) {
                        e.preventDefault();
                        const id = document.getElementById('editFeeId').value;
                        const btn = document.getElementById('updateFeeBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            title: document.getElementById('editFeeTitle').value,
                            amount: parseFloat(document.getElementById('editFeeAmount').value),
                            due_date: document.getElementById('editFeeDueDate').value
                        };

                        try {
                            btn.innerHTML = '<span>Updating...</span>';
                            btn.disabled = true;
                            const res = await fetch(`/api/fees/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                closeModal('editFeeModal');
                                loadFees();
                                loadFeeStats();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Update failed');
                            }
                        } catch (err) { console.error(err); } finally { btn.innerHTML = originalText; btn.disabled = false; }
                    }

                    async function deleteFee(id) {
                        if (!confirm('Are you sure you want to delete this fee record?')) return;
                        try {
                            const res = await fetch(`/api/fees/${id}`, { method: 'DELETE' });
                            if (res.ok) {
                                loadFees(); // Reload table
                                loadFeeStats();
                            } else {
                                alert('Failed to delete');
                            }
                        } catch (err) { console.error(err); }
                    }
                </script>