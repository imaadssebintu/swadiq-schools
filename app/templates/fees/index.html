<div class="px-4 py-3 lg:px-6 lg:py-4 space-y-4">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="flex flex-col">
            <h1 class="text-lg font-black text-slate-900 tracking-tight uppercase">Fees Management</h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Track and manage student fees</p>
        </div>
        <div class="flex flex-wrap items-center gap-2 sm:gap-2.5">
            <a href="/fees/active"
                class="bg-emerald-50 text-emerald-600 px-3 py-1.5 sm:px-3 sm:py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-emerald-100 transition-colors shadow-sm flex items-center gap-1.5 border border-emerald-100">
                <i class="fas fa-check-circle text-[10px]"></i>
                <span class="hidden sm:inline">Active Fees</span>
            </a>
            <a href="/fee-types"
                class="bg-slate-100 text-slate-600 px-3 py-1.5 sm:px-3 sm:py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-slate-200 transition-colors shadow-sm flex items-center gap-1.5">
                <i class="fas fa-tags text-[10px]"></i>
                <span class="hidden sm:inline">Fee Types</span>
            </a>
            <button id="addFeeBtn"
                class="bg-indigo-600 text-white px-3 py-1.5 sm:px-3 sm:py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-sm flex items-center gap-1.5">
                <i class="fas fa-plus text-[10px]"></i>
                <span class="hidden sm:inline">Add Fee</span>
            </button>
            <button id="applyFeesBtn"
                class="bg-slate-900 text-white px-3 py-1.5 sm:px-3 sm:py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-1.5">
                <i class="fas fa-layer-group text-[10px]"></i>
                <span class="hidden sm:inline">Apply Fees</span>
            </button>
        </div>
    </div>


    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Total Payable -->
        <div
            class="bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-xl p-3 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4 group-hover:scale-110 transition-transform">
                <i class="fas fa-coins text-4xl text-white"></i>
            </div>
            <p class="text-[9px] font-black text-indigo-200 uppercase tracking-widest relative z-10">Total Payable</p>
            <h3 id="totalAmount" class="text-lg font-black text-white mt-0.5 relative z-10 tracking-tight">
                <div class="h-6 w-20 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Total Paid -->
        <div
            class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-3 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4 group-hover:scale-110 transition-transform">
                <i class="fas fa-check-circle text-4xl text-white"></i>
            </div>
            <p class="text-[9px] font-black text-emerald-100 uppercase tracking-widest relative z-10">Total Paid</p>
            <h3 id="totalPaid" class="text-lg font-black text-white mt-0.5 relative z-10 tracking-tight">
                <div class="h-6 w-20 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Total Balance -->
        <div
            class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl p-3 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4 group-hover:scale-110 transition-transform">
                <i class="fas fa-exclamation-circle text-4xl text-white"></i>
            </div>
            <p class="text-[9px] font-black text-rose-100 uppercase tracking-widest relative z-10">Total Balance</p>
            <h3 id="totalBalance" class="text-lg font-black text-white mt-0.5 relative z-10 tracking-tight">
                <div class="h-6 w-20 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>

        <!-- Students with Fees -->
        <div
            class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-3 shadow-sm relative overflow-hidden group">
            <div
                class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4 group-hover:scale-110 transition-transform">
                <i class="fas fa-users text-4xl text-white"></i>
            </div>
            <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest relative z-10">Active Students</p>
            <h3 id="studentsWithFees" class="text-lg font-black text-white mt-0.5 relative z-10 tracking-tight">
                <div class="h-6 w-10 bg-white/20 rounded animate-pulse"></div>
            </h3>
        </div>
    </div>

    <!-- Layout Grid -->
    <div class="flex flex-col gap-6">
        <!-- Main Content (Table) -->
        <div class="space-y-4 order-2">
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100">
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                    Student</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                    Type</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right whitespace-nowrap">
                                    Financials</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center whitespace-nowrap">
                                    Status</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right whitespace-nowrap">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feesTableBody">
                            <!-- Initial Skeleton -->
                            <tr class="skeleton-row animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="h-8 w-8 bg-slate-100 rounded-lg inline-block align-middle mr-3"></div>
                                    <div class="h-3 w-24 bg-slate-100 rounded inline-block align-middle"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-12 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex flex-col items-end gap-1">
                                        <div class="h-3 w-16 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-12 bg-slate-100 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4 text-center">
                                    <div class="h-5 w-16 bg-slate-100 rounded-full mx-auto"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="h-6 w-6 bg-slate-100 rounded ml-auto"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Scroll Sentinel for Infinite Scroll -->
                <div id="scrollSentinel" class="h-4 w-full opacity-0"></div>
            </div>
        </div>

        <!-- Sidebar (Filters) -->
        <div class="space-y-6 order-1">
            <!-- Filter Widget -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 lg:p-5 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-[11px] font-black text-slate-800 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-filter text-slate-400"></i>
                        Display Options
                    </h3>
                    <button id="clearFilters"
                        class="text-[9px] font-bold text-indigo-600 hover:text-indigo-800 uppercase tracking-wide">
                        Reset
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Search
                            Student</label>
                        <div class="relative">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <input type="text" id="studentFilter" oninput="applyFilters()" placeholder="Name or Code..."
                                class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 pl-9 pr-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 placeholder:text-slate-300">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Academic
                            Year</label>
                        <select id="yearFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Years</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Term</label>
                        <select id="termFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Terms</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Status</label>
                        <select id="statusFilter" onchange="applyFilters()"
                            class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 px-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none text-slate-600">
                            <option value="">All Statuses</option>
                            <option value="paid">Fully Paid</option>
                            <option value="unpaid">Unpaid/Partial</option>
                        </select>
                    </div>
                </div>

                <!-- Add Fee Modal -->
                <div id="addFeeModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('addFeeModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Add New Fee</h3>
                            <button onclick="closeModal('addFeeModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="addFeeForm" class="p-6 space-y-4">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Student</label>
                                <select id="studentSelect" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                    <option value="">Select a student</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Title</label>
                                <input type="text" id="feeTitle" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="feeAmount" required step="0.01" min="0"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="feeDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="saveFeeBtn"
                                    class="w-full bg-indigo-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                    <span>Save Fee</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Fee Modal -->
                <div id="editFeeModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('editFeeModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Edit Fee</h3>
                            <button onclick="closeModal('editFeeModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="editFeeForm" class="p-6 space-y-4">
                            <input type="hidden" id="editFeeId">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Title</label>
                                <input type="text" id="editFeeTitle" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="editFeeAmount" required step="0.01" min="0"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="editFeeDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="updateFeeBtn"
                                    class="w-full bg-indigo-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                    <span>Update Fee</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Record Payment Modal -->
                <div id="paymentModal" style="margin: 0 !important; padding: 0 !important;"
                    class="fixed top-0 left-0 right-0 bottom-0 w-full h-full bg-black/40 backdrop-blur-sm z-[9999] hidden flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('paymentModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Record Payment</h3>
                            <button onclick="closeModal('paymentModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="paymentForm" class="p-6 space-y-4">
                            <input type="hidden" id="paymentStudentId">

                            <!-- Student Info Display -->
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                                <div class="flex items-center justify-between">
                                    <span
                                        class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Student</span>
                                    <span id="paymentStudentName" class="text-xs font-bold text-slate-700"></span>
                                </div>
                            </div>

                            <!-- All Fees List -->
                            <div id="allFeesList" class="space-y-2 max-h-48 overflow-y-auto"></div>

                            <!-- Fee Selection -->
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Select Fee
                                    to Pay</label>
                                <select id="selectedFeeDropdown" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                    <option value="">Choose a fee...</option>
                                </select>
                            </div>

                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount to
                                    Pay</label>
                                <div class="relative">
                                    <span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">UGX</span>
                                    <input type="number" id="paymentAmount" required step="0.01" min="0" placeholder="0"
                                        class="w-full text-xs font-semibold pl-10 pr-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Payment
                                        Method</label>
                                    <select id="paymentMethod" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Mobile Money">Mobile Money</option>
                                        <option value="Cheque">Cheque</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Ref /
                                        TxID</label>
                                    <input type="text" id="paymentTxId" placeholder="Optional"
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500">
                                </div>
                            </div>

                            <div class="pt-2">
                                <button type="submit" id="submitPaymentBtn"
                                    class="w-full bg-emerald-600 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                                    <span>Confirm Payment</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Apply Fees Modal -->
                <div id="applyFeesModal"
                    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
                    onclick="if(event.target === this) closeModal('applyFeesModal')">
                    <div
                        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Apply Bulk Fees</h3>
                            <button onclick="closeModal('applyFeesModal')"
                                class="text-slate-400 hover:text-slate-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="applyFeesForm" class="p-6 space-y-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Fee
                                    Type</label>
                                <select id="applyFeeTypeId" required
                                    class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                    <option value="">Select Fee Type</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Academic
                                        Year</label>
                                    <select id="applyYearId" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Term</label>
                                    <select id="applyTermId" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                        <option value="">Select Term</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Amount</label>
                                    <input type="number" id="applyAmount" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Due
                                        Date</label>
                                    <input type="date" id="applyDueDate" required
                                        class="w-full text-xs font-semibold px-3 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                                </div>
                            </div>

                            <div class="pt-2">
                                <button type="submit" id="submitApplyFeesBtn"
                                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                                    <span>Apply to All Students</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <script>
                    // Global variables
                    let currentFilters = {
                        status: '',
                        student: '',
                        academic_year_id: '',
                        term_id: ''
                    };

                    // Pagination state
                    let currentPage = 1;
                    let hasMore = true;
                    let isLoadingFees = false;
                    const limit = 10;
                    let sentinelObserver = null;

                    // Helper: Animation Control
                    function animateModal(id, show) {
                        const modal = document.getElementById(id);
                        if (!modal) return;
                        if (show) {
                            modal.classList.remove('hidden');
                            void modal.offsetWidth; // Force reflow
                            modal.classList.remove('opacity-0', 'pointer-events-none');
                            modal.querySelector('div').classList.remove('scale-95');
                            document.body.style.overflow = 'hidden';
                        } else {
                            modal.classList.add('opacity-0', 'pointer-events-none');
                            modal.querySelector('div').classList.add('scale-95');
                            setTimeout(() => {
                                modal.classList.add('hidden');
                                document.body.style.overflow = 'auto';
                            }, 300);
                        }
                    }

                    function closeModal(id) {
                        animateModal(id, false);
                        const form = document.querySelector(`#${id} form`);
                        if (form) form.reset();
                    }

                    // Initialize the page
                    document.addEventListener('DOMContentLoaded', function () {
                        loadAcademicYears();
                        loadTerms();
                        loadFeeTypes();
                        loadFeeStats();
                        loadFees();
                        loadStudents();

                        // Event listeners
                        document.getElementById('clearFilters').addEventListener('click', clearFilters);
                        setupSentinelObserver();

                        document.getElementById('saveFeeBtn').addEventListener('click', (e) => {
                            // Form submission handled by 'submit' event on form, but keeping button listener mostly for semantics if needed
                        });
                        document.getElementById('addFeeForm').addEventListener('submit', saveFee);
                        document.getElementById('editFeeForm').addEventListener('submit', updateFee);
                        document.getElementById('paymentForm').addEventListener('submit', submitPayment);
                        document.getElementById('applyFeesForm').addEventListener('submit', submitApplyFees);

                        // Auto-fill amount when Fee Type changes
                        document.getElementById('applyFeeTypeId').addEventListener('change', function () {
                            const selectedOption = this.options[this.selectedIndex];
                            const amount = selectedOption.getAttribute('data-amount');
                            if (amount) {
                                document.getElementById('applyAmount').value = amount;
                            }
                        });

                        document.getElementById('addFeeBtn').addEventListener('click', () => animateModal('addFeeModal', true));
                        document.getElementById('applyFeesBtn').addEventListener('click', () => animateModal('applyFeesModal', true));
                    });

                    // Handle Escape key to close modals
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape') {
                            ['addFeeModal', 'editFeeModal', 'paymentModal', 'applyFeesModal'].forEach(id => {
                                if (!document.getElementById(id).classList.contains('hidden')) {
                                    closeModal(id);
                                }
                            });
                        }
                    });

                    // Load fee statistics
                    function loadFeeStats() {
                        fetch('/api/fees/stats')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const stats = data.data;
                                    document.getElementById('totalAmount').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_amount)}`;
                                    document.getElementById('totalPaid').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_paid)}`;
                                    document.getElementById('totalBalance').textContent = `UGX ${new Intl.NumberFormat().format(stats.total_balance)}`;
                                    document.getElementById('studentsWithFees').textContent = stats.students_with_fees;
                                }
                            })
                            .catch(error => console.error('Error loading fee stats:', error));
                    }

                    function getSkeletonRows(count = 5) {
                        let html = '';
                        for (let i = 0; i < count; i++) {
                            html += `
                        <tr class="skeleton-row animate-pulse border-b border-slate-50 last:border-0">
                            <td class="px-5 py-4"><div class="h-8 w-8 bg-slate-100 rounded-lg inline-block align-middle mr-3"></div><div class="h-3 w-24 bg-slate-100 rounded inline-block align-middle"></div></td>
                            <td class="px-5 py-4"><div class="h-3 w-12 bg-slate-100 rounded"></div></td>
                            <td class="px-5 py-4 text-right"><div class="flex flex-col items-end gap-1"><div class="h-3 w-16 bg-slate-100 rounded"></div><div class="h-2 w-12 bg-slate-100 rounded"></div></div></td>
                            <td class="px-5 py-4 text-center"><div class="h-5 w-16 bg-slate-100 rounded-full mx-auto"></div></td>
                            <td class="px-5 py-4 text-right"><div class="h-6 w-6 bg-slate-100 rounded ml-auto"></div></td>
                        </tr>
                    `;
                        }
                        return html;
                    }

                    function getModalSkeletons(count = 3) {
                        let html = '';
                        for (let i = 0; i < count; i++) {
                            html += `
                        <div class="flex items-center justify-between p-2 bg-white border border-slate-50 rounded-lg animate-pulse">
                            <div class="flex-1 space-y-2">
                                <div class="h-2 w-20 bg-slate-100 rounded"></div>
                                <div class="h-1.5 w-12 bg-slate-100 rounded"></div>
                            </div>
                            <div class="text-right space-y-2">
                                <div class="h-2 w-16 bg-slate-100 rounded ml-auto"></div>
                                <div class="h-1.5 w-10 bg-slate-100 rounded ml-auto"></div>
                            </div>
                        </div>
                    `;
                        }
                        return html;
                    }
                    // Load fees using grouped API
                    async function loadFees() {
                        if (isLoadingFees || !hasMore) return;

                        try {
                            isLoadingFees = true;
                            const params = new URLSearchParams();
                            if (currentFilters.status) params.append('status', currentFilters.status);
                            if (currentFilters.student) params.append('student', currentFilters.student);
                            if (currentFilters.academic_year_id) params.append('academic_year_id', currentFilters.academic_year_id);
                            if (currentFilters.term_id) params.append('term_id', currentFilters.term_id);

                            params.append('page', currentPage);
                            params.append('limit', limit);

                            const tableBody = document.getElementById('feesTableBody');

                            // Show skeletons
                            if (currentPage === 1) {
                                tableBody.innerHTML = getSkeletonRows(6);
                            } else {
                                // Append skeletons for subsequent pages
                                tableBody.insertAdjacentHTML('beforeend', getSkeletonRows(3));
                            }

                            const response = await fetch('/api/fees/grouped-by-student?' + params.toString());
                            const data = await response.json();

                            // Remove skeletons after fetch
                            const skeletons = tableBody.querySelectorAll('.skeleton-row');
                            skeletons.forEach(s => s.remove());

                            if (data.success) {
                                if (currentPage === 1) {
                                    tableBody.innerHTML = '';
                                }

                                if (data.data.length > 0) {
                                    renderFeesTable(data.data);

                                    // If we got fewer items than the limit, there's no more data
                                    if (data.data.length < limit) {
                                        hasMore = false;
                                    } else {
                                        currentPage++;
                                    }
                                } else {
                                    hasMore = false;
                                    if (currentPage === 1) {
                                        showEmptyState();
                                    }
                                }
                            } else {
                                if (currentPage === 1) showEmptyState();
                            }
                        } catch (error) {
                            console.error('Error loading fees:', error);
                            // Cleanup skeletons on error
                            const tableBody = document.getElementById('feesTableBody');
                            const skeletons = tableBody.querySelectorAll('.skeleton-row');
                            skeletons.forEach(s => s.remove());
                            if (currentPage === 1) showEmptyState();
                        } finally {
                            isLoadingFees = false;
                        }
                    }

                    function renderFeesTable(studentGroups) {
                        const tbody = document.getElementById('feesTableBody');

                        studentGroups.forEach(studentGroup => {
                            const row = createStudentFeeRow(studentGroup);
                            tbody.appendChild(row);
                        });
                    }

                    function setupSentinelObserver() {
                        const sentinel = document.getElementById('scrollSentinel');
                        if (!sentinel) return;

                        if (sentinelObserver) {
                            sentinelObserver.disconnect();
                        }

                        sentinelObserver = new IntersectionObserver((entries) => {
                            if (entries[0].isIntersecting && !isLoadingFees && hasMore) {
                                loadFees();
                            }
                        }, {
                            rootMargin: '100px'
                        });

                        sentinelObserver.observe(sentinel);
                    }

                    async function refreshStudentRow(studentId) {
                        try {
                            const response = await fetch(`/api/fees/grouped-by-student?student_id=${studentId}&limit=1`);
                            const data = await response.json();

                            if (data.success && data.data.length > 0) {
                                const newRow = createStudentFeeRow(data.data[0]);
                                const oldRow = document.getElementById(`student-row-${studentId}`);
                                if (oldRow) {
                                    oldRow.replaceWith(newRow);
                                    // Highlight the updated row
                                    newRow.classList.add('bg-indigo-50/50');
                                    setTimeout(() => newRow.classList.remove('bg-indigo-50/50'), 2000);
                                }
                            }
                        } catch (error) {
                            console.error('Error refreshing student row:', error);
                        }
                    }

                    function showEmptyState() {
                        const tbody = document.getElementById('feesTableBody');
                        tbody.innerHTML = `<tr><td colspan="5" class="px-5 py-12 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">No fees found</td></tr>`;
                    }

                    function appendFeesToTable(fees) {
                        renderFeesTable(fees);
                    }

                    function createStudentFeeRow(studentGroup) {
                        // Calculate totals
                        let totalAmount = 0;
                        let totalBalance = 0;
                        studentGroup.fees.forEach(fee => {
                            totalAmount += parseFloat(fee.amount || 0);
                            totalBalance += parseFloat(fee.balance || 0);
                        });

                        const isFullyPaid = totalBalance === 0;
                        const isPartiallyPaid = totalBalance > 0 && totalBalance < totalAmount;

                        // Status Badge Logic
                        let statusBadge = '';
                        if (isFullyPaid) {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-emerald-500 mr-1.5"></span>Paid</span>`;
                        } else if (isPartiallyPaid) {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-amber-50 text-amber-700 border border-amber-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-amber-500 mr-1.5"></span>Partial</span>`;
                        } else {
                            statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold bg-rose-50 text-rose-700 border border-rose-100 uppercase tracking-wider"><span class="w-1 h-1 rounded-full bg-rose-500 mr-1.5"></span>Unpaid</span>`;
                        }

                        // Build fee types HTML
                        let feeTypesHTML = '';
                        studentGroup.fees.forEach(fee => {
                            const balance = parseFloat(fee.balance || 0);
                            const isPaid = balance === 0;
                            const badgeClass = isPaid ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-600 border-slate-200';
                            feeTypesHTML += `<span class="text-[10px] font-bold uppercase tracking-wide ${badgeClass} px-1.5 py-0.5 rounded border">${fee.fee_type_code || 'MISC'}</span>`;
                        });

                        const tr = document.createElement('tr');
                        tr.id = `student-row-${studentGroup.student_id}`;
                        tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors group';
                        tr.innerHTML = `
                        <td class="px-5 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 font-bold text-xs uppercase shadow-sm">
                                    ${studentGroup.student_name ? studentGroup.student_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?'}
                                </div>
                                <div>
                                    <a href="/students/${studentGroup.student_id}" class="text-[11px] font-black text-slate-800 uppercase tracking-wide group-hover:text-indigo-600 transition-colors whitespace-nowrap block">${studentGroup.student_name || 'N/A'}</a>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${studentGroup.student_code || 'N/A'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-3">
                            <div class="flex flex-wrap gap-1.5">
                                ${feeTypesHTML}
                            </div>
                        </td>
                        <td class="px-5 py-3 text-right whitespace-nowrap">
                            <div class="flex flex-col items-end gap-0.5">
                                <span class="text-[11px] font-black text-slate-700">UGX ${new Intl.NumberFormat().format(totalAmount)}</span>
                                ${totalBalance > 0 ? `<span class="text-[9px] font-bold text-rose-500 uppercase tracking-wide">Bal: ${new Intl.NumberFormat().format(totalBalance)}</span>` : '<span class="text-[9px] font-bold text-emerald-500 uppercase tracking-wide">Settled</span>'}
                            </div>
                        </td>
                        <td class="px-5 py-3 text-center">
                            ${statusBadge}
                        </td>
                        <td class="px-5 py-3 text-right">
                             <div class="flex items-center justify-end gap-2">
                                <button onclick="openPaymentModal('${studentGroup.student_id}', '${studentGroup.student_name}')" 
                                    class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center hover:bg-emerald-100 transition-colors border border-emerald-100" title="Record Payment">
                                    <i class="fas fa-hand-holding-dollar text-[10px]"></i>
                                </button>
                            </div>
                        </td>
                    `;
                        return tr;
                    }


                    function applyFilters() {
                        currentFilters.status = document.getElementById('statusFilter').value;
                        currentFilters.student = document.getElementById('studentFilter').value;
                        currentFilters.academic_year_id = document.getElementById('yearFilter').value;
                        currentFilters.term_id = document.getElementById('termFilter').value;

                        // Reset pagination
                        currentPage = 1;
                        hasMore = true;
                        loadFees();
                    }

                    function clearFilters() {
                        document.getElementById('statusFilter').value = '';
                        document.getElementById('studentFilter').value = '';
                        document.getElementById('yearFilter').value = '';
                        document.getElementById('termFilter').value = '';

                        currentFilters = {
                            status: '',
                            student: '',
                            academic_year_id: '',
                            term_id: ''
                        };

                        // Reset pagination
                        currentPage = 1;
                        hasMore = true;
                        loadFees();
                    }

                    // --- Loading Selects ---

                    function loadAcademicYears() {
                        fetch('/api/settings/academic-years')
                            .then(res => res.json())
                            .then(data => {
                                const yearSelect = document.getElementById('yearFilter');
                                const applyYearSelect = document.getElementById('applyYearId');

                                data.forEach(year => {
                                    // Filter select
                                    const option = document.createElement('option');
                                    option.value = year.id;
                                    option.textContent = year.name;
                                    yearSelect.appendChild(option);

                                    // Apply select
                                    const applyOption = option.cloneNode(true);
                                    applyYearSelect.appendChild(applyOption);
                                });
                            })
                            .catch(console.error);
                    }

                    function loadTerms() {
                        fetch('/api/settings/terms')
                            .then(res => res.json())
                            .then(data => {
                                const termSelect = document.getElementById('termFilter');
                                const applyTermSelect = document.getElementById('applyTermId');

                                data.forEach(term => {
                                    // Filter select
                                    const option = document.createElement('option');
                                    option.value = term.id;
                                    option.textContent = term.name;
                                    termSelect.appendChild(option);

                                    // Apply select
                                    const applyOption = option.cloneNode(true);
                                    applyTermSelect.appendChild(applyOption);
                                });
                            })
                            .catch(console.error);
                    }

                    function loadFeeTypes() {
                        fetch('/api/fee-types')
                            .then(res => res.json())
                            .then(data => {
                                const select = document.getElementById('applyFeeTypeId');
                                if (data.data) {
                                    data.data.forEach(type => {
                                        const option = document.createElement('option');
                                        option.value = type.id;
                                        option.textContent = `${type.name} (${type.code})`;
                                        option.setAttribute('data-amount', type.default_amount);
                                        select.appendChild(option);
                                    });
                                }
                            })
                            .catch(console.error);
                    }

                    function loadStudents() {
                        // Optimizing: Using an endpoint that returns compact student list if available, or relying on search input.
                        // For the dropdown in Add Fee, we fetch students.
                        fetch('/api/students')
                            .then(res => res.json())
                            .then(data => {
                                const select = document.getElementById('studentSelect');
                                if (data.data) {
                                    data.data.forEach(student => {
                                        const option = document.createElement('option');
                                        option.value = student.id;
                                        option.textContent = `${student.first_name} ${student.last_name} (${student.code})`;
                                        select.appendChild(option);
                                    });
                                }
                            })
                            .catch(console.error);
                    }

                    // --- Actions ---


                    let currentStudentFees = []; // Store fetched fees

                    async function openPaymentModal(studentId, studentName) {
                        document.getElementById('paymentStudentId').value = studentId;
                        document.getElementById('paymentStudentName').textContent = studentName || 'N/A';

                        // Clear previous data
                        const feesList = document.getElementById('allFeesList');
                        const dropdown = document.getElementById('selectedFeeDropdown');
                        feesList.innerHTML = getModalSkeletons(3);
                        dropdown.innerHTML = '<option value="">Loading fees...</option>';

                        animateModal('paymentModal', true);

                        try {
                            // Fetch all fees for this student (increase limit to get all)
                            const response = await fetch(`/api/fees?student_id=${studentId}&status=unpaid&limit=1000`);
                            const data = await response.json();

                            if (data.success && data.data && data.data.length > 0) {
                                currentStudentFees = data.data;

                                // Populate fees list (read-only display)
                                feesList.innerHTML = '';
                                data.data.forEach(fee => {
                                    const balance = parseFloat(fee.balance || 0);
                                    if (balance <= 0) return; // Only show fees with balance

                                    const statusClass = 'text-rose-600';
                                    const statusText = `Bal: ${new Intl.NumberFormat().format(balance)}`;

                                    const feeCard = document.createElement('div');
                                    feeCard.className = 'flex items-center justify-between p-2 bg-white border border-slate-100 rounded-lg';
                                    feeCard.innerHTML = `
                                        <div class="flex-1">
                                            <div class="text-[10px] font-bold text-slate-700 uppercase">${fee.title}</div>
                                            <div class="text-[9px] text-slate-400 font-medium">${fee.fee_type_code || 'N/A'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[10px] font-black text-slate-700">UGX ${new Intl.NumberFormat().format(fee.amount)}</div>
                                            <div class="text-[9px] font-bold ${statusClass}">${statusText}</div>
                                        </div>
                                    `;
                                    feesList.appendChild(feeCard);
                                });

                                // Populate dropdown for selection
                                dropdown.innerHTML = '<option value="">Choose a fee to pay...</option>';
                                data.data.forEach(fee => {
                                    const balance = parseFloat(fee.balance || 0);
                                    if (balance > 0) { // Only show unpaid/partial fees in dropdown
                                        const option = document.createElement('option');
                                        option.value = fee.id;
                                        option.textContent = `${fee.title} - Bal: UGX ${new Intl.NumberFormat().format(balance)}`;
                                        option.setAttribute('data-balance', balance);
                                        dropdown.appendChild(option);
                                    }
                                });

                                // Check if we actually have any fees with balance after filtering
                                if (dropdown.options.length <= 1) {
                                    feesList.innerHTML = '<div class="text-center text-xs text-slate-400 py-6">No outstanding fees found</div>';
                                    dropdown.innerHTML = '<option value="">No fees available</option>';
                                }
                            } else {
                                feesList.innerHTML = '<div class="text-center text-xs text-slate-400 py-6">No outstanding fees found</div>';
                                dropdown.innerHTML = '<option value="">No fees available</option>';
                            }
                        } catch (error) {
                            console.error('Error loading student fees:', error);
                            feesList.innerHTML = '<div class="text-center text-xs text-rose-400 py-6">Error loading fees</div>';
                            dropdown.innerHTML = '<option value="">Error loading fees</option>';
                        }

                        // Handle dropdown change to auto-fill amount
                        dropdown.onchange = function () {
                            const selectedOption = this.options[this.selectedIndex];
                            const balance = selectedOption ? selectedOption.getAttribute('data-balance') : null;
                            if (balance) {
                                document.getElementById('paymentAmount').value = balance;
                            } else {
                                document.getElementById('paymentAmount').value = '';
                            }
                        };
                    }


                    function openEditFeeModal(id, title, amount, dueDate) {
                        document.getElementById('editFeeId').value = id;
                        document.getElementById('editFeeTitle').value = title;
                        document.getElementById('editFeeAmount').value = amount;
                        document.getElementById('editFeeDueDate').value = dueDate ? dueDate.substring(0, 10) : '';
                        animateModal('editFeeModal', true);
                    }

                    async function submitPayment(e) {
                        e.preventDefault();
                        const btn = document.getElementById('submitPaymentBtn');
                        const originalText = btn.innerHTML;
                        const feeId = document.getElementById('selectedFeeDropdown').value;
                        const studentId = document.getElementById('paymentStudentId').value;
                        const amount = parseFloat(document.getElementById('paymentAmount').value);
                        const method = document.getElementById('paymentMethod').value;
                        const txId = document.getElementById('paymentTxId').value || null;

                        if (!feeId) return alert('Please select a fee to pay');
                        if (!amount || amount <= 0) return alert('Please enter a valid amount');

                        try {
                            btn.innerHTML = '<span>Processing...</span>';
                            btn.disabled = true;

                            // Use the RecordPaymentAPI endpoint with proper structure
                            const payload = {
                                student_id: studentId,
                                total_amount: amount,
                                payment_method: method,
                                transaction_id: txId,
                                fee_allocations: [
                                    {
                                        fee_id: feeId,
                                        amount: amount
                                    }
                                ]
                            };

                            const res = await fetch('/api/fees/record-payment', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            const data = await res.json();
                            if (res.ok) {
                                closeModal('paymentModal');
                                refreshStudentRow(studentId);
                                loadFeeStats();
                                // success msg could use a toast
                            } else {
                                alert(data.error || 'Failed to record payment');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('An error occurred');
                        } finally {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }

                    async function submitApplyFees(e) {
                        e.preventDefault();
                        const btn = document.getElementById('submitApplyFeesBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            fee_type_id: parseInt(document.getElementById('applyFeeTypeId').value),
                            academic_year_id: parseInt(document.getElementById('applyYearId').value),
                            term_id: parseInt(document.getElementById('applyTermId').value),
                            amount: parseFloat(document.getElementById('applyAmount').value),
                            due_date: document.getElementById('applyDueDate').value,
                        };

                        try {
                            btn.innerHTML = '<span>Applying...</span>';
                            btn.disabled = true;

                            const res = await fetch('/api/fees/apply', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const data = await res.json();

                            if (res.ok) {
                                closeModal('applyFeesModal');
                                loadFees();
                                loadFeeStats();
                                alert(`Successfully applied fees to ${data.applied_count || 'students'}`);
                            } else {
                                alert(data.error || 'Failed to apply fees');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Server error');
                        } finally {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }

                    async function saveFee(e) {
                        e.preventDefault();
                        // Logic for creating single fee
                        const btn = document.getElementById('saveFeeBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            student_id: parseInt(document.getElementById('studentSelect').value),
                            title: document.getElementById('feeTitle').value,
                            amount: parseFloat(document.getElementById('feeAmount').value),
                            due_date: document.getElementById('feeDueDate').value,
                            // Default category for now or random
                            fee_type_id: 1 // Assuming 1 exists or is optional, backend might require it carefully
                        };

                        // Add Fee endpoint check? Existing API says `POST /api/fees`.
                        try {
                            btn.innerHTML = '<span>Saving...</span>';
                            btn.disabled = true;
                            const res = await fetch('/api/fees', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                closeModal('addFeeModal');
                                loadFees();
                                loadFeeStats();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Failed to create fee');
                            }
                        } catch (err) { console.error(err); } finally { btn.innerHTML = originalText; btn.disabled = false; }
                    }

                    async function updateFee(e) {
                        e.preventDefault();
                        const id = document.getElementById('editFeeId').value;
                        const btn = document.getElementById('updateFeeBtn');
                        const originalText = btn.innerHTML;

                        const payload = {
                            title: document.getElementById('editFeeTitle').value,
                            amount: parseFloat(document.getElementById('editFeeAmount').value),
                            due_date: document.getElementById('editFeeDueDate').value
                        };

                        try {
                            btn.innerHTML = '<span>Updating...</span>';
                            btn.disabled = true;
                            const res = await fetch(`/api/fees/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                closeModal('editFeeModal');
                                loadFees();
                                loadFeeStats();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Update failed');
                            }
                        } catch (err) { console.error(err); } finally { btn.innerHTML = originalText; btn.disabled = false; }
                    }

                    async function deleteFee(id) {
                        if (!confirm('Are you sure you want to delete this fee record?')) return;
                        try {
                            const res = await fetch(`/api/fees/${id}`, { method: 'DELETE' });
                            if (res.ok) {
                                loadFees(); // Reload table
                                loadFeeStats();
                            } else {
                                alert('Failed to delete');
                            }
                        } catch (err) { console.error(err); }
                    }
                </script>