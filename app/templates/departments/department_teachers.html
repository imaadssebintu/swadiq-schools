<div class="p-6 space-y-8 animate-fade-in">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <a href="/departments"
                class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-100 hover:bg-indigo-50 transition-all shadow-sm">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 id="pageTitle" class="text-2xl font-black text-slate-900 tracking-tight">Department Faculty</h1>
                <p class="text-xs font-bold text-slate-500 mt-1 flex items-center gap-2">
                    <span id="headerDeptName" class="text-indigo-600">Loading...</span>
                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                    <span id="headerDeptCode"
                        class="bg-slate-100 px-1.5 py-0.5 rounded text-[10px] uppercase">...</span>
                </p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative group">
                <i
                    class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors text-xs"></i>
                <input type="text" id="teacherSearch" placeholder="Search faculty..."
                    class="pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all w-full md:w-64 appearance-none">
            </div>
            <button onclick="openAddTeacherModal()"
                class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-xs font-black transition-all shadow-sm hover:shadow-indigo-200 active:scale-95">
                <i class="fas fa-plus"></i>
                Assign Teacher
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Faculty -->
        <div
            class="group bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-indigo-100 uppercase tracking-wider mb-1">Total Faculty</p>
                    <p id="totalFacultyCount" class="text-2xl font-black text-white leading-none">0</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-users text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Total Subjects -->
        <div
            class="group bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-emerald-100 uppercase tracking-wider mb-1">Department
                        Subjects</p>
                    <p id="totalSubjectsCount" class="text-2xl font-black text-white leading-none">0</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-book-open text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Head of Department -->
        <div
            class="group bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-purple-100 uppercase tracking-wider mb-1">Head of
                        Department</p>
                    <p id="hodName" class="text-sm font-black text-white leading-tight mt-1 truncate max-w-[150px]">Not
                        Assigned</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-user-tie text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Assistant Head -->
        <div
            class="group bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-orange-100 uppercase tracking-wider mb-1">Assistant Head
                    </p>
                    <p id="assistantName"
                        class="text-sm font-black text-white leading-tight mt-1 truncate max-w-[150px]">Not Assigned</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-user-shield text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Table -->
    <div class="glass-card rounded-2xl overflow-hidden border border-slate-200">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse" id="teachersTable">
                <thead>
                    <tr class="bg-slate-50/50 border-b border-slate-100">
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Faculty
                            Member</th>
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Contact
                            Information</th>
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Department
                            Role</th>
                        <th
                            class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="teachersTableBody" class="divide-y divide-slate-100 bg-white">
                    <!-- Skeleton rows -->
                    <tr class="skeleton-row animate-pulse">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-slate-100"></div>
                                <div class="space-y-2">
                                    <div class="h-3 w-32 bg-slate-100 rounded"></div>
                                    <div class="h-2 w-20 bg-slate-50 rounded"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="h-3 w-40 bg-slate-50 rounded"></div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="h-5 w-24 bg-slate-100 rounded-full"></div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="h-8 w-8 bg-slate-100 rounded-lg ml-auto"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden py-20 text-center animate-fade-in">
            <div
                class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100 shadow-sm">
                <i class="fas fa-users-slash text-slate-300 text-3xl"></i>
            </div>
            <h3 class="text-sm font-black text-slate-900">No Faculty Assigned</h3>
            <p class="text-xs font-bold text-slate-400 mt-1">Start by assigning teachers to this department</p>
            <button onclick="openAddTeacherModal()"
                class="mt-6 text-[10px] font-black text-indigo-600 uppercase tracking-widest bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                Assign First Teacher
            </button>
        </div>
    </div>
</div>

<!-- Add Teacher Modal -->
<div id="addTeacherModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeAddTeacherModal()">
    </div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative w-full max-w-lg transform overflow-hidden rounded-3xl bg-white shadow-2xl transition-all animate-scale-up flex flex-col max-h-[80vh]">
            <!-- Modal Header -->
            <div class="premium-gradient px-8 py-6 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-black text-white tracking-tight">Assign Faculty</h3>
                    <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-wider mt-1">Select teachers to
                        add to this department</p>
                </div>
                <button onclick="closeAddTeacherModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-xl bg-white/20 text-white hover:bg-white/30 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Search Area -->
            <div class="p-6 bg-slate-50 border-b border-slate-100">
                <div class="relative group">
                    <i
                        class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                    <input type="text" id="teacherSearchInput"
                        class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
                        placeholder="Search by name or email...">
                </div>
            </div>

            <!-- List Area -->
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="availableTeachers">
                <!-- Populated via JS -->
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-between gap-3">
                <button onclick="closeAddTeacherModal()"
                    class="flex-1 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest hover:bg-slate-100 rounded-xl transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentDepartmentId = null;
    let currentDepartmentName = null;

    async function loadDepartmentTeachers() {
        const urlParams = new URLSearchParams(window.location.search);
        currentDepartmentId = urlParams.get('id');

        if (!currentDepartmentId) {
            window.location.href = '/departments';
            return;
        }

        const tbody = document.getElementById('teachersTableBody');
        const emptyState = document.getElementById('empty-state');

        try {
            const response = await fetch(`/api/departments/${currentDepartmentId}/teachers`);
            const data = await response.json();

            // Update Header & Stats
            document.getElementById('headerDeptName').textContent = data.department_name;
            document.getElementById('headerDeptCode').textContent = data.department_code;
            document.getElementById('totalFacultyCount').textContent = data.count || 0;
            document.getElementById('totalSubjectsCount').textContent = data.subject_count || 0;

            const hod = data.head_of_department;
            document.getElementById('hodName').textContent = hod.first_name ? `${hod.first_name} ${hod.last_name}` : 'Not Assigned';

            const assist = data.assistant_head;
            document.getElementById('assistantName').textContent = assist.first_name ? `${assist.first_name} ${assist.last_name}` : 'Not Assigned';

            tbody.innerHTML = '';

            if (!data.teachers || data.teachers.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            data.teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50/50 transition-colors group';

                const initials = teacher.first_name[0] + teacher.last_name[0];
                const roleColors = getRoleConfig(teacher.role);

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 group-hover:bg-indigo-50 group-hover:border-indigo-100 group-hover:text-indigo-600 transition-all font-black text-xs">
                                ${initials}
                            </div>
                            <div>
                                <p class="text-sm font-black text-slate-900">${teacher.first_name} ${teacher.last_name}</p>
                                <p class="text-[10px] font-bold text-slate-400 uppercase mt-0.5 tracking-tighter">${teacher.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                <i class="fas fa-envelope text-[10px] text-slate-300"></i> ${teacher.email}
                            </span>
                            <span class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                <i class="fas fa-phone text-[10px] text-slate-300"></i> ${teacher.phone || 'No phone'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${roleColors.bg} ${roleColors.text} border ${roleColors.border}">
                            <span class="w-1.5 h-1.5 rounded-full ${roleColors.dot} ${teacher.role !== 'Member' ? 'animate-pulse' : ''}"></span>
                            ${teacher.role}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-end gap-1">
                            <div class="relative group/menu">
                                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all">
                                    <i class="fas fa-user-shield text-xs"></i>
                                </button>
                                <div class="hidden group-hover/menu:block absolute right-0 top-full mt-1 w-48 bg-white rounded-2xl shadow-2xl border border-slate-100 py-2 z-50 animate-scale-up">
                                    <button onclick="setRole('${teacher.id}', 'head')" class="flex items-center gap-3 w-full px-4 py-2 text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-all">
                                        <i class="fas fa-user-tie w-4"></i> Set as Head
                                    </button>
                                    <button onclick="setRole('${teacher.id}', 'assistant')" class="flex items-center gap-3 w-full px-4 py-2 text-xs font-bold text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 transition-all">
                                        <i class="fas fa-user-shield w-4"></i> Set as Assistant
                                    </button>
                                    <button onclick="setRole('${teacher.id}', 'member')" class="flex items-center gap-3 w-full px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-all border-t border-slate-50 mt-1 pt-3">
                                        <i class="fas fa-user w-4"></i> Set as Member
                                    </button>
                                </div>
                            </div>
                            <button onclick="removeTeacher('${teacher.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-rose-600 hover:bg-rose-50 transition-all">
                                <i class="fas fa-user-minus text-xs"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading teachers:', error);
            showNotification('Failed to load faculty', 'error');
        }
    }

    function getRoleConfig(role) {
        if (role === 'Head of Department') return { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-100', dot: 'bg-indigo-500' };
        if (role === 'Assistant Head') return { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100', dot: 'bg-emerald-500' };
        return { bg: 'bg-slate-50', text: 'text-slate-500', border: 'border-slate-100', dot: 'bg-slate-400' };
    }

    async function setRole(teacherId, role) {
        try {
            const response = await fetch(`/api/departments/${currentDepartmentId}/leadership`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ teacher_id: teacherId, role: role })
            });

            if (response.ok) {
                showNotification('Role updated successfully');
                loadDepartmentTeachers();
            } else {
                const err = await response.json();
                showNotification(err.error || 'Failed to update role', 'error');
            }
        } catch (error) {
            showNotification('System error occurred', 'error');
        }
    }

    async function removeTeacher(teacherId) {
        if (!confirm('Are you sure you want to remove this teacher from the department?')) return;

        try {
            const response = await fetch(`/api/departments/${currentDepartmentId}/teachers/${teacherId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Teacher removed from department');
                loadDepartmentTeachers();
            } else {
                showNotification('Failed to remove teacher', 'error');
            }
        } catch (error) {
            showNotification('System error', 'error');
        }
    }

    // Modal Operations
    function openAddTeacherModal() {
        document.getElementById('addTeacherModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadAvailableTeachers();
    }

    function closeAddTeacherModal() {
        document.getElementById('addTeacherModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    async function loadAvailableTeachers() {
        const query = document.getElementById('teacherSearchInput').value;
        const container = document.getElementById('availableTeachers');

        try {
            const response = await fetch(`/api/teachers/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            container.innerHTML = '';
            if (!data.teachers || data.teachers.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-xs font-bold text-slate-400">No teachers found</div>';
                return;
            }

            data.teachers.forEach(teacher => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 rounded-2xl bg-white border border-slate-100 hover:border-indigo-200 hover:bg-indigo-50/50 transition-all group';

                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-50 flex items-center justify-center text-[10px] font-black text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-all">
                            ${teacher.first_name[0]}${teacher.last_name[0]}
                        </div>
                        <div>
                            <p class="text-xs font-black text-slate-900 leading-none">${teacher.first_name} ${teacher.last_name}</p>
                            <p class="text-[10px] font-bold text-slate-400 mt-1">${teacher.email}</p>
                        </div>
                    </div>
                    <button onclick="assignTeacher('${teacher.id}', this)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg text-[10px] font-black transition-all shadow-sm">
                        Assign
                    </button>
                `;
                container.appendChild(item);
            });
        } catch (error) {
            console.error('Error fetching teachers:', error);
        }
    }

    async function assignTeacher(teacherId, btn) {
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const response = await fetch(`/api/departments/${currentDepartmentId}/teachers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ teacher_id: teacherId })
            });

            if (response.ok) {
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.className = 'bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-[10px] font-black';
                showNotification('Teacher assigned successfully');
                loadDepartmentTeachers();
            } else {
                const err = await response.json();
                showNotification(err.error || 'Failed to assign', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            showNotification('System error', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Event Listeners
    document.getElementById('teacherSearchInput').addEventListener('input', debounce(loadAvailableTeachers, 300));

    document.getElementById('teacherSearch').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#teachersTableBody tr:not(.skeleton-row)');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showNotification(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-6 right-6 z-[200] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-in ${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'
            } text-white`;
        toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <p class="text-xs font-black uppercase tracking-widest">${msg}</p>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    document.addEventListener('DOMContentLoaded', loadDepartmentTeachers);
</script>

<style>
    @keyframes scaleUp {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-scale-up {
        animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .animate-fade-in {
        animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>