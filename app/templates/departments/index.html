<div class="p-6 space-y-8 animate-fade-in">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tight">Departments Management</h1>
            <p class="text-sm font-bold text-slate-500 mt-1">Manage school departments, leadership, and faculty</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative group">
                <i
                    class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors text-xs"></i>
                <input type="text" id="departmentSearch" placeholder="Search departments..."
                    class="pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all w-full md:w-64 appearance-none">
            </div>
            <button onclick="openModal()"
                class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-xs font-black transition-all shadow-sm hover:shadow-indigo-200 active:scale-95">
                <i class="fas fa-plus"></i>
                Add Department
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Departments -->
        <div
            class="group bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-indigo-100 uppercase tracking-wider mb-1">Total Departments
                    </p>
                    <p id="totalDepartmentsCount" class="text-2xl font-black text-white leading-none">
                        {{.TotalDepartments}}</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-landmark text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Active Departments -->
        <div
            class="group bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-emerald-100 uppercase tracking-wider mb-1">Active
                        Departments</p>
                    <p id="activeDepartmentsCount" class="text-2xl font-black text-white leading-none">
                        {{.ActiveDepartments}}</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-check-double text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Total Faculty -->
        <div
            class="group bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-purple-100 uppercase tracking-wider mb-1">Dedicated Faculty
                    </p>
                    <p id="totalTeachersCount" class="text-2xl font-black text-white leading-none">{{.TotalTeachers}}
                    </p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-chalkboard-user text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <a href="/subjects"
            class="group bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-semibold text-orange-100 uppercase tracking-wider mb-1">Manage Subjects
                    </p>
                    <p id="totalSubjectsCount" class="text-2xl font-black text-white leading-none">{{.TotalSubjects}}
                        Subjects</p>
                    <div class="h-1 w-12 bg-white/30 rounded-full group-hover:w-20 transition-all duration-300 mt-2">
                    </div>
                </div>
                <div
                    class="bg-white/20 backdrop-blur-sm p-2.5 rounded-lg group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-book-open text-white text-lg transition-transform group-hover:rotate-12"></i>
                </div>
            </div>
        </a>
    </div>

    <!-- Main Content Table -->
    <div class="glass-card rounded-2xl overflow-hidden border border-slate-200">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse" id="departmentsTable">
                <thead>
                    <tr class="bg-slate-50/50 border-b border-slate-100">
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Department & Code</th>
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Head of
                            Department
                        </th>
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Assistant
                            Head
                        </th>
                        <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Status
                        </th>
                        <th
                            class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="departmentsTableBody" class="divide-y divide-slate-100 bg-white">
                    <!-- Skeleton Loading -->
                    <tr class="skeleton-row animate-pulse">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-slate-100"></div>
                                <div class="space-y-2">
                                    <div class="h-3 w-24 bg-slate-100 rounded"></div>
                                    <div class="h-2 w-12 bg-slate-50 rounded"></div>
                                </div>
                            </div>
                        </td>
                        <td colspan="4" class="px-6 py-4">
                            <div class="h-3 w-full bg-slate-50 rounded"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State (Hidden) -->
        <div id="empty-state" class="hidden py-20 text-center animate-fade-in">
            <div
                class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100 shadow-sm">
                <i class="fas fa-landmark text-slate-300 text-3xl"></i>
            </div>
            <h3 class="text-sm font-black text-slate-900">No Departments Found</h3>
            <p class="text-xs font-bold text-slate-400 mt-1">Get started by creating your first school department</p>
            <button onclick="openModal()"
                class="mt-6 text-[10px] font-black text-indigo-600 uppercase tracking-widest bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                Add First Department
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Department Modal -->
<div id="addDepartmentModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative w-full max-w-lg transform overflow-hidden rounded-3xl bg-white shadow-2xl transition-all animate-scale-up">
            <!-- Modal Header -->
            <div class="premium-gradient px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-black text-white tracking-tight" id="modalTitle">Add New Department</h3>
                        <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-wider mt-1">Specify
                            department details and leadership</p>
                    </div>
                    <button onclick="closeModal()"
                        class="w-8 h-8 flex items-center justify-center rounded-xl bg-white/20 text-white hover:bg-white/30 transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <form id="addDepartmentForm" class="p-8 space-y-6">
                <input type="hidden" id="editDepartmentId" name="editDepartmentId">
                <div class="grid grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1 space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Department
                            Name</label>
                        <div class="relative group">
                            <i
                                class="fas fa-landmark absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                            <input type="text" id="departmentName" name="departmentName" required
                                class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
                                placeholder="e.g. Mathematics">
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-1 space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Department
                            Code</label>
                        <div class="relative group">
                            <i
                                class="fas fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                            <input type="text" id="departmentCode" name="departmentCode" required
                                class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
                                placeholder="e.g. MATH">
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Description
                        (Optional)</label>
                    <div class="relative group">
                        <i
                            class="fas fa-align-left absolute left-4 top-4 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                        <textarea id="departmentDescription" name="departmentDescription" rows="3"
                            class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
                            placeholder="Briefly describe the department's focus..."></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                    <!-- Head of Department -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Head of
                            Department</label>
                        <div class="relative group cursor-pointer" onclick="openTeacherSelection('head')">
                            <i
                                class="fas fa-user-tie absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                            <input type="text" id="selectedTeacherDisplay" readonly required
                                class="w-full pl-11 pr-10 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all cursor-pointer"
                                placeholder="Select Head">
                            <i
                                class="fas fa-chevron-right absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <input type="hidden" id="headOfDepartment" name="headOfDepartment">
                        </div>
                    </div>

                    <!-- Assistant Head -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Assistant
                            Head</label>
                        <div class="relative group cursor-pointer" onclick="openTeacherSelection('assistant')">
                            <i
                                class="fas fa-user-shield absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                            <input type="text" id="selectedAssistantDisplay" readonly
                                class="w-full pl-11 pr-10 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all cursor-pointer"
                                placeholder="Select Assistant">
                            <i
                                class="fas fa-chevron-right absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <input type="hidden" id="assistantHead" name="assistantHead">
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeModal()"
                        class="px-6 py-3 text-xs font-black text-slate-500 hover:text-slate-700 transition-all uppercase tracking-widest">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-2xl text-xs font-black transition-all shadow-lg shadow-indigo-200 active:scale-95 flex items-center gap-2">
                        <span id="submitBtnText">Create Department</span>
                        <i class="fas fa-arrow-right text-[10px]"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteDepartmentModal" class="fixed inset-0 z-[110] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDeleteModal()"></div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative w-full max-w-md transform overflow-hidden rounded-3xl bg-white shadow-2xl transition-all animate-scale-up p-8 text-center">
            <div
                class="w-20 h-20 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-6 border border-rose-100 shadow-sm">
                <i class="fas fa-trash-alt text-rose-500 text-3xl"></i>
            </div>
            <h3 class="text-xl font-black text-slate-900 tracking-tight">Remove Department?</h3>
            <p class="text-sm font-bold text-slate-500 mt-2 leading-relaxed">
                You are about to delete <span id="deleteDepartmentName"
                    class="text-slate-900 underline decoration-rose-300 decoration-2 underline-offset-4"></span>. This
                action is irreversible. All associated metadata will be finalized.
            </p>
            <input type="hidden" id="deleteDepartmentId">

            <div class="grid grid-cols-2 gap-4 mt-8">
                <button onclick="closeDeleteModal()"
                    class="px-6 py-4 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-2xl text-xs font-black transition-all uppercase tracking-widest">
                    Cancel
                </button>
                <button id="confirmDeleteBtn"
                    class="px-6 py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl text-xs font-black transition-all shadow-lg shadow-rose-100 uppercase tracking-widest">
                    Confirm Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Teacher Picker Modal -->
<div id="teacherSearchModal" class="fixed inset-0 z-[120] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeTeacherModal()"></div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative w-full max-w-lg transform overflow-hidden rounded-3xl bg-white shadow-2xl transition-all animate-scale-up flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Select Faculty Member</h3>
                    <p class="text-[10px] font-bold text-slate-400 mt-0.5">Choose a teacher for the leadership role</p>
                </div>
                <button onclick="closeTeacherModal()" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="p-4 bg-slate-50 mb-1">
                <div class="relative group">
                    <i
                        class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-indigo-600 transition-colors"></i>
                    <input type="text" id="teacherSearchInput"
                        class="w-full pl-11 pr-4 py-3 bg-white border border-slate-100 rounded-2xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
                        placeholder="Search by name or email...">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-2" id="teacherSearchResults">
                <!-- Populated via JS -->
            </div>

            <div class="p-4 border-t border-slate-100 flex justify-between gap-3">
                <button onclick="clearTeacherSelectionInternal()"
                    class="flex-1 py-3 text-[10px] font-black text-rose-500 uppercase tracking-widest hover:bg-rose-50 rounded-xl transition-all">
                    Clear Selection
                </button>
                <button onclick="closeTeacherModal()"
                    class="flex-1 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest hover:bg-slate-50 rounded-xl transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const addDepartmentModal = document.getElementById('addDepartmentModal');
    const addDepartmentForm = document.getElementById('addDepartmentForm');
    const deleteDepartmentModal = document.getElementById('deleteDepartmentModal');
    const teacherSearchModal = document.getElementById('teacherSearchModal');
    const teacherSearchInput = document.getElementById('teacherSearchInput');
    const teacherSearchResults = document.getElementById('teacherSearchResults');

    let currentSelectionTarget = 'head'; // 'head' or 'assistant'

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        loadDepartments();
        hydrateStats();
    });

    async function hydrateStats() {
        try {
            const response = await fetch('/api/departments/stats');
            const data = await response.json();

            if (data) {
                document.getElementById('totalDepartmentsCount').textContent = data.total_departments;
                document.getElementById('activeDepartmentsCount').textContent = data.active_departments;
                document.getElementById('totalTeachersCount').textContent = data.total_teachers;
                document.getElementById('totalSubjectsCount').textContent = `${data.total_subjects} Subjects`;
            }
        } catch (error) {
            console.error('Error hydrating stats:', error);
        }
    }

    async function loadDepartments() {
        const tbody = document.getElementById('departmentsTableBody');
        const emptyState = document.getElementById('empty-state');

        try {
            const response = await fetch('/api/departments');
            const data = await response.json();

            tbody.innerHTML = '';

            if (!data.departments || data.departments.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            data.departments.forEach(dept => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50/50 transition-colors group';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 group-hover:bg-indigo-50 group-hover:border-indigo-100 group-hover:text-indigo-600 transition-all">
                                <i class="fas fa-landmark text-sm"></i>
                            </div>
                            <div>
                                <a href="/departments/teachers?id=${dept.id}&name=${encodeURIComponent(dept.name)}" class="text-sm font-black text-slate-900 hover:text-indigo-600 transition-colors">${dept.name}</a>
                                <p class="text-[10px] font-bold text-slate-400 uppercase mt-0.5 tracking-tighter">
                                    <span class="bg-slate-100 px-1.5 py-0.5 rounded mr-1">${dept.code}</span>
                                    ${dept.teacher_count || 0} Faculty Members
                                </p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        ${renderStaff(dept.head_of_department, "Head")}
                    </td>
                    <td class="px-6 py-4">
                        ${renderStaff(dept.assistant_head, "Assistant")}
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${dept.is_active ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-400'}">
                            <span class="w-1.5 h-1.5 rounded-full ${dept.is_active ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}"></span>
                            ${dept.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-end gap-1 transition-opacity">
                            <button onclick="openEditModal('${dept.id}', '${dept.name}', '${dept.code}', '${dept.description || ''}', '${dept.head_of_department?.id || ''}', '${dept.head_of_department ? dept.head_of_department.first_name + ' ' + dept.head_of_department.last_name : ''}', '${dept.assistant_head?.id || ''}', '${dept.assistant_head ? dept.assistant_head.first_name + ' ' + dept.assistant_head.last_name : ''}')" 
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all" title="Edit Department">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <a href="/departments/teachers?id=${dept.id}&name=${encodeURIComponent(dept.name)}"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-purple-600 hover:bg-purple-50 transition-all" title="View Teachers">
                                <i class="fas fa-users-viewfinder text-xs"></i>
                            </a>
                            <button onclick="openDeleteModal('${dept.id}', '${dept.name}')" 
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-rose-600 hover:bg-rose-50 transition-all" title="Delete">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error:', error);
            showNotification('Failed to load departments', 'error');
        }
    }

    function renderStaff(staff, label) {
        if (!staff) return '<span class="text-[10px] font-bold text-slate-300 italic">Not Assigned</span>';
        const init = (staff.first_name?.[0] || '') + (staff.last_name?.[0] || '');
        return `
            <div class="flex items-center gap-3 group/staff">
                <div class="w-7 h-7 rounded-lg premium-gradient flex items-center justify-center text-white text-[9px] font-black shadow-sm group-hover/staff:rotate-6 transition-transform">
                    ${init}
                </div>
                <div>
                    <p class="text-xs font-black text-slate-700 leading-none">${staff.first_name} ${staff.last_name}</p>
                    <p class="text-[9px] font-bold text-slate-400 mt-0.5">${staff.email}</p>
                </div>
            </div>
        `;
    }

    // Modal Logic
    function openModal() {
        document.getElementById('modalTitle').textContent = 'Add New Department';
        document.getElementById('submitBtnText').textContent = 'Create Department';
        document.getElementById('editDepartmentId').value = '';
        addDepartmentForm.reset();
        addDepartmentModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function openEditModal(id, name, code, description, headId, headDisplay, assistantId, assistantDisplay) {
        openModal();
        document.getElementById('modalTitle').textContent = 'Edit Department';
        document.getElementById('submitBtnText').textContent = 'Update Changes';
        document.getElementById('editDepartmentId').value = id;
        document.getElementById('departmentName').value = name;
        document.getElementById('departmentCode').value = code;
        document.getElementById('departmentDescription').value = description;

        document.getElementById('headOfDepartment').value = headId;
        document.getElementById('selectedTeacherDisplay').value = headDisplay;

        document.getElementById('assistantHead').value = assistantId;
        document.getElementById('selectedAssistantDisplay').value = assistantDisplay;
    }

    function closeModal() {
        addDepartmentModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function openDeleteModal(id, name) {
        document.getElementById('deleteDepartmentId').value = id;
        document.getElementById('deleteDepartmentName').textContent = name;
        deleteDepartmentModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        deleteDepartmentModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Teacher Selection
    function openTeacherSelection(type) {
        currentSelectionTarget = type;
        teacherSearchModal.classList.remove('hidden');
        teacherSearchInput.value = '';
        loadTeachers();
    }

    function closeTeacherModal() {
        teacherSearchModal.classList.add('hidden');
    }

    function clearTeacherSelectionInternal() {
        if (currentSelectionTarget === 'head') {
            document.getElementById('headOfDepartment').value = '';
            document.getElementById('selectedTeacherDisplay').value = '';
        } else {
            document.getElementById('assistantHead').value = '';
            document.getElementById('selectedAssistantDisplay').value = '';
        }
        closeTeacherModal();
    }

    async function loadTeachers() {
        const query = teacherSearchInput.value;
        const url = `/api/teachers/search?q=${encodeURIComponent(query)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            teacherSearchResults.innerHTML = '';

            if (!data.teachers || data.teachers.length === 0) {
                teacherSearchResults.innerHTML = '<div class="p-8 text-center text-xs font-bold text-slate-400">No teachers found</div>';
                return;
            }

            data.teachers.forEach(teacher => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 rounded-2xl hover:bg-slate-50 cursor-pointer transition-all border border-transparent hover:border-slate-100';
                item.onclick = () => selectTeacherEntry(teacher);

                const init = teacher.first_name[0] + teacher.last_name[0];
                item.innerHTML = `
                    <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500">${init}</div>
                    <div>
                        <p class="text-xs font-black text-slate-900 leading-none">${teacher.first_name} ${teacher.last_name}</p>
                        <p class="text-[10px] font-bold text-slate-400 mt-1">${teacher.email}</p>
                    </div>
                `;
                teacherSearchResults.appendChild(item);
            });
        } catch (error) {
            console.error('Error fetching teachers:', error);
        }
    }

    teacherSearchInput.addEventListener('input', debounce(loadTeachers, 300));

    function selectTeacherEntry(teacher) {
        const name = `${teacher.first_name} ${teacher.last_name}`;
        if (currentSelectionTarget === 'head') {
            document.getElementById('headOfDepartment').value = teacher.id;
            document.getElementById('selectedTeacherDisplay').value = name;
        } else {
            document.getElementById('assistantHead').value = teacher.id;
            document.getElementById('selectedAssistantDisplay').value = name;
        }
        closeTeacherModal();
    }

    // Form Submissions
    addDepartmentForm.onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('editDepartmentId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/departments/${id}` : '/api/departments';

        const data = {
            name: document.getElementById('departmentName').value,
            code: document.getElementById('departmentCode').value,
            description: document.getElementById('departmentDescription').value,
            head_of_department_id: document.getElementById('headOfDepartment').value || null,
            assistant_head_id: document.getElementById('assistantHead').value || null
        };

        setButtonState(true);
        try {
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotification(id ? 'Department updated successfully' : 'Department created successfully', 'success');
                closeModal();
                loadDepartments();
                hydrateStats();
            } else {
                const err = await response.json();
                showNotification(err.error || 'Operation failed', 'error');
            }
        } catch (error) {
            showNotification('System error occurred', 'error');
        } finally {
            setButtonState(false);
        }
    };

    document.getElementById('confirmDeleteBtn').onclick = async () => {
        const id = document.getElementById('deleteDepartmentId').value;
        try {
            const response = await fetch(`/api/departments/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showNotification('Department removed', 'success');
                closeDeleteModal();
                loadDepartments();
                hydrateStats();
            } else {
                showNotification('Failed to delete department', 'error');
            }
        } catch (error) {
            showNotification('System error', 'error');
        }
    };

    // Utils
    function setButtonState(loading) {
        const btn = document.getElementById('submitBtn');
        const text = document.getElementById('submitBtnText');
        btn.disabled = loading;
        if (loading) {
            text.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        } else {
            text.textContent = document.getElementById('editDepartmentId').value ? 'Update Changes' : 'Create Department';
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showNotification(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-6 right-6 z-[200] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-in ${type === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'
            }`;
        toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <p class="text-xs font-black uppercase tracking-widest">${msg}</p>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Search implementation
    document.getElementById('departmentSearch').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#departmentsTableBody tr:not(.skeleton-row)');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    });
</script>

<style>
    @keyframes scaleUp {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-scale-up {
        animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
</style>