<style>
    @media print {

        header,
        .sidebar,
        .no-print,
        #loadBtn,
        .filters-section {
            display: none !important;
        }

        .main-content {
            margin: 0 !important;
            padding: 0 !important;
        }

        .max-w-7xl {
            max-width: 100% !important;
            width: 100% !important;
        }

        .bg-gray-50 {
            background-color: white !important;
        }

        .shadow-sm {
            box-shadow: none !important;
            border: none !important;
        }

        table {
            border-collapse: collapse !important;
            width: 100% !important;
        }

        th,
        td {
            border: 1px solid #e2e8f0 !important;
            padding: 4px !important;
            font-size: 8px !important;
        }

        [class*="shadow-"] {
            box-shadow: none !important;
        }

        .sticky {
            position: static !important;
        }

        .text-slate-400,
        .text-slate-500,
        .text-slate-300 {
            color: #000 !important;
        }
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f8fafc;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #cbd5e1;
    }
</style>

<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-4 lg:px-6 lg:py-5 space-y-6">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex flex-col gap-1">
                <h1 id="pageTitle" class="text-xl font-black text-slate-900 tracking-tight uppercase tracking-tighter">
                    Class Performance Report
                </h1>
                <p id="pageDescription" class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                    Term-wide aggregate results for all subjects
                </p>
            </div>
            <div class="flex items-center gap-3 no-print">
                <button onclick="history.back()"
                    class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fas fa-arrow-left text-[8px]"></i>
                    <span>Back</span>
                </button>
                <button onclick="window.print()"
                    class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fas fa-print text-[8px]"></i>
                    <span>Print Sheet</span>
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div
            class="filters-section flex flex-wrap items-center gap-3 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm no-print">
            <!-- Class Filter -->
            <div class="relative min-w-[160px]">
                <label
                    class="absolute -top-2 left-3 bg-white px-1 text-[8px] font-black text-slate-400 uppercase tracking-widest">Class</label>
                <select id="filterClass"
                    class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Select Class</option>
                </select>
                <i
                    class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
            </div>

            <!-- Term Filter -->
            <div class="relative min-w-[140px]">
                <label
                    class="absolute -top-2 left-3 bg-white px-1 text-[8px] font-black text-slate-400 uppercase tracking-widest">Term</label>
                <select id="filterTerm"
                    class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Select Term</option>
                </select>
                <i
                    class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
            </div>

            <!-- Assessment Type Filter -->
            <div class="relative min-w-[160px]">
                <label
                    class="absolute -top-2 left-3 bg-white px-1 text-[8px] font-black text-slate-400 uppercase tracking-widest">Type</label>
                <select id="filterType"
                    class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="all">All Types</option>
                </select>
                <i
                    class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
            </div>

            <!-- Search Filter -->
            <div class="relative min-w-[200px] flex-grow sm:flex-grow-0">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                <input type="text" id="filterSearch" placeholder="Search name or ID..."
                    class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all hover:border-slate-300"
                    oninput="debounceSearch()">
            </div>

            <div class="h-8 w-px bg-slate-100 hidden sm:block"></div>

            <button id="loadBtn"
                class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-sm flex items-center gap-2 ml-auto group/btn">
                <i class="fas fa-sync-alt text-[8px] group-hover/btn:rotate-180 transition-transform duration-500"></i>
                <span>Generate Report</span>
            </button>
        </div>

        <!-- Matrix Container -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden mb-8">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead>
                        <tr id="matrixHeaderRow" class="bg-slate-50 border-b border-slate-100">
                            <!-- Headers will be injected via JS -->
                        </tr>
                    </thead>
                    <tbody id="matrixBody">
                        <tr>
                            <td colspan="10"
                                class="px-6 py-12 text-center text-slate-400 text-xs font-bold uppercase tracking-widest flex flex-col items-center gap-3">
                                <i class="fas fa-chart-line text-lg opacity-20"></i>
                                <span>Select filters and click Generate to view class performance</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Sentinel for infinite scroll -->
            <div id="infiniteScrollSentinel" class="h-10 w-full no-print"></div>
        </div>
    </div>
</div>

<script>
    let currentData = null;
    let loadedCount = 0;
    let totalStudents = 0;
    const itemsPerPage = 10;
    let isLoadingMore = false;
    let scrollObserver = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([
            loadFilters(),
        ]);

        // Pre-fill from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('class_id');
        const termId = urlParams.get('term_id');
        const typeId = urlParams.get('assessment_type_id');

        if (classId) document.getElementById('filterClass').value = classId;
        if (termId) document.getElementById('filterTerm').value = termId;
        if (typeId) document.getElementById('filterType').value = typeId;

        if (classId && termId) {
            loadClassMatrix(true);
        }

        document.getElementById('loadBtn').addEventListener('click', () => {
            resetPagination();
            loadClassMatrix(true);
        });

        setupInfiniteScroll();
    });

    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            resetPagination();
            loadClassMatrix(true);
        }, 500);
    }

    async function loadFilters() {
        try {
            const [classesRes, termsRes, typesRes] = await Promise.all([
                fetch('/api/classes'),
                fetch('/api/terms'),
                fetch('/api/settings/assessment-types')
            ]);

            const classesData = await classesRes.json();
            const termsData = await termsRes.json();
            const typesData = await typesRes.json();

            const classes = Array.isArray(classesData) ? classesData : (classesData.classes || []);
            const terms = Array.isArray(termsData) ? termsData : (termsData.terms || []);
            const types = Array.isArray(typesData) ? typesData : (typesData.types || []);

            const classSelect = document.getElementById('filterClass');
            classSelect.innerHTML = '<option value="">Select Class</option>' +
                classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const termSelect = document.getElementById('filterTerm');
            termSelect.innerHTML = '<option value="">Select Term</option>' +
                terms.map(t => `<option value="${t.id}" ${t.is_current ? 'selected' : ''}>${t.name}</option>`).join('');

            const typeSelect = document.getElementById('filterType');
            typeSelect.innerHTML = '<option value="all">All Types</option>' +
                types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        } catch (err) {
            console.error('Failed to load filters:', err);
        }
    }

    function resetPagination() {
        loadedCount = 0;
        totalStudents = 0;
        isLoadingMore = false;
    }

    function setupInfiniteScroll() {
        const sentinel = document.getElementById('infiniteScrollSentinel');
        if (!sentinel) return;

        scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoadingMore && loadedCount < totalStudents) {
                loadClassMatrix(false);
            }
        }, { threshold: 0.1 });

        scrollObserver.observe(sentinel);
    }

    async function loadClassMatrix(isInitial = true) {
        const classId = document.getElementById('filterClass').value;
        const termId = document.getElementById('filterTerm').value;
        const typeId = document.getElementById('filterType').value;
        const searchQuery = document.getElementById('filterSearch').value;

        if (!classId || !termId) {
            if (isInitial) {
                showToast('Please select Class and Term', 'error');
            }
            return;
        }

        isLoadingMore = true;
        const offset = isInitial ? 0 : loadedCount;

        if (isInitial) {
            renderSkeleton(false);
        } else {
            renderSkeleton(true);
        }

        try {
            const url = `/api/results/class-matrix?class_id=${classId}&term_id=${termId}&assessment_type_id=${typeId}&q=${encodeURIComponent(searchQuery)}&limit=${itemsPerPage}&offset=${offset}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Failed to load report');

            // Remove skeletons
            const tbody = document.getElementById('matrixBody');
            const skeletons = tbody.querySelectorAll('.skeleton-row');
            skeletons.forEach(s => s.remove());

            if (isInitial) {
                currentData = data;
                totalStudents = data.total_students || 0;
                renderHeaders(data.subjects, data.papers);
                tbody.innerHTML = '';
            }

            if (!data.students || data.students.length === 0) {
                if (isInitial) {
                    tbody.innerHTML = `<tr><td colspan="100%" class="px-6 py-12 text-center text-slate-400 text-[10px] font-black uppercase tracking-widest">No students found</td></tr>`;
                }
                isLoadingMore = false;
                return;
            }

            renderStudents(data.students, data.subjects, data.results, data.weights, data.grades, data.papers);
            loadedCount += data.students.length;

            if (loadedCount < totalStudents && scrollObserver) {
                const sentinel = document.getElementById('infiniteScrollSentinel');
                scrollObserver.unobserve(sentinel);
                scrollObserver.observe(sentinel);
            }

        } catch (err) {
            console.error('Report Error:', err);
            showToast(err.message, 'error');
            if (isInitial) {
                document.getElementById('matrixBody').innerHTML = `<tr><td colspan="100%" class="px-6 py-12 text-center text-red-500 text-xs font-bold uppercase tracking-widest">${err.message}</td></tr>`;
            }
        } finally {
            isLoadingMore = false;
        }
    }

    function renderHeaders(subjects, papers = []) {
        const headerRow = document.getElementById('matrixHeaderRow');
        let html = `
            <th class="sticky left-0 z-20 bg-slate-50 px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest border-r border-slate-100 min-w-[220px]">
                Student Identity
            </th>
        `;

        subjects.forEach(subject => {
            const subjectPapers = (papers || []).filter(p => p.subject_id === subject.id);

            if (subjectPapers.length > 0) {
                subjectPapers.forEach(p => {
                    html += `
                        <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest text-center border-l border-slate-100 min-w-[100px]">
                            <div class="flex flex-col gap-0.5">
                                <span class="text-slate-900">${subject.code}: ${p.name}</span>
                                <span class="text-[8px] text-slate-400">${p.code}</span>
                            </div>
                        </th>
                    `;
                });
                // Add Total column for the subject
                html += `
                    <th class="px-5 py-4 text-[10px] font-black text-slate-900 uppercase tracking-widest text-center border-l border-slate-200 bg-slate-100/30 min-w-[100px]">
                        ${subject.code} Total
                    </th>
                `;
            } else {
                // Fallback for subjects with no papers? (Shouldn't happen with updated query)
                html += `
                    <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest text-center border-l border-slate-100 min-w-[100px]">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-slate-900">${subject.name}</span>
                        </div>
                    </th>
                `;
            }
        });

        html += `
            <th class="px-5 py-4 text-[10px] font-black text-slate-700 uppercase tracking-widest text-center border-l border-slate-100 bg-slate-100/50 min-w-[100px]">
                Avg / Pts
            </th>
        `;

        headerRow.innerHTML = html;
    }

    function renderStudents(students, subjects, results, weights, grades, papers = []) {
        const tbody = document.getElementById('matrixBody');

        students.forEach(student => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-50 hover:bg-slate-50/50 transition-colors group';

            let subjectTds = '';
            let totalWeightedSum = 0;
            let subjectsWithResults = 0;

            subjects.forEach(subject => {
                // 1. Get all papers for this subject
                const subjectPapers = (papers || []).filter(p => p.subject_id === subject.id);
                const subjectWeights = (weights || []).filter(w => w.subject_id === subject.id);

                let subjectWeightedSum = 0;
                let subjectWeightTotal = 0;
                let subjectRawSum = 0;
                let hasSubjectResults = false;

                if (subjectPapers.length > 0) {
                    subjectPapers.forEach(paper => {
                        // Find all results for this student and paper
                        const paperResults = results.filter(r => r.student_id === student.id && r.paper_id === paper.id);
                        let paperDisplay = '-';

                        if (paperResults.length > 0) {
                            const paperAvg = paperResults.reduce((sum, r) => sum + r.marks, 0) / paperResults.length;
                            paperDisplay = Math.round(paperAvg);

                            // For overall aggregate
                            const weightEntry = subjectWeights.find(w => w.paper_id === paper.id);
                            if (weightEntry) {
                                subjectWeightedSum += (paperAvg * weightEntry.weight) / 100;
                                subjectWeightTotal += weightEntry.weight;
                            }
                            subjectRawSum += paperAvg;
                            hasSubjectResults = true;
                        }

                        subjectTds += `
                                <td class="px-5 py-3 border-l border-slate-50 text-center">
                                    <span class="text-[11px] font-black ${paperDisplay === '-' ? 'text-slate-300' : 'text-slate-700'}">${paperDisplay}</span>
                                </td>
                            `;
                    });

                    // Append the weighted total for this subject
                    const finalSubjectMark = subjectWeightTotal > 0 ? subjectWeightedSum : (subjectRawSum / (subjectPapers.length || 1));
                    const displayTotal = hasSubjectResults ? Math.round(finalSubjectMark) : '-';
                    subjectTds += `
                            <td class="px-5 py-3 border-l border-slate-200 text-center bg-slate-100/10">
                                <span class="text-[11px] font-black ${displayTotal === '-' ? 'text-slate-400' : 'text-slate-900'}">${displayTotal}${displayTotal !== '-' ? '%' : ''}</span>
                            </td>
                        `;

                    if (hasSubjectResults) {
                        totalWeightedSum += finalSubjectMark;
                        subjectsWithResults++;
                    }
                } else {
                    subjectTds += `
                        <td class="px-5 py-3 border-l border-slate-50 text-center">
                            <span class="text-[10px] font-bold text-slate-300">-</span>
                        </td>
                    `;
                }
            });

            const avg = subjectsWithResults > 0 ? Math.round(totalWeightedSum / subjectsWithResults) : 0;

            row.innerHTML = `
                <td class="sticky left-0 z-10 bg-white px-5 py-3 border-r border-slate-100 group-hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500 uppercase">
                            ${student.first_name[0]}${student.last_name[0]}
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] font-black text-slate-900 uppercase tracking-tight">${student.first_name} ${student.last_name}</span>
                            <span class="text-[9px] font-bold text-slate-400 tracking-wider">${student.student_id}</span>
                        </div>
                    </div>
                </td>
                ${subjectTds}
                <td class="px-5 py-3 border-l border-slate-50 text-center bg-slate-50/30">
                    <div class="flex flex-col items-center">
                        <span class="text-[12px] font-black text-slate-900">${avg}</span>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderSkeleton(isAppend = false) {
        const tbody = document.getElementById('matrixBody');
        // Roughly estimate column count: SubCount * (AvgPaperPerSub + 1) + Identity + FinalAvg
        const subCount = currentData?.subjects?.length || 5;
        const totalCols = (subCount * 3) + 2;

        let skeletonHtml = '';
        for (let i = 0; i < 5; i++) {
            let cells = '';
            for (let j = 0; j < totalCols - 1; j++) {
                cells += `
                    <td class="px-5 py-3 border-l border-slate-50 text-center">
                        <div class="h-6 w-10 bg-slate-100 rounded-lg animate-pulse mx-auto"></div>
                    </td>
                `;
            }

            skeletonHtml += `
                <tr class="skeleton-row border-b border-slate-50">
                    <td class="sticky left-0 z-10 bg-white px-5 py-3 border-r border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-slate-100 animate-pulse"></div>
                            <div class="space-y-2">
                                <div class="h-3 w-24 bg-slate-100 rounded animate-pulse"></div>
                                <div class="h-2 w-16 bg-slate-50 rounded animate-pulse"></div>
                            </div>
                        </div>
                    </td>
                    ${cells}
                </tr>
            `;
        }

        if (isAppend) {
            tbody.insertAdjacentHTML('beforeend', skeletonHtml);
        } else {
            tbody.innerHTML = skeletonHtml;
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-2xl shadow-2xl z-[9999] transform transition-all duration-300 translate-y-20 opacity-0 flex items-center gap-3 border ${type === 'success'
            ? 'bg-emerald-50 border-emerald-100 text-emerald-800'
            : 'bg-red-50 border-red-100 text-red-800'
            }`;

        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `
            <i class="fas ${icon} text-lg"></i>
            <span class="text-[11px] font-bold uppercase tracking-widest">${message}</span>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
        }, 100);

        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>