<!-- Exams Management Page -->
<div class="px-4 py-4 lg:px-6 lg:py-5 space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div class="flex flex-col gap-1">
            <h1 id="pageTitle" class="text-xl font-black text-slate-900 tracking-tight uppercase">Assessments Hub</h1>
            <p id="pageDescription" class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Select a class
                to manage assessments</p>
        </div>
        <div class="flex items-center gap-3" id="actionButtons">
            <button id="backToClassesBtn"
                class="hidden bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-200 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </button>
            <button id="addExamBtn"
                class="hidden bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Assessment</span>
            </button>
        </div>
    </div>

    <!-- Classes Section -->
    <div id="classesView" class="space-y-4">
        <div class="flex items-center gap-2">
            <span
                class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest">Available
                Classes</span>
            <div class="h-px bg-slate-100 w-12"></div>
        </div>
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50/50 border-b border-slate-100">
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">Class Name
                        </th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">Code</th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">Students
                        </th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="classesTableBody">
                    <!-- Skeleton Rows -->
                    <tr class="animate-pulse border-b border-slate-50">
                        <td class="px-5 py-4">
                            <div class="h-3 w-24 bg-slate-100 rounded"></div>
                        </td>
                        <td class="px-5 py-4">
                            <div class="h-3 w-16 bg-slate-100 rounded"></div>
                        </td>
                        <td class="px-5 py-4">
                            <div class="h-5 w-20 bg-slate-100 rounded-lg"></div>
                        </td>
                        <td class="px-5 py-4 text-right">
                            <div class="h-8 w-24 bg-slate-100 rounded-lg ml-auto"></div>
                        </td>
                    </tr>
                    <tr class="animate-pulse border-b border-slate-50">
                        <td class="px-5 py-4">
                            <div class="h-3 w-28 bg-slate-100 rounded"></div>
                        </td>
                        <td class="px-5 py-4">
                            <div class="h-3 w-14 bg-slate-100 rounded"></div>
                        </td>
                        <td class="px-5 py-4">
                            <div class="h-5 w-20 bg-slate-100 rounded-lg"></div>
                        </td>
                        <td class="px-5 py-4 text-right">
                            <div class="h-8 w-24 bg-slate-100 rounded-lg ml-auto"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Exams Section -->
    <div id="examsView" class="space-y-4 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span
                    class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest"
                    id="examsTitle">Scheduled Assessments</span>
                <div class="h-px bg-slate-100 w-12"></div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Type Filter -->
                <select id="filterType"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Type</option>
                </select>
                <!-- Subject Filter -->
                <select id="filterSubject"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Subject</option>
                </select>
                <!-- Paper Filter -->
                <select id="filterPaper"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Paper</option>
                </select>
                <div class="relative">
                    <input type="text" id="searchExams" placeholder="Search exams..."
                        class="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden relative min-h-[400px]">
            <!-- Header -->
            <div
                class="grid grid-cols-[1.5fr_1fr_1.2fr_1.2fr_100px_100px] gap-4 bg-slate-50 border-b border-slate-200 px-6 py-3 font-bold text-[10px] uppercase tracking-wider text-slate-500 sticky top-0 z-10">
                <div>Assessment Name</div>
                <div>Type</div>
                <div>Paper</div>
                <div>Date & Time</div>
                <div class="text-center">Status</div>
                <div class="text-right">Actions</div>
            </div>

            <!-- Body -->
            <div id="examsListBody" class="divide-y divide-slate-100">
                <!-- Skeleton Loading -->
                <div id="examsLoadingSkeleton" class="divide-y divide-slate-100">
                    <!-- Row 1 -->
                    <div class="grid grid-cols-[1.5fr_1fr_1.2fr_1.2fr_100px_100px] gap-4 px-6 py-4 animate-pulse">
                        <div class="h-4 bg-slate-100 rounded w-3/4"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-5 bg-slate-100 rounded-full w-16 mx-auto"></div>
                        <div class="h-8 bg-slate-100 rounded w-8 ml-auto"></div>
                    </div>
                    <!-- Row 2 -->
                    <div class="grid grid-cols-[1.5fr_1fr_1.2fr_1.2fr_100px_100px] gap-4 px-6 py-4 animate-pulse">
                        <div class="h-4 bg-slate-100 rounded w-2/3"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-5 bg-slate-100 rounded-full w-16 mx-auto"></div>
                        <div class="h-8 bg-slate-100 rounded w-8 ml-auto"></div>
                    </div>
                    <!-- Row 3 -->
                    <div class="grid grid-cols-[1.5fr_1fr_1.2fr_1.2fr_100px_100px] gap-4 px-6 py-4 animate-pulse">
                        <div class="h-4 bg-slate-100 rounded w-3/4"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                        <div class="h-5 bg-slate-100 rounded-full w-16 mx-auto"></div>
                        <div class="h-8 bg-slate-100 rounded w-8 ml-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="noExamsMessage"
                class="hidden absolute inset-0 flex flex-col items-center justify-center text-center bg-white/80 backdrop-blur-sm z-20">
                <div
                    class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center mb-4 ring-1 ring-slate-100 shadow-sm rotate-3">
                    <i class="fas fa-clipboard-list text-slate-300 text-2xl"></i>
                </div>
                <h3 class="text-sm font-bold text-slate-900">No exams scheduled</h3>
                <p class="text-xs text-slate-500 mt-1 max-w-[200px]">There are no scheduled exams for this class yet.
                </p>
                <button onclick="showAddExamModal()"
                    class="mt-4 px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all text-xs font-bold shadow-lg shadow-slate-200">
                    With Expected Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Exam Modal -->
<div id="examModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden">
        <div class="px-6 py-4 bg-slate-50 border-b border-slate-200">
            <h3 class="text-lg font-black text-slate-900 uppercase tracking-tight" id="examModalTitle">Add Assessment
            </h3>
        </div>
        <form id="examForm" class="px-6 py-5 space-y-4">
            <input type="hidden" id="examId">

            <div>
                <div class="flex items-center justify-between mb-2">
                    <label for="examTypeDisplay"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Assessment
                        Type</label>
                    <a href="/settings"
                        class="text-[9px] font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors">
                        <i class="fas fa-cog text-[8px]"></i>
                        Manage
                    </a>
                </div>
                <div class="relative">
                    <input type="hidden" id="examType" required>
                    <input type="text" id="examTypeDisplay" placeholder="Select Type" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div>
                <label for="examClass"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Class</label>
                <select id="examClass" required
                    class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                    <option value="">Select Class</option>
                </select>
            </div>
            <div>
                <label for="examSubjectDisplay"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Subject</label>
                <div class="relative">
                    <input type="hidden" id="examSubject" name="subject_id" required>
                    <input type="text" id="examSubjectDisplay" placeholder="Select Subject" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
            <div>
                <label for="examPaperDisplay"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Paper</label>
                <div class="relative">
                    <input type="hidden" id="examPaper" name="paper_id" required>
                    <input type="text" id="examPaperDisplay" placeholder="Select Paper" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="examStartTime"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Start
                        Time</label>
                    <input type="datetime-local" id="examStartTime" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                </div>
                <div>
                    <label for="examEndTime"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">End
                        Time</label>
                    <input type="datetime-local" id="examEndTime" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" id="cancelExamBtn"
                    class="px-4 py-2 text-xs font-bold uppercase tracking-wide text-slate-600 bg-slate-100 rounded-xl hover:bg-slate-200 transition-colors">Cancel</button>
                <button type="submit"
                    class="px-4 py-2 text-xs font-bold uppercase tracking-wide text-white bg-slate-900 rounded-xl hover:bg-slate-800 transition-colors shadow-sm">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Subject Selection Modal -->
<div id="subjectSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Subject</h3>
            <button type="button" id="closeSubjectModalBtn"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="subjectListContainer">
            <!-- Subjects will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<!-- Paper Selection Modal -->
<div id="paperSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Paper</h3>
            <button type="button" id="closePaperModalBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="paperListContainer">
            <!-- Papers will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<!-- Assessment Type Selection Modal -->
<div id="assessmentTypeSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Assessment Type</h3>
            <button type="button" id="closeAssessmentTypeModalBtn"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="assessmentTypeListContainer">
            <!-- Assessment Types will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<script>
    let exams = [];
    let classes = [];
    let subjects = [];
    let papers = [];
    let assessmentTypes = [];
    let selectedClass = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadClasses();
        loadSubjects();
        loadPapers();
        loadAssessmentTypes();

        document.getElementById('addExamBtn').addEventListener('click', showAddExamModal);
        document.getElementById('cancelExamBtn').addEventListener('click', hideExamModal);
        document.getElementById('examForm').addEventListener('submit', saveExam);
        document.getElementById('backToClassesBtn').addEventListener('click', showClassesView);

        // Filter Listeners
        document.getElementById('searchExams').addEventListener('input', renderExams);
        document.getElementById('filterType').addEventListener('change', renderExams);
        document.getElementById('filterSubject').addEventListener('change', renderExams);
        document.getElementById('filterPaper').addEventListener('change', renderExams);

        // Assessment Type Modal Listeners
        document.getElementById('examTypeDisplay').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.remove('hidden');
            renderAssessmentTypeList(assessmentTypes);
        });
        document.getElementById('closeAssessmentTypeModalBtn').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
        });

        // Class change listener
        document.getElementById('examClass').addEventListener('change', function () {
            const classId = this.value;
            if (classId) {
                loadSubjectsByClass(classId);
            } else {
                renderSubjectList([]);
                renderPaperList([]);
            }
        });

        // Subject Modal Listeners
        document.getElementById('examSubjectDisplay').addEventListener('click', () => {
            const classId = document.getElementById('examClass').value;
            if (!classId) {
                alert('Please select a class first');
                return;
            }
            // Load subjects for the selected class
            loadSubjectsByClass(classId);
            document.getElementById('subjectSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closeSubjectModalBtn').addEventListener('click', () => {
            document.getElementById('subjectSelectionModal').classList.add('hidden');
        });

        // Paper Modal Listeners
        document.getElementById('examPaperDisplay').addEventListener('click', () => {
            const subjectId = document.getElementById('examSubject').value;
            if (!subjectId) {
                alert('Please select a subject first');
                return;
            }
            document.getElementById('paperSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closePaperModalBtn').addEventListener('click', () => {
            document.getElementById('paperSelectionModal').classList.add('hidden');
        });
    });

    async function loadExams(classId = null) {
        try {
            const url = classId ? `/api/exams?class_id=${classId}` : '/api/exams';
            const response = await fetch(url);
            const data = await response.json();
            exams = Array.isArray(data) ? data : (data?.data || []);
            populateFilterOptions();
            renderExams();
        } catch (error) {
            console.error('Error loading exams:', error);
            exams = [];
            renderExams();
        }
    }

    function renderClasses() {
        const tbody = document.getElementById('classesTableBody');
        tbody.innerHTML = '';

        if (classes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-5 py-8 text-center text-xs text-slate-400">No classes found</td></tr>';
            return;
        }

        classes.forEach(cls => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-50 hover:bg-slate-50/50 cursor-pointer transition-colors';
            row.onclick = () => showClassExams(cls);
            row.innerHTML = `
            <td class="px-5 py-4">
                <div class="text-xs font-semibold text-slate-900">${cls.name}</div>
            </td>
            <td class="px-5 py-4">
                <div class="text-xs text-slate-500">${cls.code || '-'}</div>
            </td>
            <td class="px-5 py-4">
                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-600">
                    ${cls.student_count || 0} students
                </span>
            </td>
            <td class="px-5 py-4 text-right">
                <button class="text-xs font-bold text-slate-900 hover:text-slate-600 flex items-center justify-end gap-1.5 transition-colors">
                    Manage <i class="fas fa-arrow-right text-[10px]"></i>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function showClassExams(cls) {
        selectedClass = cls;
        document.getElementById('classesView').classList.add('hidden');
        document.getElementById('examsView').classList.remove('hidden');
        document.getElementById('addExamBtn').classList.remove('hidden');
        document.getElementById('backToClassesBtn').classList.remove('hidden');
        document.getElementById('pageTitle').textContent = cls.name;
        document.getElementById('pageDescription').textContent = `Manage and schedule assessments for ${cls.name}`;
        document.getElementById('examsTitle').textContent = `Class Assessments`;
        document.title = `${cls.name} - Assessments | Swadiq Schools`;
        loadExams(cls.id);
    }

    function showClassesView() {
        selectedClass = null;
        document.getElementById('classesView').classList.remove('hidden');
        document.getElementById('examsView').classList.add('hidden');
        document.getElementById('addExamBtn').classList.add('hidden');
        document.getElementById('backToClassesBtn').classList.add('hidden');
        document.getElementById('pageTitle').textContent = 'Assessments Hub';
        document.getElementById('pageDescription').textContent = 'Select a class to manage assessments';
        document.title = `Assessments Hub - Swadiq Schools`;
    }

    async function loadClasses() {
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
            console.log('Classes API response:', data);
            classes = Array.isArray(data) ? data : (data.classes || data.data || []);
            console.log('Processed classes:', classes);
            renderClasses();
            populateClassDropdown();
        } catch (error) {
            console.error('Error loading classes:', error);
            classes = [];
        }
    }

    async function loadSubjects() {
        try {
            const response = await fetch('/api/subjects');
            const data = await response.json();
            subjects = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading subjects:', error);
            subjects = [];
        }
    }
    async function loadAssessmentTypes() {
        try {
            const response = await fetch('/api/settings/assessment-types');
            const data = await response.json();
            assessmentTypes = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading assessment types:', error);
            assessmentTypes = [];
        }
    }

    async function loadPapers() {
        try {
            const response = await fetch('/api/papers');
            const data = await response.json();
            papers = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading papers:', error);
            papers = [];
        }
    }



    function populateFilterOptions() {
        const typeFilter = document.getElementById('filterType');
        const subjectFilter = document.getElementById('filterSubject');
        const paperFilter = document.getElementById('filterPaper');

        const currentType = typeFilter.value;
        const currentSubject = subjectFilter.value;
        const currentPaper = paperFilter.value;

        // Get unique types from exams
        const types = [...new Set(exams.map(e => e.type))].filter(Boolean).sort();
        typeFilter.innerHTML = '<option value="">Type</option>' +
            types.map(t => `<option value="${t}" ${currentType === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('');

        // Get unique subjects from exams
        const subjectMap = new Map();
        exams.forEach(e => {
            if (e.paper && e.paper.subject) {
                subjectMap.set(e.paper.subject.id, e.paper.subject.name);
            }
        });
        const subjectsArr = Array.from(subjectMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        subjectFilter.innerHTML = '<option value="">Subject</option>' +
            subjectsArr.map(([id, name]) => `<option value="${id}" ${currentSubject === id ? 'selected' : ''}>${name}</option>`).join('');

        // Get unique papers from exams
        const paperMap = new Map();
        exams.forEach(e => {
            if (e.paper) {
                paperMap.set(e.paper.id, e.paper.name);
            }
        });
        const papersArr = Array.from(paperMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        paperFilter.innerHTML = '<option value="">Paper</option>' +
            papersArr.map(([id, name]) => `<option value="${id}" ${currentPaper === id ? 'selected' : ''}>${name}</option>`).join('');
    }

    function renderAssessmentTypeList(typesToShow = []) {
        const container = document.getElementById('assessmentTypeListContainer');
        container.innerHTML = '';

        if (typesToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No assessment types found</div>';
            return;
        }

        typesToShow.forEach(type => {
            if (!type.is_active) return;

            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';

            const badgeStyle = getBadgeStyle(type.code);

            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${type.name}</div>
                    <span class="px-2 py-0.5 inline-flex text-[9px] font-black uppercase tracking-widest rounded-md border ${badgeStyle} mt-1">
                        ${type.code}
                    </span>
                </div>
                <i class="fas fa-check text-emerald-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examType').value = type.code.toLowerCase();
                document.getElementById('examTypeDisplay').value = type.name;
                document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }

    async function loadPapersByClassAndSubject(classId, subjectId) {
        try {
            const response = await fetch(`/api/papers?class_id=${classId}&subject_id=${subjectId}`);
            const data = await response.json();
            // Handle null/undefined data safely
            const filteredPapers = (data && Array.isArray(data)) ? data : (data?.data || []);
            renderPaperList(filteredPapers);
        } catch (error) {
            console.error('Error loading papers by class and subject:', error);
            renderPaperList([]);
        }
    }

    async function loadSubjectsByClass(classId) {
        try {
            console.log('Loading subjects for class:', classId);
            const response = await fetch(`/api/subjects?class_id=${classId}`);
            console.log('Subjects API response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Subjects data received:', data);

            // Handle null/undefined data safely
            const filteredSubjects = (data && Array.isArray(data)) ? data : (data?.data || []);
            console.log('Filtered subjects:', filteredSubjects);

            renderSubjectList(filteredSubjects);
        } catch (error) {
            console.error('Error loading subjects by class:', error);
            // Fallback: use all subjects if class-specific fetch fails
            console.log('Falling back to all subjects');
            renderSubjectList(subjects);
        }
    }

    function renderExams() {
        const container = document.getElementById('examsListBody');
        const emptyState = document.getElementById('noExamsMessage');
        const skeleton = document.getElementById('examsLoadingSkeleton');
        const searchQuery = document.getElementById('searchExams').value.toLowerCase();
        const typeFilter = document.getElementById('filterType').value.toLowerCase();
        const subjectFilter = document.getElementById('filterSubject').value;
        const paperFilter = document.getElementById('filterPaper').value;

        // Hide skeleton
        if (skeleton) skeleton.classList.add('hidden');

        // Apply filtering
        const filteredExams = exams.filter(exam => {
            const matchesSearch = !searchQuery ||
                exam.name.toLowerCase().includes(searchQuery) ||
                (exam.paper && exam.paper.name.toLowerCase().includes(searchQuery));

            const matchesType = !typeFilter || (exam.type && exam.type.toLowerCase() === typeFilter);

            const matchesSubject = !subjectFilter || (exam.paper && exam.paper.subject && exam.paper.subject.id === subjectFilter);

            const matchesPaper = !paperFilter || (exam.paper && exam.paper.id === paperFilter);

            return matchesSearch && matchesType && matchesSubject && matchesPaper;
        });

        // Clear previous content
        container.innerHTML = '';

        if (filteredExams.length === 0) {
            // If no exams at all, show initial empty state
            if (exams.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                container.innerHTML = '<div class="py-12 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">No assessments match your criteria</div>';
            }
            return;
        } else {
            emptyState.classList.add('hidden');
        }

        filteredExams.forEach(exam => {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-[1.5fr_1fr_1.2fr_1.2fr_100px_100px] gap-4 px-6 py-4 items-center hover:bg-slate-50 transition-colors group relative';

            const isActive = exam.is_active;
            const statusClass = isActive ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500';
            const statusText = isActive ? 'Active' : 'Inactive';

            row.innerHTML = `
            <div>
                <div class="text-sm font-bold text-slate-800">${exam.name}</div>
                <div class="text-[10px] bg-indigo-50/50 text-indigo-600 px-1.5 py-0.5 rounded inline-block mt-1 font-black tracking-wider uppercase">
                    ${selectedClass ? selectedClass.name : 'Class'} 
                </div> 
            </div>

            <!-- Type -->
            <div>
                <span class="px-2 py-0.5 inline-flex text-[9px] font-black uppercase tracking-widest rounded-md border 
                    ${getBadgeStyle(exam.type)}">
                    ${exam.type || 'Exam'}
                </span>
            </div>

            <!-- Paper -->
            <div class="text-xs font-semibold text-slate-600 flex items-center gap-1.5">
                <i class="fas fa-file-alt text-slate-300"></i>
                ${exam.paper ? exam.paper.name : 'N/A'}
            </div>

            <!-- Date -->
            <div class="flex flex-col">
                <span class="text-xs font-bold text-slate-700">${new Date(exam.start_time).toLocaleDateString()}</span>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                    ${new Date(exam.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - 
                    ${new Date(exam.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
            </div>

            <!-- Status -->
            <div class="text-center">
                 <span class="px-2.5 py-1 inline-flex text-[10px] font-black uppercase tracking-wider rounded-lg ${statusClass}">
                    ${statusText}
                </span>
            </div>

            <!-- Actions -->
            <div class="text-right transition-opacity flex justify-end gap-2">
                <button onclick="editExam('${exam.id}')" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="Edit">
                    <i class="fas fa-pen-to-square text-xs"></i>
                </button>
                <button onclick="deleteExam('${exam.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" title="Delete">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            </div>
        `;
            container.appendChild(row);
        });
    }

    function populateClassDropdown() {
        const select = document.getElementById('examClass');
        select.innerHTML = '<option value="">Select Class</option>';
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.name;
            select.appendChild(option);
        });

        // Pre-select current class if viewing class exams
        if (selectedClass) {
            select.value = selectedClass.id;
            select.disabled = true;
        }
    }

    function renderSubjectList(subjectsToShow = []) {
        const container = document.getElementById('subjectListContainer');
        container.innerHTML = '';

        if (subjectsToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No subjects found</div>';
            return;
        }

        subjectsToShow.forEach(subject => {
            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';
            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${subject.name}</div>
                    <div class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${subject.code}</div>
                </div>
                <i class="fas fa-arrow-right text-slate-300 group-hover:text-primary-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
                document.getElementById('subjectSelectionModal').classList.add('hidden');

                // Clear paper selection
                document.getElementById('examPaper').value = '';
                document.getElementById('examPaperDisplay').value = '';

                // Load papers for this subject
                const classId = document.getElementById('examClass').value;
                if (classId) {
                    loadPapersByClassAndSubject(classId, subject.id);
                }
            };
            container.appendChild(item);
        });
    }

    function renderPaperList(papersToShow = []) {
        const container = document.getElementById('paperListContainer');
        container.innerHTML = '';

        if (papersToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No papers found</div>';
            return;
        }

        papersToShow.forEach(paper => {
            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';
            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${paper.name}</div>
                    <div class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${paper.code}</div>
                </div>
                <i class="fas fa-check text-emerald-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examPaper').value = paper.id;
                document.getElementById('examPaperDisplay').value = paper.name;
                document.getElementById('paperSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }
    function showAddExamModal() {
        document.getElementById('examModalTitle').textContent = 'Create Assessment';
        document.getElementById('examForm').reset();
        document.getElementById('examId').value = '';

        // Reset display inputs
        document.getElementById('examType').value = '';
        document.getElementById('examTypeDisplay').value = '';
        document.getElementById('examSubject').value = '';
        document.getElementById('examPaper').value = '';
        document.getElementById('examSubjectDisplay').value = '';
        document.getElementById('examPaperDisplay').value = '';

        // Reset lists
        renderSubjectList([]);
        renderPaperList([]);

        if (selectedClass) {
            document.getElementById('examClass').value = selectedClass.id;
            document.getElementById('examClass').disabled = true; // Use disabled property instead of attribute

            // Trigger loading of subjects for the selected class
            loadSubjectsByClass(selectedClass.id);
        } else {
            document.getElementById('examClass').disabled = false;
        }

        document.getElementById('examModal').classList.remove('hidden');
    }

    function hideExamModal() {
        document.getElementById('examModal').classList.add('hidden');
    }

    async function saveExam(e) {
        e.preventDefault();

        const id = document.getElementById('examId').value;
        const examType = document.getElementById('examType').value;
        const examData = {
            name: document.getElementById('examPaperDisplay').value,
            type: examType,
            class_id: document.getElementById('examClass').value,
            paper_id: document.getElementById('examPaper').value,
            start_time: new Date(document.getElementById('examStartTime').value).toISOString(),
            end_time: new Date(document.getElementById('examEndTime').value).toISOString()
        };

        try {
            let response;
            if (id) {
                response = await fetch(`/api/exams/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            } else {
                response = await fetch('/api/exams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            }

            if (response.ok) {
                hideExamModal();
                loadExams(selectedClass ? selectedClass.id : null);
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            console.error('Error saving exam:', error);
            alert('Failed to save exam');
        }
    }

    function editExam(id) {
        const exam = exams.find(e => e.id === id);
        if (!exam) return;

        document.getElementById('examModalTitle').textContent = 'Edit Assessment';
        document.getElementById('examId').value = exam.id;
        document.getElementById('examType').value = exam.type || 'exam';

        // Populate assessment type display
        const typeObj = assessmentTypes.find(t => t.code.toLowerCase() === (exam.type || 'exam').toLowerCase());
        document.getElementById('examTypeDisplay').value = typeObj ? typeObj.name : (exam.type || 'Exam');

        document.getElementById('examClass').value = exam.class_id;
        document.getElementById('examPaper').value = exam.paper_id;

        // Find the paper from the papers array using paper_id
        const paper = papers.find(p => p.id === exam.paper_id);

        // Populate subject field from paper data
        if (paper && paper.subject) {
            document.getElementById('examSubject').value = paper.subject.id || paper.subject_id;
            document.getElementById('examSubjectDisplay').value = paper.subject.name;
        } else if (paper && paper.subject_id) {
            // Fallback: if paper has subject_id but no subject object, find subject from subjects array
            const subject = subjects.find(s => s.id === paper.subject_id);
            if (subject) {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
            }
        } else if (exam.paper && exam.paper.subject) {
            // Fallback: use exam.paper.subject if available
            document.getElementById('examSubject').value = exam.paper.subject.id;
            document.getElementById('examSubjectDisplay').value = exam.paper.subject.name;
        }

        // Populate paper field
        if (exam.paper) {
            document.getElementById('examPaperDisplay').value = exam.paper.name;
        } else if (paper) {
            document.getElementById('examPaperDisplay').value = paper.name;
        }

        document.getElementById('examStartTime').value = formatDateTimeForInput(exam.start_time);
        document.getElementById('examEndTime').value = formatDateTimeForInput(exam.end_time);
        document.getElementById('examModal').classList.remove('hidden');
    }

    async function deleteExam(id) {
        if (!confirm('Are you sure you want to delete this exam?')) return;

        try {
            const response = await fetch(`/api/exams/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadExams(selectedClass ? selectedClass.id : null);
            } else {
                alert('Failed to delete exam');
            }
        } catch (error) {
            console.error('Error deleting exam:', error);
            alert('Failed to delete exam');
        }
    }

    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString();
    }

    function formatDateTimeForInput(dateString) {
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    function getBadgeStyle(typeCode) {
        if (!typeCode) return 'bg-slate-50 text-slate-400 border-slate-100';
        const type = assessmentTypes.find(t => t.code.toLowerCase() === typeCode.toLowerCase());
        const color = type ? type.color : 'indigo';

        const styles = {
            indigo: 'bg-indigo-50 text-indigo-600 border-indigo-100',
            sky: 'bg-sky-50 text-sky-600 border-sky-100',
            amber: 'bg-amber-50 text-amber-600 border-amber-100',
            rose: 'bg-rose-50 text-rose-600 border-rose-100',
            emerald: 'bg-emerald-50 text-emerald-600 border-emerald-100',
            slate: 'bg-slate-50 text-slate-600 border-slate-100'
        };

        return styles[color] || styles.indigo;
    }

    window.editExam = editExam;
    window.deleteExam = deleteExam;
</script>