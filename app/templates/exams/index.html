<!-- Class Assessments Management -->
<div class="px-4 py-4 lg:px-6 lg:py-5 space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div class="flex flex-col gap-1">
            <h1 id="pageTitle" class="text-xl font-black text-slate-900 tracking-tight uppercase">Loading Class...</h1>
            <p id="pageDescription" class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Manage and
                schedule assessments</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="/assessments"
                class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
            <button id="addExamBtn"
                class="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Assessment</span>
            </button>
        </div>
    </div>

    <!-- Exams Section -->
    <div id="examsView" class="space-y-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span
                    class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest"
                    id="examsTitle">Class Assessments</span>
                <div class="h-px bg-slate-100 w-12"></div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Type Filter -->
                <select id="filterType"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Type</option>
                </select>
                <!-- Subject Filter -->
                <select id="filterSubject"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Subject</option>
                </select>
                <!-- Paper Filter -->
                <select id="filterPaper"
                    class="px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold uppercase tracking-wider text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300">
                    <option value="">Paper</option>
                </select>
                <div class="relative">
                    <input type="text" id="searchExams" placeholder="Search assessments..."
                        class="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                </div>
            </div>
        </div>

        <!-- Exams Dynamic Content Container -->
        <div id="examsContentContainer" class="space-y-6">
            <!-- Loading Skeleton -->
            <div id="examsLoadingSkeleton"
                class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                <!-- Header Skeleton -->
                <div
                    class="grid grid-cols-[100px_repeat(7,1fr)] bg-slate-50 border-b border-slate-200 divide-x divide-slate-200">
                    <div class="p-2 flex items-center justify-center">
                        <div class="w-4 h-4 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                    <div class="p-2 text-center">
                        <div class="h-3 bg-slate-200 rounded animate-pulse mx-auto w-12"></div>
                    </div>
                </div>
                <!-- Rows Skeleton -->
                <div class="divide-y divide-slate-200">
                    <div class="grid grid-cols-[100px_repeat(7,1fr)] divide-x divide-slate-200">
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                        <div class="p-10 bg-white"></div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="noExamsMessage"
                class="hidden py-12 text-center bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center justify-center space-y-4">
                <div
                    class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-200 text-2xl group-hover:scale-110 transition-transform duration-500">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="space-y-1">
                    <p class="text-[10px] font-black text-slate-800 uppercase tracking-widest">No Assessments Scheduled
                    </p>
                    <p class="text-slate-400 text-[10px] font-bold">Get started by creating your first assessment.</p>
                </div>
                <button onclick="showAddExamModal()"
                    class="bg-slate-900 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-sm">
                    New Assessment
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Exam Modal -->
<div id="examModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden">
        <div class="px-6 py-4 bg-slate-50 border-b border-slate-200">
            <h3 class="text-lg font-black text-slate-900 uppercase tracking-tight" id="examModalTitle">Add Assessment
            </h3>
        </div>
        <form id="examForm" class="px-6 py-5 space-y-4">
            <input type="hidden" id="examId">

            <div>
                <div class="flex items-center justify-between mb-2">
                    <label for="examTypeDisplay"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Assessment
                        Type</label>
                    <a href="/settings"
                        class="text-[9px] font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors">
                        <i class="fas fa-cog text-[8px]"></i>
                        Manage
                    </a>
                </div>
                <div class="relative">
                    <input type="hidden" id="examType" required>
                    <input type="hidden" id="assessmentTypeId">
                    <input type="text" id="examTypeDisplay" placeholder="Select Type" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div>
                <label for="examClass"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Class</label>
                <select id="examClass" required
                    class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                    <option value="">Select Class</option>
                </select>
            </div>
            <div>
                <label for="examSubjectDisplay"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Subject</label>
                <div class="relative">
                    <input type="hidden" id="examSubject" name="subject_id" required>
                    <input type="text" id="examSubjectDisplay" placeholder="Select Subject" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
            <div>
                <label for="examPaperDisplay"
                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Paper</label>
                <div class="relative">
                    <input type="hidden" id="examPaper" name="paper_id" required>
                    <input type="text" id="examPaperDisplay" placeholder="Select Paper" readonly
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all cursor-pointer">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="examStartTime"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Start
                        Time</label>
                    <input type="datetime-local" id="examStartTime" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                </div>
                <div>
                    <label for="examEndTime"
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">End
                        Time</label>
                    <input type="datetime-local" id="examEndTime" required
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" id="cancelExamBtn"
                    class="px-4 py-2 text-xs font-bold uppercase tracking-wide text-slate-600 bg-slate-100 rounded-xl hover:bg-slate-200 transition-colors">Cancel</button>
                <button type="submit"
                    class="px-4 py-2 text-xs font-bold uppercase tracking-wide text-white bg-slate-900 rounded-xl hover:bg-slate-800 transition-colors shadow-sm">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Subject Selection Modal -->
<div id="subjectSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Subject</h3>
            <button type="button" id="closeSubjectModalBtn"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="subjectListContainer">
            <!-- Subjects will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<!-- Paper Selection Modal -->
<div id="paperSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Paper</h3>
            <button type="button" id="closePaperModalBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="paperListContainer">
            <!-- Papers will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<!-- Assessment Type Selection Modal -->
<div id="assessmentTypeSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Assessment Type</h3>
            <button type="button" id="closeAssessmentTypeModalBtn"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="assessmentTypeListContainer">
            <!-- Assessment Types will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<script>
    let exams = [];
    let classes = []; // We still need this for the dropdown if needed, though we primarily use fixed class
    let subjects = [];
    let papers = [];
    let assessmentTypes = [];
    const currentClassID = "{{.classID}}";

    document.addEventListener('DOMContentLoaded', async function () {
        // Load static data
        loadSubjects();
        loadPapers();
        loadAssessmentTypes();

        // Load class info and assessments
        await loadClassInfo(currentClassID);
        await loadExams(currentClassID);

        document.getElementById('addExamBtn').addEventListener('click', showAddExamModal);
        document.getElementById('cancelExamBtn').addEventListener('click', hideExamModal);
        document.getElementById('examForm').addEventListener('submit', saveExam);

        // Filter Listeners
        document.getElementById('searchExams').addEventListener('input', renderExams);
        document.getElementById('filterType').addEventListener('change', renderExams);
        document.getElementById('filterSubject').addEventListener('change', renderExams);
        document.getElementById('filterPaper').addEventListener('change', renderExams);

        // Assessment Type Modal Listeners
        document.getElementById('examTypeDisplay').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.remove('hidden');
            renderAssessmentTypeList(assessmentTypes);
        });
        document.getElementById('closeAssessmentTypeModalBtn').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
        });

        // Class change listener
        document.getElementById('examClass').addEventListener('change', function () {
            const classId = this.value;
            if (classId) {
                loadSubjectsByClass(classId);
            } else {
                renderSubjectList([]);
                renderPaperList([]);
            }
        });

        // Subject Modal Listeners
        document.getElementById('examSubjectDisplay').addEventListener('click', () => {
            const classId = document.getElementById('examClass').value;
            if (!classId) {
                alert('Please select a class first');
                return;
            }
            // Load subjects for the selected class
            loadSubjectsByClass(classId);
            document.getElementById('subjectSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closeSubjectModalBtn').addEventListener('click', () => {
            document.getElementById('subjectSelectionModal').classList.add('hidden');
        });

        // Paper Modal Listeners
        document.getElementById('examPaperDisplay').addEventListener('click', () => {
            const subjectId = document.getElementById('examSubject').value;
            if (!subjectId) {
                alert('Please select a subject first');
                return;
            }
            document.getElementById('paperSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closePaperModalBtn').addEventListener('click', () => {
            document.getElementById('paperSelectionModal').classList.add('hidden');
        });
    });

    async function loadExams(classId = null) {
        try {
            const url = classId ? `/api/assessments?class_id=${classId}` : '/api/assessments';
            const response = await fetch(url);
            const data = await response.json();
            console.log('Exams/Assessments data received:', data);
            exams = Array.isArray(data) ? data : (data?.data || []);
            populateFilterOptions();
            renderExams();
        } catch (error) {
            console.error('Error loading exams:', error);
            exams = [];
            renderExams();
        }
    }

    async function loadClassInfo(classId) {
        try {
            const response = await fetch(`/api/classes/${classId}`);
            if (!response.ok) throw new Error('Failed to load class info');
            const cls = await response.json();

            document.getElementById('pageTitle').textContent = cls.name;
            document.getElementById('pageDescription').textContent = `Manage and schedule assessments for ${cls.name}`;
            document.title = `${cls.name} - Assessments | Swadiq Schools`;

            // Set fixed class in modal
            const select = document.getElementById('examClass');
            select.innerHTML = `<option value="${cls.id}" selected>${cls.name}</option>`;
            select.disabled = true;
        } catch (error) {
            console.error('Error loading class info:', error);
            document.getElementById('pageTitle').textContent = 'Class Assessments';
        }
    }

    async function loadClasses() {
        // Minimal load for dropdown fallback if needed, but primarily we use fixed class
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
            classes = Array.isArray(data) ? data : (data.classes || data.data || []);
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    async function loadSubjects() {
        try {
            const response = await fetch('/api/subjects');
            const data = await response.json();
            subjects = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading subjects:', error);
            subjects = [];
        }
    }
    async function loadAssessmentTypes() {
        try {
            const response = await fetch('/api/settings/assessment-types');
            const data = await response.json();
            assessmentTypes = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading assessment types:', error);
            assessmentTypes = [];
        }
    }

    async function loadPapers() {
        try {
            const response = await fetch('/api/papers');
            const data = await response.json();
            papers = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading papers:', error);
            papers = [];
        }
    }



    function populateFilterOptions() {
        const typeFilter = document.getElementById('filterType');
        const subjectFilter = document.getElementById('filterSubject');
        const paperFilter = document.getElementById('filterPaper');

        const currentType = typeFilter.value;
        const currentSubject = subjectFilter.value;
        const currentPaper = paperFilter.value;

        // Get unique types from exams
        const types = [...new Set(exams.map(e => e.type))].filter(Boolean).sort();
        typeFilter.innerHTML = '<option value="">Type</option>' +
            types.map(t => `<option value="${t}" ${currentType === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('');

        // Get unique subjects from exams
        const subjectMap = new Map();
        exams.forEach(e => {
            if (e.paper && e.paper.subject) {
                subjectMap.set(e.paper.subject.id, e.paper.subject.name);
            }
        });
        const subjectsArr = Array.from(subjectMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        subjectFilter.innerHTML = '<option value="">Subject</option>' +
            subjectsArr.map(([id, name]) => `<option value="${id}" ${currentSubject === id ? 'selected' : ''}>${name}</option>`).join('');

        // Get unique papers from exams
        const paperMap = new Map();
        exams.forEach(e => {
            if (e.paper) {
                paperMap.set(e.paper.id, e.paper.name);
            }
        });
        const papersArr = Array.from(paperMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        paperFilter.innerHTML = '<option value="">Paper</option>' +
            papersArr.map(([id, name]) => `<option value="${id}" ${currentPaper === id ? 'selected' : ''}>${name}</option>`).join('');
    }

    function renderAssessmentTypeList(typesToShow = []) {
        const container = document.getElementById('assessmentTypeListContainer');
        container.innerHTML = '';

        if (typesToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No assessment types found</div>';
            return;
        }

        typesToShow.forEach(type => {
            if (!type.is_active) return;

            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';

            const badgeStyle = getBadgeStyle(type.code);

            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${type.name}</div>
                    <span class="px-2 py-0.5 inline-flex text-[9px] font-black uppercase tracking-widest rounded-md border ${badgeStyle} mt-1">
                        ${type.code}
                    </span>
                </div>
                <i class="fas fa-check text-emerald-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examType').value = type.code.toLowerCase();
                document.getElementById('assessmentTypeId').value = type.id;
                document.getElementById('examTypeDisplay').value = type.name;
                document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }

    async function loadPapersByClassAndSubject(classId, subjectId) {
        try {
            const response = await fetch(`/api/papers?class_id=${classId}&subject_id=${subjectId}`);
            const data = await response.json();
            // Handle null/undefined data safely
            const filteredPapers = (data && Array.isArray(data)) ? data : (data?.data || []);
            renderPaperList(filteredPapers);
        } catch (error) {
            console.error('Error loading papers by class and subject:', error);
            renderPaperList([]);
        }
    }

    async function loadSubjectsByClass(classId) {
        try {
            console.log('Loading subjects for class:', classId);
            const response = await fetch(`/api/subjects?class_id=${classId}`);
            console.log('Subjects API response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Subjects data received:', data);

            // Handle null/undefined data safely
            const filteredSubjects = (data && Array.isArray(data)) ? data : (data?.data || []);
            console.log('Filtered subjects:', filteredSubjects);

            renderSubjectList(filteredSubjects);
        } catch (error) {
            console.error('Error loading subjects by class:', error);
            // Fallback: use all subjects if class-specific fetch fails
            console.log('Falling back to all subjects');
            renderSubjectList(subjects);
        }
    }

    function renderExams() {
        console.log('Rendering exams. Total count:', exams.length);
        const contentContainer = document.getElementById('examsContentContainer');
        const emptyState = document.getElementById('noExamsMessage');
        const skeleton = document.getElementById('examsLoadingSkeleton');
        const searchQuery = document.getElementById('searchExams').value.toLowerCase();
        const typeFilter = document.getElementById('filterType').value.toLowerCase();
        const subjectFilter = document.getElementById('filterSubject').value;
        const paperFilter = document.getElementById('filterPaper').value;

        // Hide skeleton
        if (skeleton) skeleton.classList.add('hidden');

        // Apply filtering
        const filteredExams = exams.filter(exam => {
            const matchesSearch = !searchQuery ||
                exam.name.toLowerCase().includes(searchQuery) ||
                (exam.paper && exam.paper.name.toLowerCase().includes(searchQuery));

            const matchesType = !typeFilter || (exam.type && exam.type.toLowerCase() === typeFilter);

            const matchesSubject = !subjectFilter || (exam.paper && exam.paper.subject && exam.paper.subject.id === subjectFilter);

            const matchesPaper = !paperFilter || (exam.paper && exam.paper.id === paperFilter);

            return matchesSearch && matchesType && matchesSubject && matchesPaper;
        });

        console.log('Filtered exams count:', filteredExams.length);

        // Clear only dynamic sections
        const dynamicSections = contentContainer.querySelectorAll('.exams-dynamic-section');
        dynamicSections.forEach(s => s.remove());

        if (filteredExams.length === 0) {
            if (exams.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                const noMatch = document.createElement('div');
                noMatch.className = 'exams-dynamic-section py-12 text-center bg-white rounded-2xl border border-slate-200 shadow-sm text-slate-400 text-xs font-bold uppercase tracking-widest';
                noMatch.innerHTML = 'No assessments match your criteria';
                contentContainer.appendChild(noMatch);
            }
            return;
        } else {
            emptyState.classList.add('hidden');
        }

        // Group exams by display style
        const timetableExams = filteredExams.filter(e => {
            const style = e.assessment_type?.category?.display_style || 'table';
            console.log(`Exam: ${e.name}, Style: ${style}`);
            return style === 'timetable';
        });
        const tableExams = filteredExams.filter(e => e.assessment_type?.category?.display_style === 'table');

        console.log(`Timetable count: ${timetableExams.length}, Table count: ${tableExams.length}`);

        // Render Timetable Section if there are timetable exams
        if (timetableExams.length > 0) {
            renderTimetableSection(timetableExams, contentContainer);
        }

        // Render Table Section if there are table exams
        if (tableExams.length > 0) {
            renderTableSection(tableExams, contentContainer);
        }
    }

    function renderTimetableSection(timetableExams, container) {
        const section = document.createElement('div');
        section.className = 'exams-dynamic-section space-y-4';
        section.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-black text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded-lg border border-indigo-100 uppercase tracking-widest">Timetable View</span>
                <div class="h-px bg-slate-100 flex-1"></div>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative">
                <div class="grid grid-cols-[100px_repeat(7,1fr)] bg-slate-50 border-b border-slate-200 divide-x divide-slate-200 font-bold text-[10px] uppercase tracking-wider text-slate-500 sticky top-0 z-10 shadow-sm">
                    <div class="p-3 flex items-center justify-center bg-white"><i class="fas fa-clock text-slate-300 text-lg"></i></div>
                    ${['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => `
                        <div class="p-2 text-center border-r border-slate-200 last:border-0 bg-slate-50">
                            <span class="block text-indigo-900 font-extrabold text-xs">${day}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-slate-50/50 relative overflow-auto max-h-[500px]">
                    <div class="timetable-rows"></div>
                </div>
            </div>
        `;

        const rowsContainer = section.querySelector('.timetable-rows');
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Get unique hours
        const hourSet = new Set();
        timetableExams.forEach(e => hourSet.add(new Date(e.start_time).getHours()));
        const sortedHours = Array.from(hourSet).sort((a, b) => a - b);

        sortedHours.forEach(hour => {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-[100px_repeat(7,1fr)] divide-x divide-slate-200 border-b border-slate-200';
            const timeLabel = `${hour % 12 || 12}:00 ${hour >= 12 ? 'PM' : 'AM'}`;

            let colsHtml = `<div class="p-3 bg-slate-50 flex items-center justify-center sticky left-0 z-10">
                <span class="text-[10px] font-bold text-slate-500 uppercase">${timeLabel}</span>
            </div>`;

            days.forEach((day, dayIndex) => {
                const cellExams = timetableExams.filter(e => {
                    const d = new Date(e.start_time);
                    return d.getDay() === dayIndex && d.getHours() === hour;
                });

                colsHtml += `<div class="p-2 min-h-[80px] bg-white hover:bg-slate-50/50 transition-colors">
                    ${cellExams.map(exam => `
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-2 mb-2 hover:shadow-md transition-all group cursor-pointer" onclick="editExam('${exam.id}')">
                            <div class="flex items-start justify-between gap-2 mb-1">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[11px] font-bold text-slate-900 truncate">${exam.name}</div>
                                    <div class="text-[9px] text-slate-500 truncate">${exam.paper ? exam.paper.name : 'N/A'}</div>
                                </div>
                                <span class="px-1.5 py-0.5 text-[8px] font-black uppercase tracking-wider rounded border ${getBadgeStyle(exam.type)} whitespace-nowrap">
                                    ${exam.type || 'Exam'}
                                </span>
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-[9px] font-bold text-slate-600">
                                    ${new Date(exam.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="event.stopPropagation(); window.location.href='/assessments/${exam.id}/results'" class="p-1 text-emerald-600 hover:bg-emerald-100 rounded transition-all"><i class="fas fa-clipboard-list text-[10px]"></i></button>
                                    <button onclick="event.stopPropagation(); deleteExam('${exam.id}')" class="p-1 text-red-600 hover:bg-red-100 rounded transition-all"><i class="fas fa-trash-alt text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            });
            row.innerHTML = colsHtml;
            rowsContainer.appendChild(row);
        });

        container.appendChild(section);
    }

    function renderTableSection(tableExams, container) {
        const section = document.createElement('div');
        section.className = 'exams-dynamic-section space-y-4';
        section.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-black text-slate-600 bg-slate-100 px-2.5 py-1 rounded-lg border border-slate-200 uppercase tracking-widest">List View</span>
                <div class="h-px bg-slate-100 flex-1"></div>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-6 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest">Assessment</th>
                            <th class="px-6 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest">Type</th>
                            <th class="px-6 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest">Subject/Paper</th>
                            <th class="px-6 py-3 text-[10px] font-black text-slate-500 uppercase tracking-widest">Schedule</th>
                            <th class="px-6 py-3 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${tableExams.map(exam => `
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <td class="px-6 py-4">
                                    <div class="text-sm font-bold text-slate-900">${exam.name}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-0.5 inline-flex text-[9px] font-black uppercase tracking-widest rounded-md border ${getBadgeStyle(exam.type)}">
                                        ${exam.type || 'Exam'}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs text-slate-600 font-semibold">${exam.paper?.subject?.name || 'N/A'}</div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase">${exam.paper?.name || 'N/A'}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-[11px] font-bold text-slate-700">${new Date(exam.start_time).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                        ${new Date(exam.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - 
                                        ${new Date(exam.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button onclick="window.location.href='/assessments/${exam.id}/results'" class="w-8 h-8 rounded-lg bg-slate-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all shadow-sm"><i class="fas fa-clipboard-list text-[10px]"></i></button>
                                        <button onclick="editExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-slate-50 text-indigo-600 hover:bg-indigo-900 hover:text-white transition-all shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                                        <button onclick="deleteExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:bg-rose-500 hover:text-white transition-all shadow-sm"><i class="fas fa-trash-alt text-[10px]"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.appendChild(section);
    }


    function renderSubjectList(subjectsToShow = []) {
        const container = document.getElementById('subjectListContainer');
        container.innerHTML = '';

        if (subjectsToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No subjects found</div>';
            return;
        }

        subjectsToShow.forEach(subject => {
            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';
            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${subject.name}</div>
                    <div class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${subject.code}</div>
                </div>
                <i class="fas fa-arrow-right text-slate-300 group-hover:text-primary-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
                document.getElementById('subjectSelectionModal').classList.add('hidden');

                // Clear paper selection
                document.getElementById('examPaper').value = '';
                document.getElementById('examPaperDisplay').value = '';

                // Load papers for this subject
                const classId = document.getElementById('examClass').value;
                if (classId) {
                    loadPapersByClassAndSubject(classId, subject.id);
                }
            };
            container.appendChild(item);
        });
    }

    function renderPaperList(papersToShow = []) {
        const container = document.getElementById('paperListContainer');
        container.innerHTML = '';

        if (papersToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No papers found</div>';
            return;
        }

        papersToShow.forEach(paper => {
            const item = document.createElement('div');
            item.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';
            item.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${paper.name}</div>
                    <div class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${paper.code}</div>
                </div>
                <i class="fas fa-check text-emerald-500 transition-all text-xs"></i>
            `;
            item.onclick = () => {
                document.getElementById('examPaper').value = paper.id;
                document.getElementById('examPaperDisplay').value = paper.name;
                document.getElementById('paperSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }
    function showAddExamModal() {
        document.getElementById('examModalTitle').textContent = 'Create Assessment';
        document.getElementById('examForm').reset();
        document.getElementById('examId').value = '';

        // Reset display inputs
        document.getElementById('examType').value = '';
        document.getElementById('assessmentTypeId').value = '';
        document.getElementById('examTypeDisplay').value = '';
        document.getElementById('examSubject').value = '';
        document.getElementById('examPaper').value = '';
        document.getElementById('examSubjectDisplay').value = '';
        document.getElementById('examPaperDisplay').value = '';

        // Reset lists
        renderSubjectList([]);
        renderPaperList([]);

        if (currentClassID) {
            document.getElementById('examClass').value = currentClassID;
            document.getElementById('examClass').disabled = true;

            // Trigger loading of subjects for the current class
            loadSubjectsByClass(currentClassID);
        }

        document.getElementById('examModal').classList.remove('hidden');
    }

    function hideExamModal() {
        document.getElementById('examModal').classList.add('hidden');
    }

    async function saveExam(e) {
        e.preventDefault();

        const id = document.getElementById('examId').value;
        const examType = document.getElementById('examType').value;
        const examData = {
            name: document.getElementById('examPaperDisplay').value,
            type: examType,
            assessment_type_id: document.getElementById('assessmentTypeId').value,
            class_id: document.getElementById('examClass').value,
            paper_id: document.getElementById('examPaper').value,
            start_time: new Date(document.getElementById('examStartTime').value).toISOString(),
            end_time: new Date(document.getElementById('examEndTime').value).toISOString()
        };

        try {
            let response;
            if (id) {
                response = await fetch(`/api/assessments/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            } else {
                response = await fetch('/api/assessments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            }

            if (response.ok) {
                hideExamModal();
                loadExams(currentClassID);
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            console.error('Error saving exam:', error);
            alert('Failed to save exam');
        }
    }

    function editExam(id) {
        const exam = exams.find(e => e.id === id);
        if (!exam) return;

        document.getElementById('examModalTitle').textContent = 'Edit Assessment';
        document.getElementById('examId').value = exam.id;
        document.getElementById('examType').value = exam.type || 'exam';

        // Populate assessment type display and ID
        const typeObj = assessmentTypes.find(t => t.code.toLowerCase() === (exam.type || 'exam').toLowerCase());
        document.getElementById('assessmentTypeId').value = exam.assessment_type_id || (typeObj ? typeObj.id : '');
        document.getElementById('examTypeDisplay').value = typeObj ? typeObj.name : (exam.type || 'Exam');

        document.getElementById('examClass').value = exam.class_id;
        document.getElementById('examPaper').value = exam.paper_id;

        // Find the paper from the papers array using paper_id
        const paper = papers.find(p => p.id === exam.paper_id);

        // Populate subject field from paper data
        if (paper && paper.subject) {
            document.getElementById('examSubject').value = paper.subject.id || paper.subject_id;
            document.getElementById('examSubjectDisplay').value = paper.subject.name;
        } else if (paper && paper.subject_id) {
            // Fallback: if paper has subject_id but no subject object, find subject from subjects array
            const subject = subjects.find(s => s.id === paper.subject_id);
            if (subject) {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
            }
        } else if (exam.paper && exam.paper.subject) {
            // Fallback: use exam.paper.subject if available
            document.getElementById('examSubject').value = exam.paper.subject.id;
            document.getElementById('examSubjectDisplay').value = exam.paper.subject.name;
        }

        // Populate paper field
        if (exam.paper) {
            document.getElementById('examPaperDisplay').value = exam.paper.name;
        } else if (paper) {
            document.getElementById('examPaperDisplay').value = paper.name;
        }

        document.getElementById('examStartTime').value = formatDateTimeForInput(exam.start_time);
        document.getElementById('examEndTime').value = formatDateTimeForInput(exam.end_time);
        document.getElementById('examModal').classList.remove('hidden');
    }

    async function deleteExam(id) {
        if (!confirm('Are you sure you want to delete this exam?')) return;

        try {
            const response = await fetch(`/api/assessments/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadExams(currentClassID);
            } else {
                alert('Failed to delete exam');
            }
        } catch (error) {
            console.error('Error deleting exam:', error);
            alert('Failed to delete exam');
        }
    }

    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString();
    }

    function formatDateTimeForInput(dateString) {
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    function getBadgeStyle(typeCode) {
        if (!typeCode) return 'bg-slate-50 text-slate-400 border-slate-100';
        const type = assessmentTypes.find(t => t.code.toLowerCase() === typeCode.toLowerCase());
        const color = type ? type.color : 'indigo';

        const styles = {
            indigo: 'bg-indigo-50 text-indigo-600 border-indigo-100',
            sky: 'bg-sky-50 text-sky-600 border-sky-100',
            amber: 'bg-amber-50 text-amber-600 border-amber-100',
            rose: 'bg-rose-50 text-rose-600 border-rose-100',
            emerald: 'bg-emerald-50 text-emerald-600 border-emerald-100',
            slate: 'bg-slate-50 text-slate-600 border-slate-100'
        };

        return styles[color] || styles.indigo;
    }

    window.editExam = editExam;
    window.deleteExam = deleteExam;
</script>