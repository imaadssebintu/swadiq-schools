<!-- Class Assessments Management -->
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-4 lg:px-6 lg:py-5 space-y-6">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex flex-col gap-1">
                <h1 id="pageTitle" class="text-xl font-black text-slate-900 tracking-tight uppercase">Loading Class...
                </h1>
                <p id="pageDescription" class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Manage and
                    schedule assessments</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/assessments"
                    class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fas fa-arrow-left text-[8px]"></i>
                    <span>Back</span>
                </a>
                <button onclick="showWeightsModal()"
                    class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fas fa-balance-scale text-[8px]"></i>
                    <span>Weights</span>
                </button>
                <button id="addExamBtn" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest
                hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fas fa-plus text-[8px]"></i>
                    <span>New Assessment</span>
                </button>
            </div>
        </div>

        <!-- Exams Section -->
        <div id="examsView" class="space-y-4">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                    <span
                        class="text-[10px] font-black text-slate-900 bg-slate-100 px-2.5 py-1 rounded-md uppercase tracking-widest"
                        id="examsTitle">Class Assessments</span>
                    <div class="h-px bg-slate-100 w-12"></div>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Type Filter -->
                    <div class="relative min-w-[100px]">
                        <select id="filterType"
                            class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300 shadow-sm">
                            <option value="">Type</option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
                    </div>
                    <!-- Subject Filter -->
                    <div class="relative min-w-[120px]">
                        <select id="filterSubject"
                            class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300 shadow-sm">
                            <option value="">Subject</option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
                    </div>
                    <!-- Paper Filter -->
                    <div class="relative min-w-[120px]">
                        <select id="filterPaper"
                            class="w-full pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-all appearance-none cursor-pointer hover:border-slate-300 shadow-sm">
                            <option value="">Paper</option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[8px] pointer-events-none"></i>
                    </div>
                    <div class="relative flex-1 sm:min-w-[200px]">
                        <input type="text" id="searchExams" placeholder="Search assessments..."
                            class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all shadow-sm">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Exams Dynamic Content Container -->
            <div id="examsContentContainer" class="space-y-6">
                <!-- Loading Skeleton -->
                <div id="examsLoadingSkeleton"
                    class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                    <div class="h-10 bg-slate-50 border-b border-slate-100 flex items-center px-6">
                        <div class="h-3 w-32 bg-slate-200 rounded animate-pulse"></div>
                    </div>
                    <div class="divide-y divide-slate-50">
                        <div class="h-16 flex items-center px-6 gap-4">
                            <div class="h-4 w-4 bg-slate-100 rounded"></div>
                            <div class="h-4 w-32 bg-slate-100 rounded"></div>
                            <div class="h-4 w-24 bg-slate-100 rounded ml-auto"></div>
                        </div>
                        <div class="h-16 flex items-center px-6 gap-4">
                            <div class="h-4 w-4 bg-slate-100 rounded"></div>
                            <div class="h-4 w-40 bg-slate-100 rounded"></div>
                            <div class="h-4 w-24 bg-slate-100 rounded ml-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="noExamsMessage"
                    class="hidden py-16 text-center bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center justify-center space-y-4">
                    <div
                        class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-200 text-3xl">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs font-black text-slate-800 uppercase tracking-widest">No Assessments Scheduled
                        </p>
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Get started by creating
                            your first assessment.</p>
                    </div>
                    <button onclick="showAddExamModal()"
                        class="bg-slate-900 text-white px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-sm transform hover:scale-105 active:scale-95">
                        New Assessment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Add/Edit Assessment Modal -->
<div id="examModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) hideExamModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300 flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50 shrink-0">
            <div>
                <h3 id="examModalTitle" class="text-sm font-black text-slate-900 uppercase tracking-wide">Create
                    Assessment</h3>
                <p class="text-slate-500 text-[9px] font-bold uppercase tracking-widest mt-0.5">Fill in the details for
                    the new assessment</p>
            </div>
            <button onclick="hideExamModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="examForm" class="p-6 space-y-4 overflow-y-auto custom-scrollbar">
            <input type="hidden" id="examId" name="id">
            <input type="hidden" id="examClass" name="class_id" required>
            <input type="hidden" id="examType" name="type">


            <div class="space-y-1">
                <label for="examTypeDisplay"
                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Assessment Type</label>
                <div class="relative group">
                    <input type="hidden" id="assessmentTypeId" name="assessment_type_id" required>
                    <input type="text" id="examTypeDisplay" placeholder="Select Type" readonly
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all cursor-pointer bg-white group-hover:border-indigo-300">
                    <i
                        class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 text-[9px] pointer-events-none group-hover:text-indigo-500 transition-colors"></i>
                </div>
            </div>

            <div class="space-y-1">
                <label for="examSubjectDisplay"
                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Subject</label>
                <div class="relative group">
                    <input type="hidden" id="examSubject" name="subject_id" required>
                    <input type="text" id="examSubjectDisplay" placeholder="Select Subject" readonly
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all cursor-pointer bg-white group-hover:border-indigo-300">
                    <i
                        class="fas fa-book absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 text-[9px] pointer-events-none group-hover:text-indigo-500 transition-colors"></i>
                </div>
            </div>

            <div class="space-y-1">
                <label for="examPaperDisplay"
                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Paper</label>
                <div class="relative group">
                    <input type="hidden" id="examPaper" name="paper_id" required>
                    <input type="text" id="examPaperDisplay" placeholder="Select Paper" readonly
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all cursor-pointer bg-white group-hover:border-indigo-300">
                    <i
                        class="fas fa-file-alt absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 text-[9px] pointer-events-none group-hover:text-indigo-500 transition-colors"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label for="examStartTime"
                        class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Start Time</label>
                    <input type="datetime-local" id="examStartTime" name="start_time" required
                        class="w-full text-[11px] font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all [color-scheme:light]">
                </div>
                <div class="space-y-1">
                    <label for="examEndTime" class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">End
                        Time</label>
                    <input type="datetime-local" id="examEndTime" name="end_time" required
                        class="w-full text-[11px] font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all [color-scheme:light]">
                </div>
            </div>

            <div class="pt-2 flex flex-row gap-3">
                <button type="button" id="cancelExamBtn" onclick="hideExamModal()"
                    class="flex-1 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-xl transition-all order-1">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2 order-2">
                    <i class="fas fa-check-circle text-[9px]"></i>
                    <span>Save</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Subject Selection Modal -->
<div id="subjectSelectionModal"
    class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center hidden z-[110] transition-all duration-300">
    <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh] transform scale-100">
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div class="flex flex-col gap-0.5">
                <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Select Subject</h3>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Choose a subject for
                    this assessment</p>
            </div>
            <button type="button" id="closeSubjectModalBtn"
                class="w-8 h-8 rounded-xl bg-white border border-slate-100 text-slate-400 hover:text-rose-600 hover:border-rose-100 hover:bg-rose-50 transition-all flex items-center justify-center shadow-sm">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1 custom-scrollbar" id="subjectListContainer">
            <!-- Subjects will be loaded here -->
            <div class="text-center py-12 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-xl mb-3 text-indigo-400"></i>
                <p class="text-[10px] font-bold uppercase tracking-widest animate-pulse">Scanning Subjects...</p>
            </div>
        </div>
    </div>
</div>

<!-- Paper Selection Modal -->
<div id="paperSelectionModal"
    class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center hidden z-[110] transition-all duration-300">
    <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh] transform scale-100">
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div class="flex flex-col gap-0.5">
                <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Select Paper</h3>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Choose a paper for this
                    subject</p>
            </div>
            <button type="button" id="closePaperModalBtn"
                class="w-8 h-8 rounded-xl bg-white border border-slate-100 text-slate-400 hover:text-rose-600 hover:border-rose-100 hover:bg-rose-50 transition-all flex items-center justify-center shadow-sm">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1 custom-scrollbar" id="paperListContainer">
            <!-- Papers will be loaded here -->
            <div class="text-center py-12 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-xl mb-3 text-indigo-400"></i>
                <p class="text-[10px] font-bold uppercase tracking-widest animate-pulse">Scanning Papers...</p>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Type Selection Modal -->
<div id="assessmentTypeSelectionModal"
    class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center hidden z-[110] transition-all duration-300">
    <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh] transform scale-100">
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div class="flex flex-col gap-0.5">
                <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Assessment Type</h3>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Select the type of
                    assessment</p>
            </div>
            <button type="button" id="closeAssessmentTypeModalBtn"
                class="w-8 h-8 rounded-xl bg-white border border-slate-100 text-slate-400 hover:text-rose-600 hover:border-rose-100 hover:bg-rose-50 transition-all flex items-center justify-center shadow-sm">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1 custom-scrollbar" id="assessmentTypeListContainer">
            <!-- Assessment Types will be loaded here -->
            <div class="text-center py-12 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-xl mb-3 text-indigo-400"></i>
                <p class="text-[10px] font-bold uppercase tracking-widest animate-pulse">Scanning Types...</p>
            </div>
        </div>
    </div>
</div>

<!-- Weight Configuration Modal -->
<div id="weightsModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center hidden z-[100] transition-all duration-300"
    onclick="if(event.target === this) hideWeightsModal()">
    <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50 shrink-0">
            <div>
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Configure Paper Weights</h3>
                <p class="text-slate-500 text-[9px] font-bold uppercase tracking-widest mt-0.5">Set how papers
                    contribute to subject total</p>
            </div>
            <button type="button" onclick="hideWeightsModal()"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
            <!-- Selectors -->
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide ml-1">Subject</label>
                    <select id="weightSubject"
                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all appearance-none cursor-pointer">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide ml-1">Term</label>
                    <select id="weightTerm"
                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all appearance-none cursor-pointer">
                        <option value="">Select Term</option>
                    </select>
                </div>
            </div>

            <!-- Papers List -->
            <div id="weightPapersList" class="space-y-3 hidden">
                <div
                    class="flex items-center justify-between text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">
                    <span>Paper</span>
                    <span>Weight (%)</span>
                </div>
                <div id="papersWeightContainer" class="space-y-2">
                    <!-- Dynamic Rows -->
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                    <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Total
                        Contribution</span>
                    <span id="totalWeightDisplay"
                        class="text-xs font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md border border-indigo-100 shadow-sm">0%</span>
                </div>
            </div>

            <div id="weightLoading" class="hidden text-center py-8">
                <i class="fas fa-circle-notch fa-spin text-indigo-400 text-lg mb-2"></i>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest animate-pulse">Calculating...
                </p>
            </div>

            <div class="pt-2 flex flex-row gap-3">
                <button type="button" onclick="hideWeightsModal()"
                    class="flex-1 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-xl transition-all order-1">
                    Cancel
                </button>
                <button type="button" onclick="saveWeights()"
                    class="flex-1 bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2 order-2">
                    <i class="fas fa-save text-[9px]"></i>
                    <span>Save Changes</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Weights Logic ---
    let terms = [];

    async function loadTerms() {
        try {
            const response = await fetch('/api/terms'); // Assuming there is a terms API
            const data = await response.json();
            terms = Array.isArray(data) ? data : (data.data || []);

            const termSelect = document.getElementById('weightTerm');
            termSelect.innerHTML = '<option value="">Select Term</option>' +
                terms.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        } catch (error) {
            console.error('Error loading terms:', error);
        }
    }

    function showWeightsModal() {
        document.getElementById('weightsModal').classList.remove('hidden');

        const subjectSelect = document.getElementById('weightSubject');
        const termSelect = document.getElementById('weightTerm');

        // Only populate if empty (avoid losing selection on every open)
        if (subjectSelect.options.length <= 1) {
            console.log('Populating weight subjects select');
            subjectSelect.innerHTML = '<option value="">Select Subject</option>' +
                subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        if (terms.length === 0) {
            loadTerms();
        }

        // If both are selected (from previous session), trigger loadWeightPapers to refresh the configs
        if (subjectSelect.value && termSelect.value) {
            console.log('Reopening modal with existing selection, loading papers...');
            loadWeightPapers();
        }
    }

    function hideWeightsModal() {
        document.getElementById('weightsModal').classList.add('hidden');
        // Do not clear the selections so they persist when reopening
    }

    document.getElementById('weightSubject').addEventListener('change', loadWeightPapers);
    document.getElementById('weightTerm').addEventListener('change', loadWeightPapers);

    async function loadWeightPapers() {
        const subjectId = document.getElementById('weightSubject').value;
        const termId = document.getElementById('weightTerm').value;
        const classId = currentClassID;

        if (!subjectId || !termId) {
            document.getElementById('weightPapersList').classList.add('hidden');
            return;
        }

        document.getElementById('weightLoading').classList.remove('hidden');
        document.getElementById('weightPapersList').classList.add('hidden');

        try {
            // 1. Get Papers for this subject
            console.log(`Fetching papers for subject: ${subjectId}`);
            const paperRes = await fetch(`/api/subjects/papers?class_id=${classId}&subject_id=${subjectId}`);
            const paperData = await paperRes.json();
            const papersList = Array.isArray(paperData) ? paperData : (paperData.data || []);
            console.log(`Found ${papersList.length} papers`);

            // 2. Get Existing Weights
            console.log(`Fetching existing weights for subject: ${subjectId}, term: ${termId}`);
            const weightRes = await fetch(`/api/subjects/papers/weights?class_id=${classId}&subject_id=${subjectId}&term_id=${termId}`);
            let weights = [];
            if (weightRes.ok) {
                const weightData = await weightRes.json();
                weights = Array.isArray(weightData) ? weightData : (weightData.data || []);
                console.log(`Found ${weights.length} existing weight records`);
            } else {
                console.warn('Failed to fetch existing weights or none found');
            }

            const container = document.getElementById('papersWeightContainer');
            container.innerHTML = '';

            papersList.forEach(p => {
                const existing = weights.find(w => w.paper_id === p.id);
                const val = existing ? existing.weight : '';

                const row = document.createElement('div');
                row.className = 'flex items-center justify-between gap-4';
                row.innerHTML = `
                    <div class="flex-1">
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${p.name}</div>
                        <div class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${p.code}</div>
                    </div>
                    <div class="relative w-28">
                        <input type="number" min="0" max="100" data-paper-id="${p.id}" value="${val}"
                            class="weight-input w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-black text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-right pr-7"
                            placeholder="0">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-300">%</span>
                    </div>
                `;
                container.appendChild(row);
            });

            document.getElementById('weightLoading').classList.add('hidden');
            document.getElementById('weightPapersList').classList.remove('hidden');

            // Add listeners to calculate total
            document.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('input', updateTotalWeight);
            });
            updateTotalWeight();

        } catch (error) {
            console.error(error);
            alert('Failed to load papers/weights');
            document.getElementById('weightLoading').classList.add('hidden');
        }
    }

    function updateTotalWeight() {
        let total = 0;
        document.querySelectorAll('.weight-input').forEach(input => {
            total += parseInt(input.value || 0);
        });
        const display = document.getElementById('totalWeightDisplay');
        display.textContent = total + '%';
        if (total === 100) {
            display.className = 'text-xs font-black text-emerald-600';
        } else {
            display.className = 'text-xs font-black text-rose-500';
        }
    }

    async function saveWeights() {
        let total = 0;
        const weights = [];
        const inputs = document.querySelectorAll('.weight-input');

        inputs.forEach(input => {
            const val = parseInt(input.value || 0);
            total += val;
            weights.push({
                paper_id: input.dataset.paperId,
                weight: val
            });
        });

        if (total !== 100 && weights.length > 0) {
            alert('Total weight must sum up to 100%');
            return;
        }

        const payload = {
            class_id: currentClassID,
            subject_id: document.getElementById('weightSubject').value,
            term_id: document.getElementById('weightTerm').value,
            weights: weights
        };

        try {
            const res = await fetch('/api/subjects/papers/weights', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('Weights saved successfully');
                hideWeightsModal();
            } else {
                const err = await res.json();
                alert(err.error || 'Failed to save');
            }
        } catch (e) {
            console.error(e);
            alert('Error saving weights');
        }
    }
    let exams = [];
    let classes = []; // We still need this for the dropdown if needed, though we primarily use fixed class
    let subjects = [];
    let papers = [];
    let assessmentTypes = [];
    const currentClassID = "{{.classID}}";

    document.addEventListener('DOMContentLoaded', async function () {
        // Load static data
        loadSubjects();
        loadPapers();
        loadAssessmentTypes();

        // Load class info and assessments
        await loadClassInfo(currentClassID);
        await loadExams(currentClassID);

        // Initialize elements safely
        const safeAddEventListener = (id, event, handler) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener(event, handler);
        };

        safeAddEventListener('addExamBtn', 'click', showAddExamModal);
        safeAddEventListener('cancelExamBtn', 'click', hideExamModal);
        safeAddEventListener('examForm', 'submit', saveExam);

        // Filter Listeners
        safeAddEventListener('searchExams', 'input', renderExams);
        safeAddEventListener('filterType', 'change', renderExams);
        safeAddEventListener('filterSubject', 'change', renderExams);
        safeAddEventListener('filterPaper', 'change', renderExams);

        // Assessment Type Modal Listeners
        document.getElementById('examTypeDisplay').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.remove('hidden');
            renderAssessmentTypeList(assessmentTypes);
        });
        document.getElementById('closeAssessmentTypeModalBtn').addEventListener('click', () => {
            document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
        });

        // Class change listener
        document.getElementById('examClass').addEventListener('change', function () {
            const classId = this.value;
            if (classId) {
                loadSubjectsByClass(classId);
            } else {
                renderSubjectList([]);
                renderPaperList([]);
            }
        });

        // Subject Modal Listeners
        document.getElementById('examSubjectDisplay').addEventListener('click', () => {
            const classId = document.getElementById('examClass').value;
            if (!classId) {
                alert('Please select a class first');
                return;
            }
            // Load subjects for the selected class
            loadSubjectsByClass(classId);
            document.getElementById('subjectSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closeSubjectModalBtn').addEventListener('click', () => {
            document.getElementById('subjectSelectionModal').classList.add('hidden');
        });

        // Paper Modal Listeners
        document.getElementById('examPaperDisplay').addEventListener('click', () => {
            const subjectId = document.getElementById('examSubject').value;
            if (!subjectId) {
                alert('Please select a subject first');
                return;
            }
            document.getElementById('paperSelectionModal').classList.remove('hidden');
        });
        document.getElementById('closePaperModalBtn').addEventListener('click', () => {
            document.getElementById('paperSelectionModal').classList.add('hidden');
        });
    });

    async function loadExams(classId = null) {
        try {
            const url = classId ? `/api/assessments?class_id=${classId}` : '/api/assessments';
            const response = await fetch(url);
            const data = await response.json();
            console.log('Exams/Assessments data received:', data);
            exams = Array.isArray(data) ? data : (data?.data || []);
            populateFilterOptions();
            renderExams();
        } catch (error) {
            console.error('Error loading exams:', error);
            exams = [];
            renderExams();
        }
    }

    async function loadClassInfo(classId) {
        try {
            const response = await fetch(`/api/classes/${classId}`);
            if (!response.ok) throw new Error('Failed to load class info');
            const data = await response.json();
            const cls = data.class || data;

            document.getElementById('pageTitle').textContent = cls.name;
            document.getElementById('pageDescription').textContent = `Manage and schedule assessments for ${cls.name}`;
            document.title = `${cls.name} - Assessments | Swadiq Schools`;

            // Set fixed class in modal
            const classInput = document.getElementById('examClass');
            if (classInput) {
                classInput.value = cls.id;
            }
        } catch (error) {
            console.error('Error loading class info:', error);
            document.getElementById('pageTitle').textContent = 'Class Assessments';
        }
    }

    async function loadClasses() {
        // Minimal load for dropdown fallback if needed, but primarily we use fixed class
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
            classes = Array.isArray(data) ? data : (data.classes || data.data || []);
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    async function loadSubjects() {
        try {
            const response = await fetch('/api/subjects');
            const data = await response.json();
            subjects = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading subjects:', error);
            subjects = [];
        }
    }
    async function loadAssessmentTypes() {
        try {
            const response = await fetch('/api/settings/assessment-types');
            const data = await response.json();
            assessmentTypes = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading assessment types:', error);
            assessmentTypes = [];
        }
    }

    async function loadPapers() {
        try {
            const response = await fetch('/api/subjects/papers');
            const data = await response.json();
            papers = Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('Error loading papers:', error);
            papers = [];
        }
    }



    function populateFilterOptions() {
        const typeFilter = document.getElementById('filterType');
        const subjectFilter = document.getElementById('filterSubject');
        const paperFilter = document.getElementById('filterPaper');

        const currentType = typeFilter.value;
        const currentSubject = subjectFilter.value;
        const currentPaper = paperFilter.value;

        // Get unique types from exams
        const types = [...new Set(exams.map(e => e.type))].filter(Boolean).sort();
        typeFilter.innerHTML = '<option value="">Type</option>' +
            types.map(t => `<option value="${t}" ${currentType === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('');

        // Get unique subjects from exams
        const subjectMap = new Map();
        exams.forEach(e => {
            if (e.paper && e.paper.subject) {
                subjectMap.set(e.paper.subject.id, e.paper.subject.name);
            }
        });
        const subjectsArr = Array.from(subjectMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        subjectFilter.innerHTML = '<option value="">Subject</option>' +
            subjectsArr.map(([id, name]) => `<option value="${id}" ${currentSubject === id ? 'selected' : ''}>${name}</option>`).join('');

        // Get unique papers from exams
        const paperMap = new Map();
        exams.forEach(e => {
            if (e.paper) {
                paperMap.set(e.paper.id, e.paper.name);
            }
        });
        const papersArr = Array.from(paperMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
        paperFilter.innerHTML = '<option value="">Paper</option>' +
            papersArr.map(([id, name]) => `<option value="${id}" ${currentPaper === id ? 'selected' : ''}>${name}</option>`).join('');
    }

    function getBadgeStyle(type) {
        const t = (type || '').toLowerCase();
        if (t.includes('exam') || t.includes('mid') || t.includes('final')) {
            return 'bg-indigo-50 text-indigo-700 border-indigo-100';
        }
        if (t.includes('test') || t.includes('quiz')) {
            return 'bg-emerald-50 text-emerald-700 border-emerald-100';
        }
        if (t.includes('assign') || t.includes('project')) {
            return 'bg-amber-50 text-amber-700 border-amber-100';
        }
        return 'bg-slate-50 text-slate-700 border-slate-100';
    }

    function renderAssessmentTypeList(typesToShow = []) {
        const container = document.getElementById('assessmentTypeListContainer');
        container.innerHTML = '';

        if (typesToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No assessment types found</div>';
            return;
        }

        typesToShow.forEach(type => {
            if (!type.is_active) return;

            const item = document.createElement('div');
            item.className = 'group p-3 mb-2 rounded-xl border border-slate-100 bg-white hover:border-indigo-100 hover:bg-indigo-50/30 cursor-pointer transition-all duration-300 flex items-center justify-between';

            const badgeStyle = getBadgeStyle(type.code);

            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-500 group-hover:scale-110 transition-transform shadow-sm border border-indigo-100/50">
                        <i class="fas fa-tag text-[10px]"></i>
                    </div>
                    <div>
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-tight group-hover:text-indigo-600 transition-colors">${type.name}</div>
                        <span class="px-1.5 py-0.5 inline-flex text-[7px] font-black uppercase tracking-widest rounded-md border ${badgeStyle} mt-1 shadow-sm">
                            ${type.code}
                        </span>
                    </div>
                </div>
                <div class="w-5 h-5 rounded-full border-2 border-slate-100 group-hover:border-indigo-200 flex items-center justify-center transition-all">
                    <i class="fas fa-check text-[8px] text-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
            `;
            item.onclick = () => {
                document.getElementById('examType').value = type.code.toLowerCase();
                document.getElementById('assessmentTypeId').value = type.id;
                document.getElementById('examTypeDisplay').value = type.name;
                document.getElementById('assessmentTypeSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }

    async function loadPapersByClassAndSubject(classId, subjectId) {
        try {
            const response = await fetch(`/api/subjects/papers?class_id=${classId}&subject_id=${subjectId}`);
            const data = await response.json();
            // Handle null/undefined data safely
            const filteredPapers = (data && Array.isArray(data)) ? data : (data?.data || []);
            renderPaperList(filteredPapers);
        } catch (error) {
            console.error('Error loading papers by class and subject:', error);
            renderPaperList([]);
        }
    }

    async function loadSubjectsByClass(classId) {
        try {
            console.log('Loading subjects for class:', classId);
            const response = await fetch(`/api/subjects?class_id=${classId}`);
            console.log('Subjects API response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Subjects data received:', data);

            // Handle null/undefined data safely
            const filteredSubjects = (data && Array.isArray(data)) ? data : (data?.data || []);
            console.log('Filtered subjects:', filteredSubjects);

            renderSubjectList(filteredSubjects);
        } catch (error) {
            console.error('Error loading subjects by class:', error);
            // Fallback: use all subjects if class-specific fetch fails
            console.log('Falling back to all subjects');
            renderSubjectList(subjects);
        }
    }

    function renderExams() {
        console.log('Rendering exams. Total count:', exams.length);
        const contentContainer = document.getElementById('examsContentContainer');
        const emptyState = document.getElementById('noExamsMessage');
        const skeleton = document.getElementById('examsLoadingSkeleton');
        const searchQuery = document.getElementById('searchExams').value.toLowerCase();
        const typeFilter = document.getElementById('filterType').value.toLowerCase();
        const subjectFilter = document.getElementById('filterSubject').value;
        const paperFilter = document.getElementById('filterPaper').value;

        // Hide skeleton
        if (skeleton) skeleton.classList.add('hidden');

        // Apply filtering
        const filteredExams = exams.filter(exam => {
            const matchesSearch = !searchQuery ||
                exam.name.toLowerCase().includes(searchQuery) ||
                (exam.paper && exam.paper.name.toLowerCase().includes(searchQuery));

            const matchesType = !typeFilter || (exam.type && exam.type.toLowerCase() === typeFilter);

            const matchesSubject = !subjectFilter || (exam.paper && exam.paper.subject && exam.paper.subject.id === subjectFilter);

            const matchesPaper = !paperFilter || (exam.paper && exam.paper.id === paperFilter);

            return matchesSearch && matchesType && matchesSubject && matchesPaper;
        });

        console.log('Filtered exams count:', filteredExams.length);

        // Clear only dynamic sections
        const dynamicSections = contentContainer.querySelectorAll('.exams-dynamic-section');
        dynamicSections.forEach(s => s.remove());

        if (filteredExams.length === 0) {
            if (exams.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                const noMatch = document.createElement('div');
                noMatch.className = 'exams-dynamic-section py-12 text-center bg-white rounded-2xl border border-slate-200 shadow-sm text-slate-400 text-xs font-bold uppercase tracking-widest';
                noMatch.innerHTML = 'No assessments match your criteria';
                contentContainer.appendChild(noMatch);
            }
            return;
        } else {
            emptyState.classList.add('hidden');
        }

        // Group exams by display style
        const timetableExams = filteredExams.filter(e => {
            const style = e.assessment_type?.category?.display_style || 'table';
            console.log(`Exam: ${e.name}, Style: ${style}`);
            return style === 'timetable';
        });
        const tableExams = filteredExams.filter(e => e.assessment_type?.category?.display_style === 'table');

        console.log(`Timetable count: ${timetableExams.length}, Table count: ${tableExams.length}`);

        // Render Timetable Section if there are timetable exams
        if (timetableExams.length > 0) {
            renderTimetableSection(timetableExams, contentContainer);
        }

        // Render Table Section if there are table exams
        if (tableExams.length > 0) {
            renderTableSection(tableExams, contentContainer);
        }
    }

    function renderTimetableSection(timetableExams, container) {
        const section = document.createElement('div');
        section.className = 'exams-dynamic-section space-y-4';
        section.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-black text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded-lg border border-indigo-100 uppercase tracking-widest">Timetable View</span>
                <div class="h-px bg-slate-100 flex-1"></div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden relative">
                <div class="grid grid-cols-[80px_repeat(7,1fr)] bg-slate-50 border-b border-slate-100 divide-x divide-slate-100 font-black text-[9px] uppercase tracking-widest text-slate-400 sticky top-0 z-10 shadow-sm">
                    <div class="p-3 shadow-inner bg-white flex items-center justify-center">
                        <i class="fas fa-clock text-slate-300 text-sm"></i>
                    </div>
                    ${['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => `
                        <div class="p-3 text-center bg-slate-50/50">
                            <span class="block text-slate-600">${day.substring(0, 3)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-white relative overflow-auto max-h-[600px] custom-scrollbar">
                    <div class="timetable-rows"></div>
                </div>
            </div>
        `;

        const rowsContainer = section.querySelector('.timetable-rows');
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Get unique hours
        const hourSet = new Set();
        timetableExams.forEach(e => hourSet.add(new Date(e.start_time).getHours()));
        const sortedHours = Array.from(hourSet).sort((a, b) => a - b);

        sortedHours.forEach(hour => {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-[80px_repeat(7,1fr)] divide-x divide-slate-50 border-b border-slate-50 last:border-0';
            const timeLabel = `${hour % 12 || 12}:00 ${hour >= 12 ? 'PM' : 'AM'}`;

            let colsHtml = `<div class="p-3 bg-slate-50/30 flex items-center justify-center sticky left-0 z-[5] backdrop-blur-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${timeLabel}</span>
            </div>`;

            days.forEach((day, dayIndex) => {
                const cellExams = timetableExams.filter(e => {
                    const d = new Date(e.start_time);
                    return d.getDay() === dayIndex && d.getHours() === hour;
                });

                colsHtml += `<div class="p-2 min-h-[100px] transition-colors relative">
                    ${cellExams.map(exam => `
                        <div class="group/card bg-gradient-to-br from-white to-slate-50/50 border border-slate-200 rounded-xl p-2.5 mb-2 hover:shadow-xl hover:border-indigo-100 hover:-translate-y-0.5 transition-all duration-300 cursor-pointer relative overflow-hidden" onclick="editExam('${exam.id}')">
                            <div class="absolute -right-2 -top-2 w-8 h-8 bg-slate-50 rounded-full group-hover/card:bg-indigo-50 transition-colors"></div>
                            
                            <div class="relative space-y-2">
                                <div class="flex items-start justify-between gap-1.5">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-[10px] font-black text-slate-800 uppercase tracking-tight truncate group-hover/card:text-indigo-600 transition-colors">${exam.name}</div>
                                        <div class="text-[8px] font-bold text-slate-400 uppercase tracking-widest truncate mt-0.5">${exam.paper ? exam.paper.name : 'N/A'}</div>
                                    </div>
                                    <span class="px-1.5 py-0.5 text-[7px] font-black uppercase tracking-widest rounded-md border ${getBadgeStyle(exam.type)} shadow-sm whitespace-nowrap">
                                        ${exam.type || 'Exam'}
                                    </span>
                                </div>
                                
                                <div class="flex items-center justify-between pt-2 border-t border-slate-50">
                                    <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                                        <i class="fas fa-clock text-[7px]"></i>
                                        ${new Date(exam.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}
                                    </span>
                                    <div class="flex gap-1 transition-all">
                                        <button onclick="event.stopPropagation(); window.location.href='/assessments/${exam.id}/results'" 
                                            class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all flex items-center justify-center">
                                            <i class="fas fa-clipboard-list text-[8px]"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteExam('${exam.id}')" 
                                            class="w-6 h-6 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center">
                                            <i class="fas fa-trash-alt text-[8px]"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            });
            row.innerHTML = colsHtml;
            rowsContainer.appendChild(row);
        });

        container.appendChild(section);
    }

    function renderTableSection(tableExams, container) {
        const section = document.createElement('div');
        section.className = 'exams-dynamic-section space-y-4';
        section.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-black text-slate-500 bg-slate-100 px-2.5 py-1 rounded-lg border border-slate-200 uppercase tracking-widest">List View</span>
                <div class="h-px bg-slate-100 flex-1"></div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100">
                                <th class="px-6 py-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">Assessment</th>
                                <th class="px-6 py-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">Type</th>
                                <th class="px-6 py-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">Subject & Paper</th>
                                <th class="px-6 py-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">Schedule</th>
                                <th class="px-6 py-4 text-right text-[9px] font-black text-slate-400 uppercase tracking-widest">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${tableExams.map(exam => `
                                <tr class="hover:bg-slate-50/50 transition-all duration-200 group cursor-pointer" onclick="window.location.href='/assessments/${exam.id}/results'">
                                    <td class="px-6 py-4">
                                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-tight group-hover:text-indigo-600 transition-colors">${exam.name}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-0.5 inline-flex text-[9px] font-black uppercase tracking-widest rounded-md border ${getBadgeStyle(exam.type)} shadow-sm">
                                            ${exam.type || 'Exam'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-[10px] text-slate-600 font-black uppercase tracking-tight">${exam.paper?.subject?.name || 'N/A'}</div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${exam.paper?.name || 'N/A'}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-[10px] font-black text-slate-700 uppercase tracking-tight">${new Date(exam.start_time).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                            ${new Date(exam.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - 
                                            ${new Date(exam.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <button onclick="event.stopPropagation(); window.location.href='/assessments/${exam.id}/results'" 
                                                class="px-3 py-1.5 bg-slate-900 text-white rounded-lg text-[9px] font-black uppercase tracking-widest transition-all hover:bg-emerald-600 shadow-sm">
                                                Results <i class="fas fa-clipboard-list ml-1 text-[8px]"></i>
                                            </button>
                                            <div class="flex items-center gap-1">
                                                <button onclick="event.stopPropagation(); editExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-200 transition-all flex items-center justify-center shadow-sm">
                                                    <i class="fas fa-pen text-[10px]"></i>
                                                </button>
                                                <button onclick="event.stopPropagation(); deleteExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-rose-500 hover:bg-rose-50 hover:border-rose-200 transition-all flex items-center justify-center shadow-sm">
                                                    <i class="fas fa-trash-alt text-[10px]"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        container.appendChild(section);
    }


    function renderSubjectList(subjectsToShow = []) {
        const container = document.getElementById('subjectListContainer');
        container.innerHTML = '';

        if (subjectsToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No subjects found</div>';
            return;
        }

        subjectsToShow.forEach(subject => {
            const item = document.createElement('div');
            item.className = 'group p-3 mb-2 rounded-xl border border-slate-100 bg-white hover:border-indigo-100 hover:bg-indigo-50/30 cursor-pointer transition-all duration-300 flex items-center justify-between';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-100/50 group-hover:text-indigo-500 group-hover:scale-110 transition-all shadow-sm border border-slate-100">
                        <i class="fas fa-book text-[10px]"></i>
                    </div>
                    <div>
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-tight group-hover:text-indigo-600 transition-colors">${subject.name}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${subject.code}</div>
                    </div>
                </div>
                <div class="w-6 h-6 rounded-lg bg-slate-50 border border-slate-100 text-slate-300 flex items-center justify-center group-hover:border-indigo-100 group-hover:bg-white group-hover:text-indigo-500 transition-all shadow-sm">
                    <i class="fas fa-chevron-right text-[8px]"></i>
                </div>
            `;
            item.onclick = () => {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
                document.getElementById('subjectSelectionModal').classList.add('hidden');

                // Clear paper selection
                document.getElementById('examPaper').value = '';
                document.getElementById('examPaperDisplay').value = '';

                // Load papers for this subject
                const classId = document.getElementById('examClass').value;
                if (classId) {
                    loadPapersByClassAndSubject(classId, subject.id);
                }
            };
            container.appendChild(item);
        });
    }

    function renderPaperList(papersToShow = []) {
        const container = document.getElementById('paperListContainer');
        container.innerHTML = '';

        if (papersToShow.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No papers found</div>';
            return;
        }

        papersToShow.forEach(paper => {
            const item = document.createElement('div');
            item.className = 'group p-3 mb-2 rounded-xl border border-slate-100 bg-white hover:border-emerald-100 hover:bg-emerald-50/30 cursor-pointer transition-all duration-300 flex items-center justify-between';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-emerald-100/50 group-hover:text-emerald-500 group-hover:scale-110 transition-all shadow-sm border border-slate-100">
                        <i class="fas fa-file-alt text-[10px]"></i>
                    </div>
                    <div>
                        <div class="text-[11px] font-black text-slate-700 uppercase tracking-tight group-hover:text-emerald-600 transition-colors">${paper.name}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${paper.code}</div>
                    </div>
                </div>
                <div class="w-5 h-5 rounded-full border-2 border-slate-100 group-hover:border-emerald-200 flex items-center justify-center transition-all">
                    <i class="fas fa-check text-[8px] text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
            `;
            item.onclick = () => {
                document.getElementById('examPaper').value = paper.id;
                document.getElementById('examPaperDisplay').value = paper.name;
                document.getElementById('paperSelectionModal').classList.add('hidden');
            };
            container.appendChild(item);
        });
    }
    function showAddExamModal() {
        document.getElementById('examModalTitle').textContent = 'Create Assessment';
        document.getElementById('examForm').reset();
        document.getElementById('examId').value = '';

        // Reset display inputs
        document.getElementById('examType').value = '';
        document.getElementById('assessmentTypeId').value = '';
        document.getElementById('examTypeDisplay').value = '';
        document.getElementById('examSubject').value = '';
        document.getElementById('examPaper').value = '';
        document.getElementById('examSubjectDisplay').value = '';
        document.getElementById('examPaperDisplay').value = '';

        // Reset lists
        renderSubjectList([]);
        renderPaperList([]);

        if (currentClassID) {
            document.getElementById('examClass').value = currentClassID;
            document.getElementById('examClass').disabled = true;

            // Trigger loading of subjects for the current class
            loadSubjectsByClass(currentClassID);
        }

        document.getElementById('examModal').classList.remove('hidden');
    }

    function hideExamModal() {
        document.getElementById('examModal').classList.add('hidden');
    }

    async function saveExam(e) {
        e.preventDefault();

        const id = document.getElementById('examId').value;
        const examType = document.getElementById('examType').value;
        const examData = {
            name: document.getElementById('examPaperDisplay').value,
            type: examType,
            assessment_type_id: document.getElementById('assessmentTypeId').value,
            class_id: document.getElementById('examClass').value,
            paper_id: document.getElementById('examPaper').value,
            start_time: new Date(document.getElementById('examStartTime').value).toISOString(),
            end_time: new Date(document.getElementById('examEndTime').value).toISOString()
        };

        try {
            let response;
            if (id) {
                response = await fetch(`/api/assessments/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            } else {
                response = await fetch('/api/assessments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
            }

            if (response.ok) {
                hideExamModal();
                loadExams(currentClassID);
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            console.error('Error saving exam:', error);
            alert('Failed to save exam');
        }
    }

    function editExam(id) {
        const exam = exams.find(e => e.id === id);
        if (!exam) return;

        document.getElementById('examModalTitle').textContent = 'Edit Assessment';
        document.getElementById('examId').value = exam.id;
        document.getElementById('examType').value = exam.type || 'exam';

        // Populate assessment type display and ID
        const typeObj = assessmentTypes.find(t => t.code.toLowerCase() === (exam.type || 'exam').toLowerCase());
        document.getElementById('assessmentTypeId').value = exam.assessment_type_id || (typeObj ? typeObj.id : '');
        document.getElementById('examTypeDisplay').value = typeObj ? typeObj.name : (exam.type || 'Exam');

        document.getElementById('examClass').value = exam.class_id;
        document.getElementById('examPaper').value = exam.paper_id;

        // Find the paper from the papers array using paper_id
        const paper = papers.find(p => p.id === exam.paper_id);

        // Populate subject field from paper data
        if (paper && paper.subject) {
            document.getElementById('examSubject').value = paper.subject.id || paper.subject_id;
            document.getElementById('examSubjectDisplay').value = paper.subject.name;
        } else if (paper && paper.subject_id) {
            // Fallback: if paper has subject_id but no subject object, find subject from subjects array
            const subject = subjects.find(s => s.id === paper.subject_id);
            if (subject) {
                document.getElementById('examSubject').value = subject.id;
                document.getElementById('examSubjectDisplay').value = subject.name;
            }
        } else if (exam.paper && exam.paper.subject) {
            // Fallback: use exam.paper.subject if available
            document.getElementById('examSubject').value = exam.paper.subject.id;
            document.getElementById('examSubjectDisplay').value = exam.paper.subject.name;
        }

        // Populate paper field
        if (exam.paper) {
            document.getElementById('examPaperDisplay').value = exam.paper.name;
        } else if (paper) {
            document.getElementById('examPaperDisplay').value = paper.name;
        }

        document.getElementById('examStartTime').value = formatDateTimeForInput(exam.start_time);
        document.getElementById('examEndTime').value = formatDateTimeForInput(exam.end_time);
        document.getElementById('examModal').classList.remove('hidden');
    }

    async function deleteExam(id) {
        if (!confirm('Are you sure you want to delete this exam?')) return;

        try {
            const response = await fetch(`/api/assessments/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadExams(currentClassID);
            } else {
                alert('Failed to delete exam');
            }
        } catch (error) {
            console.error('Error deleting exam:', error);
            alert('Failed to delete exam');
        }
    }

    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString();
    }

    function formatDateTimeForInput(dateString) {
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    function getBadgeStyle(typeCode) {
        if (!typeCode) return 'bg-slate-50 text-slate-400 border-slate-100';
        const type = assessmentTypes.find(t => t.code.toLowerCase() === typeCode.toLowerCase());
        const color = type ? type.color : 'indigo';

        const styles = {
            indigo: 'bg-indigo-50 text-indigo-600 border-indigo-100',
            sky: 'bg-sky-50 text-sky-600 border-sky-100',
            amber: 'bg-amber-50 text-amber-600 border-amber-100',
            rose: 'bg-rose-50 text-rose-600 border-rose-100',
            emerald: 'bg-emerald-50 text-emerald-600 border-emerald-100',
            slate: 'bg-slate-50 text-slate-600 border-slate-100'
        };

        return styles[color] || styles.indigo;
    }

    window.editExam = editExam;
    window.deleteExam = deleteExam;
</script>