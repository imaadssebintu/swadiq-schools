<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Grid - {{.class.Name}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .grid-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: white;
        }

        .student-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            text-align: center;
            background: transparent;
            transition: all 0.2s;
        }

        .cell-input:focus {
            background: white;
            outline: none;
            box-shadow: inset 0 0 0 2px #6366f1;
        }

        .auto-saved {
            animation: flash-green 0.5s;
        }

        @keyframes flash-green {
            0% {
                background: #dcfce7;
            }

            100% {
                background: transparent;
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-600 antialiased">
    <div class="h-screen flex flex-col overflow-hidden">
        <!-- Persistent Header -->
        <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-4">
                <a href="/exams" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <div>
                    <h1 class="text-lg font-black text-slate-900 tracking-tight uppercase">Bulk Results Entry</h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5">
                        <span id="className">Loading...</span> <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span id="academicYearName">Loading...</span>
                    </p>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex items-center gap-3">
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Term</label>
                    <select id="termSelect"
                        class="bg-slate-50 border border-slate-200 text-[11px] font-bold rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-indigo-500 outline-none w-40 hover:border-slate-300 transition-colors"></select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Assessment
                        Type</label>
                    <select id="typeSelect"
                        class="bg-slate-50 border border-slate-200 text-[11px] font-bold rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-indigo-500 outline-none w-48 hover:border-slate-300 transition-colors"></select>
                </div>
                <button onclick="saveAll()"
                    class="mt-4 bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide hover:bg-indigo-700 transition-all shadow-sm flex items-center gap-2">
                    <i class="fas fa-save opacity-70"></i>Save All
                </button>
            </div>
        </header>

        <!-- Main Grid Area -->
        <main class="flex-1 overflow-hidden p-6 relative">
            <div id="resultsGrid"
                class="h-full bg-white rounded-2xl border border-slate-200 shadow-xl overflow-auto custom-scrollbar no-scrollbar-x select-none">
                <div id="loadingOverlay"
                    class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
                    <div class="flex flex-col items-center gap-3">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin">
                        </div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Preparing
                            Matrix...</span>
                    </div>
                </div>
                <table class="w-full border-collapse min-w-max">
                    <thead class="grid-header">
                        <tr id="paperHeadersRow">
                            <th
                                class="student-col px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-left min-w-[200px]">
                                Students</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </main>

        <!-- Footer / Status Bar -->
        <footer class="bg-white border-t border-slate-200 px-6 py-2 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-1.5">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-sm animate-pulse"></div>
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">Cloud Synchronized</span>
                </div>
                <div class="h-4 w-px bg-slate-200"></div>
                <div id="saveStatus" class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">All changes
                    saved</div>
            </div>
            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Use Arrow Keys or TAB to Navigate
            </div>
        </footer>
    </div>

    <script>
        const CLASS_ID = "{{.classID}}";
        let matrixData = null;
        let assessmentTypes = [];
        let terms = [];
        let currentAcademicYear = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Metadata
                await Promise.all([
                    fetchAssessmentTypes(),
                    fetchTerms(),
                    fetchAcademicYears()
                ]);

                initGrid();
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Failed to initialize grid', 'error');
            }
        });

        async function fetchAssessmentTypes() {
            const resp = await fetch('/api/settings/assessment-types');
            assessmentTypes = await resp.json();
            const select = document.getElementById('typeSelect');

            // Filter types by class
            const filteredTypes = assessmentTypes.filter(t => {
                if (t.all_classes) return true;
                if (!t.classes) return false;
                return t.classes.some(c => c.id === CLASS_ID);
            });

            // Group types by category
            const categories = {};
            filteredTypes.forEach(t => {
                const catName = t.category_name || 'Common';
                if (!categories[catName]) categories[catName] = [];
                categories[catName].push(t);
            });

            select.innerHTML = '';
            Object.keys(categories).forEach(cat => {
                const group = document.createElement('optgroup');
                group.label = cat.toUpperCase();
                categories[cat].forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    if (t.code === 'BOT') opt.selected = true;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            });

            select.onchange = () => loadMatrix();
        }

        async function fetchTerms() {
            const resp = await fetch('/api/settings/terms');
            terms = await resp.json();
            const select = document.getElementById('termSelect');
            select.innerHTML = terms.map(t => `
                <option value="${t.id}" ${t.is_current ? 'selected' : ''}>
                    ${t.name} ${t.is_current ? '(Current)' : ''}
                </option>
            `).join('');
            select.onchange = () => loadMatrix();
        }

        async function fetchAcademicYears() {
            const resp = await fetch('/api/settings/academic-years');
            const years = await resp.json();
            currentAcademicYear = years.find(y => y.is_current) || years[0];
            document.getElementById('academicYearName').textContent = currentAcademicYear.name;
        }

        async function loadMatrix() {
            const termID = document.getElementById('termSelect').value;
            const typeID = document.getElementById('typeSelect').value;

            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                const resp = await fetch(`/api/results/matrix?class_id=${CLASS_ID}&term_id=${termID}&assessment_type_id=${typeID}`);
                matrixData = await resp.json();
                renderGrid();
            } catch (err) {
                console.error(err);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function renderGrid() {
            // Render Headers
            const headerRow = document.getElementById('paperHeadersRow');
            headerRow.innerHTML = '<th class="student-col px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-left min-w-[200px]">Students</th>';

            if (matrixData.papers && Array.isArray(matrixData.papers)) {
                matrixData.papers.forEach(p => {
                    const th = document.createElement('th');
                    th.className = 'px-4 py-3 text-[10px] font-black text-slate-900 uppercase tracking-wider text-center border-b border-slate-100 min-w-[120px] bg-slate-50/50';
                    th.innerHTML = `
                        <div class="flex flex-col">
                            <span>${p.name}</span>
                            <span class="text-[8px] text-slate-400 mt-1">${p.code}</span>
                        </div>
                    `;
                    headerRow.appendChild(th);
                });
            }

            // Render Body
            const body = document.getElementById('gridBody');
            body.innerHTML = '';

            // Build Results Map for quick access [studentID_paperID]
            const resultsMap = {};
            if (matrixData.results && Array.isArray(matrixData.results)) {
                matrixData.results.forEach(r => {
                    resultsMap[`${r.student_id}_${r.paper_id}`] = r.marks;
                });
            }

            if (matrixData.students && Array.isArray(matrixData.students)) {
                matrixData.students.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-50 hover:bg-indigo-50/30 transition-colors group';

                    // Student Info Cell
                    const stCell = document.createElement('td');
                    stCell.className = 'student-col px-4 py-3 group-hover:bg-indigo-50/30 transition-colors';
                    stCell.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-700 text-[10px] font-bold">
                                ${s.first_name[0]}${s.last_name[0]}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[11px] font-bold text-slate-900">${s.first_name} ${s.last_name}</span>
                                <span class="text-[9px] text-slate-400 font-medium">${s.student_id}</span>
                            </div>
                        </div>
                    `;
                    tr.appendChild(stCell);

                    // Paper Entry Cells
                    if (matrixData.papers && Array.isArray(matrixData.papers)) {
                        matrixData.papers.forEach(p => {
                            const cell = document.createElement('td');
                            cell.className = 'p-0 text-center border-l border-slate-50';
                            const marks = resultsMap[`${s.id}_${p.id}`] || '';

                            const input = document.createElement('input');
                            input.type = 'number';
                            input.step = '0.5';
                            input.min = '0';
                            input.max = '100';
                            input.value = marks;
                            input.className = 'cell-input text-[11px] font-bold py-3';
                            input.dataset.studentId = s.id;
                            input.dataset.paperId = p.id;

                            input.addEventListener('change', (e) => handleAutoSave(e.target));
                            input.addEventListener('keydown', handleKeyNavigation);

                            cell.appendChild(input);
                            tr.appendChild(cell);
                        });
                    }

                    body.appendChild(tr);
                });
            }

            // Update Class Name in Header if not set
            if (matrixData.students.length > 0) {
                // You might want to get this from elsewhere if it's a new class entry
                document.getElementById('className').textContent = "{{.class.Name}}"; // Template handles this usually
            }
        }

        let saveTimeout = null;
        let pendingSave = [];

        function handleAutoSave(input) {
            const marks = parseFloat(input.value);
            if (isNaN(marks)) return;

            input.classList.add('bg-indigo-50');
            document.getElementById('saveStatus').textContent = 'Saving changes...';

            pendingSave.push({
                student_id: input.dataset.studentId,
                paper_id: input.dataset.paperId,
                marks: marks
            });

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveAll, 1000);
        }

        async function saveAll() {
            if (pendingSave.length === 0) return;

            const toSave = [...pendingSave];
            pendingSave = [];

            const payload = {
                class_id: CLASS_ID,
                term_id: document.getElementById('termSelect').value,
                academic_year_id: currentAcademicYear.id,
                assessment_type_id: document.getElementById('typeSelect').value,
                results: toSave
            };

            try {
                const resp = await fetch('/api/results/grid-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    document.getElementById('saveStatus').textContent = 'All changes saved';
                    // Visual feedback: brief green flash on saved items
                    toSave.forEach(s => {
                        const input = document.querySelector(`input[data-student-id="${s.student_id}"][data-paper-id="${s.paper_id}"]`);
                        if (input) {
                            input.classList.remove('bg-indigo-50');
                            input.classList.add('auto-saved');
                            setTimeout(() => input.classList.remove('auto-saved'), 500);
                        }
                    });
                } else {
                    document.getElementById('saveStatus').textContent = 'Error saving';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('saveStatus').textContent = 'Sync failed';
            }
        }

        function handleKeyNavigation(e) {
            const inputs = Array.from(document.querySelectorAll('.cell-input'));
            const index = inputs.indexOf(e.target);
            const cols = matrixData.papers.length;

            switch (e.key) {
                case 'ArrowRight':
                    if (index < inputs.length - 1) inputs[index + 1].focus();
                    break;
                case 'ArrowLeft':
                    if (index > 0) inputs[index - 1].focus();
                    break;
                case 'ArrowDown':
                    if (index + cols < inputs.length) inputs[index + cols].focus();
                    break;
                case 'ArrowUp':
                    if (index - cols >= 0) inputs[index - cols].focus();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (index + cols < inputs.length) inputs[index + cols].focus();
                    break;
            }
        }

        function initGrid() {
            loadMatrix();
        }
    </script>
</body>

</html>