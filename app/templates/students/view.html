<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 20px 0 rgba(31, 38, 135, 0.05);
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            scrollbar-width: thin;
            scrollbar-color: #e2e8f0 transparent;
        }

        .premium-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .skeleton-row-cell {
            height: 1rem;
            background: #e2e8f0;
            border-radius: 0.5rem;
            animation: pulse-slow 2s infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: flex !important;
                flex-direction: column;
                padding: 1rem !important;
                border-bottom: 2px solid #f1f5f9;
                gap: 0.5rem;
            }

            .responsive-table td {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                padding: 0 !important;
                border: none !important;
                text-align: right !important;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #94a3b8;
                font-size: 10px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                text-align: left;
            }

            .responsive-table td:last-child {
                margin-top: 0.5rem;
                padding-top: 0.5rem !important;
                border-top: 1px solid #f8fafc !important;
                justify-content: center !important;
            }
        }
    </style>
</head>

<body class="min-h-screen text-slate-900 overflow-x-hidden">
    <!-- Main Decorative Gradients -->
    <div class="fixed top-0 left-0 w-full h-full -z-10 pointer-events-none opacity-40">
        <div class="absolute top-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-200 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-100 rounded-full blur-[120px]"></div>
    </div>

    <div class="flex flex-col lg:flex-row min-h-[calc(100vh-3.5rem)]">
        <!-- Sidebar: Student & Guardian Info -->
        <aside
            class="w-full lg:w-80 glass-sidebar lg:sticky lg:top-0 lg:h-[calc(100vh-3.5rem)] lg:overflow-y-auto z-10 p-6 overscroll-contain">
            <div class="flex items-center gap-3 mb-8">
                <a href="/fees"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm border border-slate-200 text-slate-500 hover:text-indigo-600 transition-all">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <span class="font-bold text-slate-800 text-lg">Fees Center</span>
            </div>

            <!-- Profile Section -->
            <div class="text-center mb-6">
                <div class="relative inline-block mb-3">
                    <div
                        class="w-16 h-16 rounded-lg premium-gradient shadow-lg flex items-center justify-center text-white text-xl font-extrabold mx-auto">
                        <span>
                            {{if .student.FirstName}}
                            {{if .student.LastName}}
                            {{printf "%c%c" (index .student.FirstName 0) (index .student.LastName 0)}}
                            {{else}}
                            {{printf "%c" (index .student.FirstName 0)}}
                            {{end}}
                            {{else}}?{{end}}
                        </span>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-emerald-500 border-2 border-white rounded-full flex items-center justify-center shadow-md"
                        title="Active">
                        <i class="fas fa-check text-[8px] text-white"></i>
                    </div>
                </div>
                <h2 class="text-lg font-bold text-slate-900 tracking-tight break-words">{{.student.FirstName}}
                    {{.student.LastName}}</h2>
                <div class="inline-flex items-center px-2 py-0.5 mt-1 bg-indigo-50 border border-indigo-100 rounded">
                    <span class="text-[10px] font-bold text-indigo-600 tracking-wider uppercase">ID:
                        {{.student.StudentID}}</span>
                </div>
            </div>

            <div class="space-y-5 pb-6">
                <!-- Academic Stats -->
                <div>
                    <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.1em] mb-2 ml-1">Academic
                        Status</h3>
                    <div class="bg-white/50 border border-white/40 p-3 rounded-lg space-y-2">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-slate-500">Class</span>
                            <span class="font-bold text-slate-800 text-right">{{if
                                .student.Class}}{{.student.Class.Name}}{{else}}N/A{{end}}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-slate-500">Gender</span>
                            <span class="font-bold text-slate-800 capitalize">{{if
                                .student.Gender}}{{.student.Gender}}{{else}}N/A{{end}}</span>
                        </div>
                    </div>
                </div>

                <!-- Guardian Info -->
                <div>
                    <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.1em] mb-2 ml-1">Guardian
                        Details</h3>
                    <div class="bg-white/50 border border-white/40 p-3 rounded-lg space-y-3">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-user-shield text-emerald-600 text-xs mt-1 shrink-0"></i>
                            <div class="overflow-hidden">
                                <p
                                    class="text-[9px] text-slate-400 font-bold uppercase tracking-wider leading-none mb-1">
                                    Guardian</p>
                                <p class="text-xs font-bold text-slate-800 break-words line-clamp-1">
                                    {{if .student.Parents}}
                                    {{with index .student.Parents 0}}{{.FirstName}} {{.LastName}}{{end}}
                                    {{else}}Not Assigned{{end}}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-phone text-blue-600 text-[10px] mt-1 shrink-0"></i>
                            <div class="overflow-hidden">
                                <p
                                    class="text-[9px] text-slate-400 font-bold uppercase tracking-wider leading-none mb-1">
                                    Phone</p>
                                <p class="text-xs font-bold text-slate-800 break-all">
                                    {{if .student.Parents}}
                                    {{with index .student.Parents 0}}{{if .Phone}}{{.Phone}}{{else}}N/A{{end}}{{end}}
                                    {{else}}N/A{{end}}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-2 sticky bottom-0 bg-transparent pb-4 lg:relative lg:p-0">
                    <button id="addFeeForStudentBtn"
                        class="w-full py-3 bg-slate-900 hover:bg-black text-white rounded-lg font-bold text-xs shadow-md transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus text-[10px]"></i>
                        Assign New Fee
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-5 lg:p-8">
            <!-- Header Greeting -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tight">Financial Health</h1>
                    <p class="text-xs text-slate-500 mt-0.5 font-medium">Ledger for <span
                            class="text-indigo-600 font-bold">{{.student.FirstName}}</span></p>
                </div>

                <!-- Quick Search / Actions -->
                <div class="flex items-center gap-2">
                    <div class="relative">
                        <i
                            class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                        <input type="text" placeholder="Search records..."
                            class="pl-8 pr-3 py-2 bg-white border border-slate-200 rounded text-[10px] font-medium focus:ring-2 focus:ring-indigo-500/10 outline-none w-40 transition-all">
                    </div>
                    <button
                        class="p-2 bg-white border border-slate-200 rounded text-slate-500 hover:text-indigo-600 transition-all">
                        <i class="fas fa-download text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Major Stats Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-8">
                <!-- Total Invoiced -->
                <div class="glass-card p-4 rounded-xl relative overflow-hidden group">
                    <div class="flex items-center justify-between mb-2">
                        <div
                            class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs text-xs">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Invoiced</span>
                    </div>
                    <h3 id="totalPayable" class="text-lg font-black text-slate-900 mb-0.5 break-words">UGX 0</h3>
                    <p class="text-[9px] text-slate-400 font-medium">Lifetime generated billing</p>
                </div>

                <!-- Total Collections -->
                <div class="glass-card p-4 rounded-xl relative overflow-hidden group border-emerald-100/30">
                    <div class="flex items-center justify-between mb-2">
                        <div
                            class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center text-emerald-600 text-xs">
                            <i class="fas fa-hand-holding-dollar"></i>
                        </div>
                        <span class="text-[9px] font-black text-emerald-400 uppercase tracking-widest">Collected</span>
                    </div>
                    <h3 id="totalPaid" class="text-lg font-black text-slate-900 mb-2 break-words">UGX 0</h3>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-slate-100 rounded-full h-1 overflow-hidden">
                            <div id="paymentProgress"
                                class="bg-emerald-500 h-full rounded-full transition-all duration-1000"
                                style="width: 0%"></div>
                        </div>
                        <span class="text-[9px] font-black text-slate-400 shrink-0" id="progressPct">0%</span>
                    </div>
                </div>

                <!-- Current Liabilities -->
                <div
                    class="glass-card p-4 rounded-xl relative overflow-hidden group border-rose-100/30 md:col-span-2 xl:col-span-1">
                    <div class="flex items-center justify-between mb-2">
                        <div
                            class="w-8 h-8 rounded-lg bg-rose-100 flex items-center justify-center text-rose-600 text-xs">
                            <i class="fas fa-stopwatch"></i>
                        </div>
                        <span class="text-[9px] font-black text-rose-400 uppercase tracking-widest">Balance</span>
                    </div>
                    <h3 id="totalBalance" class="text-lg font-black text-rose-600 mb-0.5 break-words">UGX 0</h3>
                    <p class="text-[9px] text-rose-400 font-bold uppercase tracking-tight line-clamp-1">Outstanding dues
                    </p>
                </div>
            </div>

            <!-- Detailed Ledger Table -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white/40">
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                        <h3 class="text-sm font-bold text-slate-800 tracking-tight">Fees Ledger</h3>
                    </div>
                    <span id="feeCountLabel"
                        class="px-2 py-0.5 bg-indigo-50 border border-indigo-100 rounded text-[9px] font-bold text-indigo-600 uppercase">0
                        Records</span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full responsive-table">
                        <thead class="bg-slate-100/50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Description</th>
                                <th
                                    class="px-6 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Academic Info</th>
                                <th
                                    class="px-6 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Revenue</th>
                                <th
                                    class="px-6 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Balance</th>
                                <th
                                    class="px-6 py-3 text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentFeesTableBody" class="divide-y divide-slate-100">
                            <!-- Skeletons -->
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-32"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-24"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-32 ml-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-20 ml-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-16 mx-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-20 ml-auto"></div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-24"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-20"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-28 ml-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-24 ml-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-16 mx-auto"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="skeleton-row-cell w-20 ml-auto"></div>
                                </td>
                            </tr>
                        </tbody>
                        <div class="skeleton-row-cell w-24 ml-auto"></div>
                        </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals & Scripts included from original logic -->

    <!-- Record Payment Modal -->
    <div id="paymentModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded shadow-2xl max-w-md w-full mx-4 overflow-hidden transform transition-all scale-95"
            id="paymentModalContent">
            <div class="px-6 py-4 flex justify-between items-center border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-900">Record Payment</h3>
                <button onclick="closePaymentModal()"
                    class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-all flex items-center justify-center">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <form id="paymentForm" class="p-6 space-y-4">
                <input type="hidden" id="paymentFeeId">
                <input type="hidden" id="paymentStudentId">

                <div class="p-3 bg-indigo-50 border border-indigo-100 rounded">
                    <p id="paymentStudentName" class="text-xs font-bold text-indigo-900"></p>
                    <p id="paymentFeeTitle" class="text-[10px] text-indigo-600/70 mt-0.5 font-bold"></p>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-indigo-200/50">
                        <span class="text-[9px] text-indigo-400 font-bold uppercase tracking-widest">Balance Due</span>
                        <span id="paymentCurrentBalance" class="text-base font-black text-rose-600"></span>
                    </div>
                </div>

                <div>
                    <label for="paymentAmount"
                        class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Amount
                        (UGX)</label>
                    <input type="number" id="paymentAmount" step="0.01" min="0" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all text-lg font-bold color-slate-900">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="paymentMethod"
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Method</label>
                        <select id="paymentMethod" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-xs appearance-none">
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Mobile Money">Mobile Money</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div>
                        <label for="paymentTxId"
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Ref
                            #</label>
                        <input type="text" id="paymentTxId" placeholder="ID/Txn"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-xs">
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closePaymentModal()"
                        class="flex-1 px-4 py-3 text-slate-500 font-bold text-xs hover:bg-slate-50 rounded transition-all">
                        Discard
                    </button>
                    <button type="submit" id="submitPaymentBtn"
                        class="flex-[2] px-4 py-3 bg-indigo-600 hover:bg-black text-white rounded font-bold text-xs shadow transition-all">
                        Confirm Collection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Fee Modal -->
    <div id="addFeeModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded shadow-2xl max-w-lg w-full mx-4 overflow-hidden transform transition-all scale-95"
            id="addFeeModalContent">
            <div class="px-8 py-5 flex justify-between items-center border-b border-slate-100 text-slate-900 font-bold">
                <h3 class="text-lg">Assign New Fee</h3>
                <button onclick="closeAddFeeModal()"
                    class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-all flex items-center justify-center">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <form id="addFeeForm" class="p-8 space-y-4">
                <input type="hidden" id="addFeeStudentId" value="{{.studentID}}">

                <div>
                    <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Fee
                        Description</label>
                    <input type="text" id="addFeeTitle" required placeholder="e.g. Activity Fees Term 2"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Category</label>
                        <select id="addFeeType" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-xs appearance-none">
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Amount
                            (UGX)</label>
                        <input type="number" id="addFeeAmount" required placeholder="0"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-sm text-indigo-600">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Academic
                            Year</label>
                        <select id="addFeeYear" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-xs appearance-none">
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Term</label>
                        <select id="addFeeTerm" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-xs appearance-none">
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1 ml-1">Due
                        Date</label>
                    <input type="date" id="addFeeDueDate" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded focus:ring-2 focus:ring-indigo-500/10 outline-none transition-all font-bold text-sm">
                </div>

                <div class="flex gap-3 pt-4 border-t border-slate-50">
                    <button type="button" onclick="closeAddFeeModal()"
                        class="flex-1 px-6 py-3 text-slate-500 font-bold text-xs hover:bg-slate-50 rounded transition-all">
                        Cancel
                    </button>
                    <button type="submit" id="saveFeeBtn"
                        class="flex-[2] px-6 py-3 bg-indigo-600 hover:bg-black text-white rounded font-bold text-xs shadow transition-all">
                        Assign Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const studentID = "{{.studentID}}";
        let studentFees = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadStudentFees();
            loadFeeFormData();

            // Payment Form Submission
            document.getElementById('paymentForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitPayment();
            });

            // Add Fee Form Submission
            document.getElementById('addFeeForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitAddFee();
            });

            // Open Add Fee Modal Trigger
            const addBtn = document.getElementById('addFeeForStudentBtn');
            if (addBtn) addBtn.addEventListener('click', openAddFeeModal);
        });

        async function loadStudentFees() {
            const tableBody = document.getElementById('studentFeesTableBody');

            // Initial Skeletons handled in HTML, but can re-trigger if needed

            try {
                const res = await fetch(`/api/fees?student_id=${studentID}&limit=100`);
                const data = await res.json();

                if (data.success && data.data) {
                    studentFees = data.data;
                    renderFees(studentFees);
                    updateStats(studentFees);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center"><div class="flex flex-col items-center"><i class="fas fa-folder-open text-4xl text-slate-200 mb-4"></i><p class="text-slate-400 font-bold uppercase tracking-widest text-xs">No records found</p></div></td></tr>';
                }
            } catch (err) {
                console.error('Error:', err);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center text-rose-500 font-bold">Failed to connect to ledger service.</td></tr>';
            }
        }

        async function loadFeeFormData() {
            try {
                const [yearsRes, termsRes, typesRes] = await Promise.all([
                    fetch('/api/academic-years'),
                    fetch('/api/terms'),
                    fetch('/api/fee-types')
                ]);

                const [yearsInfo, termsInfo, typesInfo] = await Promise.all([
                    yearsRes.json(),
                    termsRes.json(),
                    typesRes.json()
                ]);

                const yearSelect = document.getElementById('addFeeYear');
                const termSelect = document.getElementById('addFeeTerm');
                const typeSelect = document.getElementById('addFeeType');

                const years = Array.isArray(yearsInfo) ? yearsInfo : (yearsInfo.data || []);
                const terms = Array.isArray(termsInfo) ? termsInfo : (termsInfo.data || []);
                const types = Array.isArray(typesInfo) ? typesInfo : (typesInfo.data || []);

                yearSelect.innerHTML = years.map(y => `<option value="${y.id}" ${y.is_current ? 'selected' : ''}>${y.name}</option>`).join('');
                termSelect.innerHTML = terms.map(t => `<option value="${t.id}" ${t.is_current ? 'selected' : ''}>${t.name}</option>`).join('');
                typeSelect.innerHTML = types.map(t => `<option value="${t.id}">${t.name} (${t.code})</option>`).join('');
            } catch (error) {
                console.error('Error loading form data:', error);
            }
        }

        function renderFees(fees) {
            const tableBody = document.getElementById('studentFeesTableBody');
            document.getElementById('feeCountLabel').textContent = `${fees.length} Records`;

            if (fees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center"><div class="flex flex-col items-center"><i class="fas fa-folder-open text-4xl text-slate-200 mb-4"></i><p class="text-slate-400 font-bold uppercase tracking-widest text-xs">No records found</p></div></td></tr>';
                return;
            }

            tableBody.innerHTML = fees.map(fee => {
                const balance = parseFloat(fee.balance);
                const amount = parseFloat(fee.amount);
                const paid = amount - balance;
                const progress = (paid / amount) * 100;

                const isPaid = fee.paid || balance === 0;
                const statusClass = isPaid ? 'bg-emerald-50 text-emerald-600' : (balance < amount ? 'bg-amber-50 text-amber-600' : 'bg-rose-50 text-rose-600');
                const statusText = isPaid ? 'Settled' : (balance < amount ? 'Partial' : 'Due');

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="px-6 py-4" data-label="Description">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-700 tracking-tight">${fee.title}</span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter mt-0.5">Ref: ${fee.id.substring(0, 8)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4" data-label="Academic Info">
                            <div class="flex flex-col">
                                <div class="flex items-center gap-1">
                                    <span class="px-1 py-0.5 bg-indigo-50 text-indigo-500 rounded text-[9px] font-bold uppercase tracking-wider">${fee.fee_type_code || 'GEN'}</span>
                                    <span class="text-xs font-bold text-slate-600">${fee.academic_year_name || '-'}</span>
                                </div>
                                <span class="text-[10px] font-medium text-slate-400 mt-0.5">${fee.term_name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4" data-label="Revenue">
                            <div class="max-w-[100px] md:ml-auto">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] font-bold text-slate-400">UGX ${new Intl.NumberFormat().format(amount)}</span>
                                    <span class="text-[10px] font-bold text-emerald-600">${Math.round(progress)}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1 overflow-hidden">
                                     <div class="bg-emerald-500 h-full rounded-full transition-all duration-700" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right" data-label="Balance">
                            <span class="text-sm font-bold ${balance > 0 ? 'text-rose-600' : 'text-slate-400'}">UGX ${new Intl.NumberFormat().format(balance)}</span>
                        </td>
                        <td class="px-6 py-4 text-center" data-label="Status">
                            <span class="inline-flex px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-widest ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 text-right" data-label="Action">
                            ${!isPaid ? `
                                <button onclick="openPaymentModal('${fee.id}', '${fee.student_id}', '${fee.student_name}', '${fee.title}', ${fee.balance})" 
                                    class="px-3 py-1.5 bg-slate-900 hover:bg-black text-white text-[10px] font-bold uppercase tracking-widest rounded transition-all shadow-sm">
                                    Pay Record
                                </button>
                            ` : `
                                <button class="w-8 h-8 bg-slate-50 hover:bg-slate-100 text-slate-400 rounded transition-all flex items-center justify-center mx-auto">
                                    <i class="fas fa-print text-sm"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats(fees) {
            let total = 0;
            let paid = 0;
            let balance = 0;

            fees.forEach(f => {
                const amt = parseFloat(f.amount);
                const bal = parseFloat(f.balance);
                total += amt;
                balance += bal;
                paid += (amt - bal);
            });

            document.getElementById('totalPayable').textContent = `UGX ${new Intl.NumberFormat().format(total)}`;
            document.getElementById('totalPaid').textContent = `UGX ${new Intl.NumberFormat().format(paid)}`;
            document.getElementById('totalBalance').textContent = `UGX ${new Intl.NumberFormat().format(balance)}`;

            const progress = total > 0 ? (paid / total) * 100 : 0;
            document.getElementById('paymentProgress').style.width = `${progress}%`;
            document.getElementById('progressPct').textContent = `${Math.round(progress)}%`;
        }

        // Modal Functions
        function openPaymentModal(feeId, studentId, studentName, title, balance) {
            document.getElementById('paymentFeeId').value = feeId;
            document.getElementById('paymentStudentId').value = studentId;
            document.getElementById('paymentStudentName').textContent = studentName || '{{.student.FirstName}} {{.student.LastName}}';
            document.getElementById('paymentFeeTitle').textContent = title;
            document.getElementById('paymentCurrentBalance').textContent = `UGX ${new Intl.NumberFormat().format(balance)}`;
            document.getElementById('paymentAmount').value = balance;
            document.getElementById('paymentAmount').max = balance;

            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentModalContent');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentModalContent');

            modal.classList.remove('opacity-100');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('paymentForm').reset();
            }, 300);
            document.body.style.overflow = 'auto';
        }

        async function submitPayment() {
            const btn = document.getElementById('submitPaymentBtn');
            const originalText = btn.innerHTML;

            const data = {
                fee_id: document.getElementById('paymentFeeId').value,
                student_id: document.getElementById('paymentStudentId').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                payment_method: document.getElementById('paymentMethod').value,
                transaction_id: document.getElementById('paymentTxId').value
            };

            if (isNaN(data.amount) || data.amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Processing...`;

                const response = await fetch('/api/fees/record-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closePaymentModal();
                    loadStudentFees();
                    alert('Collection recorded successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Failed to record payment'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Connection failure. Check your network.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function openAddFeeModal() {
            const modal = document.getElementById('addFeeModal');
            const content = document.getElementById('addFeeModalContent');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeAddFeeModal() {
            const modal = document.getElementById('addFeeModal');
            const content = document.getElementById('addFeeModalContent');

            modal.classList.remove('opacity-100');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('addFeeForm').reset();
            }, 300);
            document.body.style.overflow = 'auto';
        }

        async function submitAddFee() {
            const btn = document.getElementById('saveFeeBtn');
            const originalText = btn.innerHTML;

            const data = {
                student_id: document.getElementById('addFeeStudentId').value,
                title: document.getElementById('addFeeTitle').value,
                fee_type_id: document.getElementById('addFeeType').value,
                amount: parseFloat(document.getElementById('addFeeAmount').value),
                academic_year_id: document.getElementById('addFeeYear').value,
                academic_term_id: document.getElementById('addFeeTerm').value,
                due_date: document.getElementById('addFeeDueDate').value
            };

            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Assigning...`;

                const response = await fetch('/api/fees', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closeAddFeeModal();
                    loadStudentFees();
                    alert('Fee record created successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Failed to create fee'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>