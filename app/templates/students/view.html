<div class="p-4 lg:p-6 space-y-6 animate-fade-in-up bg-slate-50 min-h-screen relative">
    <!-- Premium Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <div
                class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center border border-slate-200 shadow-sm relative overflow-hidden group">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                </div>
                <span class="text-2xl font-black text-indigo-600 uppercase relative z-10">{{slice .student.FirstName 0
                    1}}{{slice .student.LastName 0 1}}</span>
            </div>
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight uppercase">{{.student.FirstName}}
                        {{.student.LastName}}</h2>
                    <span
                        class="px-2 py-0.5 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded text-[10px] font-black uppercase tracking-widest">Active</span>
                </div>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                    <div class="flex items-center gap-1.5 p-1 px-2 bg-slate-100 rounded-lg border border-slate-200/50">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">System ID</span>
                        <span class="text-[10px] font-black text-slate-700">#{{slice .studentID 0 8}}</span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-400">
                        <i class="fas fa-graduation-cap text-[10px]"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">{{if
                            .student.Class}}{{.student.Class.Name}}{{else}}UNASSIGNED{{end}}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.history.back()"
                class="h-10 px-4 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 shadow-sm">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button onclick="openAddFeeModal()"
                class="h-10 px-6 bg-slate-900 hover:bg-black text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                <i class="fas fa-plus"></i> Assign Fee
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">


        <!-- Main Content Area -->
        <div class="lg:col-span-8 space-y-6">
            <!-- Financial Health Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-5 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="fas fa-file-invoice-dollar text-4xl"></i>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Invoiced</p>
                    <h3 id="totalPayable" class="text-xl font-black text-slate-800 tracking-tight">UGX 0</h3>
                    <div class="mt-3 flex items-center gap-2">
                        <span
                            class="text-[9px] font-black text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-widest">Session
                            Total</span>
                    </div>
                </div>

                <div
                    class="p-5 rounded-3xl bg-gradient-to-br from-indigo-600 to-indigo-700 border-indigo-500 shadow-lg shadow-indigo-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i class="fas fa-hand-holding-dollar text-4xl text-white"></i>
                    </div>
                    <p class="text-[10px] font-black text-indigo-100 uppercase tracking-widest mb-1 opacity-80">Fees
                        Collected</p>
                    <h3 id="totalPaid" class="text-xl font-black text-white tracking-tight">UGX 0</h3>
                    <div class="mt-3 flex items-center gap-2">
                        <div class="flex-1 h-1 bg-white/20 rounded-full overflow-hidden">
                            <div id="paymentProgress" class="h-full bg-white transition-all duration-1000"
                                style="width: 0%"></div>
                        </div>
                        <span id="progressPct"
                            class="text-[10px] font-black text-white uppercase tracking-widest">0%</span>
                    </div>
                </div>

                <div class="p-5 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="fas fa-clock text-4xl"></i>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Outstanding Balance
                    </p>
                    <h3 id="totalBalance" class="text-xl font-black text-rose-600 tracking-tight">UGX 0</h3>
                    <div class="mt-3 flex items-center gap-2">
                        <span
                            class="text-[9px] font-black text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded border border-rose-100 uppercase tracking-widest">Payable
                            Item</span>
                    </div>
                </div>
            </div>


            <!-- Detailed Records Tabbed Section -->
            <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden min-h-[500px]">
                <div
                    class="flex flex-col sm:flex-row items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50/30 gap-4">
                    <div
                        class="flex items-center gap-1 p-1 bg-slate-100 rounded-xl w-full sm:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('finance')" id="tab-button-finance"
                            class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all bg-white text-indigo-600 shadow-sm border border-slate-200/50 whitespace-nowrap">
                            Financial Ledger
                        </button>
                        <button onclick="switchTab('attendance')" id="tab-button-attendance"
                            class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-indigo-600 whitespace-nowrap">
                            Lesson Attendance
                        </button>
                        <button onclick="switchTab('assessments')" id="tab-button-assessments"
                            class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-indigo-600 whitespace-nowrap">
                            Assessment Results
                        </button>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end gap-2 w-full sm:w-auto">
                        <span id="feeCountLabel"
                            class="px-2 py-0.5 bg-white border border-slate-200 rounded text-[9px] font-bold text-slate-500 uppercase">0
                            Records</span>
                        <button
                            class="w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-600 transition-all">
                            <i class="fas fa-download text-[10px]"></i>
                        </button>
                    </div>
                </div>

                <!-- Finance Tab -->
                <div id="tab-content-finance" class="animate-fade-in p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50/50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Entity Details</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Academic Session</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Settlement Status</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Condition</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentFeesTableBody" class="divide-y divide-slate-100">
                                <!-- Loaded via JS -->
                                <tr>
                                    <td colspan="5" class="px-6 py-20 text-center italic text-slate-400">Initializing
                                        financial ledger...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/30">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                            <h3 class="text-[11px] font-black text-slate-800 uppercase tracking-tight">Recent Payment
                                Activity</h3>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50/50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Timestamp</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Allocation Summary</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Gross Amount</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryTableBody"
                                class="divide-y divide-slate-100 italic text-slate-400 text-[11px]">
                                <tr>
                                    <td colspan="4"
                                        class="px-6 py-10 text-center uppercase tracking-widest font-black opacity-40">
                                        Loading ledger history...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Tab -->
                <div id="tab-content-attendance" class="hidden animate-fade-in p-0">
                    <div class="p-6 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between">
                        <div>
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Attendance Metric
                            </h4>
                            <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Real-time lesson tracking</p>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-center">
                                <p id="statTotalLessons" class="text-sm font-black text-slate-800 tracking-tight">0</p>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Lessons</p>
                            </div>
                            <div class="text-center">
                                <p id="statAttended" class="text-sm font-black text-emerald-600 tracking-tight">0</p>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Present</p>
                            </div>
                            <div class="text-center">
                                <p id="statRate" class="text-sm font-black text-indigo-600 tracking-tight">0%</p>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50/50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Timestamp</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Subject Detail</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Topic Covered</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Mark</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceReportBody"
                                class="divide-y divide-slate-100 italic text-slate-400 text-[11px]">
                                <tr>
                                    <td colspan="4"
                                        class="px-6 py-20 text-center uppercase tracking-widest font-black opacity-40">
                                        Initializing attendance report...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Assessment Results Tab -->
                <div id="tab-content-assessments" class="hidden animate-fade-in p-0">
                    <div class="p-6 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between">
                        <div>
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Academic Performance
                            </h4>
                            <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Exam and test score history
                            </p>
                        </div>
                        <a href="/results/student-performance/{{.studentID}}"
                            class="px-4 py-2 bg-indigo-600 hover:bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                            <i class="fas fa-file-invoice"></i> Detailed Report
                        </a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50/50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Exam Name</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Paper / Subject</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Marks</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        Grade</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentResultsBody"
                                class="divide-y divide-slate-100 italic text-slate-400 text-[11px]">
                                <tr>
                                    <td colspan="4"
                                        class="px-6 py-20 text-center uppercase tracking-widest font-black opacity-40">
                                        Loading academic results...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div> <!-- End of lg:col-span-8 -->

        <!-- Sidebar / Academic Info -->
        <div class="lg:col-span-4 space-y-6">
            <!-- Academic Profile Card -->
            <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 overflow-hidden relative group">
                <div class="absolute top-0 right-0 p-6 opacity-0 group-hover:opacity-10 transition-opacity">
                    <i class="fas fa-graduation-cap text-4xl text-indigo-600"></i>
                </div>
                <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest mb-6">Academic Profile</h3>

                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Enrolled
                            Class</span>
                        <span class="text-[10px] font-black text-indigo-600 uppercase">{{if
                            .student.Class}}{{.student.Class.Name}}{{else}}UNASSIGNED{{end}}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Gender Spec</span>
                        <span class="text-[10px] font-black text-slate-700 uppercase">{{if
                            .student.Gender}}{{.student.Gender}}{{else}}N/A{{end}}</span>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-100">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Guardian Network
                    </h4>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-xl bg-indigo-50 flex items-center justify-center shrink-0">
                                <i class="fas fa-user-shield text-indigo-500 text-xs"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-800 leading-none mb-1">
                                    {{if .student.Parents}}{{with index .student.Parents 0}}{{.FirstName}}
                                    {{.LastName}}{{end}}{{else}}SYSTEM UNASSIGNED{{end}}
                                </p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Primary Liaison
                                </p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-xl bg-emerald-50 flex items-center justify-center shrink-0">
                                <i class="fas fa-phone-alt text-emerald-500 text-xs"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-800 leading-none mb-1">
                                    {{if .student.Parents}}{{with index .student.Parents 0}}{{if
                                    .Phone}}{{.Phone}}{{else}}N/A{{end}}{{end}}{{else}}N/A{{end}}
                                </p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Cellular line
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="addFeeForStudentBtn"
                        class="w-full py-4 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> Assign New Fee
                    </button>
                </div>
            </div>

            <!-- Quick Tips/Info -->
            <div class="p-6 rounded-3xl bg-indigo-600 text-white shadow-lg shadow-indigo-100 relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 opacity-10 rotate-12">
                    <i class="fas fa-lightbulb text-8xl"></i>
                </div>
                <h4 class="text-xs font-black uppercase tracking-widest mb-2 relative z-10">Financial Tip</h4>
                <p class="text-[11px] leading-relaxed opacity-90 relative z-10">Consolidate multiple small fees into
                    single semester records for cleaner ledger management and easier collection tracking.</p>
            </div>
        </div>
    </div> <!-- End of grid -->


    <!-- Revenue Collection Modal -->
    <div id="paymentModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform transition-all scale-95"
            id="paymentModalContent">
            <div class="px-8 py-5 flex justify-between items-center border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-[15px] font-black text-slate-900 uppercase tracking-widest">Revenue Collection</h3>
                <button onclick="closePaymentModal()"
                    class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-400 hover:text-rose-500 transition-all flex items-center justify-center shadow-sm">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>

            <form id="paymentForm" class="p-6 space-y-4">
                <input type="hidden" id="paymentFeeId">
                <input type="hidden" id="paymentStudentId">

                <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-2xl">
                    <p id="paymentStudentName" class="text-[10px] font-black text-indigo-900 uppercase tracking-widest">
                    </p>
                    <p id="paymentFeeTitle" class="text-[11px] text-indigo-600/70 mt-1 font-bold"></p>
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-indigo-200/50">
                        <span class="text-[9px] text-indigo-400 font-black uppercase tracking-widest">Balance Due</span>
                        <span id="paymentCurrentBalance" class="text-lg font-black text-rose-600 tracking-tight"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="paymentAmount"
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Collection
                            Amount (UGX)</label>
                        <input type="number" id="paymentAmount" step="0.01" min="0" required
                            class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all text-xl font-black text-slate-900">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="paymentMethod"
                                class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Payment
                                Method</label>
                            <select id="paymentMethod" required
                                class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[10px] uppercase tracking-widest appearance-none">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Mobile Money">Mobile Money</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>
                        <div>
                            <label for="paymentTxId"
                                class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Reference
                                ID</label>
                            <input type="text" id="paymentTxId" placeholder="TXN-XXXX"
                                class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[10px] uppercase tracking-widest">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closePaymentModal()"
                        class="flex-1 px-6 py-4 text-slate-500 font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 rounded-2xl transition-all">
                        Discard
                    </button>
                    <button type="submit" id="submitPaymentBtn"
                        class="flex-[2] px-6 py-4 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all shadow-slate-200">
                        Confirm Collection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Revenue Record Modal -->
    <div id="addFeeModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-[2.5rem] shadow-2xl max-w-lg w-full mx-4 overflow-hidden transform transition-all scale-95"
            id="addFeeModalContent">
            <div class="px-10 py-8 flex justify-between items-center border-b border-slate-100 bg-slate-50/30">
                <div>
                    <h3 class="text-[17px] font-black text-slate-900 uppercase tracking-widest leading-none">Assign
                        Revenue</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-2 opacity-60">Financial
                        Debit Entry</p>
                </div>
                <button onclick="closeAddFeeModal()"
                    class="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-rose-500 transition-all flex items-center justify-center shadow-sm">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <form id="addFeeForm" class="p-10 space-y-6">
                <input type="hidden" id="addFeeStudentId" value="{{.studentID}}">
                <input type="hidden" id="addFeeTitle">

                <div class="grid grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Fee
                            Classification</label>
                        <button type="button" onclick="openFeeTypeSelectionModal()" id="categorySelectBtn"
                            class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl hover:border-indigo-200 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[10px] uppercase tracking-widest text-left flex items-center justify-between group">
                            <span id="selectedCategoryName" class="text-slate-400 italic">Determine category...</span>
                            <i
                                class="fas fa-chevron-right text-[10px] text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                        </button>
                        <input type="hidden" id="addFeeType" required>
                    </div>

                    <div class="col-span-2">
                        <label
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Billing
                            Amount (UGX)</label>
                        <input type="number" id="addFeeAmount" required placeholder="0.00"
                            class="w-full px-6 py-5 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-2xl text-slate-900">
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Academic
                            Cycle</label>
                        <select id="addFeeYear" required
                            class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[10px] uppercase tracking-widest appearance-none">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Session
                            Term</label>
                        <select id="addFeeTerm" required
                            class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[10px] uppercase tracking-widest appearance-none">
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <div class="col-span-2">
                        <label
                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Settlement
                            Deadline</label>
                        <input type="date" id="addFeeDueDate" required
                            class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-black text-[11px] uppercase tracking-widest">
                    </div>
                </div>

                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="closeAddFeeModal()"
                        class="flex-1 px-8 py-4 text-slate-400 font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 rounded-2xl transition-all">
                        Cancel
                    </button>
                    <button type="submit" id="saveFeeBtn"
                        class="flex-[2] px-8 py-4 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all shadow-slate-200">
                        Assign Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Library Selection Modal -->
    <div id="feeTypeSelectionModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[60] transition-opacity duration-300">
        <div class="bg-white rounded-[2.5rem] shadow-2xl max-w-2xl w-full mx-4 overflow-hidden transform transition-all scale-95"
            id="feeTypeSelectionModalContent">
            <div class="px-10 py-8 flex justify-between items-center border-b border-slate-100 bg-slate-50/50">
                <div>
                    <h3 class="text-[17px] font-black text-slate-900 uppercase tracking-widest">Category Library</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-2">Select Financial
                        Classification</p>
                </div>
                <button onclick="closeFeeTypeSelectionModal()"
                    class="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-rose-500 transition-all flex items-center justify-center shadow-sm">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div class="p-6 border-b border-slate-50 bg-slate-50/30">
                <div class="relative group">
                    <i
                        class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 text-sm group-focus-within:text-indigo-500 transition-colors"></i>
                    <input type="text" id="feeTypeSearch" oninput="filterFeeTypes(this.value)"
                        placeholder="Search classifications..."
                        class="w-full pl-14 pr-6 py-5 bg-white border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-bold text-sm shadow-sm">
                </div>
            </div>

            <div class="p-6 max-h-[400px] overflow-y-auto" id="feeTypeList">
                <!-- Loaded via JS -->
                <div id="feeTypesGrid" class="flex flex-col gap-2"></div>
                <div id="feeTypesEmptyState" class="hidden py-12 text-center" style="display: none;">
                    <i class="fas fa-search text-slate-200 text-4xl mb-4"></i>
                    <p class="text-slate-400 font-black text-xs uppercase tracking-widest">No categories found</p>
                </div>
            </div>

            <div class="px-10 py-6 bg-slate-50/50 border-t border-slate-100 flex items-center justify-between">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Pick a category to populate
                    the assignment form</p>
                <button onclick="closeFeeTypeSelectionModal()"
                    class="px-6 py-2 bg-white border border-slate-200 rounded-xl text-[9px] font-black text-slate-800 uppercase tracking-widest hover:bg-slate-50 transition-all">
                    System Close
                </button>
            </div>
        </div>
    </div>


    <script>
        const studentID = "{{.studentID}}";
        const classID = "{{if .student.ClassID}}{{.student.ClassID}}{{end}}";
        let studentFees = [];
        let allFeeTypes = [];

        document.addEventListener('DOMContentLoaded', function () {
            console.log("Student Profile Loaded. StudentID:", studentID);
            loadStudentFees();
            loadFeeFormData();

            // Payment Form Submission 
            document.getElementById('paymentForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitPayment();
            });

            // Add Fee Form Submission
            document.getElementById('addFeeForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitAddFee();
            });

            // Open Add Fee Modal Trigger
            const addBtn = document.getElementById('addFeeForStudentBtn');
            if (addBtn) addBtn.addEventListener('click', openAddFeeModal);

            loadStudentPayments();
            handleTabFromUrl();
        });

        async function loadStudentPayments() {
            const container = document.getElementById('paymentHistoryTableBody');

            try {
                const res = await fetch(`/api/fees/student/${studentID}/payments`);
                const result = await res.json();

                if (result.success && result.data) {
                    renderPayments(result.data);
                } else {
                    container.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No payment history found</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                container.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-rose-500 text-xs font-bold">Failed to load payment history</td></tr>`;
            }
        }

        function renderPayments(payments) {
            const container = document.getElementById('paymentHistoryTableBody');
            if (!payments || payments.length === 0) {
                container.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No payment history recorded yet</td></tr>`;
                return;
            }

            container.innerHTML = payments.map(p => {
                const date = new Date(p.payment_date).toLocaleDateString();
                const method = p.payment_method;
                const total = new Intl.NumberFormat().format(p.total_amount);

                // Formating allocations display
                const allocationsHtml = p.allocations.map(a => {
                    const cumulativePaid = a.total_fee_amount - a.balance;
                    return `
                    <div class="flex flex-col gap-1.5 mt-2 first:mt-0 p-2.5 bg-slate-50 border border-slate-100 rounded-lg min-w-[220px]">
                        <div class="flex items-center justify-between mb-1">
                            <span class="px-1.5 py-0.5 bg-white text-[9px] font-black text-slate-500 rounded border border-slate-200 uppercase tracking-widest">${a.fee_type_name}</span>
                            ${a.is_fully_paid ? '<span class="text-[8px] font-black text-emerald-500 uppercase tracking-widest"><i class="fas fa-check-circle mr-1"></i>Settled</span>' : ''}
                        </div>
                        
                        <div class="flex items-center justify-between text-[10px] font-black">
                            <span class="text-slate-400 uppercase tracking-tighter text-[8px]">Session Credit:</span>
                            <span class="text-indigo-600">UGX ${new Intl.NumberFormat().format(a.amount)}</span>
                        </div>

                        <div class="flex items-center justify-between mt-1 pt-1.5 border-t border-slate-100">
                            <div class="flex items-center gap-1">
                                <span class="text-[8px] text-slate-400 font-black uppercase tracking-tighter">Balance Due:</span>
                                <span class="text-[10px] font-black ${a.balance > 0 ? 'text-rose-500' : 'text-emerald-500'}">
                                    UGX ${new Intl.NumberFormat().format(a.balance)}
                                </span>
                            </div>
                        </div>
                    </div>
                `}).join('') || '<span class="text-[10px] text-slate-400">No specific allocations</span>';

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-700 whitespace-nowrap">${date}</span>
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5 whitespace-nowrap">${method}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col min-w-[200px]">
                                ${allocationsHtml}
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4 text-right">
                            <span class="font-bold text-slate-700 text-sm whitespace-nowrap">UGX ${total}</span>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex justify-center">
                                <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded text-[10px] font-bold uppercase tracking-widest whitespace-nowrap">Successful</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadStudentFees() {
            const tableBody = document.getElementById('studentFeesTableBody');

            // Initial Skeletons handled in HTML, but can re-trigger if needed

            try {
                const res = await fetch(`/api/fees?student_id=${studentID}&limit=100`);
                const data = await res.json();

                if (data.success && data.data) {
                    studentFees = data.data;
                    renderFees(studentFees);
                    updateStats(studentFees);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center"><div class="flex flex-col items-center"><i class="fas fa-folder-open text-4xl text-slate-200 mb-4"></i><p class="text-slate-400 font-bold uppercase tracking-widest text-xs">No records found</p></div></td></tr>';
                }
            } catch (err) {
                console.error('Error:', err);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center text-rose-500 font-bold">Failed to connect to ledger service.</td></tr>';
            }
        }

        async function loadFeeFormData() {
            try {
                const [yearsRes, termsRes, typesRes] = await Promise.all([
                    fetch('/api/settings/academic-years'),
                    fetch('/api/settings/terms'),
                    fetch(`/api/fee-types?class_id=${classID}&student_id=${studentID}`)
                ]);

                const [yearsInfo, termsInfo, typesInfo] = await Promise.all([
                    yearsRes.json(),
                    termsRes.json(),
                    typesRes.json()
                ]);

                const yearSelect = document.getElementById('addFeeYear');
                const termSelect = document.getElementById('addFeeTerm');

                const years = Array.isArray(yearsInfo) ? yearsInfo : (yearsInfo.data || []);
                const terms = Array.isArray(termsInfo) ? termsInfo : (termsInfo.data || []);
                allFeeTypes = Array.isArray(typesInfo) ? typesInfo : (typesInfo.data || []);

                yearSelect.innerHTML = years.map(y => `<option value="${y.id}" ${y.is_current ? 'selected' : ''}>${y.name}</option>`).join('');
                termSelect.innerHTML = terms.map(t => `<option value="${t.id}" ${t.is_current ? 'selected' : ''}>${t.name}</option>`).join('');

                // Render the selection grid
                renderFeeTypeSelection(allFeeTypes);
            } catch (error) {
                console.error('Error loading form data:', error);
            }
        }

        function renderFeeTypeSelection(types) {
            const grid = document.getElementById('feeTypesGrid');
            const emptyState = document.getElementById('feeTypesEmptyState');

            if (types.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = types.map(t => `
                <button type="button" onclick="selectFeeType('${t.id}', '${t.name}', ${t.amount})"
                    class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg text-left hover:border-indigo-600 hover:bg-indigo-50/20 transition-all group w-full">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">
                            <i class="fas fa-file-invoice-dollar text-xs"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-800 group-hover:text-indigo-600 transition-colors">${t.name}</span>
                            <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">${t.code}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-700">UGX ${new Intl.NumberFormat().format(t.amount)}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase">Standard Rate</p>
                        </div>
                        <i class="fas fa-plus-circle text-slate-200 group-hover:text-indigo-500 transition-colors"></i>
                    </div>
                </button>
            `).join('');
        }

        function filterFeeTypes(query) {
            const filtered = allFeeTypes.filter(t =>
                t.name.toLowerCase().includes(query.toLowerCase()) ||
                t.code.toLowerCase().includes(query.toLowerCase())
            );
            renderFeeTypeSelection(filtered);
        }

        function selectFeeType(id, name, amount) {
            document.getElementById('addFeeType').value = id;
            document.getElementById('addFeeTitle').value = name;
            const categorySpan = document.getElementById('selectedCategoryName');
            categorySpan.textContent = name;
            categorySpan.classList.remove('text-slate-400', 'italic');
            categorySpan.classList.add('text-slate-900');

            // Auto fill amount
            const amountInput = document.getElementById('addFeeAmount');
            amountInput.value = amount;

            closeFeeTypeSelectionModal();
        }

        function openFeeTypeSelectionModal() {
            const modal = document.getElementById('feeTypeSelectionModal');
            const content = document.getElementById('feeTypeSelectionModalContent');

            // Clear search
            document.getElementById('feeTypeSearch').value = '';
            renderFeeTypeSelection(allFeeTypes);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeFeeTypeSelectionModal() {
            const modal = document.getElementById('feeTypeSelectionModal');
            const content = document.getElementById('feeTypeSelectionModalContent');

            modal.classList.remove('opacity-100');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function renderFees(fees) {
            const tableBody = document.getElementById('studentFeesTableBody');
            document.getElementById('feeCountLabel').textContent = `${fees.length} Records`;

            if (fees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-8 py-20 text-center"><div class="flex flex-col items-center"><i class="fas fa-folder-open text-4xl text-slate-200 mb-4"></i><p class="text-slate-400 font-bold uppercase tracking-widest text-xs">No records found</p></div></td></tr>';
                return;
            }

            tableBody.innerHTML = fees.map(fee => {
                const balance = parseFloat(fee.balance);
                const amount = parseFloat(fee.amount);
                const paid = amount - balance;
                const progress = (paid / amount) * 100;

                const isPaid = fee.paid || balance === 0;
                const statusClass = isPaid ? 'bg-emerald-50 text-emerald-600' : (balance < amount ? 'bg-amber-50 text-amber-600' : 'bg-rose-50 text-rose-600');
                const statusText = isPaid ? 'Settled' : (balance < amount ? 'Partial' : 'Due');

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors group border-b border-slate-50 last:border-0">
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col items-start gap-1">
                                <span class="text-[13px] font-black text-slate-900 tracking-tight uppercase whitespace-nowrap">${fee.fee_type_code || 'GEN'}</span>
                                <span class="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] font-black uppercase tracking-widest border border-slate-200/50 whitespace-nowrap">ID: ${fee.id.substring(0, 8)}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col whitespace-nowrap">
                                <span class="text-[11px] font-black text-slate-700 uppercase tracking-wider">${fee.academic_year_name || '-'}</span>
                                <span class="text-[9px] font-black text-slate-400 mt-1 uppercase tracking-widest">${fee.term_name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="min-w-[140px] md:max-w-[150px] md:ml-auto flex flex-col gap-1.5">
                                <div class="flex justify-between items-center whitespace-nowrap">
                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Gross</span>
                                    <span class="text-[10px] font-black text-indigo-600">${Math.round(progress)}%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden shadow-inner">
                                     <div class="bg-indigo-500 h-full rounded-full transition-all duration-700 shadow-[0_0_8px_rgba(99,102,241,0.3)]" style="width: ${progress}%"></div>
                                </div>
                                <div class="flex justify-end items-center whitespace-nowrap mt-0.5">
                                    <span class="text-[10px] font-black text-slate-400 mr-2 uppercase tracking-widest">Bal:</span>
                                    <span class="text-[12px] font-black ${balance > 0 ? 'text-rose-500' : 'text-slate-400'} uppercase">UGX ${new Intl.NumberFormat().format(balance)}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4 text-center">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest ${statusClass} shadow-sm border border-black/5 whitespace-nowrap">
                                <i class="fas ${isPaid ? 'fa-circle-check' : (balance < amount ? 'fa-circle-half-stroke' : 'fa-circle-dot')} mr-1.5 text-[9px]"></i>${statusText}
                            </span>
                        </td>
                        <td class="px-4 md:px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-1.5">
                                ${!isPaid ? `
                                    <button onclick="openPaymentModal('${fee.id}', '${fee.student_id}', '${fee.student_name}', '${fee.title}', ${fee.balance})" 
                                        class="h-8 px-4 bg-slate-900 hover:bg-black text-white text-[10px] font-black uppercase tracking-widest rounded-xl transition-all shadow-md hover:scale-[1.05] active:scale-95 whitespace-nowrap">
                                        Collect
                                    </button>
                                ` : `
                                    <button class="w-9 h-9 bg-slate-50 hover:bg-indigo-50 hover:text-indigo-600 text-slate-400 rounded-xl transition-all flex items-center justify-center border border-slate-200/50 group" title="Print Receipt">
                                        <i class="fas fa-receipt text-xs transition-transform group-hover:scale-110"></i>
                                    </button>
                                `}
                                <button onclick="deleteFee('${fee.id}')" 
                                    class="w-9 h-9 bg-rose-50 hover:bg-rose-100 text-rose-400 rounded-xl transition-all flex items-center justify-center border border-rose-100 group"
                                    title="Purge Record">
                                    <i class="fas fa-trash-alt text-xs transition-transform group-hover:scale-110"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function deleteFee(feeId) {
            if (!confirm('Are you sure you want to remove this fee record? This action cannot be undone.')) return;

            try {
                const res = await fetch(`/api/fees/${feeId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadStudentFees();
                    // Also refresh payments in case allocations were affected
                    loadStudentPayments();
                } else {
                    alert(data.error || 'Failed to delete fee');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Connection failure');
            }
        }

        function updateStats(fees) {
            let total = 0;
            let paid = 0;
            let balance = 0;

            fees.forEach(f => {
                const amt = parseFloat(f.amount);
                const bal = parseFloat(f.balance);
                total += amt;
                balance += bal;
                paid += (amt - bal);
            });

            document.getElementById('totalPayable').textContent = `UGX ${new Intl.NumberFormat().format(total)}`;
            document.getElementById('totalPaid').textContent = `UGX ${new Intl.NumberFormat().format(paid)}`;
            document.getElementById('totalBalance').textContent = `UGX ${new Intl.NumberFormat().format(balance)}`;

            const progress = total > 0 ? (paid / total) * 100 : 0;
            document.getElementById('paymentProgress').style.width = `${progress}%`;
            document.getElementById('progressPct').textContent = `${Math.round(progress)}%`;
        }

        // Modal Functions
        function openPaymentModal(feeId, studentId, studentName, title, balance) {
            document.getElementById('paymentFeeId').value = feeId;
            document.getElementById('paymentStudentId').value = studentId;
            document.getElementById('paymentStudentName').textContent = studentName || '{{.student.FirstName}} {{.student.LastName}}';
            document.getElementById('paymentFeeTitle').textContent = title;
            document.getElementById('paymentCurrentBalance').textContent = `UGX ${new Intl.NumberFormat().format(balance)}`;
            document.getElementById('paymentAmount').value = balance;
            document.getElementById('paymentAmount').max = balance;

            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentModalContent');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentModalContent');

            modal.classList.remove('opacity-100');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('paymentForm').reset();
            }, 300);
            document.body.style.overflow = 'auto';
        }

        async function submitPayment() {
            const btn = document.getElementById('submitPaymentBtn');
            const originalText = btn.innerHTML;

            const feeId = document.getElementById('paymentFeeId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);

            const txId = document.getElementById('paymentTxId').value;

            const data = {
                student_id: document.getElementById('paymentStudentId').value,
                total_amount: amount,
                payment_method: document.getElementById('paymentMethod').value,
                transaction_id: txId.trim() !== "" ? txId : null,
                fee_allocations: [
                    {
                        fee_id: feeId,
                        amount: amount
                    }
                ]
            };

            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Processing...`;

                const response = await fetch('/api/fees/record-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Force refresh both tables before alerting
                    await Promise.all([
                        loadStudentFees(),
                        loadStudentPayments()
                    ]);

                    closePaymentModal();
                    alert('Collection recorded successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Failed to record payment'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Connection failure. Check your network.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function openAddFeeModal() {
            const modal = document.getElementById('addFeeModal');
            const content = document.getElementById('addFeeModalContent');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeAddFeeModal() {
            const modal = document.getElementById('addFeeModal');
            const content = document.getElementById('addFeeModalContent');

            modal.classList.remove('opacity-100');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('addFeeForm').reset();

                // Reset category selection span
                const categorySpan = document.getElementById('selectedCategoryName');
                categorySpan.textContent = 'Determine category...';
                categorySpan.classList.remove('text-slate-900');
                categorySpan.classList.add('text-slate-400', 'italic');
            }, 300);
            document.body.style.overflow = 'auto';
        }

        async function submitAddFee() {
            const btn = document.getElementById('saveFeeBtn');
            const originalText = btn.innerHTML;

            const data = {
                student_id: document.getElementById('addFeeStudentId').value,
                title: document.getElementById('addFeeTitle').value,
                fee_type_id: document.getElementById('addFeeType').value,
                amount: parseFloat(document.getElementById('addFeeAmount').value),
                academic_year_id: document.getElementById('addFeeYear').value,
                academic_term_id: document.getElementById('addFeeTerm').value,
                due_date: document.getElementById('addFeeDueDate').value
            };

            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Assigning...`;

                const response = await fetch('/api/fees', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closeAddFeeModal();
                    loadStudentFees();
                    alert('Fee record created successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Failed to create fee'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Initialize tab based on query parameter
        function handleTabFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab === 'attendance') {
                switchTab('attendance');
            }
        }

        // --- NEW FEATURES: Tab switching and Attendance/Assessment Reports ---
        function switchTab(tab) {
            // Content visibility
            document.getElementById('tab-content-finance').classList.toggle('hidden', tab !== 'finance');
            document.getElementById('tab-content-attendance').classList.toggle('hidden', tab !== 'attendance');
            document.getElementById('tab-content-assessments').classList.toggle('hidden', tab !== 'assessments');

            // Button styling
            const financeBtn = document.getElementById('tab-button-finance');
            const attendanceBtn = document.getElementById('tab-button-attendance');
            const assessmentsBtn = document.getElementById('tab-button-assessments');

            const toggleBtn = (btn, isActive) => {
                if (isActive) {
                    btn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-200/50');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-200/50');
                    btn.classList.add('text-slate-500');
                }
            };

            toggleBtn(financeBtn, tab === 'finance');
            toggleBtn(attendanceBtn, tab === 'attendance');
            toggleBtn(assessmentsBtn, tab === 'assessments');

            // Load data based on tab
            if (tab === 'attendance') {
                loadAttendanceReport();
            } else if (tab === 'assessments') {
                loadAssessmentResults();
            }
        }

        async function loadAssessmentResults() {
            const tbody = document.getElementById('assessmentResultsBody');
            console.log("Loading Assessment Results for:", studentID);
            try {
                const res = await fetch(`/api/results/student/${studentID}`);
                const data = await res.json();
                console.log("Results API Result:", data);

                if (data.success && data.results) {
                    renderAssessmentResults(data.results);
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No assessment history found</td></tr>';
                }
            } catch (err) {
                console.error("Results API Error:", err);
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-rose-500 text-xs font-bold">Failed to load assessment history</td></tr>';
            }
        }

        function renderAssessmentResults(results) {
            const tbody = document.getElementById('assessmentResultsBody');
            console.log("Rendering Assessment Results. Items:", results.length);

            if (!results || results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No assessment results have been recorded for this student yet.</td></tr>';
                return;
            }

            tbody.innerHTML = results.map(r => {
                const exam = r.exam || {};
                const paper = r.paper || {};
                const subject = paper.subject || {};
                const grade = r.grade || {};
                const hasResult = r.id && r.id !== "";
                const marksValue = hasResult ? r.marks : "";
                const gradeDisplay = hasResult && grade.name ? grade.name : 'PENDING';
                const gradeClass = hasResult && grade.name
                    ? 'bg-indigo-50 text-indigo-600 border-indigo-100'
                    : 'bg-amber-50 text-amber-600 border-amber-100 shadow-sm';

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors" data-exam-id="${exam.id || ''}" data-paper-id="${r.paper_id || ''}" data-term-id="${r.term_id || ''}">
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-700 text-xs uppercase">${exam.name || 'Unnamed Exam'}</span>
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${exam.type || 'General'}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-700 text-xs">${subject.name || 'Unknown'}</span>
                                <span class="text-[9px] text-indigo-500 font-bold uppercase tracking-widest mt-0.5">${paper.name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col items-center relative group min-w-[80px]">
                                <input type="number" step="0.01" min="0" max="100" 
                                    class="marks-input w-16 text-center text-xs font-black text-slate-700 bg-transparent border-b border-transparent hover:border-slate-200 focus:border-indigo-500 focus:outline-none transition-all p-1"
                                    value="${marksValue}" 
                                    oninput="debounceResultSave(this)"
                                    placeholder="-">
                                <div class="saving-spinner hidden absolute -right-2 top-2">
                                    <i class="fas fa-circle-notch fa-spin text-indigo-400 text-[10px]"></i>
                                </div>
                                <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Marks</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex justify-center">
                                <span class="grade-badge px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border ${gradeClass} whitespace-nowrap">
                                    ${gradeDisplay}
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadAttendanceReport() {
            const tbody = document.getElementById('attendanceReportBody');
            console.log("Loading Attendance Report for:", studentID);
            try {
                const res = await fetch(`/api/attendance/student-report/${studentID}`);
                const data = await res.json();
                console.log("Attendance API Result:", data);

                if (data.success && data.report) {
                    renderAttendanceReport(data.report);
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No attendance history found</td></tr>';
                }
            } catch (err) {
                console.error("Attendance API Error:", err);
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-rose-500 text-xs font-bold">Failed to load attendance report</td></tr>';
            }
        }

        function renderAttendanceReport(report) {
            const tbody = document.getElementById('attendanceReportBody');
            console.log("Rendering Attendance Report. Items:", report.length);

            if (!report || report.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 text-xs italic">No lessons have been logged for this student yet.</td></tr>';
                return;
            }

            let attended = 0;
            tbody.innerHTML = report.map(r => {
                if (r.status === 'present') attended++;

                // Format date manually or via helper
                const dateObj = new Date(r.date);
                const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

                const statusColors = {
                    'present': 'bg-emerald-50 text-emerald-600 border-emerald-100',
                    'absent': 'bg-rose-50 text-rose-600 border-rose-100',
                    'late': 'bg-amber-50 text-amber-600 border-amber-100',
                    'pending': 'bg-slate-50 text-slate-400 border-slate-100'
                };

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col whitespace-nowrap">
                                <span class="font-bold text-slate-700 text-xs">${dateStr}</span>
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${r.time_slot}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex flex-col min-w-[120px]">
                                <span class="font-bold text-slate-700 text-xs">${r.subject}</span>
                                ${r.paper ? `<span class="text-[9px] text-indigo-500 font-bold uppercase tracking-widest mt-0.5">${r.paper}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <span class="text-xs text-slate-500 line-clamp-1 max-w-[200px]" title="${r.topic || 'No topic recorded'}">${r.topic || '-'}</span>
                        </td>
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex justify-center">
                                <span class="px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest border ${statusColors[r.status] || statusColors.pending} whitespace-nowrap">
                                    ${r.status}
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update stats
            document.getElementById('statTotalLessons').textContent = report.length;
            document.getElementById('statAttended').textContent = attended;
            const rate = report.length > 0 ? Math.round((attended / report.length) * 100) : 0;
            document.getElementById('statRate').textContent = rate + '%';
        }

        let saveTimeout;
        function debounceResultSave(input) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveResultMark(input), 1200);
        }

        async function saveResultMark(input) {
            const marks = parseFloat(input.value);
            if (isNaN(marks)) return; // Don't save empty/invalid locally

            const row = input.closest('tr');
            const examID = row.dataset.examId;
            const paperID = row.dataset.paperId;
            const termID = row.dataset.termId;
            const spinner = row.querySelector('.saving-spinner');
            const badge = row.querySelector('.grade-badge');

            if (marks < 0 || marks > 100) {
                alert('Marks must be between 0 and 100');
                return;
            }

            try {
                spinner.classList.remove('hidden');

                const response = await fetch('/api/results/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exam_id: examID,
                        paper_id: paperID,
                        term_id: termID || null,
                        results: [{
                            student_id: studentID,
                            marks: marks,
                            grade_id: null
                        }]
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    console.log("Mark saved successfully");
                    // Optionally refresh the tab to get updated grade, 
                    // or just update badge to show "SAVED" temporarily
                    badge.textContent = 'SAVED';
                    badge.className = 'grade-badge px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border bg-emerald-50 text-emerald-600 border-emerald-100 shadow-sm whitespace-nowrap';

                    // Reload assessment results after a delay to get definitive grade
                    setTimeout(() => loadAssessmentResults(), 5000);
                } else {
                    console.error("Failed to save mark:", result.error);
                }
            } catch (err) {
                console.error("Error saving mark:", err);
            } finally {
                spinner.classList.add('hidden');
            }
        }
    </script>
    </body>

    </html>