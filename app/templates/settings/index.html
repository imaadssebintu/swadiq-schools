<!-- Unified Settings Hub -->
<div class="px-4 py-4 lg:px-6 lg:py-5 space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div class="flex flex-col gap-1">
            <h1 class="text-xl font-black text-slate-900 tracking-tight uppercase">Settings Hub</h1>
            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Configure Academic Years, Terms &
                System Protocols</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="addAcademicYearBtn"
                class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-200 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Year</span>
            </button>
            <button id="addTermBtn"
                class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-200 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Term</span>
            </button>
            <button id="addAssessmentTypeBtn"
                class="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Category</span>
            </button>
        </div>
    </div>

    <!-- Layout Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Academic Years Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span
                            class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest">Current
                            Years</span>
                        <div class="h-px bg-slate-100 w-12"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100">
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Year Name</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Duration</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Status</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="academicYearsList">
                            <!-- Skeleton Rows -->
                            <tr class="animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="h-3 w-24 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-32 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-5 w-16 bg-slate-100 rounded-lg"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="h-8 w-8 bg-slate-100 rounded-lg ml-auto"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Terms Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span
                            class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest">Current
                            Terms</span>
                        <div class="h-px bg-slate-100 w-12"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100">
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Term Info</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Academic Year</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Dates</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Status</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="termsList">
                            <!-- Skeleton Rows -->
                            <tr class="animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="space-y-2">
                                        <div class="h-3 w-20 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-16 bg-slate-50 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-20 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-32 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-5 w-16 bg-slate-100 rounded-lg"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="h-8 w-8 bg-slate-100 rounded-lg ml-auto"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Assessment Types Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span
                            class="text-[10px] font-black text-slate-900 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-widest">Assessment
                            Categories</span>
                        <div class="h-px bg-slate-100 w-12"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100">
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Category Name</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Code</th>
                                <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    Status</th>
                                <th
                                    class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assessmentTypesList">
                            <!-- Populated via JS -->
                            <tr>
                                <td colspan="4"
                                    class="px-5 py-12 text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest animate-pulse">
                                    Initializing Categories...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Filter Widget -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 space-y-4">
                <h3 class="text-[11px] font-black text-slate-800 uppercase tracking-wider flex items-center gap-2">
                    <i class="fas fa-filter text-slate-400"></i>
                    Display Options
                </h3>

                <div class="space-y-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Search
                            Years</label>
                        <div class="relative">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <input type="text" id="searchAcademicYears" placeholder="Year name..."
                                class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 pl-9 pr-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 placeholder:text-slate-300">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-1">Filter
                            Terms</label>
                        <div class="relative">
                            <i
                                class="fas fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            <select id="academicYearFilter"
                                class="w-full bg-slate-50 border-none text-xs font-bold py-2.5 pl-9 pr-4 rounded-xl focus:ring-2 focus:ring-slate-900/5 appearance-none">
                                <option value="">All Academic Years</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div
                class="bg-slate-900 rounded-2xl p-5 text-white shadow-xl shadow-slate-200 relative overflow-hidden group">
                <div
                    class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                </div>
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 relative z-10">Quick
                    Status</h3>
                <div class="space-y-4 relative z-10">
                    <div class="flex flex-col gap-0.5">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-300">Current Year</span>
                            <span id="activeYearBadge"
                                class="text-[10px] font-black bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded uppercase">None</span>
                        </div>
                        <div id="activeYearDates" class="text-[9px] font-bold text-slate-500 text-right opacity-80">
                        </div>
                    </div>
                    <div class="flex flex-col gap-0.5">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-300">Current Term</span>
                            <span id="activeTermBadge"
                                class="text-[10px] font-black bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded uppercase">None</span>
                        </div>
                        <div id="activeTermDates" class="text-[9px] font-bold text-slate-500 text-right opacity-80">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Settings Nav -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Other Areas</h3>
                <div class="grid grid-cols-1 gap-2">
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl opacity-60">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-halved text-slate-400 text-xs text-center w-4"></i>
                            <span class="text-[10px] font-black text-slate-600 uppercase tracking-tight">Security</span>
                        </div>
                        <span class="text-[8px] font-black text-slate-400">Locked</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl opacity-60">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-puzzle-piece text-slate-400 text-xs text-center w-4"></i>
                            <span
                                class="text-[10px] font-black text-slate-600 uppercase tracking-tight">Integrations</span>
                        </div>
                        <span class="text-[8px] font-black text-slate-400">Soon</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Academic Year Modal -->
<div id="academicYearModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
    onclick="if(event.target === this) hideAcademicYearModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide" id="academicYearModalTitle">Add
                Current Year</h3>
            <button onclick="hideAcademicYearModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="academicYearForm" class="p-6 space-y-4">
            <input type="hidden" id="academicYearId">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Year Name</label>
                <input type="text" id="academicYearName" required placeholder="e.g. 2023/2024"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Start Date</label>
                    <input type="date" id="academicYearStartDate" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">End Date</label>
                    <input type="date" id="academicYearEndDate" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                <input type="checkbox" id="academicYearIsActive"
                    class="w-4 h-4 rounded border-slate-300 text-slate-900 focus:ring-slate-900/5">
                <div class="flex flex-col">
                    <label for="academicYearIsActive" class="text-xs font-bold text-slate-700">Set as Current
                        Year</label>
                    <p class="text-[9px] text-slate-400 font-medium">This will be the default year for new entries</p>
                </div>
            </div>
            <div class="pt-2">
                <button type="submit" id="saveAcademicYearBtn"
                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                    <span>Save Academic Year</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Term Modal -->
<div id="termModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
    onclick="if(event.target === this) hideTermModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide" id="termModalTitle">Add Term</h3>
            <button onclick="hideTermModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="termForm" class="p-6 space-y-4">
            <input type="hidden" id="termId">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Term Name</label>
                <input type="text" id="termName" required placeholder="e.g. Term 1, First Semester"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Academic Year</label>
                <select id="termAcademicYear" required
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900 bg-white">
                    <option value="">Select Academic Year</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Start Date</label>
                    <input type="date" id="termStartDate" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">End Date</label>
                    <input type="date" id="termEndDate" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
                </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                <input type="checkbox" id="termIsActive"
                    class="w-4 h-4 rounded border-slate-300 text-slate-900 focus:ring-slate-900/5">
                <div class="flex flex-col">
                    <label for="termIsActive" class="text-xs font-bold text-slate-700">Set as Current Term</label>
                    <p class="text-[9px] text-slate-400 font-medium">Mark this as the ongoing term for the school</p>
                </div>
            </div>
            <div class="pt-2">
                <button type="submit" id="saveTermBtn"
                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                    <span>Save Term</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Assessment Type Modal -->
<div id="assessmentTypeModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
    onclick="if(event.target === this) hideAssessmentTypeModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide" id="assessmentTypeModalTitle">Add
                Category</h3>
            <button onclick="hideAssessmentTypeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="assessmentTypeForm" class="p-6 space-y-4">
            <input type="hidden" id="assessmentTypeId">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Category Name</label>
                <input type="text" id="assessmentTypeName" required placeholder="e.g. Formal Exam, Pop Quiz"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Short Code</label>
                <input type="text" id="assessmentTypeCode" required placeholder="e.g. EXM, TST"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900 uppercase">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Color Theme</label>
                <select id="assessmentTypeColor"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900/5 focus:border-slate-900 bg-white">
                    <option value="indigo">Indigo (Standard)</option>
                    <option value="sky">Sky (Casual)</option>
                    <option value="amber">Amber (Project)</option>
                    <option value="rose">Rose (Critical)</option>
                    <option value="emerald">Emerald (Success)</option>
                    <option value="slate">Slate (Passive)</option>
                </select>
            </div>
            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                <input type="checkbox" id="assessmentTypeIsActive" checked
                    class="w-4 h-4 rounded border-slate-300 text-slate-900 focus:ring-slate-900/5">
                <div class="flex flex-col">
                    <label for="assessmentTypeIsActive" class="text-xs font-bold text-slate-700">Available for
                        Use</label>
                    <p class="text-[9px] text-slate-400 font-medium">Show this category in the assessment creator</p>
                </div>
            </div>
            <div class="pt-2">
                <button type="submit" id="saveAssessmentTypeBtn"
                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                    <span>Save Category</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden place-items-center flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none"
    onclick="if(event.target === this) hideDeleteModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all scale-95 duration-300">
        <div class="p-8 text-center">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-red-500 text-xl"></i>
            </div>
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide mb-2">Confirm Delete</h3>
            <p class="text-xs text-slate-500 font-medium leading-relaxed">Are you sure you want to delete this item?
                This action is permanent and cannot be undone.</p>
            <input type="hidden" id="deleteItemId">
            <input type="hidden" id="deleteItemType">
        </div>
        <div class="p-4 bg-slate-50 flex gap-3">
            <button type="button" onclick="hideDeleteModal()"
                class="flex-1 bg-white border border-slate-200 text-slate-600 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-100 transition-colors">
                Cancel
            </button>
            <button type="button" id="confirmDeleteBtn"
                class="flex-1 bg-red-600 text-white py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-700 transition-colors shadow-lg shadow-red-200 flex items-center justify-center gap-2">
                <span>Delete</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let academicYears = [];
    let terms = [];
    let assessmentTypes = [];

    // Loading functions
    function setBtnLoading(btnId, isLoading, originalText) {
        const btn = document.getElementById(btnId);
        if (!btn) return;

        if (isLoading) {
            btn.disabled = true;
            btn.classList.add('opacity-80', 'cursor-not-allowed');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Processing...</span>`;
        } else {
            btn.disabled = false;
            btn.classList.remove('opacity-80', 'cursor-not-allowed');
            btn.innerHTML = `<span>${originalText}</span>`;
        }
    }


    // Modal Helpers
    function animateModal(id, show) {
        const modal = document.getElementById(id);
        if (!modal) return;
        if (show) {
            modal.classList.remove('hidden');
            void modal.offsetWidth; // Force reflow
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
        } else {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    function showAddAcademicYearModal() {
        document.getElementById('academicYearModalTitle').textContent = 'Add Current Year';
        document.getElementById('academicYearId').value = '';
        document.getElementById('academicYearName').value = '';
        document.getElementById('academicYearStartDate').value = '';
        document.getElementById('academicYearEndDate').value = '';
        document.getElementById('academicYearIsActive').checked = true;
        animateModal('academicYearModal', true);
    }

    function hideAcademicYearModal() {
        animateModal('academicYearModal', false);
    }

    function showAddTermModal() {
        document.getElementById('termModalTitle').textContent = 'Add Term';
        document.getElementById('termId').value = '';
        document.getElementById('termName').value = '';

        // Auto-select and lock to active year
        const select = document.getElementById('termAcademicYear');
        const activeYear = academicYears.find(y => y.is_active);
        if (activeYear) {
            select.value = activeYear.id;
            select.disabled = true;
        } else {
            select.value = '';
            select.disabled = false;
        }

        document.getElementById('termStartDate').value = '';
        document.getElementById('termEndDate').value = '';
        document.getElementById('termIsActive').checked = true;
        animateModal('termModal', true);
    }

    function hideTermModal() {
        animateModal('termModal', false);
    }

    function showAddAssessmentTypeModal() {
        document.getElementById('assessmentTypeModalTitle').textContent = 'Add Category';
        document.getElementById('assessmentTypeId').value = '';
        document.getElementById('assessmentTypeName').value = '';
        document.getElementById('assessmentTypeCode').value = '';
        document.getElementById('assessmentTypeColor').value = 'indigo';
        document.getElementById('assessmentTypeIsActive').checked = true;
        animateModal('assessmentTypeModal', true);
    }

    function hideAssessmentTypeModal() {
        animateModal('assessmentTypeModal', false);
    }

    function showDeleteModal(id, type) {
        document.getElementById('deleteItemId').value = id;
        document.getElementById('deleteItemType').value = type;
        animateModal('deleteModal', true);
    }

    function hideDeleteModal() {
        animateModal('deleteModal', false);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
        loadAcademicYears();
        loadAssessmentTypes();

        // Event Listeners
        document.getElementById('addAcademicYearBtn').addEventListener('click', showAddAcademicYearModal);
        document.getElementById('addTermBtn').addEventListener('click', showAddTermModal);
        document.getElementById('addAssessmentTypeBtn').addEventListener('click', showAddAssessmentTypeModal);
        document.getElementById('academicYearForm').addEventListener('submit', saveAcademicYear);
        document.getElementById('termForm').addEventListener('submit', saveTerm);
        document.getElementById('assessmentTypeForm').addEventListener('submit', saveAssessmentType);
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

        // Filter events
        document.getElementById('academicYearFilter').addEventListener('change', function () {
            this.dataset.manuallySelected = "true";
            renderTerms();
        });
        document.getElementById('searchAcademicYears').addEventListener('input', renderAcademicYears);
    });

    // Load academic years
    async function loadAcademicYears() {
        try {
            const response = await fetch('/api/settings/academic-years');
            academicYears = await response.json();

            // Flatten terms from academic years for global filter/search use
            terms = academicYears.flatMap(y => (y.terms || []).map(t => ({
                ...t,
                academic_year: { id: y.id, name: y.name }
            })));

            renderAcademicYears();
            populateAcademicYearDropdowns();
            renderTerms();
            updateStats();
        } catch (error) {
            console.error('Error loading academic years:', error);
        }
    }


    async function loadAssessmentTypes() {
        try {
            const response = await fetch('/api/settings/assessment-types');
            const data = await response.json();
            assessmentTypes = Array.isArray(data) ? data : [];
            renderAssessmentTypes();
        } catch (error) {
            console.error('Error loading assessment types:', error);
        }
    }

    function updateStats() {
        const activeYear = academicYears.find(y => y.is_active);
        const activeYearBadge = document.getElementById('activeYearBadge');
        const activeYearDates = document.getElementById('activeYearDates');

        if (activeYearBadge) {
            if (activeYear) {
                activeYearBadge.textContent = activeYear.name;
                activeYearBadge.className = 'text-[10px] font-black bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded uppercase';
                if (activeYearDates) {
                    activeYearDates.textContent = `${new Date(activeYear.start_date).toLocaleDateString()} - ${new Date(activeYear.end_date).toLocaleDateString()}`;
                }
            } else {
                activeYearBadge.textContent = 'None';
                activeYearBadge.className = 'text-[10px] font-black bg-slate-800 text-slate-500 px-2 py-0.5 rounded uppercase';
                if (activeYearDates) activeYearDates.textContent = '';
            }
        }

        // Current term must be strictly active in the database
        const activeTerm = terms.find(t => t.is_active);
        const activeTermBadge = document.getElementById('activeTermBadge');
        const activeTermDates = document.getElementById('activeTermDates');

        if (activeTermBadge) {
            if (activeTerm) {
                activeTermBadge.textContent = activeTerm.name;
                activeTermBadge.className = 'text-[10px] font-black bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded uppercase';
                if (activeTermDates) {
                    activeTermDates.textContent = `${new Date(activeTerm.start_date).toLocaleDateString()} - ${new Date(activeTerm.end_date).toLocaleDateString()}`;
                }
            } else {
                activeTermBadge.textContent = 'None';
                activeTermBadge.className = 'text-[10px] font-black bg-slate-800 text-slate-500 px-2 py-0.5 rounded uppercase';
                if (activeTermDates) activeTermDates.textContent = '';
            }
        }
    }

    // Render academic years as table rows
    function renderAcademicYears() {
        const container = document.getElementById('academicYearsList');
        const searchTerm = document.getElementById('searchAcademicYears').value.toLowerCase();

        container.innerHTML = '';
        const filtered = academicYears.filter(y => y.name.toLowerCase().includes(searchTerm));

        if (filtered.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="4" class="px-5 py-12 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        No matching years found
                    </td>
                </tr>`;
            return;
        }

        filtered.forEach(year => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors group cursor-pointer';

            // Set year filter and render terms on row click
            tr.onclick = (e) => {
                // Don't trigger if clicking buttons
                if (e.target.closest('button')) return;

                const filterEl = document.getElementById('academicYearFilter');
                filterEl.value = year.id;
                filterEl.dataset.manuallySelected = "true";
                renderTerms();

                // Optional: scroll to terms section for better UX
                document.getElementById('termsList').closest('div').scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            tr.innerHTML = `
                <td class="px-5 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-slate-900 group-hover:text-white transition-colors">
                            <i class="fas fa-calendar-alt text-[10px]"></i>
                        </div>
                        <span class="text-xs font-black text-slate-700 uppercase tracking-tight">${year.name}</span>
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">
                        ${formatDate(year.start_date)} - ${formatDate(year.end_date)}
                    </span>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[9px] font-black px-2 py-0.5 rounded uppercase ${year.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-slate-100 text-slate-400 border border-slate-200'}">
                        ${year.is_active ? 'Current' : 'Previous'}
                    </span>
                </td>
                <td class="px-5 py-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="setCurrentYear('${year.id}')" 
                            class="w-8 h-8 flex items-center justify-center rounded-xl transition-all ${year.is_active ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-200 cursor-default' : 'bg-slate-50 text-slate-400 hover:bg-emerald-500 hover:text-white'}"
                            title="Set as Current Year">
                            <i class="fas fa-check text-[10px]"></i>
                        </button>
                        <button onclick="editAcademicYear('${year.id}')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                        <button onclick="showDeleteModal('${year.id}', 'academic_year')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </td>`;
            container.appendChild(tr);
        });
    }

    // Render assessment types as table rows
    function renderAssessmentTypes() {
        const container = document.getElementById('assessmentTypesList');
        container.innerHTML = '';

        if (assessmentTypes.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="4" class="px-5 py-12 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        No assessment categories defined
                    </td>
                </tr>`;
            return;
        }

        assessmentTypes.forEach(t => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors group';
            tr.innerHTML = `
                <td class="px-5 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white bg-${t.color}-500 shadow-sm shadow-${t.color}-200">
                            <i class="fas fa-tag text-[10px]"></i>
                        </div>
                        <span class="text-xs font-black text-slate-700 uppercase tracking-tight">${t.name}</span>
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${t.code}</span>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[9px] font-black px-2 py-0.5 rounded uppercase ${t.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-slate-100 text-slate-400 border border-slate-200'}">
                        ${t.is_active ? 'Active' : 'Disabled'}
                    </span>
                </td>
                <td class="px-5 py-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="editAssessmentType('${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                        <button onclick="showDeleteModal('${t.id}', 'assessment_type')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </td>`;
            container.appendChild(tr);
        });
    }

    // Render terms as table rows
    function renderTerms() {
        const container = document.getElementById('termsList');
        const filterEl = document.getElementById('academicYearFilter');
        let yearFilter = filterEl.value;

        // No more defaulting to active year in JS. 
        // Backend strictly returns active terms by default.

        container.innerHTML = '';
        const filtered = terms.filter(t => !yearFilter || t.academic_year_id === yearFilter);

        if (filtered.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="5" class="px-5 py-12 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        No active terms found
                    </td>
                </tr>`;
            return;
        }

        filtered.forEach(term => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors group';
            tr.innerHTML = `
                <td class="px-5 py-4">
                    <div class="flex flex-col">
                        <span class="text-xs font-black text-slate-700 uppercase tracking-tight">${term.name}</span>
                        <span class="text-[8px] font-bold text-slate-300 uppercase tracking-widest mt-0.5">Academic Term</span>
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-tight">
                        ${term.academic_year ? term.academic_year.name : 'Unknown'}
                    </span>
                </td>
                <td class="px-5 py-4">
                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase">
                        <span>${formatDate(term.start_date)}</span>
                        <span class="text-slate-200">â€”</span>
                        <span>${formatDate(term.end_date)}</span>
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-[9px] font-black px-2 py-0.5 rounded uppercase 
                        ${term.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-slate-100 text-slate-400 border border-slate-200'}">
                        ${term.is_active ? 'Current' : 'Previous'}
                    </span>
                </td>
                <td class="px-5 py-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="setCurrentTerm('${term.id}')" 
                            class="w-8 h-8 flex items-center justify-center rounded-xl transition-all ${term.is_active ? 'bg-blue-500 text-white shadow-lg shadow-blue-200 cursor-default' : 'bg-slate-50 text-slate-400 hover:bg-blue-500 hover:text-white'}"
                            title="Set as Current Term">
                            <i class="fas fa-check text-[10px]"></i>
                        </button>
                        <button onclick="editTerm('${term.id}')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                        <button onclick="showDeleteModal('${term.id}', 'term')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </td>`;
            container.appendChild(tr);
        });
    }

    // Populate academic year dropdowns
    function populateAcademicYearDropdowns() {
        const filter = document.getElementById('academicYearFilter');
        const select = document.getElementById('termAcademicYear');

        filter.innerHTML = '<option value="">All Academic Years</option>';
        select.innerHTML = '<option value="">Select Academic Year</option>';

        let activeYearId = '';
        academicYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year.id;
            option.textContent = year.name;
            filter.appendChild(option.cloneNode(true));
            select.appendChild(option);
            if (year.is_active) activeYearId = year.id;
        });

        // Default to active year if not manually changed
        if (activeYearId && !filter.value && !filter.dataset.manuallySelected) {
            filter.value = activeYearId;
        }
    }

    async function setCurrentYear(id) {
        const year = academicYears.find(y => y.id === id);
        if (year && year.is_active) return;

        try {
            const response = await fetch(`/api/settings/academic-years/${id}/set-current`, {
                method: 'PUT'
            });
            if (response.ok) {
                await loadAcademicYears();

            } else {
                const error = await response.json();
                alert(error.error || 'Failed to update current year');
            }
        } catch (error) {
            console.error('Error setting current year:', error);
        }
    }

    async function setCurrentTerm(id) {
        const term = terms.find(t => t.id === id);
        if (term && term.is_active) return;

        try {
            const response = await fetch(`/api/settings/terms/${id}/set-current`, {
                method: 'PUT'
            });
            if (response.ok) {
                await loadAcademicYears();

            } else {
                const error = await response.json();
                alert(error.error || 'Failed to update current term');
            }
        } catch (error) {
            console.error('Error setting current term:', error);
        }
    }

    // Edit functions
    function editAcademicYear(id) {
        const year = academicYears.find(y => y.id === id);
        if (!year) return;

        document.getElementById('academicYearModalTitle').textContent = 'Edit Academic Year';
        document.getElementById('academicYearId').value = year.id;
        document.getElementById('academicYearName').value = year.name;
        document.getElementById('academicYearStartDate').value = formatDateForInput(year.start_date);
        document.getElementById('academicYearEndDate').value = formatDateForInput(year.end_date);
        document.getElementById('academicYearIsActive').checked = year.is_active;
        animateModal('academicYearModal', true);
    }

    function editTerm(id) {
        const term = terms.find(t => t.id === id);
        if (!term) return;

        document.getElementById('termModalTitle').textContent = 'Edit Term';
        document.getElementById('termId').value = term.id;
        document.getElementById('termName').value = term.name;

        const select = document.getElementById('termAcademicYear');
        select.value = term.academic_year_id;
        select.disabled = true; // Lock academic year during edit as well

        document.getElementById('termStartDate').value = formatDateForInput(term.start_date);
        document.getElementById('termEndDate').value = formatDateForInput(term.end_date);
        document.getElementById('termIsActive').checked = term.is_current;
        animateModal('termModal', true);
    }

    function editAssessmentType(id) {
        const t = assessmentTypes.find(type => type.id === id);
        if (!t) return;

        document.getElementById('assessmentTypeModalTitle').textContent = 'Edit Category';
        document.getElementById('assessmentTypeId').value = t.id;
        document.getElementById('assessmentTypeName').value = t.name;
        document.getElementById('assessmentTypeCode').value = t.code;
        document.getElementById('assessmentTypeColor').value = t.color || 'indigo';
        document.getElementById('assessmentTypeIsActive').checked = t.is_active;
        animateModal('assessmentTypeModal', true);
    }

    // Save academic year
    async function saveAcademicYear(e) {
        e.preventDefault();
        const id = document.getElementById('academicYearId').value;
        const data = {
            name: document.getElementById('academicYearName').value,
            start_date: document.getElementById('academicYearStartDate').value,
            end_date: document.getElementById('academicYearEndDate').value,
            is_active: document.getElementById('academicYearIsActive').checked,
            is_current: false
        };

        if (!data.start_date || !data.end_date) return alert('Please provide dates');

        setBtnLoading('saveAcademicYearBtn', true, 'Save Academic Year');
        try {
            const response = await fetch(id ? `/api/settings/academic-years/${id}` : '/api/settings/academic-years', {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                hideAcademicYearModal();
                loadAcademicYears();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to save academic year');
            }
        } catch (error) {
            console.error('Error saving academic year:', error);
        } finally {
            setBtnLoading('saveAcademicYearBtn', false, 'Save Academic Year');
        }
    }

    // Save term
    async function saveTerm(e) {
        e.preventDefault();
        const id = document.getElementById('termId').value;
        const data = {
            name: document.getElementById('termName').value,
            academic_year_id: document.getElementById('termAcademicYear').value,
            start_date: document.getElementById('termStartDate').value,
            end_date: document.getElementById('termEndDate').value,
            is_current: document.getElementById('termIsActive').checked
        };

        setBtnLoading('saveTermBtn', true, 'Save Term');
        try {
            const response = await fetch(id ? `/api/settings/terms/${id}` : '/api/settings/terms', {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                hideTermModal();
                loadAcademicYears();

            } else {
                const error = await response.json();
                alert(error.error || 'Failed to save term');
            }
        } catch (error) {
            console.error('Error saving term:', error);
        } finally {
            setBtnLoading('saveTermBtn', false, 'Save Term');
        }
    }

    async function saveAssessmentType(e) {
        e.preventDefault();
        const id = document.getElementById('assessmentTypeId').value;
        const data = {
            name: document.getElementById('assessmentTypeName').value,
            code: document.getElementById('assessmentTypeCode').value,
            color: document.getElementById('assessmentTypeColor').value,
            is_active: document.getElementById('assessmentTypeIsActive').checked
        };

        setBtnLoading('saveAssessmentTypeBtn', true, 'Save Category');
        try {
            const response = await fetch(id ? `/api/settings/assessment-types/${id}` : '/api/settings/assessment-types', {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                hideAssessmentTypeModal();
                loadAssessmentTypes();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to save category');
            }
        } catch (error) {
            console.error('Error saving assessment type:', error);
        } finally {
            setBtnLoading('saveAssessmentTypeBtn', false, 'Save Category');
        }
    }

    // Confirm delete
    async function confirmDelete() {
        const id = document.getElementById('deleteItemId').value;
        const type = document.getElementById('deleteItemType').value;

        setBtnLoading('confirmDeleteBtn', true, 'Delete');
        try {
            let endpoint = '';
            if (type === 'academic_year') endpoint = `/api/settings/academic-years/${id}`;
            else if (type === 'term') endpoint = `/api/settings/terms/${id}`;
            else if (type === 'assessment_type') endpoint = `/api/settings/assessment-types/${id}`;

            const response = await fetch(endpoint, { method: 'DELETE' });

            if (response.ok) {
                hideDeleteModal();
                if (type === 'academic_year') loadAcademicYears();
                else if (type === 'term') loadAcademicYears();

                else if (type === 'assessment_type') loadAssessmentTypes();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to delete item');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
        } finally {
            setBtnLoading('confirmDeleteBtn', false, 'Delete');
        }
    }

    // Helper functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];
    }

    // Globals for button clicks
    window.editAcademicYear = editAcademicYear;
    window.editTerm = editTerm;
    window.setCurrentYear = setCurrentYear;
    window.setCurrentTerm = setCurrentTerm;
    window.editAssessmentType = editAssessmentType;
    window.showDeleteModal = showDeleteModal;
    window.hideAcademicYearModal = hideAcademicYearModal;
    window.hideTermModal = hideTermModal;
    window.hideAssessmentTypeModal = hideAssessmentTypeModal;
    window.hideDeleteModal = hideDeleteModal;
</script>