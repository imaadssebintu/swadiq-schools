<div class="h-full flex flex-col bg-[#f8fafc]">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-8 py-6 shrink-0">
        <div class="flex items-center justify-between max-w-7xl mx-auto w-full">
            <div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight">Assessment Structure</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Manage major classifications
                    and specific assessment types</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/settings"
                    class="px-4 py-2 text-[10px] font-black text-slate-500 uppercase tracking-widest hover:text-slate-900 transition-colors flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
                <button onclick="showCategoryModal()"
                    class="px-6 py-2.5 bg-slate-100 text-slate-900 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 transition-all flex items-center gap-2 shadow-sm">
                    <i class="fas fa-plus"></i> New Classification
                </button>
                <button onclick="showTypeModal()"
                    class="px-6 py-2.5 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all flex items-center gap-2 shadow-lg shadow-slate-200">
                    <i class="fas fa-plus"></i> New Assessment
                </button>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto space-y-8">
            <!-- Categories Section -->
            <section class="space-y-4">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-6 bg-slate-900 rounded-full"></div>
                    <h2 class="text-sm font-black text-slate-900 uppercase tracking-widest">Major Classifications</h2>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Classification</th>
                                <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Code</th>
                                <th
                                    class="px-5 py-4 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                            <!-- Skeleton Rows -->
                            <tr class="animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="h-3 w-24 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-12 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="h-3 w-32 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-16 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Types Section -->
            <section class="space-y-4">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-6 bg-indigo-600 rounded-full"></div>
                    <h2 class="text-sm font-black text-slate-900 uppercase tracking-widest">Specific Assessment Types
                    </h2>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Assessment Name</th>
                                <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Code</th>
                                <th class="px-5 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Classification</th>
                                <th
                                    class="px-5 py-4 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="typesTableBody">
                            <!-- Skeleton Rows -->
                            <tr class="animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="flex flex-col gap-1">
                                        <div class="h-3 w-24 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-16 bg-slate-50 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-10 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-5 w-20 bg-slate-100 rounded-lg"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="animate-pulse border-b border-slate-50">
                                <td class="px-5 py-4">
                                    <div class="flex flex-col gap-1">
                                        <div class="h-3 w-32 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-20 bg-slate-50 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-12 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-5 w-24 bg-slate-100 rounded-lg"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="animate-pulse">
                                <td class="px-5 py-4">
                                    <div class="flex flex-col gap-1">
                                        <div class="h-3 w-28 bg-slate-100 rounded"></div>
                                        <div class="h-2 w-12 bg-slate-50 rounded"></div>
                                    </div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-3 w-8 bg-slate-100 rounded"></div>
                                </td>
                                <td class="px-5 py-4">
                                    <div class="h-5 w-16 bg-slate-100 rounded-lg"></div>
                                </td>
                                <td class="px-5 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                        <div class="w-8 h-8 rounded-lg bg-slate-100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <!-- Category Modal -->
    <div id="categoryModal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden place-items-center p-4 overflow-y-auto flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest" id="catModalTitle">Add
                    Classification</h3>
                <button onclick="hideCategoryModal()" class="text-slate-400 hover:text-slate-600 transition-colors"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="categoryForm" class="p-6 space-y-4">
                <input type="hidden" id="catId">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Category Name</label>
                    <input type="text" id="catName" required placeholder="e.g. Formal Exam"
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Short Code</label>
                    <input type="text" id="catCode" required placeholder="e.g. EXM"
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg uppercase">
                </div>
                <button type="submit"
                    class="w-full py-2.5 rounded-xl text-xs font-black text-white bg-slate-900 hover:bg-slate-800 uppercase shadow-lg transition-all">Save
                    Classification</button>
            </form>
        </div>
    </div>

    <!-- Type Modal -->
    <div id="typeModal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden place-items-center p-4 overflow-y-auto flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest" id="typeModalTitle">Add
                    Assessment</h3>
                <button onclick="hideTypeModal()" class="text-slate-400 hover:text-slate-600 transition-colors"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="typeForm" class="p-6 space-y-4">
                <input type="hidden" id="typeId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Assessment
                            Name</label>
                        <input type="text" id="typeName" required placeholder="e.g. BOT"
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Short Code</label>
                        <input type="text" id="typeCode" required placeholder="e.g. BOT"
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg uppercase">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Classification</label>
                    <select id="typeCatId" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg bg-white">
                        <option value="">Select Category</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Color Theme</label>
                        <select id="typeColor"
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg bg-white">
                            <option value="indigo">Indigo (Standard)</option>
                            <option value="sky">Sky (Casual)</option>
                            <option value="amber">Amber (Project)</option>
                            <option value="rose">Rose (Critical)</option>
                            <option value="emerald">Emerald (Success)</option>
                            <option value="slate">Slate (Passive)</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-3 pt-5">
                        <input type="checkbox" id="typeIsActive" checked class="w-4 h-4 rounded border-slate-300">
                        <label for="typeIsActive" class="text-[10px] font-bold text-slate-500 uppercase">Active</label>
                    </div>
                </div>

                <!-- Class Selection -->
                <div class="space-y-3 pt-2">
                    <div class="flex items-center justify-between">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-wide text-slate-900">Applicable
                            Classes</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="typeAllClasses" checked class="w-4 h-4 rounded border-slate-300">
                            <label for="typeAllClasses" class="text-[10px] font-bold text-slate-600">All Classes</label>
                        </div>
                    </div>
                    <div id="typeClassesContainer"
                        class="hidden grid grid-cols-2 gap-2 p-3 bg-slate-50 rounded-xl border border-slate-100 max-h-32 overflow-y-auto">
                        <!-- Classes populated via JS -->
                    </div>
                </div>

                <button type="submit"
                    class="w-full py-2.5 rounded-xl text-xs font-black text-white bg-slate-900 hover:bg-slate-800 uppercase shadow-lg transition-all mt-4">Save
                    Assessment</button>
            </form>
        </div>
    </div>

    <script>
        let allCategories = [];
        let allTypes = [];
        let allAvailableClasses = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();

            // Toggle classes visibility
            document.getElementById('typeAllClasses').addEventListener('change', (e) => {
                document.getElementById('typeClassesContainer').classList.toggle('hidden', e.target.checked);
            });

            document.getElementById('categoryForm').onsubmit = handleSaveCategory;
            document.getElementById('typeForm').onsubmit = handleSaveType;
        });

        async function loadData() {
            try {
                const [catsResp, typesResp, classesResp] = await Promise.all([
                    fetch('/api/settings/assessment-categories'),
                    fetch('/api/settings/assessment-types'),
                    fetch('/api/classes')
                ]);

                allCategories = (await catsResp.json()) || [];
                allTypes = (await typesResp.json()) || [];
                allAvailableClasses = (await classesResp.json()) || [];

                renderCategories();
                renderTypes();
                populateCatDropdown();
                renderClassCheckboxes();
            } catch (err) {
                console.error('Failed to load assessment data:', err);
                // Fallback to empty arrays on error
                allCategories = allCategories || [];
                allTypes = allTypes || [];
                allAvailableClasses = allAvailableClasses || [];
            }
        }

        function renderClassCheckboxes() {
            const container = document.getElementById('typeClassesContainer');
            if (!container) return;
            container.innerHTML = '';

            // Handle if classes data is wrapped in an object or array
            const classesArray = Array.isArray(allAvailableClasses) ? allAvailableClasses : (allAvailableClasses.classes || []);

            classesArray.forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="checkbox" name="typeClass" value="${c.id}" id="class_${c.id}" class="w-3.5 h-3.5 rounded border-slate-300">
                    <label for="class_${c.id}" class="text-[10px] font-bold text-slate-600 truncate uppercase tracking-tighter">${c.name}</label>
                `;
                container.appendChild(div);
            });
        }

        function renderCategories() {
            const body = document.getElementById('categoryTableBody');
            if (!body) return;
            body.innerHTML = '';
            (allCategories || []).forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-50 hover:bg-slate-50 group transition-colors';
                tr.innerHTML = `
                    <td class="px-5 py-4"><span class="text-xs font-black text-slate-800 uppercase tracking-tight">${c.name}</span></td>
                    <td class="px-5 py-4"><span class="text-[10px] font-black text-slate-400 tracking-widest">${c.code}</span></td>
                    <td class="px-5 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 transition-opacity">
                            <button onclick="editCategory('${c.id}')" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-900 hover:text-white transition-all shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                            <button onclick="deleteCategory('${c.id}')" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 hover:bg-rose-500 hover:text-white transition-all shadow-sm"><i class="fas fa-trash-alt text-[10px]"></i></button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function renderTypes() {
            const body = document.getElementById('typesTableBody');
            if (!body) return;
            body.innerHTML = '';
            (allTypes || []).forEach(t => {
                const cat = (allCategories || []).find(c => c.id === t.category_id);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-50 hover:bg-slate-50 group transition-colors';

                const displayCategory = cat?.name || t.category_name || 'Unmapped';

                let classInfo = '';
                if (t.all_classes) {
                    classInfo = `<span class="text-[9px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100 uppercase tracking-widest">Global</span>`;
                } else if (t.classes && t.classes.length > 0) {
                    const count = t.classes.length;
                    const names = t.classes.map(c => c.name).slice(0, 2).join(', ');
                    classInfo = `<span class="text-[9px] font-black text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 uppercase tracking-widest">${count} Classes (${names}${count > 2 ? '...' : ''})</span>`;
                } else {
                    classInfo = `<span class="text-[9px] font-black text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 uppercase tracking-widest">No Classes</span>`;
                }

                tr.innerHTML = `
                    <td class="px-5 py-4">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-800">${t.name}</span>
                            <div class="mt-1">${classInfo}</div>
                        </div>
                    </td>
                    <td class="px-5 py-4"><span class="text-[10px] font-black text-slate-400 tracking-widest uppercase">${t.code}</span></td>
                    <td class="px-5 py-4"><span class="text-[10px] font-black text-slate-900 bg-slate-100 px-2.5 py-1 rounded-lg uppercase tracking-tight">${displayCategory}</span></td>
                    <td class="px-5 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 transition-opacity">
                            <button onclick="editType('${t.id}')" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-900 hover:text-white transition-all shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                            <button onclick="deleteType('${t.id}')" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 hover:bg-rose-500 hover:text-white transition-all shadow-sm"><i class="fas fa-trash-alt text-[10px]"></i></button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function populateCatDropdown() {
            const select = document.getElementById('typeCatId');
            if (!select) return;
            select.innerHTML = '<option value="">Select Category</option>';
            (allCategories || []).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        // Modal Controls
        function showCategoryModal() {
            document.getElementById('catModalTitle').textContent = 'Add Classification';
            document.getElementById('catId').value = '';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModal').classList.remove('hidden');
        }
        function hideCategoryModal() { document.getElementById('categoryModal').classList.add('hidden'); }

        function showTypeModal() {
            document.getElementById('typeModalTitle').textContent = 'Add Assessment';
            document.getElementById('typeId').value = '';
            document.getElementById('typeForm').reset();
            document.getElementById('typeAllClasses').checked = true;
            document.getElementById('typeIsActive').checked = true;
            document.getElementById('typeColor').value = 'indigo';
            document.getElementById('typeClassesContainer').classList.add('hidden');
            document.getElementById('typeModal').classList.remove('hidden');
        }
        function hideTypeModal() { document.getElementById('typeModal').classList.add('hidden'); }

        async function editCategory(id) {
            const c = allCategories.find(x => x.id === id);
            document.getElementById('catModalTitle').textContent = 'Edit Classification';
            document.getElementById('catId').value = c.id;
            document.getElementById('catName').value = c.name;
            document.getElementById('catCode').value = c.code;
            document.getElementById('categoryModal').classList.remove('hidden');
        }

        async function editType(id) {
            const t = allTypes.find(x => x.id === id);
            document.getElementById('typeModalTitle').textContent = 'Edit Assessment';
            document.getElementById('typeId').value = t.id;
            document.getElementById('typeName').value = t.name;
            document.getElementById('typeCode').value = t.code;
            document.getElementById('typeCatId').value = t.category_id;
            document.getElementById('typeColor').value = t.color || 'indigo';
            document.getElementById('typeIsActive').checked = t.is_active !== false;

            const isAllClasses = t.all_classes !== false;
            document.getElementById('typeAllClasses').checked = isAllClasses;
            document.getElementById('typeClassesContainer').classList.toggle('hidden', isAllClasses);

            // Reset and set checkboxes
            document.querySelectorAll('input[name="typeClass"]').forEach(cb => {
                cb.checked = !isAllClasses && t.classes && t.classes.some(c => c.id === cb.value);
            });

            document.getElementById('typeModal').classList.remove('hidden');
        }

        async function handleSaveCategory(e) {
            e.preventDefault();
            const id = document.getElementById('catId').value;
            const data = {
                name: document.getElementById('catName').value,
                code: document.getElementById('catCode').value
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/settings/assessment-categories/${id}` : '/api/settings/assessment-categories';
            const resp = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (resp.ok) { hideCategoryModal(); loadData(); }
        }

        async function handleSaveType(e) {
            e.preventDefault();
            const id = document.getElementById('typeId').value;
            const allClasses = document.getElementById('typeAllClasses').checked;

            const selectedClasses = [];
            if (!allClasses) {
                document.querySelectorAll('input[name="typeClass"]:checked').forEach(cb => {
                    selectedClasses.push({ id: cb.value });
                });
            }

            const data = {
                name: document.getElementById('typeName').value,
                code: document.getElementById('typeCode').value,
                category_id: document.getElementById('typeCatId').value,
                weight: 1.0, // Default weight
                color: document.getElementById('typeColor').value,
                is_active: document.getElementById('typeIsActive').checked,
                all_classes: allClasses,
                classes: selectedClasses
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/settings/assessment-types/${id}` : '/api/settings/assessment-types';
            const resp = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (resp.ok) { hideTypeModal(); loadData(); }
        }

        async function deleteCategory(id) {
            if (!confirm('Are you sure? This classification might have assessment types linked to it.')) return;
            const resp = await fetch(`/api/settings/assessment-categories/${id}`, { method: 'DELETE' });
            if (resp.ok) loadData();
        }

        async function deleteType(id) {
            if (!confirm('Are you sure? This assessment might have results recorded.')) return;
            const resp = await fetch(`/api/settings/assessment-types/${id}`, { method: 'DELETE' });
            if (resp.ok) loadData();
        }
    </script>
</div>