<!-- Teachers Management Content -->
<div class="px-4 py-4 lg:px-6 lg:py-5">
    <!-- Header Section -->
    <div class="mb-5">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-xl lg:text-lg font-black text-slate-900 tracking-tight uppercase">Teachers Management
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">SYSTEM NODE: FACULTY
                        REGISTRY</span>
                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                    <span class="text-indigo-600 text-[10px] font-bold uppercase tracking-wider">INSTRUCTIONAL STAFF
                        ACCESS</span>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:flex items-center gap-2 flex-wrap">
                <button id="runPayrollBtn"
                    class="px-3 py-2 bg-emerald-600 border border-emerald-700 text-white rounded-xl hover:bg-emerald-700 transition-all duration-200 text-[10px] font-black uppercase tracking-widest shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-money-bill-wave"></i>Run Payroll
                </button>
                <button
                    class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition-all duration-200 text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-up-from-bracket opacity-50"></i>Export
                </button>
                <div class="relative group">
                    <button
                        class="px-4 py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-cog opacity-50"></i>Configuration
                    </button>
                    <!-- Dropdown for configuration -->
                    <div
                        class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-20 overflow-hidden">
                        <button id="manageDeptsBtn"
                            class="w-full text-left px-4 py-3 text-[10px] font-bold text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-building w-4 text-center"></i>Divisions
                        </button>
                        <button id="manageSubjectsBtn"
                            class="w-full text-left px-4 py-3 text-[10px] font-bold text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-book-open w-4 text-center"></i>Modules
                        </button>
                        <button id="manageRolesBtn"
                            class="w-full text-left px-4 py-3 text-[10px] font-bold text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-users-cog w-4 text-center"></i>Access Levels
                        </button>
                    </div>
                </div>
                <button id="addTeacherBtn"
                    class="px-4 py-2 premium-gradient text-white rounded-xl hover:opacity-90 transition-all duration-200 text-[10px] font-bold shadow-sm uppercase tracking-wider flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i>Add Faculty
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards (Premium White Style) -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-5" id="statsCards">
        <!-- Total Faculty -->
        <div
            class="group bg-white rounded-2xl border border-slate-200 p-3 md:p-4 hover:shadow-xl hover:shadow-indigo-500/10 transition-all duration-300 relative overflow-hidden cursor-pointer">
            <div
                class="absolute top-0 right-0 w-16 h-16 md:w-24 md:h-24 bg-indigo-50 rounded-full -mr-8 -mt-8 md:-mr-12 md:-mt-12 transition-transform group-hover:scale-110">
            </div>
            <div class="flex items-center justify-between relative z-10">
                <div>
                    <p class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total
                        Faculty</p>
                    <p id="totalFaculty" class="text-xl md:text-2xl font-black text-slate-900 leading-none">0</p>
                </div>
                <div
                    class="w-8 h-8 md:w-10 md:h-10 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm">
                    <i class="fas fa-chalkboard-teacher text-xs md:text-sm"></i>
                </div>
            </div>
        </div>

        <!-- Active Duty -->
        <div
            class="group bg-white rounded-2xl border border-slate-200 p-3 md:p-4 hover:shadow-xl hover:shadow-emerald-500/10 transition-all duration-300 relative overflow-hidden cursor-pointer">
            <div
                class="absolute top-0 right-0 w-16 h-16 md:w-24 md:h-24 bg-emerald-50 rounded-full -mr-8 -mt-8 md:-mr-12 md:-mt-12 transition-transform group-hover:scale-110">
            </div>
            <div class="flex items-center justify-between relative z-10">
                <div>
                    <p class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Active
                        Duty</p>
                    <p id="activeDuty" class="text-xl md:text-2xl font-black text-slate-900 leading-none">0</p>
                </div>
                <div
                    class="w-8 h-8 md:w-10 md:h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-all shadow-sm">
                    <i class="fas fa-check-circle text-xs md:text-sm"></i>
                </div>
            </div>
        </div>

        <!-- Commanders -->
        <div
            class="group bg-white rounded-2xl border border-slate-200 p-3 md:p-4 hover:shadow-xl hover:shadow-purple-500/10 transition-all duration-300 relative overflow-hidden cursor-pointer">
            <div
                class="absolute top-0 right-0 w-16 h-16 md:w-24 md:h-24 bg-purple-50 rounded-full -mr-8 -mt-8 md:-mr-12 md:-mt-12 transition-transform group-hover:scale-110">
            </div>
            <div class="flex items-center justify-between relative z-10">
                <div>
                    <p class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                        Commanders</p>
                    <p id="commanders" class="text-xl md:text-2xl font-black text-slate-900 leading-none">0</p>
                </div>
                <div
                    class="w-8 h-8 md:w-10 md:h-10 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-all shadow-sm">
                    <i class="fas fa-school text-xs md:text-sm"></i>
                </div>
            </div>
        </div>

        <!-- Specialists -->
        <div
            class="group bg-white rounded-2xl border border-slate-200 p-3 md:p-4 hover:shadow-xl hover:shadow-orange-500/10 transition-all duration-300 relative overflow-hidden cursor-pointer">
            <div
                class="absolute top-0 right-0 w-16 h-16 md:w-24 md:h-24 bg-orange-50 rounded-full -mr-8 -mt-8 md:-mr-12 md:-mt-12 transition-transform group-hover:scale-110">
            </div>
            <div class="flex items-center justify-between relative z-10">
                <div>
                    <p class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                        Specialists</p>
                    <p id="specialists" class="text-xl md:text-2xl font-black text-slate-900 leading-none">0</p>
                </div>
                <div
                    class="w-8 h-8 md:w-10 md:h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-all shadow-sm">
                    <i class="fas fa-book text-xs md:text-sm"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Departmental Architecture (Hidden for now, maybe integrate into stats or sidebar) -->
    <div class="hidden bg-white rounded-2xl border border-slate-200 p-4 mb-5 shadow-sm overflow-hidden relative">
        <div id="departmentOverview"></div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-2xl border border-slate-200 p-2 md:p-3 mb-5">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 md:gap-4">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 md:gap-3 flex-1">
                <!-- Search -->
                <div class="relative group flex-1 md:max-w-md">
                    <input id="searchInput" type="text" placeholder="Search Faculty Database..."
                        class="w-full pl-9 pr-4 py-2 text-[10px] md:text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500/50 bg-slate-50 transition-all duration-300 group-hover:bg-white uppercase tracking-wider">
                    <i
                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-[10px] group-hover:text-indigo-500 transition-colors"></i>
                </div>

                <!-- Filters -->
                <select id="departmentFilter"
                    class="w-full sm:w-auto px-3 md:px-4 py-2 text-[10px] md:text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500/50 bg-slate-50 hover:bg-white transition-all duration-300 uppercase tracking-wider">
                    <option value="">All Divisions</option>
                </select>

                <select id="roleFilter"
                    class="w-full sm:w-auto px-3 md:px-4 py-2 text-[10px] md:text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500/50 bg-slate-50 hover:bg-white transition-all duration-300 uppercase tracking-wider">
                    <option value="">All Clearances</option>
                </select>
            </div>

            <div class="flex items-center justify-between sm:justify-end gap-2">
                <button
                    class="px-3 md:px-4 py-2 text-[10px] md:text-[11px] font-black text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all duration-200 uppercase tracking-wider flex items-center gap-2 border border-transparent hover:border-indigo-100">
                    <i class="fas fa-sliders opacity-50 text-[9px] md:text-[10px]"></i><span
                        class="hidden xs:inline">Advanced</span><span class="xs:hidden">Filter</span>
                </button>
                <button
                    class="px-3 md:px-4 py-2 text-[10px] md:text-[11px] font-black text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all duration-200 uppercase tracking-wider flex items-center gap-2 border border-transparent hover:border-indigo-100">
                    <i class="fas fa-arrow-down-wide-short opacity-50 text-[9px] md:text-[10px]"></i><span
                        class="hidden xs:inline">Sequence</span><span class="xs:hidden">Sort</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Teachers Table (Compact) -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="hidden md:table-header-group bg-slate-50/50 border-b border-slate-100">
                    <tr>
                        <th class="px-4 py-3 text-left whitespace-nowrap">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Faculty
                                Member</span>
                        </th>
                        <th class="px-4 py-3 text-left whitespace-nowrap">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Division</span>
                        </th>
                        <th class="px-4 py-3 text-left whitespace-nowrap">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Clearance</span>
                        </th>
                        <th class="px-4 py-3 text-left whitespace-nowrap">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Deployments</span>
                        </th>
                        <th class="px-4 py-3 text-center whitespace-nowrap">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Status</span>
                        </th>
                        <th class="px-4 py-3 text-right whitespace-nowrap">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="teachers-table-body" class="divide-y divide-slate-100">
                    <!-- Teachers will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination (Compact) -->

    </div>
</div>


<!-- Add Teacher Modal -->
<div id="addTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeAddModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Faculty Induction</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Registering Staff Asset
                </p>
            </div>
            <button id="closeModalBtn" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="addTeacherForm" class="p-6 space-y-6 overflow-y-auto max-h-[80vh]">
            <div class="space-y-6">
                <!-- Professional Information -->
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Assigned
                            Department *</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="selectedDepartment" name="selectedDepartment" readonly required
                                class="flex-1 text-xs font-semibold px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none"
                                placeholder="Select unit">
                            <button type="button" id="selectDeptBtn"
                                class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-all text-[10px] font-black uppercase tracking-widest shadow-md">
                                Department
                            </button>
                        </div>
                        <input type="hidden" id="departmentId" name="department">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Core
                            Modules</label>
                        <div id="selectedSubjectsContainer"
                            class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                            <span class="text-[11px] font-bold text-slate-400">No modules selected</span>
                        </div>
                        <button type="button" id="selectSubjectsBtn"
                            class="mt-2 w-full py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                            <i class="fas fa-book-open mr-1.5 opacity-50"></i>Assign Domains
                        </button>
                        <input type="hidden" id="selectedSubjectIds" name="subjects">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Access
                            Hierarchy *</label>
                        <div id="addSelectedRolesContainer"
                            class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                            <span class="text-[11px] font-bold text-slate-400">No clearances selected</span>
                        </div>
                        <button type="button" id="selectRoleBtn"
                            class="mt-2 w-full py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                            <i class="fas fa-users-cog mr-1.5 opacity-50"></i>Set Permissions
                        </button>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="space-y-4 pt-4 border-t border-slate-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">First Name
                                *</label>
                            <input type="text" id="firstName" name="firstName" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="First Name">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Surname
                                *</label>
                            <input type="text" id="lastName" name="lastName" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Last Name">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Digital
                            Identity *</label>
                        <input type="email" id="email" name="email" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                            placeholder="Email Address">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Comms
                            Protocol</label>
                        <input type="tel" id="phone" name="phone"
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                            placeholder="+256 ...">
                    </div>
                </div>

                <!-- Security Credentials -->
                <div class="space-y-4 pt-4 border-t border-slate-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Secure Key
                                *</label>
                            <input type="password" id="password" name="password" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Password">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Confirm Key
                                *</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Confirm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end gap-3 pt-6 border-t border-slate-100">
                <button type="button" onclick="closeAddModal()"
                    class="px-6 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Abort
                </button>
                <button type="submit"
                    class="px-6 py-2.5 text-white bg-slate-900 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Induct Faculty
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Teacher Modal -->
<div id="viewTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeViewModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-lg mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Personnel Overview</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Faculty Profile</p>
            </div>
            <button id="closeViewModalBtn" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-4 overflow-y-auto max-h-[80vh]">
            <!-- Identity Section -->
            <div class="flex items-center gap-4 pb-4 border-b border-slate-100">
                <div id="viewTeacherInitials"
                    class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                    <span class="text-white text-xl font-black uppercase"></span>
                </div>
                <div class="flex-1">
                    <h3 id="viewTeacherName" class="text-lg font-black text-slate-900 tracking-tight uppercase"></h3>
                    <p id="viewTeacherID" class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">
                    </p>
                </div>
            </div>

            <!-- Information Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Digital
                        Identity</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <p id="viewTeacherEmail" class="text-xs font-semibold text-slate-800 break-all"></p>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Comms Line</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <p id="viewTeacherPhone" class="text-xs font-semibold text-slate-800"></p>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Assigned
                        Division</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <p id="viewTeacherDepartment"
                            class="text-xs font-semibold text-slate-800 uppercase tracking-tight"></p>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Service
                        Status</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <span id="viewTeacherStatus"
                            class="inline-flex items-center px-2 py-0.5 text-[9px] font-black uppercase tracking-widest rounded-full shadow-sm"></span>
                    </div>
                </div>
            </div>

            <!-- Roles Section -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Hierarchy
                    Clearances</label>
                <div id="viewTeacherRoles"
                    class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px]"></div>
            </div>

            <!-- Classes Section -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Active
                    Deployments</label>
                <div id="viewTeacherClasses"
                    class="space-y-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px]"></div>
            </div>

            <!-- Modal Footer -->
            <div class="pt-4 border-t border-slate-50 flex justify-end gap-3">
                <button id="closeViewModalBtn2"
                    class="px-6 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Dismiss
                </button>
                <a id="fullProfileBtn" href="#"
                    class="px-6 py-2.5 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Full Personnel Record
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Active Deployments Modal -->
<div id="classesModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300 p-4"
    onclick="if(event.target === this) closeClassesModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-auto overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 id="classesModalTitle" class="text-sm font-black text-slate-900 uppercase tracking-wide">Active
                    Deployments</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Class Assignments</p>
            </div>
            <button onclick="closeClassesModal()" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-3 overflow-y-auto max-h-[70vh]" id="classesList">
            <!-- Classes will be loaded here -->
        </div>
    </div>
</div>

<!-- Departments Modal -->
<div id="departmentsModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300 p-4"
    onclick="if(event.target === this) closeDepartmentsModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-auto overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 id="departmentsModalTitle" class="text-sm font-black text-slate-900 uppercase tracking-wide">
                    Department Assignments</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Organizational Units</p>
            </div>
            <button onclick="closeDepartmentsModal()" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-3 overflow-y-auto max-h-[70vh]" id="departmentsList">
            <!-- Departments will be loaded here -->
        </div>
    </div>
</div>

<!-- Additional Intel Modal -->
<div id="moreInfoModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300 p-4"
    onclick="if(event.target === this) closeMoreInfoModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-auto overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 id="moreInfoModalTitle" class="text-sm font-black text-slate-900 uppercase tracking-wide">Additional
                    Intelligence</h3>
                <p id="moreInfoModalSubtitle"
                    class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Asset Attributes</p>
            </div>
            <button onclick="closeMoreInfoModal()" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-3 overflow-y-auto max-h-[70vh]" id="moreInfoModalBody">
            <!-- Data will be loaded here -->
        </div>
    </div>
</div>

<!-- View Functions moved to main script -->

<!-- Edit Teacher Modal -->
<div id="editTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeEditModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Edit Personnel</h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editTeacherForm" class="p-6 space-y-4">
            <input type="hidden" id="editTeacherId" name="teacherId">

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">First
                            Name</label>
                        <input type="text" id="editFirstName" name="firstName" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Last
                            Name</label>
                        <input type="text" id="editLastName" name="lastName" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Email
                        Address</label>
                    <input type="email" id="editEmail" name="email" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Phone
                        Number</label>
                    <input type="tel" id="editPhone" name="phone"
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Clearance
                        Levels</label>
                    <div id="editSelectedRolesContainer"
                        class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                        <span class="text-[11px] font-bold text-slate-400">No clearances selected</span>
                    </div>
                    <button type="button" id="editSelectRoleBtn"
                        class="mt-2 w-full py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 transition-all">
                        <i class="fas fa-plus mr-1.5 opacity-50"></i>Manage Clearances
                    </button>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Assigned
                        Department</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="editSelectedDepartment" readonly required
                            class="flex-1 text-xs font-semibold px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none"
                            placeholder="Select unit">
                        <button type="button" id="editSelectDeptBtn"
                            class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-all text-[10px] font-black uppercase tracking-widest shadow-md">
                            Change
                        </button>
                    </div>
                    <input type="hidden" id="editDepartmentId" name="department">
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="pt-4 border-t border-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeEditModal()"
                    class="px-6 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Dismiss
                </button>
                <button type="submit"
                    class="px-6 py-2.5 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Apply Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteTeacherModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full border border-slate-200/60 overflow-hidden transform transition-all duration-300">
        <div class="p-8 text-center">
            <div class="w-20 h-20 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-exclamation-triangle text-rose-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-black text-slate-900 tracking-tight uppercase mb-2">Decommission Asset?</h2>
            <p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest mb-6">This action will purge the
                personnel record</p>

            <p class="text-[13px] text-slate-600 font-medium mb-8 leading-relaxed">
                Are you certain you want to remove <span id="deleteTeacherName"
                    class="font-black text-slate-900"></span> from active duty? This data cannot be recovered.
            </p>

            <input type="hidden" id="deleteTeacherId">

            <div class="flex flex-col gap-3">
                <button type="button" id="confirmDeleteBtn"
                    class="w-full py-4 bg-rose-600 text-white rounded-2xl hover:bg-rose-700 transition-all text-[11px] font-black uppercase tracking-widest shadow-lg shadow-rose-200">
                    <i class="fas fa-trash mr-2 text-[10px]"></i>Confirm Deletion
                </button>
                <button type="button" id="deleteCancelBtn"
                    class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl hover:bg-slate-200 transition-all text-[11px] font-black uppercase tracking-widest">
                    Abort Protocol
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div id="manageRolesModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Security Hierarchy</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Managing Access Levels
                </p>
            </div>
            <button id="closeRolesModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Role -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Initialize New
                    Clearances</h3>
                <form id="addRoleForm" class="flex gap-2.5">
                    <input type="text" id="roleName" placeholder="Define role designation..." required
                        class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    <button type="submit"
                        class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Induct
                    </button>
                </form>
            </div>

            <!-- Existing Roles -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active Protocols
                </h3>
                <div id="rolesList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Departments Modal -->
<div id="manageDeptsModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Departmental Architecture</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Defining Departments
                </p>
            </div>
            <button id="closeDeptsModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Department -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Register New
                    Department</h3>
                <form id="addDeptForm" class="grid grid-cols-1 gap-3">
                    <div class="flex gap-2.5">
                        <input type="text" id="deptCode" placeholder="Code (e.g. ENG)" required
                            class="w-24 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                        <input type="text" id="deptName" placeholder="Department Name..." required
                            class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    </div>
                    <button type="submit"
                        class="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Authorize Department
                    </button>
                </form>
            </div>

            <!-- Existing Divisions -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active
                    Architecture</h3>
                <div id="deptsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Departments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Modules Modal -->
<div id="manageSubjectsModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Instructional Matrices</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Defining Core Modules
                </p>
            </div>
            <button id="closeSubjectsModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Module -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Initialize New
                    Module</h3>
                <form id="addSubjectForm" class="grid grid-cols-1 gap-3">
                    <div class="flex gap-2.5">
                        <select id="subjectDeptId" required
                            class="w-32 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[11px] font-bold">
                            <option value="">Department...</option>
                        </select>
                        <input type="text" id="subjectName" placeholder="Module Title..." required
                            class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    </div>
                    <button type="submit"
                        class="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Register Module
                    </button>
                </form>
            </div>

            <!-- Existing Modules -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active Modules
                </h3>
                <div id="subjectsManagementList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Subjects will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Selection Modal -->
<div id="roleSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[110]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Clearance Levels</h3>
            <div class="flex items-center gap-3">
                <a href="javascript:void(0)" onclick="window.openManageRoles()"
                    class="text-[9px] font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors">
                    <i class="fas fa-cog text-[8px]"></i>
                    Manage
                </a>
                <button type="button" onclick="closeRoleSelectionModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="roleSelectionList">
            <!-- Roles will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
        <div class="p-4 border-t border-slate-50 bg-slate-50/50">
            <button onclick="closeRoleSelectionModal()"
                class="w-full py-3 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                Confirm Selection
            </button>
        </div>
    </div>
</div>

<!-- Department Selection Modal -->
<div id="deptSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[110]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Assigned Department</h3>
            <div class="flex items-center gap-3">
                <a href="javascript:void(0)" onclick="window.openManageDepts()"
                    class="text-[9px] font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors">
                    <i class="fas fa-cog text-[8px]"></i>
                    Manage
                </a>
                <button type="button" onclick="closeDeptSelectionModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="deptSelectionList">
            <!-- Departments will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
    </div>
</div>

<!-- Subject Selection Modal -->
<div id="subjectSelectionModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[110]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Core Modules</h3>
            <div class="flex items-center gap-3">
                <a href="javascript:void(0)" onclick="window.openManageSubjects()"
                    class="text-[9px] font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors">
                    <i class="fas fa-cog text-[8px]"></i>
                    Manage
                </a>
                <button type="button" onclick="closeSubjectSelectionModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-2 overflow-y-auto flex-1" id="subjectSelectionList">
            <!-- Subjects will be loaded here -->
            <div class="text-center py-8 text-slate-400 text-sm">Loading...</div>
        </div>
        <div class="p-4 border-t border-slate-50 bg-slate-50/50">
            <button onclick="closeSubjectSelectionModal()"
                class="w-full py-3 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                Confirm Selection
            </button>
        </div>
    </div>
</div>

<!-- Classes Modal (Popover style) -->
<div id="classesModal" class="fixed z-50 hidden">
    <div
        class="bg-white rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-100 p-5 max-w-xs animate-in fade-in zoom-in duration-200">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-50">
            <h3 id="classesModalTitle" class="text-[10px] font-black text-slate-900 uppercase tracking-widest">Active
                Deployments</h3>
            <button onclick="window.closeClassesModal()" class="text-slate-400 hover:text-rose-500 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div id="classesList" class="space-y-2">
            <!-- Classes will be loaded here -->
        </div>
    </div>
</div>

<!-- More Info Modal (Pop-over style for badges) -->
<div id="moreInfoModal" class="fixed z-50 hidden">
    <div
        class="bg-white rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-100 p-5 max-w-xs animate-in fade-in zoom-in duration-200">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-50">
            <h3 id="moreInfoModalTitle" class="text-[10px] font-black text-slate-900 uppercase tracking-widest">
                Additional
                Intel</h3>
            <button onclick="window.closeMoreInfoModal()" class="text-slate-400 hover:text-rose-500 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div id="moreInfoModalBody" class="space-y-2">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
    /**
     * GLOBAL STATE & CACHES
     */
    let allTeachers = [];
    let cachedSubjects = {}; // Cache for module names
    let deptTarget = { name: null, id: null };
    let roleSelectionTarget = 'add'; // 'add' or 'edit'
    let selectedRolesArray = [];
    let selectedSubjectIdsArray = [];

    /**
     * UTILITY FUNCTIONS
     */
    function setButtonLoading(button, isLoading, originalText = null) {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = originalText || button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || originalText;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function generateBadgesHtml(items, type, teacherId) {
        if (!items || items.length === 0) {
            return '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">None</span>';
        }

        const maxVisible = 1;
        let html = '';
        const visibleItems = items.slice(0, maxVisible);
        const hiddenItemsCount = items.length - maxVisible;

        html = visibleItems.map(item => {
            const badgeClass = type === 'role' ? 'bg-indigo-50 text-indigo-600 border-indigo-100/50' : 'bg-slate-50 text-slate-600 border-slate-100/50';
            return '<span class="inline-flex px-2 py-1 text-[10px] font-black uppercase tracking-widest ' + badgeClass + ' border rounded-lg shadow-sm">' + item.name + '</span>';
        }).join(' ');

        if (hiddenItemsCount > 0) {
            html += '<button class="ml-2 inline-flex items-center px-2 py-1 bg-slate-100 text-slate-600 text-[9px] font-black uppercase tracking-widest rounded-lg hover:bg-slate-200 transition-all active:scale-95" ' +
                'onclick="showMoreModal(\'' + type + '\', \'' + teacherId + '\', event)">' +
                '+' + hiddenItemsCount + ' MORE' +
                '</button>';
        }

        return '<div class="flex flex-wrap items-center gap-1.5">' + html + '</div>';
    }

    function generateDeploymentsHtml(classes, teacherName, teacherId) {
        if (!classes || classes.length === 0) {
            return '<span class="text-[9px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Active Deployments</span>';
        }

        const maxVisible = 1;
        const visibleClasses = classes.slice(0, maxVisible);
        const hiddenCount = classes.length - maxVisible;

        let html = visibleClasses.map(cls =>
            '<span class="inline-flex items-center px-2 py-1 bg-emerald-50 text-emerald-600 border border-emerald-100/50 text-[10px] font-black uppercase tracking-widest rounded-lg shadow-sm">' +
            '<i class="fas fa-building mr-1.5 text-[8px] opacity-60"></i>' + (cls.code || cls.name) +
            '</span>'
        ).join('');

        if (hiddenCount > 0) {
            html += '<button class="ml-2 inline-flex items-center px-2 py-1 bg-slate-100 text-slate-600 text-[9px] font-black uppercase tracking-widest rounded-lg hover:bg-slate-200 transition-all shadow-sm active:scale-95" ' +
                'onclick="showClassesModal(this, \'' + teacherName + '\', event)" data-classes=\'' + JSON.stringify(classes) + '\'>' +
                '<i class="fas fa-plus mr-1 text-[7px]"></i>' + hiddenCount + ' MORE' +
                '</button>';
        } else {
            // For single item, let's still make it clickable for details
            html = '<div class="cursor-pointer group" onclick="showClassesModal(this, \'' + teacherName + '\', event)" data-classes=\'' + JSON.stringify(classes) + '\'>' +
                html +
                '</div>';
        }

        return '<div class="flex items-center">' + html + '</div>';
    }

    /**
     * MODAL OPERATIONS (GLOBAL)
     */
    window.openViewModal = function (teacher) {
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        if (!viewTeacherModal) return;

        document.getElementById('viewTeacherName').textContent = teacher.first_name + ' ' + teacher.last_name;
        document.getElementById('viewTeacherEmail').textContent = teacher.email;
        document.getElementById('viewTeacherID').textContent = 'FAC-REF-' + teacher.id.toString().padStart(4, '0');
        document.getElementById('viewTeacherPhone').textContent = teacher.phone || 'SECURE LINE UNSET';

        const deptDisplay = teacher.department ? teacher.department.name : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].name : 'UNASSIGNED');
        document.getElementById('viewTeacherDepartment').textContent = deptDisplay;

        // Initials
        const initialsContainer = document.getElementById('viewTeacherInitials');
        const initialsSpan = initialsContainer.querySelector('span');
        if (initialsSpan) {
            initialsSpan.textContent = teacher.first_name[0] + teacher.last_name[0];
        }

        // Status
        const statusSpan = document.getElementById('viewTeacherStatus');
        statusSpan.textContent = teacher.is_active ? 'Active Pursuit' : 'Stationary / Inactive';
        statusSpan.className = 'inline-flex items-center px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-full shadow-sm ' + (teacher.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100/50' : 'bg-rose-50 text-rose-600 border border-rose-100/50');
        const indicatorColor = teacher.is_active ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500';
        statusSpan.innerHTML = '<span class="w-1.5 h-1.5 rounded-full mr-2 ' + indicatorColor + '"></span>' + statusSpan.textContent;

        // Roles
        const rolesContainer = document.getElementById('viewTeacherRoles');
        rolesContainer.innerHTML = '';
        if (teacher.roles && teacher.roles.length > 0) {
            teacher.roles.forEach(role => {
                const badge = document.createElement('span');
                badge.className = 'px-3 py-1.5 bg-white text-indigo-600 border border-indigo-50 text-[10px] font-black uppercase tracking-widest rounded-xl shadow-sm';
                badge.textContent = role.name;
                rolesContainer.appendChild(badge);
            });
        } else {
            rolesContainer.innerHTML = '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Clearances</span>';
        }

        // Classes
        const classesContainer = document.getElementById('viewTeacherClasses');
        classesContainer.innerHTML = '';
        if (teacher.classes && teacher.classes.length > 0) {
            teacher.classes.forEach(cls => {
                const classDiv = document.createElement('div');
                classDiv.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm';
                classDiv.innerHTML = '<span class="text-[12px] font-bold text-slate-700 uppercase tracking-tight">' + cls.name + '</span>' +
                    '<span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">Active Deployment</span>';
                classesContainer.appendChild(classDiv);
            });
        } else {
            classesContainer.innerHTML = '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Active Deployments</span>';
        }

        // Link to full profile
        document.getElementById('fullProfileBtn').href = '/teachers/' + teacher.id;

        viewTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeViewModal = function () {
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        if (viewTeacherModal) {
            viewTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };



    window.openEditModal = function (teacherId, firstName, lastName, teacherEmail, teacherPhone, rolesJson, teacherDepartmentId, teacherDepartmentName) {
        const editTeacherModal = document.getElementById('editTeacherModal');
        if (!editTeacherModal) return;

        document.getElementById('editTeacherId').value = teacherId;
        document.getElementById('editFirstName').value = firstName || '';
        document.getElementById('editLastName').value = lastName || '';
        document.getElementById('editEmail').value = teacherEmail || '';
        document.getElementById('editPhone').value = teacherPhone || '';

        document.getElementById('editSelectedDepartment').value = teacherDepartmentName || '';
        document.getElementById('editDepartmentId').value = teacherDepartmentId || '';

        // Handle Roles
        roleSelectionTarget = 'edit';
        try {
            const roles = JSON.parse(rolesJson);
            selectedRolesArray = roles.map(r => r.name);
        } catch (e) {
            selectedRolesArray = [];
        }
        updateSelectedRolesUI();

        editTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeEditModal = function () {
        const editTeacherModal = document.getElementById('editTeacherModal');
        const editTeacherForm = document.getElementById('editTeacherForm');
        if (editTeacherModal) {
            editTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if (editTeacherForm) editTeacherForm.reset();
        }
    };

    window.openDeleteModal = function (teacherId, teacherName) {
        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        if (!deleteTeacherModal) return;

        document.getElementById('deleteTeacherId').value = teacherId;
        document.getElementById('deleteTeacherName').textContent = teacherName;
        deleteTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeDeleteModal = function () {
        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        if (deleteTeacherModal) {
            deleteTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };

    /**
     * POPOVER & MORE INFO LOGIC
     */
    window.showClassesModal = function (btn, teacherName, event) {
        event.stopPropagation();
        const classes = JSON.parse(btn.dataset.classes || '[]');
        const modal = document.getElementById('classesModal');
        const list = document.getElementById('classesList');
        const title = document.getElementById('classesModalTitle');

        if (!modal || !list) return;

        title.innerHTML = '<span class="text-indigo-600">' + teacherName.split(' ')[0] + '\'s</span> Active Deployments';
        list.innerHTML = classes.map(cls =>
            '<div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white hover:shadow-sm transition-all">' +
            '<div class="flex items-center gap-3">' +
            '<div class="w-8 h-8 flex items-center justify-center bg-white rounded-lg border border-slate-100/50 text-indigo-600 shadow-sm">' +
            '<i class="fas fa-school text-[10px]"></i>' +
            '</div>' +
            '<div>' +
            '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight block">' + cls.name + '</span>' +
            (cls.code ? '<span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">' + cls.code + '</span>' : '') +
            '</div>' +
            '</div>' +
            '<span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 text-[8px] font-black uppercase tracking-widest rounded-md border border-emerald-100/50">Live Status</span>' +
            '</div>'
        ).join('');

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeClassesModal = function () {
        const modal = document.getElementById('classesModal');
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };

    window.showDepartmentsModal = function (btn, teacherName, event) {
        event.stopPropagation();
        const departments = JSON.parse(btn.dataset.departments || '[]');
        const modal = document.getElementById('departmentsModal');
        const list = document.getElementById('departmentsList');
        const title = document.getElementById('departmentsModalTitle');

        if (!modal || !list) return;

        title.innerHTML = '<span class="text-indigo-600">' + teacherName.split(' ')[0] + '\'s</span> Department Assignments';
        list.innerHTML = departments.map(dept =>
            '<div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white hover:shadow-sm transition-all">' +
            '<div class="flex items-center gap-3">' +
            '<div class="w-8 h-8 flex items-center justify-center bg-white rounded-lg border border-slate-100/50 text-slate-600 shadow-sm">' +
            '<i class="fas fa-building text-[10px]"></i>' +
            '</div>' +
            '<div>' +
            '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight block">' + dept.name + '</span>' +
            (dept.code ? '<span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">' + dept.code + '</span>' : '') +
            '</div>' +
            '</div>' +
            '<span class="px-2 py-0.5 bg-slate-50 text-slate-600 text-[8px] font-black uppercase tracking-widest rounded-md border border-slate-200">Active</span>' +
            '</div>'
        ).join('');

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeDepartmentsModal = function () {
        const modal = document.getElementById('departmentsModal');
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };

    window.showMoreModal = function (type, teacherId, event) {
        event.stopPropagation();
        const teacher = allTeachers.find(t => t.id.toString() === teacherId.toString());
        if (!teacher) return;

        const items = type === 'role' ? teacher.roles : teacher.departments;
        const modal = document.getElementById('moreInfoModal');
        const list = document.getElementById('moreInfoModalBody');
        const title = document.getElementById('moreInfoModalTitle');
        const subtitle = document.getElementById('moreInfoModalSubtitle');

        if (!modal || !list) return;

        title.innerHTML = '<span class="text-indigo-600">' + teacher.first_name + '\'s</span> ' + (type === 'role' ? 'Access Hierarchy' : 'Departmental Wings');
        subtitle.innerText = type === 'role' ? 'Permission Matrix' : 'Organizational Units';

        const icon = type === 'role' ? 'fa-users-cog' : 'fa-building';
        const badgeColor = type === 'role' ? 'bg-emerald-50 text-emerald-600 border-emerald-100/50' : 'bg-blue-50 text-blue-600 border-blue-100/50';

        list.innerHTML = items.map(item =>
            '<div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white hover:shadow-sm transition-all">' +
            '<div class="flex items-center gap-3">' +
            '<div class="w-8 h-8 flex items-center justify-center bg-white rounded-lg border border-slate-100/50 ' + (type === 'role' ? 'text-purple-600' : 'text-blue-600') + ' shadow-sm">' +
            '<i class="fas ' + icon + ' text-[10px]"></i>' +
            '</div>' +
            '<div>' +
            '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight block">' + item.name + '</span>' +
            (item.code ? '<span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">' + item.code + '</span>' : '') +
            '</div>' +
            '</div>' +
            '<span class="px-2 py-0.5 ' + badgeColor + ' text-[8px] font-black uppercase tracking-widest rounded-md border">Live Status</span>' +
            '</div>'
        ).join('');

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeClassesModal = () => {
        document.getElementById('classesModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    };

    window.closeMoreInfoModal = () => {
        document.getElementById('moreInfoModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    };

    /**
     * API LOADING FUNCTIONS
     */
    async function loadTeacherStats() {
        try {
            const response = await fetch('/api/teachers/stats');
            const data = await response.json();

            // Update the card values directly
            const totalFaculty = document.getElementById('totalFaculty');
            const activeDuty = document.getElementById('activeDuty');
            const commanders = document.getElementById('commanders');
            const specialists = document.getElementById('specialists');

            if (totalFaculty) totalFaculty.textContent = data.total_teachers || 0;
            if (activeDuty) activeDuty.textContent = data.active_teachers || 0;
            if (commanders) commanders.textContent = data.class_teachers || 0;
            if (specialists) specialists.textContent = data.subject_teachers || 0;
        } catch (error) {
            console.error('Error loading teacher stats:', error);
        }
    }

    async function loadDepartmentOverview() {
        try {
            const response = await fetch('/api/teachers/department-overview');
            const data = await response.json();
            const container = document.getElementById('departmentOverview');
            if (!container) return;

            if (data.departments && data.departments.length > 0) {
                container.innerHTML = data.departments.map(dept => {
                    return '<div class="bg-slate-50/50 rounded-xl p-4 border border-slate-100 shadow-sm hover:bg-white hover:border-indigo-100 transition-all duration-300">' +
                        '<div class="flex items-center justify-between mb-3 pb-3 border-b border-slate-100/50">' +
                        '<h3 class="text-[11px] font-black text-slate-800 tracking-tight uppercase">' + dept.name + '</h3>' +
                        '<span class="px-2 py-0.5 bg-white text-indigo-600 border border-indigo-50 text-[9px] font-black uppercase tracking-widest rounded-md shadow-sm">' + dept.code + '</span>' +
                        '</div>' +
                        '<div class="space-y-3">' +
                        '<div class="flex items-center justify-between">' +
                        '<div class="flex flex-col">' +
                        '<span class="text-[8px] font-black text-slate-400 uppercase tracking-widest opacity-70">Unit Command</span>' +
                        '<span class="text-[11px] font-bold text-slate-700">' + dept.head_name + '</span>' +
                        '</div>' +
                        '<div class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[9px] font-black uppercase tracking-widest rounded-md shadow-sm">' +
                        (dept.teacher_count || 0) + ' PERS' +
                        '</div>' +
                        '</div>' +
                        '<div class="flex flex-col">' +
                        '<span class="text-[8px] font-black text-slate-400 uppercase tracking-widest opacity-70">Executive Liaison</span>' +
                        '<span class="text-[11px] font-bold text-slate-700">' + dept.assistant_name + '</span>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                }).join('');
            } else {
                container.innerHTML = '<p class="col-span-full text-center py-8 text-slate-400 uppercase font-black tracking-widest text-[10px]">No divisions mapped</p>';
            }
        } catch (error) {
            console.error('Error loading department overview:', error);
        }
    }

    async function loadTeachers() {
        const tbody = document.getElementById('teachers-table-body');
        if (!tbody) return;

        // Premium Skeleton Loader
        tbody.innerHTML = Array(5).fill().map(() =>
            '<tr class="animate-pulse border-b border-slate-50">' +
            '<td class="px-4 py-2.5"><div class="flex items-center"><div class="w-8 h-8 bg-slate-100 rounded-full mr-3"></div><div class="space-y-1"><div class="h-2.5 bg-slate-100 rounded w-24"></div><div class="h-2 bg-slate-50 rounded w-32"></div></div></div></td>' +
            '<td class="px-4 py-2.5"><div class="h-5 bg-slate-50 rounded w-20"></div></td>' +
            '<td class="px-4 py-2.5"><div class="h-5 bg-slate-50 rounded w-24"></div></td>' +
            '<td class="px-4 py-2.5"><div class="h-5 bg-slate-50 rounded w-16"></div></td>' +
            '<td class="px-4 py-2.5 text-center"><div class="h-4 bg-slate-50 rounded w-12 mx-auto"></div></td>' +
            '<td class="px-4 py-2.5 text-right"><div class="flex justify-end gap-2"><div class="w-6 h-6 bg-slate-50 rounded"></div><div class="w-6 h-6 bg-slate-50 rounded"></div></div></td>' +
            '</tr>'
        ).join('');

        try {
            const response = await fetch('/api/teachers');
            const data = await response.json();
            allTeachers = data.teachers || [];

            if (allTeachers.length > 0) {
                tbody.innerHTML = allTeachers.map(teacher => {
                    const initials = (teacher.first_name[0] || '') + (teacher.last_name[0] || '');
                    const fullName = teacher.first_name + ' ' + teacher.last_name;

                    // Status Styling
                    const isLive = teacher.is_active;
                    const statusClass = isLive
                        ? 'bg-emerald-50 text-emerald-600 border-emerald-100'
                        : 'bg-slate-50 text-slate-500 border-slate-100';
                    const indicatorClass = isLive
                        ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)] animate-pulse'
                        : 'bg-slate-400';
                    const statusText = isLive ? 'ACTIVE DUTY' : 'STATIONARY';
                    const statusIcon = isLive ? 'fa-circle' : 'fa-clock';

                    // Avatar Background (deterministically based on id)
                    const colors = ['bg-indigo-500', 'bg-blue-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-pink-500', 'bg-rose-500'];
                    const bgClass = colors[teacher.id % colors.length];

                    // Mobile Layout Logic matching Students Page pattern
                    return `
                    <tr class="hover:bg-indigo-50/30 transition-colors group cursor-pointer block md:table-row bg-transparent md:border-b md:border-slate-50 last:border-b-0 mb-2 md:mb-0">
                        <td class="px-0 py-0 md:px-4 md:py-3 block md:table-cell group">
                            <!-- Mobile Card Container / Desktop Link -->
                            <div class="relative flex flex-col items-start text-left md:flex-row md:items-center hover:opacity-80 transition-opacity w-full bg-white md:bg-transparent rounded-t-xl md:rounded-none border-x border-t border-slate-100 shadow-sm md:border-none md:shadow-none p-3 md:p-0">
                                
                                <div class="flex items-start justify-between w-full md:w-auto overflow-hidden">
                                    <!-- Avatar & Info -->
                                    <div class="flex items-center gap-2.5 md:gap-3 flex-1 min-w-0">
                                        <!-- Avatar -->
                                        <div class="w-10 h-10 md:w-8 md:h-8 bg-indigo-50 rounded-lg flex items-center justify-center border border-indigo-100 md:mr-3 group-hover:scale-105 transition-transform shadow-sm flex-shrink-0">
                                            <span class="text-[10px] icon-sm md:text-[10px] font-black text-indigo-600 uppercase tracking-wider">${initials}</span>
                                        </div>

                                        <!-- Name & Email -->
                                        <div class="min-w-0 flex-1">
                                            <a href="/teachers/${teacher.id}" class="block text-[13px] md:text-[11px] font-black text-slate-800 uppercase tracking-wide group-hover:text-indigo-700 transition-colors whitespace-nowrap truncate leading-tight">
                                                ${fullName}
                                            </a>
                                            <div class="flex items-center gap-1.5 mt-0.5">
                                                <span class="inline-flex items-center px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] md:text-[8px] font-black uppercase tracking-widest border border-slate-200/50 truncate max-w-[150px]">
                                                    ${teacher.email}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Status Badge (Top Right Mobile) -->
                                    <div class="md:hidden ml-2 flex-shrink-0">
                                         <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[8px] font-black uppercase tracking-wider border ${statusClass}">
                                            <i class="fas ${statusIcon} mr-1 text-[7px]"></i>
                                            ${statusText}
                                        </span>
                                    </div>
                                </div>

                                <!-- Mobile Divider -->
                                <div class="md:hidden w-full h-px bg-slate-50 my-2.5"></div>

                                <!-- Mobile Details Row (Department) -->
                                <div class="md:hidden flex items-center gap-2 overflow-hidden w-full">
                                    <div class="w-5 h-5 rounded bg-slate-50 flex items-center justify-center border border-slate-100 flex-shrink-0">
                                        <i class="fas fa-building text-slate-400 text-[9px]"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        ${(teacher.departments && teacher.departments.length > 0) ?
                            `<button onclick="showDepartmentsModal(this, '${fullName}', event)" data-departments='${JSON.stringify(teacher.departments)}' class="text-left w-full">
                                                <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">
                                                    ${teacher.departments[0].name}${teacher.departments.length > 1 ? ' +' + (teacher.departments.length - 1) : ''}
                                                </span>
                                            </button>` :
                            '<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide italic">Unassigned</span>'
                        }
                                    </div>
                                </div>

                                <!-- Mobile Deployments Row -->
                                <div class="md:hidden flex items-center justify-between w-full mt-2">
                                    <div class="flex items-center gap-2 overflow-hidden flex-1 mr-2">
                                        <div class="w-5 h-5 rounded bg-emerald-50 flex items-center justify-center border border-emerald-100 flex-shrink-0">
                                            <i class="fas fa-school text-emerald-500 text-[9px]"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            ${teacher.classes && teacher.classes.length > 0 ?
                            `<button onclick="showClassesModal(this, '${fullName}', event)" data-classes='${JSON.stringify(teacher.classes)}' class="text-left w-full">
                                                    <span class="text-[10px] font-bold text-emerald-600 uppercase tracking-wide">
                                                        ${teacher.classes[0].code || teacher.classes[0].name}${teacher.classes.length > 1 ? ' +' + (teacher.classes.length - 1) : ''}
                                                    </span>
                                                </button>` :
                            '<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide italic">No Deployments</span>'
                        }
                                        </div>
                                    </div>
                                    ${teacher.phone ? `
                                    <a href="tel:${teacher.phone}" class="flex items-center justify-center gap-1.5 text-[9px] font-black text-white bg-indigo-500 hover:bg-indigo-600 transition-colors uppercase tracking-wider px-4 py-1.5 rounded shadow-sm shadow-indigo-200 flex-shrink-0" onclick="event.stopPropagation()">
                                        <i class="fas fa-phone text-[9px]"></i>Call
                                    </a>
                                    ` : ''}
                                </div>
                            </div>
                        </td>

                        <!-- Desktop Columns -->
                        <td class="hidden md:table-cell px-4 py-3">
                            ${generateBadgesHtml(teacher.departments, 'department', teacher.id)}
                        </td>
                        <td class="hidden md:table-cell px-4 py-3">
                            ${generateBadgesHtml(teacher.roles, 'role', teacher.id)}
                        </td>
                        <td class="hidden md:table-cell px-4 py-3">
                            ${generateDeploymentsHtml(teacher.classes, fullName, teacher.id)}
                        </td>
                        <td class="hidden md:table-cell px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider border whitespace-nowrap ${statusClass}">
                                <i class="fas ${statusIcon} mr-1.5 text-[7px]"></i>${statusText}
                            </span>
                        </td>

                        <!-- Actions Column -->
                        <td class="px-0 py-0 md:px-4 md:py-3 block md:table-cell md:text-right">
                            <!-- Mobile: Full Width Actions Grid / Desktop: Flex Row -->
                            <div class="flex items-center md:justify-end gap-1.5 md:gap-1.5 bg-slate-50 md:bg-transparent rounded-b-xl md:rounded-none border-x border-b border-slate-100 shadow-sm md:border-none md:shadow-none overflow-hidden" onclick="event.stopPropagation()">
                                
                                <!-- View Button -->
                                 <button class="view-teacher-btn flex-1 md:w-7 md:h-7 md:flex-none flex flex-row items-center justify-center gap-1.5 md:gap-0 py-2.5 md:py-0 text-indigo-600 md:bg-indigo-50 md:rounded-lg md:border md:border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all group/btn border-r border-slate-200 md:border-none last:border-0" title="View Details" data-teacher-idx="${allTeachers.indexOf(teacher)}">
                                    <i class="fas fa-eye text-[12px] md:text-[10px] leading-none"></i>
                                    <span class="md:hidden text-[9px] font-black uppercase tracking-widest leading-none">View</span>
                                </button>

                                <!-- Edit Button -->
                                <button class="edit-teacher-btn flex-1 md:w-7 md:h-7 md:flex-none flex flex-row items-center justify-center gap-1.5 md:gap-0 py-2.5 md:py-0 text-emerald-600 md:bg-slate-50 md:rounded-lg md:border md:border-slate-200 hover:bg-emerald-600 hover:text-white transition-all group/btn border-r border-slate-200 md:border-none last:border-0" title="Modify Record" data-teacher-idx="${allTeachers.indexOf(teacher)}">
                                    <i class="fas fa-pen text-[12px] md:text-[10px] leading-none"></i>
                                    <span class="md:hidden text-[9px] font-black uppercase tracking-widest leading-none">Edit</span>
                                </button>

                                <!-- Delete Button -->
                                <button class="delete-teacher-btn flex-1 md:w-7 md:h-7 md:flex-none flex flex-row items-center justify-center gap-1.5 md:gap-0 py-2.5 md:py-0 text-rose-500 md:bg-slate-50 md:rounded-lg md:border md:border-slate-200 hover:bg-rose-600 hover:text-white transition-all group/btn md:border-none" title="Delete Record" data-teacher-id="${teacher.id}" data-teacher-name="${fullName}">
                                    <i class="fas fa-trash text-[12px] md:text-[10px] leading-none"></i>
                                    <span class="md:hidden text-[9px] font-black uppercase tracking-widest leading-none">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');

                attachTeacherActionListeners();
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-12 text-center"><div class="flex flex-col items-center justify-center"><div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-3"><i class="fas fa-chalkboard-teacher text-slate-300 text-xl"></i></div><p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">No faculty records found</p><p class="text-[10px] text-slate-300 font-bold uppercase tracking-wider mt-1">Initiate a new record to begin</p></div></td></tr>';
            }
        } catch (error) {
            console.error('Error loading teachers:', error);
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-12 text-center"><div class="flex flex-col items-center justify-center"><div class="w-12 h-12 bg-rose-50 rounded-full flex items-center justify-center mb-3"><i class="fas fa-exclamation-triangle text-rose-300 text-xl"></i></div><p class="text-[11px] font-black text-rose-400 uppercase tracking-widest">System Liaison Failed</p><p class="text-[10px] text-rose-300 font-bold uppercase tracking-wider mt-1">Check node connectivity</p></div></td></tr>';
        }
    }

    function attachTeacherActionListeners() {
        document.querySelectorAll('.view-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const teacher = allTeachers[parseInt(this.dataset.teacherIdx)];
                window.openViewModal(teacher);
            });
        });

        document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const teacher = allTeachers[parseInt(this.dataset.teacherIdx)];
                const rolesJson = JSON.stringify(teacher.roles);
                const deptId = teacher.department ? teacher.department.id : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].id : '');
                const deptName = teacher.department ? teacher.department.name : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].name : '');

                window.openEditModal(teacher.id, teacher.first_name, teacher.last_name, teacher.email, teacher.phone, rolesJson, deptId, deptName);
            });
        });

        document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                window.openDeleteModal(this.dataset.teacherId, this.dataset.teacherName);
            });
        });
    }

    // Initialize teachers page functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Load teachers and stats on page load
        loadTeachers();
        loadTeacherStats();
        loadDepartmentOverview();

        // Modal elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const addTeacherModal = document.getElementById('addTeacherModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const addTeacherForm = document.getElementById('addTeacherForm');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        // View modal elements
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        const closeViewModalBtn = document.getElementById('closeViewModalBtn');
        const closeViewModalBtn2 = document.getElementById('closeViewModalBtn2');

        const editTeacherModal = document.getElementById('editTeacherModal');
        const editTeacherForm = document.getElementById('editTeacherForm');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');

        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
        const deleteCancelBtn = document.getElementById('deleteCancelBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        const classesModal = document.getElementById('classesModal');
        const closeClassesModalBtn = document.getElementById('closeClassesModalBtn');
        const moreInfoModal = document.getElementById('moreInfoModal');
        const closeMoreInfoModalBtn = document.getElementById('closeMoreInfoModalBtn');

        // Selection Modals
        const selectDeptBtn = document.getElementById('selectDeptBtn');
        const editSelectDeptBtn = document.getElementById('editSelectDeptBtn');
        const deptSelectionModal = document.getElementById('deptSelectionModal');
        const closeDeptSelectionBtn = document.getElementById('closeDeptSelectionBtn');
        const deptSelectionList = document.getElementById('deptSelectionList');

        const selectRoleBtn = document.getElementById('selectRoleBtn');
        const editSelectRoleBtn = document.getElementById('editSelectRoleBtn');
        const roleSelectionModal = document.getElementById('roleSelectionModal');
        const closeRoleSelectionBtn = document.getElementById('closeRoleSelectionBtn');
        const roleSelectionList = document.getElementById('roleSelectionList');

        const confirmRolesBtn = document.createElement('button');
        confirmRolesBtn.id = 'confirmRolesBtn';
        confirmRolesBtn.className = 'w-full py-3 bg-indigo-600 text-white rounded-xl mt-4 text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200';
        confirmRolesBtn.textContent = 'Confirm Clearances';
        confirmRolesBtn.onclick = () => roleSelectionModal.classList.add('hidden');
        roleSelectionList.parentElement.appendChild(confirmRolesBtn);

        const selectSubjectsBtn = document.getElementById('selectSubjectsBtn');
        const subjectSelectionModal = document.getElementById('subjectSelectionModal');
        const closeSubjectSelectionBtn = document.getElementById('closeSubjectSelectionBtn');
        const subjectSelectionList = document.getElementById('subjectSelectionList');
        const confirmSubjectsBtn = document.getElementById('confirmSubjectsBtn');
        const selectedSubjectsContainer = document.getElementById('selectedSubjectsContainer');
        const selectedSubjectIdsInput = document.getElementById('selectedSubjectIds');

        // Management Modals
        const manageDeptsBtn = document.getElementById('manageDeptsBtn');
        const manageDeptsModal = document.getElementById('manageDeptsModal');
        const closeDeptsModalBtn = document.getElementById('closeDeptsModalBtn');
        const deptsList = document.getElementById('deptsList');
        const addDeptForm = document.getElementById('addDeptForm');

        const manageSubjectsBtn = document.getElementById('manageSubjectsBtn');
        const manageSubjectsModal = document.getElementById('manageSubjectsModal');
        const closeSubjectsModalBtn = document.getElementById('closeSubjectsModalBtn');
        const subjectsManagementList = document.getElementById('subjectsManagementList');
        const addSubjectForm = document.getElementById('addSubjectForm');

        const manageRolesBtn = document.getElementById('manageRolesBtn');
        const manageRolesModal = document.getElementById('manageRolesModal');
        const closeRolesModalBtn = document.getElementById('closeRolesModalBtn');
        const rolesList = document.getElementById('rolesList');
        const addRoleForm = document.getElementById('addRoleForm');

        /** ---------------------------------------------------------
         *  MODAL EVENT LISTENERS
         *  --------------------------------------------------------- */

        // Add Teacher
        if (addTeacherBtn) addTeacherBtn.addEventListener('click', () => {
            addTeacherModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        const closeAddModal = () => {
            addTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            addTeacherForm.reset();
            selectedSubjectIdsArray = [];
            selectedRolesArray = [];
            updateSelectedSubjectsUI();
            updateSelectedRolesUI();
        };
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeAddModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeAddModal);

        // View Modal
        if (closeViewModalBtn) closeViewModalBtn.addEventListener('click', window.closeViewModal);
        if (closeViewModalBtn2) closeViewModalBtn2.addEventListener('click', window.closeViewModal);

        // Edit Modal
        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', window.closeEditModal);
        if (editCancelBtn) editCancelBtn.addEventListener('click', window.closeEditModal);

        // Delete Modal
        if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener('click', window.closeDeleteModal);
        if (deleteCancelBtn) deleteCancelBtn.addEventListener('click', window.closeDeleteModal);

        // Popovers
        if (closeClassesModalBtn) closeClassesModalBtn.addEventListener('click', window.closeClassesModal);
        if (closeMoreInfoModalBtn) closeMoreInfoModalBtn.addEventListener('click', window.closeMoreInfoModal);

        // Backdrop Clicks
        [addTeacherModal, viewTeacherModal, editTeacherModal, deleteTeacherModal,
            manageDeptsModal, manageSubjectsModal, manageRolesModal,
            deptSelectionModal, roleSelectionModal, subjectSelectionModal].forEach(modal => {
                if (modal) modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            });

        // Global Escape Key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                [addTeacherModal, viewTeacherModal, editTeacherModal, deleteTeacherModal,
                    manageDeptsModal, manageSubjectsModal, manageRolesModal,
                    deptSelectionModal, roleSelectionModal, subjectSelectionModal,
                    classesModal, moreInfoModal].forEach(m => {
                        if (m) m.classList.add('hidden');
                    });
                document.body.style.overflow = 'auto';
            }
        });

        /** ---------------------------------------------------------
         *  SELECTION LOGIC
         *  --------------------------------------------------------- */

        if (selectDeptBtn) selectDeptBtn.addEventListener('click', () => {
            debtTarget = { name: document.getElementById('selectedDepartment'), id: document.getElementById('departmentId') };
            window.openDeptSelectionModal();
        });
        if (editSelectDeptBtn) editSelectDeptBtn.addEventListener('click', () => {
            debtTarget = { name: document.getElementById('editSelectedDepartment'), id: document.getElementById('editDepartmentId') };
            window.openDeptSelectionModal();
        });

        if (selectRoleBtn) selectRoleBtn.addEventListener('click', () => {
            roleSelectionTarget = 'add';
            window.openRoleSelectionModal();
        });
        if (editSelectRoleBtn) editSelectRoleBtn.addEventListener('click', () => {
            roleSelectionTarget = 'edit';
            window.openRoleSelectionModal();
        });
        if (closeRoleSelectionBtn) closeRoleSelectionBtn.addEventListener('click', () => {
            roleSelectionModal.classList.add('hidden');
            updateSelectedRolesUI();
        });

        if (selectSubjectsBtn) selectSubjectsBtn.addEventListener('click', () => {
            window.openSubjectSelectionModal();
        });


        async function loadDeptsForSelection() {
            try {
                const response = await fetch('/api/departments');
                const data = await response.json();
                deptSelectionList.innerHTML = '';

                if (!data.departments || data.departments.length === 0) {
                    deptSelectionList.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No departments found</div>';
                    return;
                }

                data.departments.forEach(dept => {
                    const isSelected = deptTarget.id && deptTarget.id.value === dept.id.toString();
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';

                    div.innerHTML = `
                        <div>
                            <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${dept.name}</div>
                            <div class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${dept.code || 'DIV'}</div>
                        </div>
                        ${isSelected ? '<i class="fas fa-check text-emerald-500 text-xs"></i>' : '<i class="fas fa-chevron-right text-slate-200 group-hover:text-primary-400 transition-all text-[10px]"></i>'}
                    `;

                    div.addEventListener('click', () => {
                        if (deptTarget.name) deptTarget.name.value = dept.name;
                        if (deptTarget.id) deptTarget.id.value = dept.id;
                        window.closeDeptSelectionModal();

                        // If this is the "Add Teacher" form department, auto-load subjects
                        if (deptTarget.id && deptTarget.id.id === 'departmentId') {
                            loadSubjectsForSelection(dept.id);
                            selectedSubjectIdsArray = [];
                            updateSelectedSubjectsUI();
                        }
                    });
                    deptSelectionList.appendChild(div);
                });
            } catch (err) {
                console.error('Error loading depts:', err);
                deptSelectionList.innerHTML = '<div class="text-center py-8 text-rose-500 text-xs font-bold uppercase">Failed to load departments</div>';
            }
        }

        async function loadRolesForSelection() {
            try {
                const response = await fetch('/api/roles');
                const data = await response.json();
                roleSelectionList.innerHTML = '';

                const activeRoles = data.roles.filter(role => role.is_active);
                if (activeRoles.length === 0) {
                    roleSelectionList.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No active roles found</div>';
                    return;
                }

                activeRoles.forEach(role => {
                    const isChecked = selectedRolesArray.includes(role.name);
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';

                    div.innerHTML = `
                        <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${role.name}</div>
                        ${isChecked ? '<i class="fas fa-check text-emerald-500 text-xs"></i>' : '<div class="w-4 h-4 rounded-md border border-slate-200 group-hover:border-primary-300"></div>'}
                    `;

                    div.addEventListener('click', () => {
                        const rname = role.name;
                        if (selectedRolesArray.includes(rname)) {
                            selectedRolesArray = selectedRolesArray.filter(r => r !== rname);
                        } else {
                            selectedRolesArray.push(rname);
                        }
                        // Immediate visual feedback without full reload if possible, but let's stick to simple
                        loadRolesForSelection();
                        updateSelectedRolesUI();
                    });
                    roleSelectionList.appendChild(div);
                });
            } catch (err) {
                console.error('Error loading roles:', err);
                roleSelectionList.innerHTML = '<div class="text-center py-8 text-rose-500 text-xs font-bold uppercase">Failed to load roles</div>';
            }
        }

        async function loadSubjectsForSelection(departmentId = '') {
            try {
                const url = departmentId ? '/api/subjects?department_id=' + departmentId : '/api/subjects';
                const response = await fetch(url);
                const data = await response.json();
                subjectSelectionList.innerHTML = '';

                if (!data.subjects || data.subjects.length === 0) {
                    subjectSelectionList.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">No modules available</div>';
                    return;
                }

                data.subjects.forEach(subject => {
                    cachedSubjects[subject.id] = subject.name;
                    const isChecked = selectedSubjectIdsArray.includes(subject.id.toString());
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors flex items-center justify-between group';

                    div.innerHTML = `
                        <div class="text-sm font-semibold text-slate-900 group-hover:text-primary-600">${subject.name}</div>
                        ${isChecked ? '<i class="fas fa-check text-emerald-500 text-xs"></i>' : '<div class="w-4 h-4 rounded-md border border-slate-200 group-hover:border-primary-300"></div>'}
                    `;

                    div.addEventListener('click', () => {
                        const sid = subject.id.toString();
                        if (selectedSubjectIdsArray.includes(sid)) {
                            selectedSubjectIdsArray = selectedSubjectIdsArray.filter(id => id !== sid);
                        } else {
                            selectedSubjectIdsArray.push(sid);
                        }
                        loadSubjectsForSelection(departmentId);
                    });
                    subjectSelectionList.appendChild(div);
                });
            } catch (err) {
                console.error('Error loading subjects:', err);
                subjectSelectionList.innerHTML = '<div class="text-center py-8 text-rose-500 text-xs font-bold uppercase">Failed to load modules</div>';
            }
        }

        /** ---------------------------------------------------------
         *  MANAGEMENT LOGIC
         *  --------------------------------------------------------- */

        // Departments
        if (manageDeptsBtn) manageDeptsBtn.addEventListener('click', () => {
            manageDeptsModal.classList.remove('hidden');
            loadDeptsManagement();
        });
        if (closeDeptsModalBtn) closeDeptsModalBtn.addEventListener('click', () => manageDeptsModal.classList.add('hidden'));

        async function loadDeptsManagement() {
            try {
                const res = await fetch('/api/departments');
                const data = await res.json();
                deptsList.innerHTML = '';
                const subjectDeptSelect = document.getElementById('subjectDeptId');
                if (subjectDeptSelect) subjectDeptSelect.innerHTML = '<option value="">Division...</option>';

                data.departments.forEach(dept => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML =
                        '<div class="flex items-center gap-3">' +
                        '<div class="w-8 h-6 flex items-center justify-center bg-slate-200/50 rounded text-[8px] font-black text-slate-500 uppercase">' + (dept.code || 'DIV') + '</div>' +
                        '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">' + dept.name + '</span>' +
                        '</div>' +
                        '<button onclick="window.deleteDept(\'' + dept.id + '\')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">' +
                        '<i class="fas fa-trash-alt text-[10px]"></i>' +
                        '</button>';
                    deptsList.appendChild(div);
                    if (subjectDeptSelect) {
                        const opt = document.createElement('option');
                        opt.value = dept.id;
                        opt.textContent = dept.name;
                        subjectDeptSelect.appendChild(opt);
                    }
                });
            } catch (err) { console.error('Error loading depts mgmt:', err); }
        }

        window.deleteDept = async (id) => {
            if (!confirm('Warning: Deleting a division may impact associated faculty records. Proceed?')) return;
            try {
                const res = await fetch('/api/departments/' + id, { method: 'DELETE' });
                if (res.ok) loadDeptsManagement();
                else alert('Error deauthorizing division');
            } catch (err) { console.error(err); }
        };

        if (addDeptForm) addDeptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('deptCode').value;
            const name = document.getElementById('deptName').value;
            try {
                const res = await fetch('/api/departments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });
                if (res.ok) {
                    addDeptForm.reset();
                    loadDeptsManagement();
                } else alert('Error authorizing division');
            } catch (err) { console.error(err); }
        });

        // Subjects
        if (manageSubjectsBtn) manageSubjectsBtn.addEventListener('click', () => {
            manageSubjectsModal.classList.remove('hidden');
            loadDeptsManagement(); // To populate dropdown
            loadSubjectsManagement();
        });
        if (closeSubjectsModalBtn) closeSubjectsModalBtn.addEventListener('click', () => manageSubjectsModal.classList.add('hidden'));

        async function loadSubjectsManagement() {
            try {
                const res = await fetch('/api/subjects');
                const data = await res.json();
                subjectsManagementList.innerHTML = '';
                data.subjects.forEach(subject => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML =
                        '<div class="flex flex-col">' +
                        '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">' + subject.name + '</span>' +
                        '<span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">' + (subject.department_name || 'Instructional Module') + '</span>' +
                        '</div>' +
                        '<button onclick="window.deleteSubject(\'' + subject.id + '\')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">' +
                        '<i class="fas fa-trash-alt text-[10px]"></i>' +
                        '</button>';
                    subjectsManagementList.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        window.deleteSubject = async (id) => {
            if (!confirm('Are you certain you want to decommission this module?')) return;
            try {
                const res = await fetch('/api/subjects/' + id, { method: 'DELETE' });
                if (res.ok) loadSubjectsManagement();
                else alert('Error decommissioning module');
            } catch (err) { console.error(err); }
        };

        if (addSubjectForm) addSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const deptId = document.getElementById('subjectDeptId').value;
            const name = document.getElementById('subjectName').value;
            try {
                const res = await fetch('/api/subjects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ department_id: deptId, name: name })
                });
                if (res.ok) {
                    addSubjectForm.reset();
                    loadSubjectsManagement();
                } else alert('Error registering module');
            } catch (err) { console.error(err); }
        });

        // Roles
        if (manageRolesBtn) manageRolesBtn.addEventListener('click', () => {
            manageRolesModal.classList.remove('hidden');
            loadRolesManagement();
        });
        if (closeRolesModalBtn) closeRolesModalBtn.addEventListener('click', () => manageRolesModal.classList.add('hidden'));

        async function loadRolesManagement() {
            try {
                const res = await fetch('/api/roles');
                const data = await res.json();
                rolesList.innerHTML = '';
                data.roles.forEach(role => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML =
                        '<div class="flex flex-col">' +
                        '<span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">' + role.name + '</span>' +
                        '<span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">' + (role.is_active ? 'Active protocol' : 'Disabled') + '</span>' +
                        '</div>' +
                        '<button onclick="window.deleteRole(\'' + role.name + '\')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">' +
                        '<i class="fas fa-trash-alt text-[10px]"></i>' +
                        '</button>';
                    rolesList.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        window.deleteRole = async (name) => {
            if (!confirm('Are you certain you want to decommissioning the \'' + name + '\' protocol?')) return;
            try {
                const res = await fetch('/api/roles/' + name, { method: 'DELETE' });
                if (res.ok) loadRolesManagement();
                else alert('Error decommissioning protocol');
            } catch (err) { console.error(err); }
        };

        if (addRoleForm) addRoleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('roleName').value;
            try {
                const res = await fetch('/api/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    addRoleForm.reset();
                    loadRolesManagement();
                } else alert('Error indexing protocol');
            } catch (err) { console.error(err); }
        });

        // Bridge Helpers
        window.openDeptSelectionModal = () => {
            deptSelectionModal.classList.remove('hidden');
            loadDeptsForSelection();
        };
        window.closeDeptSelectionModal = () => {
            deptSelectionModal.classList.add('hidden');
        };

        window.openSubjectSelectionModal = () => {
            subjectSelectionModal.classList.remove('hidden');
            loadSubjectsForSelection(document.getElementById('departmentId').value);
        };
        window.closeSubjectSelectionModal = () => {
            subjectSelectionModal.classList.add('hidden');
            updateSelectedSubjectsUI();
        };

        window.openRoleSelectionModal = () => {
            roleSelectionModal.classList.remove('hidden');
            loadRolesForSelection();
        };
        window.closeRoleSelectionModal = () => {
            roleSelectionModal.classList.add('hidden');
            updateSelectedRolesUI();
        };
        window.openManageRoles = () => { window.closeRoleSelectionModal(); manageRolesBtn.click(); };
        window.openManageDepts = () => { window.closeDeptSelectionModal(); manageDeptsBtn.click(); };
        window.openManageSubjects = () => { window.closeSubjectSelectionModal(); manageSubjectsBtn.click(); };

        /** ---------------------------------------------------------
         *  FORM SUBMISSIONS (TEACHER)
         *  --------------------------------------------------------- */

        if (addTeacherForm) addTeacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = addTeacherForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, 'Finalize Induction');

            const formData = new FormData(addTeacherForm);
            const data = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: selectedRolesArray[0] || '',
                roles: selectedRolesArray,
                phone: formData.get('phone'),
                department_id: formData.get('department'),
                subject_ids: selectedSubjectIdsArray
            };

            try {
                const res = await fetch('/api/teachers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert('Faculty Induction Complete');
                    closeAddModal();
                    loadTeachers();
                    loadTeacherStats();
                } else alert('Error: ' + result.error);
            } catch (err) { console.error(err); } finally {
                setButtonLoading(submitBtn, false, 'Finalize Induction');
            }
        });

        if (editTeacherForm) editTeacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('editTeacherId').value;
            const submitBtn = editTeacherForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, '<i class="fas fa-save mr-2"></i>Apply Changes');

            const formData = new FormData(editTeacherForm);
            const data = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName'),
                email: formData.get('email'),
                role: selectedRolesArray[0] || '',
                roles: selectedRolesArray,
                phone: formData.get('phone'),
                department_id: formData.get('department')
            };

            try {
                const res = await fetch('/api/teachers/' + teacherId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Record Updated Successfully');
                    window.closeEditModal();
                    loadTeachers();
                } else {
                    const result = await res.json();
                    alert('Error: ' + result.error);
                }
            } catch (err) { console.error(err); } finally {
                setButtonLoading(submitBtn, false, '<i class="fas fa-save mr-2"></i>Apply Changes');
            }
        });

        if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', async () => {
            const teacherId = document.getElementById('deleteTeacherId').value;
            setButtonLoading(confirmDeleteBtn, true, '<i class="fas fa-trash mr-2"></i>Confirm Deletion');

            try {
                const res = await fetch('/api/teachers/' + teacherId, { method: 'DELETE' });
                if (res.ok) {
                    alert('Personnel Record Purged');
                    window.closeDeleteModal();
                    loadTeachers();
                    loadTeacherStats();
                    loadDepartmentOverview();
                } else alert('Error decommission asset');
            } catch (err) { console.error(err); } finally {
                setButtonLoading(confirmDeleteBtn, false, '<i class="fas fa-trash mr-2"></i>Confirm Deletion');
            }
        });


    });


    function updateSelectedRolesUI() {
        const container = roleSelectionTarget === 'add' ? document.getElementById('addSelectedRolesContainer') : document.getElementById('editSelectedRolesContainer');
        if (!container) return;

        if (selectedRolesArray.length === 0) {
            container.innerHTML = '<span class="text-[' + (roleSelectionTarget === 'add' ? '12px' : '13px') + '] font-bold text-slate-400">No clearances selected</span>';
            return;
        }

        container.innerHTML = selectedRolesArray.map(role =>
            '<span class="inline-flex items-center px-2 py-1 bg-white text-indigo-600 border border-indigo-100 text-[10px] font-black uppercase tracking-widest rounded shadow-sm">' +
            role.replace('_', ' ') +
            '</span>'
        ).join('');
    }

    function updateSelectedSubjectsUI() {
        const selectedSubjectIdsInput = document.getElementById('selectedSubjectIds');
        const selectedSubjectsContainer = document.getElementById('selectedSubjectsContainer');
        if (!selectedSubjectIdsInput || !selectedSubjectsContainer) return;

        selectedSubjectIdsInput.value = selectedSubjectIdsArray.join(',');
        if (selectedSubjectIdsArray.length === 0) {
            selectedSubjectsContainer.innerHTML = '<span class="text-[12px] font-bold text-slate-400">No modules selected</span>';
            return;
        }
        selectedSubjectsContainer.innerHTML = selectedSubjectIdsArray.map(id =>
            '<span class="px-2 py-1 bg-white text-indigo-600 border border-indigo-50 text-[9px] font-black uppercase tracking-widest rounded shadow-sm">' + (cachedSubjects[id] || ('MOD-' + id)) + '</span>'
        ).join('');
    }

    // Phone Uniqueness Validation (Fast Check)
    async function validatePhone(input, excludeId = '') {
        const phone = input.value.trim();
        const feedbackId = input.id + 'Feedback';
        let feedback = document.getElementById(feedbackId);

        if (!feedback) {
            feedback = document.createElement('p');
            feedback.id = feedbackId;
            feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider hidden';
            input.parentElement.appendChild(feedback);
        }

        if (!phone) {
            feedback.classList.add('hidden');
            input.classList.remove('border-rose-500', 'border-emerald-500', 'ring-rose-500/10', 'ring-emerald-500/10');
            return;
        }

        // Simple loading state
        input.classList.add('opacity-70');

        try {
            const res = await fetch('/api/teachers/check-phone?phone=' + encodeURIComponent(phone) + '&exclude_id=' + excludeId);
            const data = await res.json();

            feedback.classList.remove('hidden');
            input.classList.remove('opacity-70');

            if (data.taken) {
                feedback.textContent = 'Phone associated with another account';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-rose-500';
                input.classList.add('border-rose-500', 'ring-4', 'ring-rose-500/10');
                input.classList.remove('border-emerald-500', 'ring-emerald-500/10');
            } else {
                feedback.textContent = 'Contact number available';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-emerald-500';
                input.classList.add('border-emerald-500', 'ring-4', 'ring-emerald-500/10');
                input.classList.remove('border-rose-500', 'ring-rose-500/10');
            }
        } catch (e) {
            console.error('Fast check failed:', e);
        }
    }

    // Debounce helper
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    const addPhoneInput = document.getElementById('phone');
    if (addPhoneInput) {
        addPhoneInput.addEventListener('input', debounce(() => validatePhone(addPhoneInput), 500));
    }

    const editPhoneInput = document.getElementById('editPhone');
    if (editPhoneInput) {
        editPhoneInput.addEventListener('input', debounce(() => {
            const teacherId = document.getElementById('editTeacherId').value;
            validatePhone(editPhoneInput, teacherId);
        }, 500));
    }

    // Run Payroll Handler
    document.getElementById('runPayrollBtn')?.addEventListener('click', async () => {
        const periodType = prompt('Enter payroll period (day/week/month):', 'month');
        if (!periodType || !['day', 'week', 'month'].includes(periodType.toLowerCase())) {
            return;
        }

        const btn = document.getElementById('runPayrollBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1.5"></i>Processing...';

        try {
            const res = await fetch(`/api/teachers/payroll/generate?period=${periodType.toLowerCase()}`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.success) {
                alert(`Payroll Generated!\n\nGenerated: ${data.generated} teachers\nSkipped: ${data.skipped}\nPeriod: ${data.period.start} to ${data.period.end}`);
                if (data.errors && data.errors.length > 0) {
                    console.error('Payroll errors:', data.errors);
                }
            } else {
                alert('Failed to generate payroll: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error occurred while generating payroll');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-money-bill-wave mr-1.5"></i>Run Payroll';
        }
    });
</script>