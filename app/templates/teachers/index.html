<!-- Teachers Management Content -->
<div class="p-4 lg:p-6">
    <!-- Header Section -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">Teachers Management</h1>
                <p class="text-gray-600 text-sm">Manage teacher records, assignments, and information</p>
            </div>
            <div class="flex items-center space-x-3">
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-sm">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button id="addTeacherBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm">
                    <i class="fas fa-plus mr-2"></i>Add Teacher
                </button>
                <button id="manageRolesBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                    <i class="fas fa-users-cog mr-2"></i>Manage Roles
                </button>
            </div>
        </div>
    </div>

    <!-- Department Overview -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Department Overview</h2>
        <div id="departmentOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Skeleton loading for departments -->
            <div class="animate-pulse">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
            <div class="animate-pulse">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
            <div class="animate-pulse">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
            <div class="animate-pulse">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="statsCards">
        <!-- Total Teachers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Total Teachers</p>
                    <p id="totalTeachersCount" class="text-2xl font-bold text-gray-900 mt-1">
                        <div class="h-8 bg-gray-200 rounded animate-pulse w-12"></div>
                    </p>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chalkboard-teacher text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Active Teachers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Active Teachers</p>
                    <p id="activeTeachersCount" class="text-2xl font-bold text-gray-900 mt-1">
                        <div class="h-8 bg-gray-200 rounded animate-pulse w-12"></div>
                    </p>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
            </div>
        </div>

        <!-- Class Teachers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Class Teachers</p>
                    <p id="classTeachersCount" class="text-2xl font-bold text-gray-900 mt-1">
                        <div class="h-8 bg-gray-200 rounded animate-pulse w-12"></div>
                    </p>
                </div>
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-school text-purple-600"></i>
                </div>
            </div>
        </div>

        <!-- Subject Teachers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Teachers</p>
                    <p id="subjectTeachersCount" class="text-2xl font-bold text-gray-900 mt-1">
                        <div class="h-8 bg-gray-200 rounded animate-pulse w-12"></div>
                    </p>
                </div>
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-book text-orange-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                <!-- Search -->
                <div class="relative">
                    <input type="text" placeholder="Search teachers..." 
                           class="w-full sm:w-64 pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                
                <!-- Department Filter -->
                <select class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white">
                    <option value="">All Departments</option>
                    <option value="mathematics">Mathematics</option>
                    <option value="science">Science</option>
                    <option value="english">English</option>
                    <option value="history">History</option>
                    <option value="physical_education">Physical Education</option>
                    <option value="arts">Arts</option>
                </select>

                <!-- Role Filter -->
                <select class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white">
                    <option value="">All Roles</option>
                    <option value="class_teacher">Class Teacher</option>
                    <option value="subject_teacher">Subject Teacher</option>
                    <option value="head_teacher">Head Teacher</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <div class="flex items-center space-x-2">
                <button class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                    <i class="fas fa-filter mr-1"></i>More Filters
                </button>
                <button class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                    <i class="fas fa-sort mr-1"></i>Sort
                </button>
            </div>
        </div>
    </div>

    <!-- Teachers Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classes</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Teachers will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">1</span> to <span class="font-medium">{{if .teachers}}{{len .teachers}}{{else}}0{{end}}</span> of <span class="font-medium">{{if .teachers}}{{len .teachers}}{{else}}0{{end}}</span> results
                </div>
                <div class="flex items-center space-x-2">
                    <button class="px-3 py-1 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition-colors duration-200" disabled>
                        Previous
                    </button>
                    <button class="px-3 py-1 text-sm bg-primary-600 text-white rounded">1</button>
                    <button class="px-3 py-1 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition-colors duration-200">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Teacher Modal -->
<div id="addTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Add New Teacher</h2>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="addTeacherForm" class="p-6 space-y-6">
            <!-- Personal Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Personal Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter first name">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter last name">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="teacher@swadiqschools.com">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="+256 XXX XXX XXX">
                    </div>
                </div>
            </div>

            <!-- Account Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Account Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter secure password">
                        <p class="text-xs text-gray-500 mt-1">Password must be at least 8 characters long</p>
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password *</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Confirm password">
                    </div>
                </div>
            </div>

            <!-- Professional Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Professional Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="selectedRole" name="selectedRole" readonly required
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900"
                                   placeholder="Click to select role">
                            <button type="button" id="selectRoleBtn" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                <i class="fas fa-users-cog mr-2"></i>Select Role
                            </button>
                        </div>
                        <input type="hidden" id="roleValue" name="role">
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <select id="department" name="department"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white">
                            <option value="">Select Department</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="subjects" class="block text-sm font-medium text-gray-700 mb-2">Subjects</label>
                        <select id="subjects" name="subjects" multiple
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white"
                                style="min-height: 80px;">
                            <option value="">Select subjects (hold Ctrl/Cmd for multiple)</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple subjects</p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" id="cancelBtn"
                        class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Teacher
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Teacher Modal -->
<div id="viewTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Teacher Details</h2>
            <button id="closeViewModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <div class="flex items-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 id="viewTeacherName" class="text-lg font-semibold text-gray-900"></h3>
                    <p id="viewTeacherEmail" class="text-gray-600"></p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Employee ID</label>
                    <p id="viewTeacherID" class="text-gray-900"></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <p id="viewTeacherPhone" class="text-gray-900"></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <p id="viewTeacherDepartment" class="text-gray-900"></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <span id="viewTeacherStatus" class="inline-flex px-2 py-1 text-xs font-medium rounded-full"></span>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Roles</label>
                    <div id="viewTeacherRoles" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Classes</label>
                    <div id="viewTeacherClasses" class="text-gray-900"></div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end p-6 border-t border-gray-200">
            <button id="closeViewModalBtn2" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                Close
            </button>
        </div>
    </div>
</div>

<script>
// Function to open the view teacher modal
function openViewModal(teacher) {
    document.getElementById('viewTeacherName').textContent = `${teacher.first_name} ${teacher.last_name}`;
    document.getElementById('viewTeacherEmail').textContent = teacher.email;
    document.getElementById('viewTeacherID').textContent = `EMP-${teacher.id}`;
    document.getElementById('viewTeacherPhone').textContent = teacher.phone || 'Not provided';
    const departmentElement = document.getElementById('viewTeacherDepartment');
    if (teacher.departments && teacher.departments.length > 0) {
        departmentElement.innerHTML = teacher.departments.map(dept => 
            `<span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full mr-1">${dept.name}</span>`
        ).join('');
    } else {
        departmentElement.innerHTML = '<span class="text-gray-500">Not Assigned</span>';
    }
    
    const statusElement = document.getElementById('viewTeacherStatus');
    statusElement.textContent = teacher.is_active ? 'Active' : 'Inactive';
    statusElement.className = `inline-flex px-2 py-1 text-xs font-medium rounded-full ${teacher.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
    
    const rolesElement = document.getElementById('viewTeacherRoles');
    if (teacher.roles && teacher.roles.length > 0) {
        rolesElement.innerHTML = teacher.roles.map(role => 
            `<span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${role.name}</span>`
        ).join('');
    } else {
        rolesElement.innerHTML = '<span class="text-gray-500">No roles assigned</span>';
    }
    
    const classesElement = document.getElementById('viewTeacherClasses');
    if (teacher.classes && teacher.classes.length > 0) {
        classesElement.textContent = teacher.classes.map(cls => cls.name).join(', ');
    } else {
        classesElement.innerHTML = '<span class="text-gray-500">No classes assigned</span>';
    }
    
    document.getElementById('viewTeacherModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

// Function to close the view teacher modal
function closeViewModal() {
    document.getElementById('viewTeacherModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Function to show classes modal
function showClassesModal(teacherName, classes, event) {
    const modal = document.getElementById('classesModal');
    const title = document.getElementById('classesModalTitle');
    const classesList = document.getElementById('classesList');
    
    title.textContent = `${teacherName}'s Classes`;
    
    classesList.innerHTML = '';
    classes.forEach(cls => {
        const classDiv = document.createElement('div');
        classDiv.className = 'py-1 text-sm text-gray-700';
        classDiv.innerHTML = `<span>${cls.name}</span>`;
        classesList.appendChild(classDiv);
    });
    
    // Position the modal next to the button using fixed positioning
    const rect = event.target.getBoundingClientRect();
    modal.style.left = `${rect.left}px`;
    modal.style.top = `${rect.bottom + 5}px`;
    
    modal.classList.remove('hidden');
}

// Function to close classes modal
function closeClassesModal() {
    document.getElementById('classesModal').classList.add('hidden');
}
</script>

<!-- Edit Teacher Modal -->
<div id="editTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Edit Teacher</h2>
            <button id="closeEditModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="editTeacherForm" class="p-6 space-y-6">
            <input type="hidden" id="editTeacherId" name="teacherId">

            <!-- Personal Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Personal Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editFirstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="editFirstName" name="firstName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter first name">
                    </div>
                    <div>
                        <label for="editLastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="editLastName" name="lastName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter last name">
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editEmail" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="editEmail" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter email address">
                    </div>
                    <div>
                        <label for="editPhone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="editPhone" name="phone"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="Enter phone number">
                    </div>
                </div>
            </div>

            <!-- Professional Information -->
            <div>
                <h3 class="text-md font-medium text-gray-900 mb-4">Professional Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Roles *</label>
                        <div class="space-y-2 p-3 border border-gray-300 rounded-lg bg-gray-50">
                            <label class="flex items-center">
                                <input type="checkbox" name="roles" value="class_teacher" class="mr-2 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm text-gray-700">Class Teacher</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="roles" value="subject_teacher" class="mr-2 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm text-gray-700">Subject Teacher</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="roles" value="head_teacher" class="mr-2 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm text-gray-700">Head Teacher</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="roles" value="admin" class="mr-2 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm text-gray-700">Admin</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Select one or more roles for this teacher</p>
                    </div>
                    <div>
                        <label for="editDepartment" class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <select id="editDepartment" name="department"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white">
                            <option value="">Select Department</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" id="editCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i>Update Teacher
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Delete Teacher</h2>
            <button id="closeDeleteModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Are you sure?</h3>
                    <p class="text-sm text-gray-500">This action cannot be undone.</p>
                </div>
            </div>
            <p class="text-gray-700 mb-4">
                Are you sure you want to delete <span id="deleteTeacherName" class="font-medium"></span>?
                This will remove the teacher from the system and they will no longer be able to access their account.
            </p>
            <input type="hidden" id="deleteTeacherId">
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200">
            <button type="button" id="deleteCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                Cancel
            </button>
            <button type="button" id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">
                <i class="fas fa-trash mr-2"></i>Delete Teacher
            </button>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div id="manageRolesModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Manage Roles</h2>
            <button id="closeRolesModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6">
            <!-- Add New Role -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Role</h3>
                <form id="addRoleForm" class="flex gap-3">
                    <input type="text" id="roleName" placeholder="Role name" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-plus mr-2"></i>Add Role
                    </button>
                </form>
            </div>

            <!-- Existing Roles -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Existing Roles</h3>
                <div id="rolesList" class="space-y-2">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Selection Modal -->
<div id="roleSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Select Role</h2>
            <button id="closeRoleSelectionBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6">
            <div id="roleSelectionList" class="space-y-3">
                <!-- Roles will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Classes Modal -->
<div id="classesModal" class="fixed z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 max-w-xs">
        <div class="flex items-center justify-between mb-3">
            <h3 id="classesModalTitle" class="text-sm font-semibold text-gray-900">Classes</h3>
            <button id="closeClassesModalBtn" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div id="classesList" class="space-y-1">
            <!-- Classes will be loaded here -->
        </div>
    </div>
</div>

<script>
// Load teacher stats via API
function loadTeacherStats() {
    fetch('/api/teachers/stats')
        .then(response => response.json())
        .then(data => {
            // Replace entire stats cards with actual data
            const statsCards = document.getElementById('statsCards');
            statsCards.innerHTML = `
                <!-- Total Teachers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Total Teachers</p>
                            <p class="text-2xl font-bold text-gray-900 mt-1">${data.total_teachers || 0}</p>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Teachers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Active Teachers</p>
                            <p class="text-2xl font-bold text-gray-900 mt-1">${data.active_teachers || 0}</p>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Class Teachers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Class Teachers</p>
                            <p class="text-2xl font-bold text-gray-900 mt-1">${data.class_teachers || 0}</p>
                        </div>
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-school text-purple-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Subject Teachers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Teachers</p>
                            <p class="text-2xl font-bold text-gray-900 mt-1">${data.subject_teachers || 0}</p>
                        </div>
                        <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-book text-orange-600"></i>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading teacher stats:', error);
            // Show error state
            const statsCards = document.getElementById('statsCards');
            statsCards.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
                    <p class="text-red-500">Error loading teacher stats</p>
                </div>
            `;
        });
}

// Load department overview via teachers API
function loadDepartmentOverview() {
    fetch('/api/teachers/department-overview')
        .then(response => response.json())
        .then(data => {
            const departmentOverview = document.getElementById('departmentOverview');
            if (data.departments && data.departments.length > 0) {
                departmentOverview.innerHTML = data.departments.map(dept => `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-gray-300 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-900">${dept.name}</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${dept.code}</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-gray-600">Head:</span>
                                    <span class="text-gray-900 font-medium">${dept.head_name}</span>
                                </div>
                                <div class="text-xs text-blue-600 font-medium">
                                    ${dept.teacher_count || 0} ${(dept.teacher_count || 0) === 1 ? 'Teacher' : 'Teachers'}
                                </div>
                            </div>
                            <div>
                                <span class="text-gray-600">Assistant:</span>
                                <span class="text-gray-900 font-medium">${dept.assistant_name}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                departmentOverview.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-building text-gray-400 text-3xl mb-3"></i>
                        <p class="text-gray-500">No departments found</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading department overview:', error);
            const departmentOverview = document.getElementById('departmentOverview');
            departmentOverview.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
                    <p class="text-red-500">Error loading departments</p>
                </div>
            `;
        });
}

// Loading utility functions
function setButtonLoading(button, isLoading, originalText = null) {
    if (isLoading) {
        button.disabled = true;
        button.dataset.originalText = originalText || button.textContent;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
        button.classList.add('opacity-75', 'cursor-not-allowed');
    } else {
        button.disabled = false;
        button.innerHTML = button.dataset.originalText || originalText;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

// Load teachers via API
function loadTeachers() {
    const tbody = document.getElementById('teachers-table-body');
    
    // Show loading skeleton
    tbody.innerHTML = Array(5).fill().map(() => `
        <tr class="animate-pulse">
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-200 rounded-full"></div>
                    <div class="ml-3">
                        <div class="h-4 bg-gray-200 rounded w-24 mb-1"></div>
                        <div class="h-3 bg-gray-200 rounded w-32"></div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3">
                <div class="h-4 bg-gray-200 rounded w-16"></div>
            </td>
            <td class="px-4 py-3">
                <div class="h-6 bg-gray-200 rounded-full w-20"></div>
            </td>
            <td class="px-4 py-3">
                <div class="h-4 bg-gray-200 rounded w-16"></div>
            </td>
            <td class="px-4 py-3">
                <div class="h-6 bg-gray-200 rounded-full w-16"></div>
            </td>
            <td class="px-4 py-3">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 bg-gray-200 rounded"></div>
                    <div class="w-6 h-6 bg-gray-200 rounded"></div>
                    <div class="w-6 h-6 bg-gray-200 rounded"></div>
                </div>
            </td>
        </tr>
    `).join('');

    fetch('/api/teachers')
        .then(response => response.json())
        .then(data => {
            if (data.teachers && data.teachers.length > 0) {
                tbody.innerHTML = data.teachers.map(teacher => `
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">${teacher.first_name} ${teacher.last_name}</p>
                                    <p class="text-xs text-gray-500">${teacher.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${teacher.departments && teacher.departments.length > 0 
                                ? teacher.departments.map(dept => `<span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full mr-1 mb-1">${dept.name}</span>`).join('')
                                : '<span class="text-gray-500">Not Assigned</span>'
                            }
                        </td>
                        <td class="px-4 py-3">
                            ${teacher.roles && teacher.roles.length > 0 
                                ? teacher.roles.map(role => `<span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${role.name}</span>`).join(', ')
                                : '<span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">No Role</span>'
                            }
                        </td>
                        <td class="px-4 py-3">
                            ${teacher.classes && teacher.classes.length > 0
                                ? `<button class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer whitespace-nowrap" onclick="showClassesModal('${teacher.first_name} ${teacher.last_name}', ${JSON.stringify(teacher.classes).replace(/"/g, '&quot;')}, event)">${teacher.classes.length} ${teacher.classes.length === 1 ? 'Class' : 'Classes'}</button>`
                                : '<span class="text-xs text-gray-500">No Classes</span>'
                            }
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex px-2 py-1 text-xs font-medium ${teacher.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded-full">
                                ${teacher.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center space-x-2">
                                <button class="view-teacher-btn p-1 text-gray-400 hover:text-blue-600 transition-colors duration-200" title="View" data-teacher='${JSON.stringify(teacher)}'>
                                    <i class="fas fa-eye text-sm"></i>
                                </button>
                                <button class="edit-teacher-btn p-1 text-gray-400 hover:text-green-600 transition-colors duration-200"
                                        title="Edit"
                                        data-teacher-id="${teacher.id}"
                                        data-teacher-name="${teacher.first_name} ${teacher.last_name}"
                                        data-teacher-email="${teacher.email}"
                                        data-teacher-phone="${teacher.phone || ''}"
                                        data-teacher-first-name="${teacher.first_name}"
                                        data-teacher-last-name="${teacher.last_name}"
                                        data-teacher-role="${teacher.roles && teacher.roles.length > 0 ? teacher.roles[0].name : ''}"
                                        data-teacher-department-id="${teacher.department ? teacher.department.id : ''}">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button class="delete-teacher-btn p-1 text-gray-400 hover:text-red-600 transition-colors duration-200"
                                        title="Delete"
                                        data-teacher-id="${teacher.id}"
                                        data-teacher-name="${teacher.first_name} ${teacher.last_name}">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Add event listeners for view buttons
                document.querySelectorAll('.view-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacher = JSON.parse(this.dataset.teacher);
                        openViewModal(teacher);
                    });
                });
                
                // Add event listeners for edit buttons
                document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.teacherId;
                        const firstName = this.dataset.teacherFirstName;
                        const lastName = this.dataset.teacherLastName;
                        const teacherEmail = this.dataset.teacherEmail;
                        const teacherPhone = this.dataset.teacherPhone;
                        const teacherRole = this.dataset.teacherRole;
                        const teacherDepartmentId = this.dataset.teacherDepartmentId;
                        openEditModal(teacherId, firstName, lastName, teacherEmail, teacherPhone, teacherRole, teacherDepartmentId);
                    });
                });
                
                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.teacherId;
                        const teacherName = this.dataset.teacherName;
                        openDeleteModal(teacherId, teacherName);
                    });
                });
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-chalkboard-teacher text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg font-medium">No teachers found</p>
                            <p class="text-sm">Add your first teacher to get started</p>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading teachers:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg font-medium">Error loading teachers</p>
                        <p class="text-sm">Please refresh the page to try again</p>
                    </td>
                </tr>
            `;
        });
}




// Global modal functions
function openEditModal(teacherId, firstName, lastName, teacherEmail, teacherPhone, teacherRole, teacherDepartment) {
    const editTeacherId = document.getElementById('editTeacherId');
    const editFirstName = document.getElementById('editFirstName');
    const editLastName = document.getElementById('editLastName');
    const editEmail = document.getElementById('editEmail');
    const editPhone = document.getElementById('editPhone');
    const editRole = document.getElementById('editRole');
    const editDepartment = document.getElementById('editDepartment');
    const editTeacherModal = document.getElementById('editTeacherModal');

    editTeacherId.value = teacherId;
    editFirstName.value = firstName || '';
    editLastName.value = lastName || '';
    editEmail.value = teacherEmail || '';
    editPhone.value = teacherPhone || '';

    // Load roles and departments
    loadEditRoles(teacherRole);
    loadEditDepartments(teacherDepartment);

    editTeacherModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeEditModal() {
    const editTeacherModal = document.getElementById('editTeacherModal');
    const editTeacherForm = document.getElementById('editTeacherForm');
    editTeacherModal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    editTeacherForm.reset();
}

function openDeleteModal(teacherId, teacherName) {
    const deleteTeacherId = document.getElementById('deleteTeacherId');
    const deleteTeacherName = document.getElementById('deleteTeacherName');
    const deleteTeacherModal = document.getElementById('deleteTeacherModal');

    deleteTeacherId.value = teacherId;
    deleteTeacherName.textContent = teacherName;
    deleteTeacherModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    const deleteTeacherModal = document.getElementById('deleteTeacherModal');
    deleteTeacherModal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Initialize teachers page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Load teachers and stats on page load
    loadTeachers();
    loadTeacherStats();
    loadDepartmentOverview();

    // Modal elements
    const addTeacherBtn = document.getElementById('addTeacherBtn');
    const addTeacherModal = document.getElementById('addTeacherModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const addTeacherForm = document.getElementById('addTeacherForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    // View modal elements
    const viewTeacherModal = document.getElementById('viewTeacherModal');
    const closeViewModalBtn = document.getElementById('closeViewModalBtn');
    const closeViewModalBtn2 = document.getElementById('closeViewModalBtn2');



    // Modal functionality
    function openModal() {
        addTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadDepartments();
        loadSubjects();
    }

    function closeModal() {
        addTeacherModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        addTeacherForm.reset();
    }
    
    // Remove this duplicate code since event listeners are already defined

    // Event listeners for modal
    addTeacherBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    
    // Event listeners for view modal
    closeViewModalBtn.addEventListener('click', closeViewModal);
    closeViewModalBtn2.addEventListener('click', closeViewModal);
    
    // Event listener for classes modal
    const closeClassesModalBtn = document.getElementById('closeClassesModalBtn');
    closeClassesModalBtn.addEventListener('click', closeClassesModal);
    
    // Remove this duplicate code since event listeners are already defined

    // Close modal when clicking outside
    addTeacherModal.addEventListener('click', function(e) {
        if (e.target === addTeacherModal) {
            closeModal();
        }
    });

    // Close view modal when clicking outside
    viewTeacherModal.addEventListener('click', function(e) {
        if (e.target === viewTeacherModal) {
            closeViewModal();
        }
    });

    // Close classes modal when clicking anywhere else
    document.addEventListener('click', function(e) {
        const classesModal = document.getElementById('classesModal');
        const closeBtn = document.getElementById('closeClassesModalBtn');
        if (!classesModal.contains(e.target) && !e.target.closest('button[onclick*="showClassesModal"]')) {
            closeClassesModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !addTeacherModal.classList.contains('hidden')) {
            closeModal();
        }
        if (e.key === 'Escape' && !viewTeacherModal.classList.contains('hidden')) {
            closeViewModal();
        }
        if (e.key === 'Escape' && !document.getElementById('classesModal').classList.contains('hidden')) {
            closeClassesModal();
        }
    });

    // Password validation
    function validatePasswords() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (password !== confirmPassword) {
            confirmPasswordInput.setCustomValidity('Passwords do not match');
        } else {
            confirmPasswordInput.setCustomValidity('');
        }
    }

    passwordInput.addEventListener('input', validatePasswords);
    confirmPasswordInput.addEventListener('input', validatePasswords);



    // Load departments from API
    async function loadDepartments() {
        try {
            const response = await fetch('/api/departments');
            const data = await response.json();

            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="">Select Department</option>';

            data.departments.forEach(department => {
                const option = document.createElement('option');
                option.value = department.id;

                // Create department display text with head info
                let displayText = department.name;
                if (department.head_of_department) {
                    displayText += ` (Head: ${department.head_of_department.first_name} ${department.head_of_department.last_name})`;
                }

                option.textContent = displayText;
                option.title = `${department.description || ''}\nHead: ${department.head_of_department ? department.head_of_department.first_name + ' ' + department.head_of_department.last_name : 'Not assigned'}\nAssistant: ${department.assistant_head ? department.assistant_head.first_name + ' ' + department.assistant_head.last_name : 'Not assigned'}`;
                departmentSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading departments:', error);
        }
    }

    // Load roles and departments from API for edit modal
    async function loadEditRoles(currentRole = '') {
        try {
            const response = await fetch('/api/roles');
            const data = await response.json();

            const editRoleSelect = document.getElementById('editRole');
            editRoleSelect.innerHTML = '<option value="">Select Role</option>';

            data.roles.forEach(role => {
                if (role.is_active) {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.textContent = role.name.replace('_', ' ');
                    if (role.name === currentRole) {
                        option.selected = true;
                    }
                    editRoleSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error('Error loading roles for edit:', error);
        }
    }

    async function loadEditDepartments(currentDepartmentId = '') {
        try {
            const response = await fetch('/api/departments');
            const data = await response.json();

            const editDepartmentSelect = document.getElementById('editDepartment');
            editDepartmentSelect.innerHTML = '<option value="">Select Department</option>';

            data.departments.forEach(department => {
                const option = document.createElement('option');
                option.value = department.id;
                option.textContent = department.name;
                if (department.id == currentDepartmentId) {
                    option.selected = true;
                }
                editDepartmentSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading departments for edit:', error);
        }
    }

    // Load subjects from API
    async function loadSubjects(departmentId = '') {
        try {
            const url = departmentId ? `/api/subjects?department_id=${departmentId}` : '/api/subjects';
            const response = await fetch(url);
            const data = await response.json();

            const subjectsSelect = document.getElementById('subjects');
            subjectsSelect.innerHTML = '<option value="">Select subjects (hold Ctrl/Cmd for multiple)</option>';

            data.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                subjectsSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading subjects:', error);
        }
    }

    // Role Selection Modal
    const selectRoleBtn = document.getElementById('selectRoleBtn');
    const roleSelectionModal = document.getElementById('roleSelectionModal');
    const closeRoleSelectionBtn = document.getElementById('closeRoleSelectionBtn');
    const roleSelectionList = document.getElementById('roleSelectionList');
    const selectedRoleInput = document.getElementById('selectedRole');
    const roleValueInput = document.getElementById('roleValue');

    selectRoleBtn.addEventListener('click', () => {
        roleSelectionModal.classList.remove('hidden');
        loadRolesForSelection();
    });

    closeRoleSelectionBtn.addEventListener('click', () => {
        roleSelectionModal.classList.add('hidden');
    });

    async function loadRolesForSelection() {
        try {
            const response = await fetch('/api/roles');
            const data = await response.json();
            
            roleSelectionList.innerHTML = '';
            
            data.roles.forEach(role => {
                if (role.is_active) {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200';
                    roleDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-gray-900 capitalize">${role.name.replace('_', ' ')}</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    `;
                    
                    roleDiv.addEventListener('click', () => {
                        selectedRoleInput.value = role.name.replace('_', ' ');
                        roleValueInput.value = role.name;
                        roleSelectionModal.classList.add('hidden');
                    });
                    
                    roleSelectionList.appendChild(roleDiv);
                }
            });
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }

    // Handle department change to filter subjects
    document.getElementById('department').addEventListener('change', function() {
        const departmentId = this.value;
        if (departmentId) {
            loadSubjects(departmentId);
        } else {
            loadSubjects();
        }
    });

    // Form submission
    addTeacherForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';

        const formData = new FormData(addTeacherForm);

        // Get selected subjects
        const subjectsSelect = document.getElementById('subjects');
        const selectedSubjects = Array.from(subjectsSelect.selectedOptions).map(option => option.value);

        // Get selected role
        const roleValue = document.getElementById('roleValue').value;
        if (!roleValue) {
            alert('Please select a role');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            return;
        }

        const data = {
            first_name: formData.get('firstName'),
            last_name: formData.get('lastName'),
            email: formData.get('email'),
            password: formData.get('password'),
            role: roleValue,
            phone: formData.get('phone'),
            department_id: formData.get('department'),
            subject_ids: selectedSubjects
        };

        try {
            const response = await fetch('/api/teachers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Teacher added successfully!');
                closeModal();
                loadTeachers();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while adding the teacher');
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    // Search functionality
    const searchInput = document.querySelector('input[placeholder="Search teachers..."]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            // Add search functionality here
            console.log('Searching for:', this.value);
        });
    }

    // Edit Teacher Modal functionality
    const editTeacherModal = document.getElementById('editTeacherModal');
    const closeEditModalBtn = document.getElementById('closeEditModalBtn');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editTeacherForm = document.getElementById('editTeacherForm');

    // Edit button event listeners are added dynamically when teachers are loaded

    // Edit modal event listeners
    closeEditModalBtn.addEventListener('click', closeEditModal);
    editCancelBtn.addEventListener('click', closeEditModal);

    // Close edit modal when clicking outside
    editTeacherModal.addEventListener('click', function(e) {
        if (e.target === editTeacherModal) {
            closeEditModal();
        }
    });

    // Edit teacher form submission
    editTeacherForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const editTeacherId = document.getElementById('editTeacherId');
        const submitBtn = this.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, '<i class="fas fa-save mr-2"></i>Update Teacher');

        const formData = new FormData(this);
        const data = {
            first_name: formData.get('firstName'),
            last_name: formData.get('lastName'),
            email: formData.get('email'),
            role: formData.get('role'),
            phone: formData.get('phone'),
            department_id: formData.get('department')
        };

        try {
            const response = await fetch(`/api/teachers/${editTeacherId.value}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Teacher updated successfully!');
                closeEditModal();
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating the teacher');
        } finally {
            setButtonLoading(submitBtn, false, '<i class="fas fa-save mr-2"></i>Update Teacher');
        }
    });

    // Delete Teacher Modal functionality
    const deleteTeacherModal = document.getElementById('deleteTeacherModal');
    const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
    const deleteCancelBtn = document.getElementById('deleteCancelBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // Delete button event listeners are added dynamically when teachers are loaded

    // Delete modal event listeners
    closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
    deleteCancelBtn.addEventListener('click', closeDeleteModal);

    // Close delete modal when clicking outside
    deleteTeacherModal.addEventListener('click', function(e) {
        if (e.target === deleteTeacherModal) {
            closeDeleteModal();
        }
    });

    // Confirm delete button
    confirmDeleteBtn.addEventListener('click', async function() {
        const deleteTeacherId = document.getElementById('deleteTeacherId');
        setButtonLoading(this, true, '<i class="fas fa-trash mr-2"></i>Delete Teacher');

        try {
            const response = await fetch(`/api/teachers/${deleteTeacherId.value}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert('Teacher deleted successfully!');
                closeDeleteModal();
                location.reload(); // Refresh the page to remove the deleted teacher
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the teacher');
        } finally {
            setButtonLoading(this, false, '<i class="fas fa-trash mr-2"></i>Delete Teacher');
        }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (!editTeacherModal.classList.contains('hidden')) {
                closeEditModal();
            }
            if (!deleteTeacherModal.classList.contains('hidden')) {
                closeDeleteModal();
            }
        }
    });

    // Manage Roles Modal
    const manageRolesBtn = document.getElementById('manageRolesBtn');
    const manageRolesModal = document.getElementById('manageRolesModal');
    const closeRolesModalBtn = document.getElementById('closeRolesModalBtn');
    const addRoleForm = document.getElementById('addRoleForm');
    const rolesList = document.getElementById('rolesList');

    manageRolesBtn.addEventListener('click', () => {
        manageRolesModal.classList.remove('hidden');
        loadRoles();
    });

    closeRolesModalBtn.addEventListener('click', () => {
        manageRolesModal.classList.add('hidden');
    });

    async function loadRoles() {
        try {
            const response = await fetch('/api/roles');
            const data = await response.json();
            
            rolesList.innerHTML = '';
            data.roles.forEach(role => {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                roleDiv.innerHTML = `
                    <span class="font-medium">${role.name}</span>
                    <span class="text-xs px-2 py-1 ${role.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded-full">
                        ${role.is_active ? 'Active' : 'Inactive'}
                    </span>
                `;
                rolesList.appendChild(roleDiv);
            });
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }

    addRoleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const roleName = document.getElementById('roleName').value;
        
        try {
            const response = await fetch('/api/roles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: roleName })
            });
            
            if (response.ok) {
                document.getElementById('roleName').value = '';
                loadRoles();
                alert('Role added successfully!');
            } else {
                alert('Error adding role');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error adding role');
        }
    });
});
</script>
