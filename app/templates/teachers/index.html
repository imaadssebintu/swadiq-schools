<!-- Teachers Management Content -->
<div class="px-4 py-4 lg:px-6 lg:py-5">
    <!-- Header Section -->
    <div class="mb-5">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-lg font-black text-slate-900 tracking-tight uppercase">Teachers Management</h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Instructional Staff & Faculty
                    Logistics</p>
            </div>
            <div class="flex items-center space-x-2">
                <button
                    class="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition-all duration-200 text-[11px] font-bold">
                    <i class="fas fa-arrow-up-from-bracket mr-1.5 opacity-50"></i>Export
                </button>
                <button id="addTeacherBtn"
                    class="px-4 py-1.5 premium-gradient text-white rounded-xl hover:opacity-90 transition-all duration-200 text-[11px] font-bold shadow-sm ring-2 ring-indigo-50">
                    <i class="fas fa-plus mr-1.5"></i>Add Faculty
                </button>
                <button id="manageDeptsBtn"
                    class="px-4 py-1.5 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[11px] font-bold shadow-sm">
                    <i class="fas fa-building mr-1.5 opacity-50"></i>Divisions
                </button>
                <button id="manageSubjectsBtn"
                    class="px-4 py-1.5 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl hover:bg-slate-200 transition-all duration-200 text-[11px] font-bold shadow-sm">
                    <i class="fas fa-book-open mr-1.5 opacity-50"></i>Modules
                </button>
                <button id="manageRolesBtn"
                    class="px-4 py-1.5 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition-all duration-200 text-[11px] font-bold shadow-sm">
                    <i class="fas fa-users-cog mr-1.5 opacity-50"></i>Access Levels
                </button>
            </div>
        </div>
    </div>

    <!-- Departmental Architecture (Compact) -->
    <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-5 shadow-sm overflow-hidden relative">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-[11px] font-black text-slate-900 uppercase tracking-widest">Departmental Architecture
                </h2>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Faculty Concentration
                    Matrix</p>
            </div>
        </div>
        <div id="departmentOverview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Loading Skeletons -->
            <div class="animate-pulse bg-slate-50 rounded-xl p-3 border border-slate-100">
                <div class="h-3 bg-slate-200 rounded w-3/4 mb-3"></div>
                <div class="h-6 bg-slate-200 rounded-lg w-full"></div>
            </div>
            <div class="animate-pulse bg-slate-50 rounded-xl p-3 border border-slate-100">
                <div class="h-3 bg-slate-200 rounded w-3/4 mb-3"></div>
                <div class="h-6 bg-slate-200 rounded-lg w-full"></div>
            </div>
        </div>
    </div>

    <!-- Stats Cards (Gradient Style) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5" id="statsCards">
        <!-- Progress Skeletons -->
        <div class="bg-slate-100 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="h-2 bg-slate-200 rounded w-1/2 mb-2"></div>
                    <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-lg"></div>
            </div>
        </div>
        <div class="bg-slate-100 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="h-2 bg-slate-200 rounded w-1/2 mb-2"></div>
                    <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-lg"></div>
            </div>
        </div>
        <div class="bg-slate-100 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="h-2 bg-slate-200 rounded w-1/2 mb-2"></div>
                    <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-lg"></div>
            </div>
        </div>
        <div class="bg-slate-100 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="h-2 bg-slate-200 rounded w-1/2 mb-2"></div>
                    <div class="h-6 bg-slate-200 rounded w-1/3"></div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- Filters and Search (Compact) -->
    <div class="bg-white rounded-2xl border border-slate-200 p-3 mb-5">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                <!-- Search -->
                <div class="relative group">
                    <input id="searchInput" type="text" placeholder="Search faculty..."
                        class="w-full sm:w-72 pl-9 pr-4 py-1.5 text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500/50 bg-slate-50 transition-all duration-300 group-hover:bg-white">
                    <i
                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-[10px] group-hover:text-indigo-500 transition-colors"></i>
                </div>

                <div class="flex items-center space-x-2">
                    <select id="departmentFilter"
                        class="px-3 py-1.5 text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500/50 bg-slate-50 hover:bg-white transition-all duration-300">
                        <option value="">All Departments</option>
                    </select>

                    <select id="roleFilter"
                        class="px-3 py-1.5 text-[11px] font-bold border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500/50 bg-slate-50 hover:bg-white transition-all duration-300">
                        <option value="">All Roles</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center space-x-1.5">
                <button
                    class="px-3 py-1.5 text-[11px] font-bold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all duration-200">
                    <i class="fas fa-filter mr-1.5 opacity-50"></i>Filters
                </button>
                <button
                    class="px-3 py-1.5 text-[11px] font-bold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all duration-200">
                    <i class="fas fa-arrow-down-wide-short mr-1.5 opacity-50"></i>Sort
                </button>
            </div>
        </div>
    </div>

    <!-- Teachers Table (Compact) -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="border-b border-slate-100 bg-slate-50/50">
                        <th class="px-5 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Faculty Member</th>
                        <th class="px-5 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Specialization</th>
                        <th class="px-5 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Access Level</th>
                        <th class="px-5 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Active Deployments</th>
                        <th
                            class="px-5 py-3 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Status</th>
                        <th
                            class="px-5 py-3 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            Admin Controls</th>
                    </tr>
                </thead>
                <tbody id="teachers-table-body" class="divide-y divide-slate-100">
                    <!-- Teachers will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination (Compact) -->
        <div class="px-5 py-3 bg-slate-50/50 border-t border-slate-100 flex items-center justify-between">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                Showing <span class="text-slate-700">1</span> to <span class="text-slate-700">{{if .teachers}}{{len
                    .teachers}}{{else}}0{{end}}</span> of <span class="text-slate-700">{{if .teachers}}{{len
                    .teachers}}{{else}}0{{end}}</span> Entries
            </p>
            <div class="flex items-center space-x-1">
                <button
                    class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:bg-white transition-all disabled:opacity-50"
                    disabled>
                    <i class="fas fa-chevron-left text-[10px]"></i>
                </button>
                <button
                    class="w-8 h-8 flex items-center justify-center rounded-lg bg-indigo-600 text-white font-bold text-[10px] shadow-sm shadow-indigo-200">1</button>
                <button
                    class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:bg-white transition-all disabled:opacity-50"
                    disabled>
                    <i class="fas fa-chevron-right text-[10px]"></i>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Add Teacher Modal -->
<div id="addTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeAddModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div>
                <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Faculty Induction</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Registering Staff Asset
                </p>
            </div>
            <button id="closeModalBtn" class="text-slate-400 hover:text-slate-900 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="addTeacherForm" class="p-6 space-y-6 overflow-y-auto max-h-[80vh]">
            <div class="space-y-6">
                <!-- Professional Information -->
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Assigned
                            Department *</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="selectedDepartment" name="selectedDepartment" readonly required
                                class="flex-1 text-xs font-semibold px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none"
                                placeholder="Select unit">
                            <button type="button" id="selectDeptBtn"
                                class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-all text-[10px] font-black uppercase tracking-widest shadow-md">
                                Department
                            </button>
                        </div>
                        <input type="hidden" id="departmentId" name="department">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Core
                            Modules</label>
                        <div id="selectedSubjectsContainer"
                            class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                            <span class="text-[11px] font-bold text-slate-400">No modules selected</span>
                        </div>
                        <button type="button" id="selectSubjectsBtn"
                            class="mt-2 w-full py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                            <i class="fas fa-book-open mr-1.5 opacity-50"></i>Assign Domains
                        </button>
                        <input type="hidden" id="selectedSubjectIds" name="subjects">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Access
                            Hierarchy *</label>
                        <div id="addSelectedRolesContainer"
                            class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                            <span class="text-[11px] font-bold text-slate-400">No clearances selected</span>
                        </div>
                        <button type="button" id="selectRoleBtn"
                            class="mt-2 w-full py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                            <i class="fas fa-users-cog mr-1.5 opacity-50"></i>Set Permissions
                        </button>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="space-y-4 pt-4 border-t border-slate-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">First Name
                                *</label>
                            <input type="text" id="firstName" name="firstName" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="First Name">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Surname
                                *</label>
                            <input type="text" id="lastName" name="lastName" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Last Name">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Digital
                            Identity *</label>
                        <input type="email" id="email" name="email" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                            placeholder="Email Address">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Comms
                            Protocol</label>
                        <input type="tel" id="phone" name="phone"
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                            placeholder="+256 ...">
                    </div>
                </div>

                <!-- Security Credentials -->
                <div class="space-y-4 pt-4 border-t border-slate-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Secure Key
                                *</label>
                            <input type="password" id="password" name="password" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Password">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Confirm Key
                                *</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                placeholder="Confirm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end gap-3 pt-6 border-t border-slate-100">
                <button type="button" onclick="closeAddModal()"
                    class="px-6 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Abort
                </button>
                <button type="submit"
                    class="px-6 py-2.5 text-white bg-slate-900 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Induct Faculty
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Teacher Modal -->
<div id="viewTeacherModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-[2.5rem] shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <!-- Modal Header -->
        <div class="p-8 pb-0">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mr-5 shadow-lg shadow-indigo-200 border-2 border-white">
                        <span id="viewTeacherInitials" class="text-white text-2xl font-black uppercase"></span>
                    </div>
                    <div>
                        <h3 id="viewTeacherName" class="text-2xl font-black text-slate-900 tracking-tight uppercase">
                        </h3>
                        <p id="viewTeacherID"
                            class="text-[11px] text-slate-400 font-bold uppercase tracking-widest mt-1 opacity-70"></p>
                    </div>
                </div>
                <button id="closeViewModalBtn"
                    class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-full transition-all">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>

        <div class="p-8 pt-0 space-y-6 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 opacity-70">Digital
                        Identity</label>
                    <p id="viewTeacherEmail" class="text-[14px] font-black text-slate-800 break-all"></p>
                </div>
                <div class="bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 opacity-70">Comms
                        Line</label>
                    <p id="viewTeacherPhone" class="text-[14px] font-black text-slate-800"></p>
                </div>
                <div class="bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 opacity-70">Assigned
                        Division</label>
                    <p id="viewTeacherDepartment"
                        class="text-[14px] font-black text-slate-800 uppercase tracking-tight"></p>
                </div>
                <div class="bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 opacity-70">Service
                        Status</label>
                    <div id="viewTeacherStatusContainer" class="mt-1">
                        <span id="viewTeacherStatus"
                            class="inline-flex items-center px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-full shadow-sm"></span>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 opacity-70">Hierarchy
                        Clearances</label>
                    <div id="viewTeacherRoles" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="md:col-span-2 bg-slate-50/50 rounded-2xl p-5 border border-slate-100">
                    <label
                        class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 opacity-70">Active
                        Deployments</label>
                    <div id="viewTeacherClasses" class="space-y-2"></div>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <button id="closeViewModalBtn2"
                    class="px-8 py-3 text-[11px] font-black uppercase tracking-widest text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all">
                    Dismiss
                </button>
                <a id="fullProfileBtn" href="#"
                    class="px-8 py-3 text-[11px] font-black uppercase tracking-widest text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-200 transition-all">
                    Full Personnel Record
                </a>
            </div>
        </div>
    </div>
</div>

<!-- View Functions moved to main script -->

<!-- Edit Teacher Modal -->
<div id="editTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeEditModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Edit Personnel</h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editTeacherForm" class="p-6 space-y-4">
            <input type="hidden" id="editTeacherId" name="teacherId">

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">First
                            Name</label>
                        <input type="text" id="editFirstName" name="firstName" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Last
                            Name</label>
                        <input type="text" id="editLastName" name="lastName" required
                            class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Email
                        Address</label>
                    <input type="email" id="editEmail" name="email" required
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Phone
                        Number</label>
                    <input type="tel" id="editPhone" name="phone"
                        class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Clearance
                        Levels</label>
                    <div id="editSelectedRolesContainer"
                        class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px] shadow-sm">
                        <span class="text-[11px] font-bold text-slate-400">No clearances selected</span>
                    </div>
                    <button type="button" id="editSelectRoleBtn"
                        class="mt-2 w-full py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 transition-all">
                        <i class="fas fa-plus mr-1.5 opacity-50"></i>Manage Clearances
                    </button>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide px-1">Assigned
                        Department</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="editSelectedDepartment" readonly required
                            class="flex-1 text-xs font-semibold px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none"
                            placeholder="Select unit">
                        <button type="button" id="editSelectDeptBtn"
                            class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-all text-[10px] font-black uppercase tracking-widest shadow-md">
                            Change
                        </button>
                    </div>
                    <input type="hidden" id="editDepartmentId" name="department">
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="pt-4 border-t border-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeEditModal()"
                    class="px-6 py-2.5 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Dismiss
                </button>
                <button type="submit"
                    class="px-6 py-2.5 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Apply Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteTeacherModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full border border-slate-200/60 overflow-hidden transform transition-all duration-300">
        <div class="p-8 text-center">
            <div class="w-20 h-20 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-exclamation-triangle text-rose-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-black text-slate-900 tracking-tight uppercase mb-2">Decommission Asset?</h2>
            <p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest mb-6">This action will purge the
                personnel record</p>

            <p class="text-[13px] text-slate-600 font-medium mb-8 leading-relaxed">
                Are you certain you want to remove <span id="deleteTeacherName"
                    class="font-black text-slate-900"></span> from active duty? This data cannot be recovered.
            </p>

            <input type="hidden" id="deleteTeacherId">

            <div class="flex flex-col gap-3">
                <button type="button" id="confirmDeleteBtn"
                    class="w-full py-4 bg-rose-600 text-white rounded-2xl hover:bg-rose-700 transition-all text-[11px] font-black uppercase tracking-widest shadow-lg shadow-rose-200">
                    <i class="fas fa-trash mr-2 text-[10px]"></i>Confirm Deletion
                </button>
                <button type="button" id="deleteCancelBtn"
                    class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl hover:bg-slate-200 transition-all text-[11px] font-black uppercase tracking-widest">
                    Abort Protocol
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Roles Modal -->
<div id="manageRolesModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Security Hierarchy</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Managing Access Levels
                </p>
            </div>
            <button id="closeRolesModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Role -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Initialize New
                    Clearances</h3>
                <form id="addRoleForm" class="flex gap-2.5">
                    <input type="text" id="roleName" placeholder="Define role designation..." required
                        class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    <button type="submit"
                        class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Induct
                    </button>
                </form>
            </div>

            <!-- Existing Roles -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active Protocols
                </h3>
                <div id="rolesList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Departments Modal -->
<div id="manageDeptsModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Departmental Architecture</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Defining Departments
                </p>
            </div>
            <button id="closeDeptsModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Department -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Register New
                    Department</h3>
                <form id="addDeptForm" class="grid grid-cols-1 gap-3">
                    <div class="flex gap-2.5">
                        <input type="text" id="deptCode" placeholder="Code (e.g. ENG)" required
                            class="w-24 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                        <input type="text" id="deptName" placeholder="Department Name..." required
                            class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    </div>
                    <button type="submit"
                        class="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Authorize Department
                    </button>
                </form>
            </div>

            <!-- Existing Divisions -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active
                    Architecture</h3>
                <div id="deptsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Departments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Modules Modal -->
<div id="manageSubjectsModal"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col border border-slate-200/60">
        <div class="flex items-center justify-between p-6 border-b border-slate-50 bg-slate-50/30">
            <div>
                <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase">Instructional Matrices</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Defining Core Modules
                </p>
            </div>
            <button id="closeSubjectsModalBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
                <i class="fas fa-times text-md"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">
            <!-- Add New Module -->
            <div class="bg-indigo-50/30 rounded-xl border border-indigo-100/50 p-5">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-0.5">Initialize New
                    Module</h3>
                <form id="addSubjectForm" class="grid grid-cols-1 gap-3">
                    <div class="flex gap-2.5">
                        <select id="subjectDeptId" required
                            class="w-32 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[11px] font-bold">
                            <option value="">Department...</option>
                        </select>
                        <input type="text" id="subjectName" placeholder="Module Title..." required
                            class="flex-1 px-3.5 py-2.5 bg-white border border-slate-100 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 text-[12px] font-bold">
                    </div>
                    <button type="submit"
                        class="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-1.5 text-[9px]"></i>Register Module
                    </button>
                </form>
            </div>

            <!-- Existing Modules -->
            <div>
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3.5 px-1">Active Modules
                </h3>
                <div id="subjectsManagementList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Subjects will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Selection Modal -->
<div id="roleSelectionModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeRoleSelectionModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Clearance Levels</h3>
            <button onclick="closeRoleSelectionModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5 max-h-[60vh] overflow-y-auto">
            <div id="roleSelectionList" class="space-y-2">
                <!-- Roles will be loaded here -->
            </div>
        </div>
        <div class="p-5 border-t border-slate-50 bg-slate-50/50 flex justify-end">
            <button onclick="closeRoleSelectionModal()"
                class="px-6 py-2 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                Confirm Selection
            </button>
        </div>
    </div>
</div>

<!-- Department Selection Modal -->
<div id="deptSelectionModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeDeptSelectionModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Assigned Department</h3>
            <button onclick="closeDeptSelectionModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5 max-h-[60vh] overflow-y-auto">
            <div id="deptSelectionList" class="space-y-2">
                <!-- Departments will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Subject Selection Modal -->
<div id="subjectSelectionModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeSubjectSelectionModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Core Modules</h3>
            <button onclick="closeSubjectSelectionModal()"
                class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5 max-h-[60vh] overflow-y-auto">
            <div id="subjectSelectionList" class="space-y-2">
                <!-- Subjects will be loaded here -->
            </div>
        </div>
        <div class="p-5 border-t border-slate-50 bg-slate-50/50 flex justify-end">
            <button onclick="closeSubjectSelectionModal()"
                class="px-6 py-2 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                Confirm Selection
            </button>
        </div>
    </div>
</div>

<!-- Classes Modal (Popover style) -->
<div id="classesModal" class="fixed z-50 hidden">
    <div
        class="bg-white rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-100 p-5 max-w-xs animate-in fade-in zoom-in duration-200">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-50">
            <h3 id="classesModalTitle" class="text-[10px] font-black text-slate-900 uppercase tracking-widest">Active
                Deployments</h3>
            <button onclick="window.closeClassesModal()" class="text-slate-400 hover:text-rose-500 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div id="classesList" class="space-y-2">
            <!-- Classes will be loaded here -->
        </div>
    </div>
</div>

<!-- More Info Modal (Pop-over style for badges) -->
<div id="moreInfoModal" class="fixed z-50 hidden">
    <div
        class="bg-white rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-100 p-5 max-w-xs animate-in fade-in zoom-in duration-200">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-50">
            <h3 id="moreInfoModalTitle" class="text-[10px] font-black text-slate-900 uppercase tracking-widest">
                Additional
                Intel</h3>
            <button onclick="window.closeMoreInfoModal()" class="text-slate-400 hover:text-rose-500 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
        <div id="moreInfoModalBody" class="space-y-2">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
    /**
     * GLOBAL STATE & CACHES
     */
    let allTeachers = [];
    let cachedSubjects = {}; // Cache for module names
    let deptTarget = { name: null, id: null };
    let roleSelectionTarget = 'add'; // 'add' or 'edit'
    let selectedRolesArray = [];
    let selectedSubjectIdsArray = [];

    /**
     * UTILITY FUNCTIONS
     */
    function setButtonLoading(button, isLoading, originalText = null) {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = originalText || button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || originalText;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function generateBadgesHtml(items, type, teacherId) {
        if (!items || items.length === 0) {
            return `<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">None</span>`;
        }

        const maxVisible = 1;
        let html = '';
        const visibleItems = items.slice(0, maxVisible);
        const hiddenItemsCount = items.length - maxVisible;

        html = visibleItems.map(item => {
            const badgeClass = type === 'role' ? 'bg-indigo-50 text-indigo-600 border-indigo-100/50' : 'bg-slate-50 text-slate-600 border-slate-100/50';
            return `<span class="inline-flex px-2 py-1 text-[10px] font-black uppercase tracking-widest ${badgeClass} border rounded-lg shadow-sm">${item.name}</span>`;
        }).join(' ');

        if (hiddenItemsCount > 0) {
            html += '<button class="ml-2 inline-flex items-center px-2 py-1 bg-slate-100 text-slate-600 text-[9px] font-black uppercase tracking-widest rounded-lg hover:bg-slate-200 transition-all active:scale-95" ' +
                'onclick="showMoreModal(\'' + type + '\', \'' + teacherId + '\', event)">' +
                '+' + hiddenItemsCount + ' MORE' +
                '</button>';
        }

        return '<div class="flex flex-wrap items-center gap-1.5">' + html + '</div>';
    }

    function generateDeploymentsHtml(classes, teacherName, teacherId) {
        if (!classes || classes.length === 0) {
            return `<span class="text-[9px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Active Deployments</span>`;
        }

        const maxVisible = 1;
        const visibleClasses = classes.slice(0, maxVisible);
        const hiddenCount = classes.length - maxVisible;

        let html = visibleClasses.map(cls => `
            <span class="inline-flex items-center px-2 py-1 bg-emerald-50 text-emerald-600 border border-emerald-100/50 text-[10px] font-black uppercase tracking-widest rounded-lg shadow-sm">
                <i class="fas fa-school mr-1.5 opacity-50 scale-75"></i>${cls.name}
            </span>
        `).join('');

        if (hiddenCount > 0) {
            html += '<button class="ml-2 inline-flex items-center px-2 py-1 bg-slate-900 text-white text-[9px] font-black uppercase tracking-widest rounded-lg hover:bg-black transition-all shadow-md active:scale-95" ' +
                'onclick="showClassesModal(this, \'' + teacherName + '\', event)" data-classes=\'' + JSON.stringify(classes) + '\'>' +
                '<i class="fas fa-plus mr-1 scale-75"></i>' + hiddenCount + ' MORE' +
                '</button>';
        } else {
            // For single item, let's still make it clickable for details
            html = '<div class="cursor-pointer group" onclick="showClassesModal(this, \'' + teacherName + '\', event)" data-classes=\'' + JSON.stringify(classes) + '\'>' +
                html +
                '</div>';
        }

        return '<div class="flex items-center">' + html + '</div>';
    }

    /**
     * MODAL OPERATIONS (GLOBAL)
     */
    window.openViewModal = function (teacher) {
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        if (!viewTeacherModal) return;

        document.getElementById('viewTeacherName').textContent = `${teacher.first_name} ${teacher.last_name}`;
        document.getElementById('viewTeacherEmail').textContent = teacher.email;
        document.getElementById('viewTeacherID').textContent = `FAC-REF-${teacher.id.toString().padStart(4, '0')}`;
        document.getElementById('viewTeacherPhone').textContent = teacher.phone || 'SECURE LINE UNSET';

        const deptDisplay = teacher.department ? teacher.department.name : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].name : 'UNASSIGNED');
        document.getElementById('viewTeacherDepartment').textContent = deptDisplay;

        // Initials
        document.getElementById('viewTeacherInitials').textContent = `${teacher.first_name[0]}${teacher.last_name[0]}`;

        // Status
        const statusSpan = document.getElementById('viewTeacherStatus');
        statusSpan.textContent = teacher.is_active ? 'Active Pursuit' : 'Stationary / Inactive';
        statusSpan.className = `inline-flex items-center px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-full shadow-sm ${teacher.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100/50' : 'bg-rose-50 text-rose-600 border border-rose-100/50'}`;
        statusSpan.innerHTML = `<span class="w-1.5 h-1.5 rounded-full mr-2 ${teacher.is_active ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500'}"></span>${statusSpan.textContent}`;

        // Roles
        const rolesContainer = document.getElementById('viewTeacherRoles');
        rolesContainer.innerHTML = '';
        if (teacher.roles && teacher.roles.length > 0) {
            teacher.roles.forEach(role => {
                const badge = document.createElement('span');
                badge.className = 'px-3 py-1.5 bg-white text-indigo-600 border border-indigo-50 text-[10px] font-black uppercase tracking-widest rounded-xl shadow-sm';
                badge.textContent = role.name;
                rolesContainer.appendChild(badge);
            });
        } else {
            rolesContainer.innerHTML = '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Clearances</span>';
        }

        // Classes
        const classesContainer = document.getElementById('viewTeacherClasses');
        classesContainer.innerHTML = '';
        if (teacher.classes && teacher.classes.length > 0) {
            teacher.classes.forEach(cls => {
                const classDiv = document.createElement('div');
                classDiv.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm';
                classDiv.innerHTML = `
                    <span class="text-[12px] font-bold text-slate-700 uppercase tracking-tight">${cls.name}</span>
                    <span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">Active Deployment</span>
                `;
                classesContainer.appendChild(classDiv);
            });
        } else {
            classesContainer.innerHTML = '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic opacity-50">No Active Deployments</span>';
        }

        // Link to full profile
        document.getElementById('fullProfileBtn').href = `/teachers/${teacher.id}`;

        viewTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeViewModal = function () {
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        if (viewTeacherModal) {
            viewTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };



    window.openEditModal = function (teacherId, firstName, lastName, teacherEmail, teacherPhone, rolesJson, teacherDepartmentId, teacherDepartmentName) {
        const editTeacherModal = document.getElementById('editTeacherModal');
        if (!editTeacherModal) return;

        document.getElementById('editTeacherId').value = teacherId;
        document.getElementById('editFirstName').value = firstName || '';
        document.getElementById('editLastName').value = lastName || '';
        document.getElementById('editEmail').value = teacherEmail || '';
        document.getElementById('editPhone').value = teacherPhone || '';

        document.getElementById('editSelectedDepartment').value = teacherDepartmentName || '';
        document.getElementById('editDepartmentId').value = teacherDepartmentId || '';

        // Handle Roles
        roleSelectionTarget = 'edit';
        try {
            const roles = JSON.parse(rolesJson);
            selectedRolesArray = roles.map(r => r.name);
        } catch (e) {
            selectedRolesArray = [];
        }
        updateSelectedRolesUI();

        editTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeEditModal = function () {
        const editTeacherModal = document.getElementById('editTeacherModal');
        const editTeacherForm = document.getElementById('editTeacherForm');
        if (editTeacherModal) {
            editTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if (editTeacherForm) editTeacherForm.reset();
        }
    };

    window.openDeleteModal = function (teacherId, teacherName) {
        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        if (!deleteTeacherModal) return;

        document.getElementById('deleteTeacherId').value = teacherId;
        document.getElementById('deleteTeacherName').textContent = teacherName;
        deleteTeacherModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeDeleteModal = function () {
        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        if (deleteTeacherModal) {
            deleteTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };

    /**
     * POPOVER & MORE INFO LOGIC
     */
    window.showClassesModal = function (btn, teacherName, event) {
        event.stopPropagation();
        const classes = JSON.parse(btn.dataset.classes || '[]');
        const modal = document.getElementById('classesModal');
        const list = document.getElementById('classesList');
        const title = document.getElementById('classesModalTitle');

        if (!modal || !list) return;

        title.innerHTML = `<span class="text-indigo-600">${teacherName.split(' ')[0]}'s</span> Active Deployments`;
        list.innerHTML = classes.map(cls => `
            <div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-white rounded-lg border border-slate-100/50 text-indigo-600 shadow-sm">
                        <i class="fas fa-school text-[10px]"></i>
                    </div>
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${cls.name}</span>
                </div>
                <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 text-[8px] font-black uppercase tracking-widest rounded-md border border-emerald-100/50">Live Status</span>
            </div>
        `).join('');

        // Position modal near button
        const rect = btn.getBoundingClientRect();
        modal.style.top = `${rect.bottom + window.scrollY + 5}px`;
        modal.style.left = `${rect.left + window.scrollX - 100}px`;
        modal.classList.remove('hidden');

        const closeHandler = () => {
            modal.classList.add('hidden');
            document.removeEventListener('click', closeHandler);
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 10);
    };

    window.showMoreModal = function (type, teacherId, event) {
        event.stopPropagation();
        const teacher = allTeachers.find(t => t.id.toString() === teacherId.toString());
        if (!teacher) return;

        const items = type === 'role' ? teacher.roles : teacher.departments;
        const modal = document.getElementById('moreInfoModal');
        const list = document.getElementById('moreInfoModalBody');
        const title = document.getElementById('moreInfoModalTitle');

        if (!modal || !list) return;

        title.textContent = type === 'role' ? 'Clearance Access' : 'Unit Assignments';
        const badgeClass = type === 'role' ? 'bg-indigo-50 text-indigo-600 border-indigo-100/50' : 'bg-slate-50 text-slate-600 border-slate-100/50';

        list.innerHTML = `<div class="flex flex-wrap gap-2">
            ${items.map(item => `
                <span class="inline-flex px-2.5 py-1.5 text-[10px] font-black uppercase tracking-widest ${badgeClass} border rounded-lg shadow-sm">
                    ${item.name}
                </span>
            `).join('')}
        </div>`;

        const rect = event.currentTarget.getBoundingClientRect();
        modal.style.top = `${rect.bottom + window.scrollY + 5}px`;
        modal.style.left = `${rect.left + window.scrollX - 50}px`;
        modal.classList.remove('hidden');

        const closeHandler = () => {
            modal.classList.add('hidden');
            document.removeEventListener('click', closeHandler);
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 10);
    };

    window.closeClassesModal = () => document.getElementById('classesModal').classList.add('hidden');
    window.closeMoreInfoModal = () => document.getElementById('moreInfoModal').classList.add('hidden');

    /**
     * API LOADING FUNCTIONS
     */
    async function loadTeacherStats() {
        try {
            const response = await fetch('/api/teachers/stats');
            const data = await response.json();
            const statsCards = document.getElementById('statsCards');
            if (!statsCards) return;

            statsCards.innerHTML =
                '<!-- Total Force -->' +
                '<div class="group bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">' +
                '<div class="flex items-center justify-between">' +
                '<div class="flex-1">' +
                '<p class="text-[10px] font-semibold text-indigo-100 uppercase tracking-wide mb-1">Total Force</p>' +
                '<p class="text-2xl font-black text-white leading-none">' + (data.total_teachers || 0) + '</p>' +
                '<div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2"></div>' +
                '</div>' +
                '<div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">' +
                '<i class="fas fa-chalkboard-teacher text-white text-lg"></i>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<!-- Active Duty -->' +
                '<div class="group bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">' +
                '<div class="flex items-center justify-between">' +
                '<div class="flex-1">' +
                '<p class="text-[10px] font-semibold text-emerald-100 uppercase tracking-wide mb-1">Active Duty</p>' +
                '<p class="text-2xl font-black text-white leading-none">' + (data.active_teachers || 0) + '</p>' +
                '<div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2"></div>' +
                '</div>' +
                '<div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">' +
                '<i class="fas fa-check-circle text-white text-lg"></i>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<!-- Commanders -->' +
                '<div class="group bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">' +
                '<div class="flex items-center justify-between">' +
                '<div class="flex-1">' +
                '<p class="text-[10px] font-semibold text-purple-100 uppercase tracking-wide mb-1">Commanders</p>' +
                '<p class="text-2xl font-black text-white leading-none">' + (data.class_teachers || 0) + '</p>' +
                '<div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2"></div>' +
                '</div>' +
                '<div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">' +
                '<i class="fas fa-school text-white text-lg"></i>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<!-- Specialists -->' +
                '<div class="group bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 p-3 transform hover:-translate-y-1 cursor-pointer">' +
                '<div class="flex items-center justify-between">' +
                '<div class="flex-1">' +
                '<p class="text-[10px] font-semibold text-orange-100 uppercase tracking-wide mb-1">Specialists</p>' +
                '<p class="text-2xl font-black text-white leading-none">' + (data.subject_teachers || 0) + '</p>' +
                '<div class="h-1 w-16 bg-white/30 rounded-full group-hover:w-24 transition-all duration-300 mt-2"></div>' +
                '</div>' +
                '<div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg group-hover:scale-110 transition-transform duration-300">' +
                '<i class="fas fa-book text-white text-lg"></i>' +
                '</div>' +
                '</div>' +
                '</div>';
        } catch (error) {
            console.error('Error loading teacher stats:', error);
        }
    }

    async function loadDepartmentOverview() {
        try {
            const response = await fetch('/api/teachers/department-overview');
            const data = await response.json();
            const container = document.getElementById('departmentOverview');
            if (!container) return;

            if (data.departments && data.departments.length > 0) {
                container.innerHTML = data.departments.map(dept => {
                    return '<div class="bg-slate-50/50 rounded-xl p-4 border border-slate-100 shadow-sm hover:bg-white hover:border-indigo-100 transition-all duration-300">' +
                        '<div class="flex items-center justify-between mb-3 pb-3 border-b border-slate-100/50">' +
                        '<h3 class="text-[11px] font-black text-slate-800 tracking-tight uppercase">' + dept.name + '</h3>' +
                        '<span class="px-2 py-0.5 bg-white text-indigo-600 border border-indigo-50 text-[9px] font-black uppercase tracking-widest rounded-md shadow-sm">' + dept.code + '</span>' +
                        '</div>' +
                        '<div class="space-y-3">' +
                        '<div class="flex items-center justify-between">' +
                        '<div class="flex flex-col">' +
                        '<span class="text-[8px] font-black text-slate-400 uppercase tracking-widest opacity-70">Unit Command</span>' +
                        '<span class="text-[11px] font-bold text-slate-700">' + dept.head_name + '</span>' +
                        '</div>' +
                        '<div class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[9px] font-black uppercase tracking-widest rounded-md shadow-sm">' +
                        (dept.teacher_count || 0) + ' PERS' +
                        '</div>' +
                        '</div>' +
                        '<div class="flex flex-col">' +
                        '<span class="text-[8px] font-black text-slate-400 uppercase tracking-widest opacity-70">Executive Liaison</span>' +
                        '<span class="text-[11px] font-bold text-slate-700">' + dept.assistant_name + '</span>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                }).join('');
            } else {
                container.innerHTML = `<p class="col-span-full text-center py-8 text-slate-400 uppercase font-black tracking-widest text-[10px]">No divisions mapped</p>`;
            }
        } catch (error) {
            console.error('Error loading department overview:', error);
        }
    }

    async function loadTeachers() {
        const tbody = document.getElementById('teachers-table-body');
        if (!tbody) return;

        // Loading skeletons
        tbody.innerHTML = Array(5).fill().map(() => `
            <tr class="animate-pulse">
                <td class="px-5 py-4"><div class="flex items-center"><div class="w-10 h-10 bg-slate-100 rounded-xl mr-3"></div><div class="space-y-2"><div class="h-3 bg-slate-100 rounded w-24"></div><div class="h-2 bg-slate-50 rounded w-32"></div></div></div></td>
                <td class="px-5 py-4"><div class="h-6 bg-slate-50 rounded-lg w-20"></div></td>
                <td class="px-5 py-4"><div class="h-6 bg-slate-50 rounded-lg w-24"></div></td>
                <td class="px-5 py-4"><div class="h-6 bg-slate-50 rounded-lg w-16"></div></td>
                <td class="px-5 py-4 text-center"><div class="h-4 bg-slate-50 rounded-lg w-12 mx-auto"></div></td>
                <td class="px-5 py-4 text-right"><div class="flex justify-end gap-2"><div class="w-8 h-8 bg-slate-50 rounded-lg"></div><div class="w-8 h-8 bg-slate-50 rounded-lg"></div></div></td>
            </tr>
        `).join('');

        try {
            const response = await fetch('/api/teachers');
            const data = await response.json();
            allTeachers = data.teachers || [];

            if (allTeachers.length > 0) {
                tbody.innerHTML = allTeachers.map(teacher => {
                    const initials = teacher.first_name[0] + teacher.last_name[0];
                    const fullName = teacher.first_name + ' ' + teacher.last_name;
                    const statusClass = teacher.is_active ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-rose-50 text-rose-600 border border-rose-100';
                    const indicatorClass = teacher.is_active ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500';
                    const statusText = teacher.is_active ? 'Live' : 'Standby';

                    let html = '<tr class="group hover:bg-slate-50 transition-all duration-300">';
                    html += '<td class="px-5 py-4"><div class="flex items-center">';
                    html += '<div class="w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-100 flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">';
                    html += '<span class="text-indigo-600 font-black text-[11px] uppercase">' + initials + '</span></div>';
                    html += '<div class="flex flex-col"><a href="/teachers/' + teacher.id + '" class="text-[13px] font-black text-slate-800 hover:text-indigo-600 transition-colors tracking-tight uppercase">' + fullName + '</a>';
                    html += '<span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5 opacity-70">' + teacher.email + (teacher.phone ? '  ' + teacher.phone : '') + '</span></div></div></td>';
                    html += '<td class="px-5 py-4">' + generateBadgesHtml(teacher.departments, 'department', teacher.id) + '</td>';
                    html += '<td class="px-5 py-4">' + generateBadgesHtml(teacher.roles, 'role', teacher.id) + '</td>';
                    html += '<td class="px-5 py-4">' + generateDeploymentsHtml(teacher.classes, fullName, teacher.id) + '</td>';
                    html += '<td class="px-5 py-4 text-center"><span class="inline-flex items-center px-2 py-0.5 text-[9px] font-black uppercase tracking-widest rounded-lg shadow-sm ' + statusClass + '">';
                    html += '<span class="w-1 h-1 rounded-full mr-1.5 ' + indicatorClass + '"></span>' + statusText + '</span></td>';
                    html += '<td class="px-5 py-4 text-right"><div class="flex items-center justify-end space-x-2">';
                    html += '<button class="view-teacher-btn w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-100 rounded-lg shadow-sm transition-all" title="Review Profile" data-teacher-idx="' + allTeachers.indexOf(teacher) + '"><i class="fas fa-eye text-[11px]"></i></button>';
                    html += '<button class="edit-teacher-btn w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-emerald-600 hover:border-emerald-100 rounded-lg shadow-sm transition-all" title="Modify Record" data-teacher-idx="' + allTeachers.indexOf(teacher) + '"><i class="fas fa-edit text-[11px]"></i></button>';
                    html += '<button class="delete-teacher-btn w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-rose-600 hover:border-rose-100 rounded-lg shadow-sm transition-all" title="Purge Record" data-teacher-id="' + teacher.id + '" data-teacher-name="' + fullName + '"><i class="fas fa-trash text-[11px]"></i></button>';
                    html += '</div></td></tr>';
                    return html;
                }).join('');

                attachTeacherActionListeners();
            } else {
                tbody.innerHTML = `<tr><td colspan="6" class="px-5 py-12 text-center"><i class="fas fa-chalkboard-teacher text-3xl mb-4 text-slate-200"></i><p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">No faculty records found</p></td></tr>`;
            }
        } catch (error) {
            console.error('Error loading teachers:', error);
            tbody.innerHTML = `<tr><td colspan="6" class="px-5 py-12 text-center text-rose-500"><i class="fas fa-exclamation-triangle text-3xl mb-4"></i><p class="text-[11px] font-black uppercase tracking-widest">System Liaison Failed</p></td></tr>`;
        }
    }

    function attachTeacherActionListeners() {
        document.querySelectorAll('.view-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const teacher = allTeachers[parseInt(this.dataset.teacherIdx)];
                window.openViewModal(teacher);
            });
        });

        document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const teacher = allTeachers[parseInt(this.dataset.teacherIdx)];
                const rolesJson = JSON.stringify(teacher.roles);
                const deptId = teacher.department ? teacher.department.id : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].id : '');
                const deptName = teacher.department ? teacher.department.name : (teacher.departments && teacher.departments.length > 0 ? teacher.departments[0].name : '');

                window.openEditModal(teacher.id, teacher.first_name, teacher.last_name, teacher.email, teacher.phone, rolesJson, deptId, deptName);
            });
        });

        document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                window.openDeleteModal(this.dataset.teacherId, this.dataset.teacherName);
            });
        });
    }

    // Initialize teachers page functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Load teachers and stats on page load
        loadTeachers();
        loadTeacherStats();
        loadDepartmentOverview();

        // Modal elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const addTeacherModal = document.getElementById('addTeacherModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const addTeacherForm = document.getElementById('addTeacherForm');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        // View modal elements
        const viewTeacherModal = document.getElementById('viewTeacherModal');
        const closeViewModalBtn = document.getElementById('closeViewModalBtn');
        const closeViewModalBtn2 = document.getElementById('closeViewModalBtn2');

        const editTeacherModal = document.getElementById('editTeacherModal');
        const editTeacherForm = document.getElementById('editTeacherForm');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');

        const deleteTeacherModal = document.getElementById('deleteTeacherModal');
        const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
        const deleteCancelBtn = document.getElementById('deleteCancelBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        const classesModal = document.getElementById('classesModal');
        const closeClassesModalBtn = document.getElementById('closeClassesModalBtn');
        const moreInfoModal = document.getElementById('moreInfoModal');
        const closeMoreInfoModalBtn = document.getElementById('closeMoreInfoModalBtn');

        // Selection Modals
        const selectDeptBtn = document.getElementById('selectDeptBtn');
        const editSelectDeptBtn = document.getElementById('editSelectDeptBtn');
        const deptSelectionModal = document.getElementById('deptSelectionModal');
        const closeDeptSelectionBtn = document.getElementById('closeDeptSelectionBtn');
        const deptSelectionList = document.getElementById('deptSelectionList');

        const selectRoleBtn = document.getElementById('selectRoleBtn');
        const editSelectRoleBtn = document.getElementById('editSelectRoleBtn');
        const roleSelectionModal = document.getElementById('roleSelectionModal');
        const closeRoleSelectionBtn = document.getElementById('closeRoleSelectionBtn');
        const roleSelectionList = document.getElementById('roleSelectionList');

        const confirmRolesBtn = document.createElement('button');
        confirmRolesBtn.id = 'confirmRolesBtn';
        confirmRolesBtn.className = 'w-full py-3 bg-indigo-600 text-white rounded-xl mt-4 text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-200';
        confirmRolesBtn.textContent = 'Confirm Clearances';
        confirmRolesBtn.onclick = () => roleSelectionModal.classList.add('hidden');
        roleSelectionList.parentElement.appendChild(confirmRolesBtn);

        const selectSubjectsBtn = document.getElementById('selectSubjectsBtn');
        const subjectSelectionModal = document.getElementById('subjectSelectionModal');
        const closeSubjectSelectionBtn = document.getElementById('closeSubjectSelectionBtn');
        const subjectSelectionList = document.getElementById('subjectSelectionList');
        const confirmSubjectsBtn = document.getElementById('confirmSubjectsBtn');
        const selectedSubjectsContainer = document.getElementById('selectedSubjectsContainer');
        const selectedSubjectIdsInput = document.getElementById('selectedSubjectIds');

        // Management Modals
        const manageDeptsBtn = document.getElementById('manageDeptsBtn');
        const manageDeptsModal = document.getElementById('manageDeptsModal');
        const closeDeptsModalBtn = document.getElementById('closeDeptsModalBtn');
        const deptsList = document.getElementById('deptsList');
        const addDeptForm = document.getElementById('addDeptForm');

        const manageSubjectsBtn = document.getElementById('manageSubjectsBtn');
        const manageSubjectsModal = document.getElementById('manageSubjectsModal');
        const closeSubjectsModalBtn = document.getElementById('closeSubjectsModalBtn');
        const subjectsManagementList = document.getElementById('subjectsManagementList');
        const addSubjectForm = document.getElementById('addSubjectForm');

        const manageRolesBtn = document.getElementById('manageRolesBtn');
        const manageRolesModal = document.getElementById('manageRolesModal');
        const closeRolesModalBtn = document.getElementById('closeRolesModalBtn');
        const rolesList = document.getElementById('rolesList');
        const addRoleForm = document.getElementById('addRoleForm');

        /** ---------------------------------------------------------
         *  MODAL EVENT LISTENERS
         *  --------------------------------------------------------- */

        // Add Teacher
        if (addTeacherBtn) addTeacherBtn.addEventListener('click', () => {
            addTeacherModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        const closeAddModal = () => {
            addTeacherModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            addTeacherForm.reset();
            selectedSubjectIdsArray = [];
            selectedRolesArray = [];
            updateSelectedSubjectsUI();
            updateSelectedRolesUI();
        };
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeAddModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeAddModal);

        // View Modal
        if (closeViewModalBtn) closeViewModalBtn.addEventListener('click', window.closeViewModal);
        if (closeViewModalBtn2) closeViewModalBtn2.addEventListener('click', window.closeViewModal);

        // Edit Modal
        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', window.closeEditModal);
        if (editCancelBtn) editCancelBtn.addEventListener('click', window.closeEditModal);

        // Delete Modal
        if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener('click', window.closeDeleteModal);
        if (deleteCancelBtn) deleteCancelBtn.addEventListener('click', window.closeDeleteModal);

        // Popovers
        if (closeClassesModalBtn) closeClassesModalBtn.addEventListener('click', window.closeClassesModal);
        if (closeMoreInfoModalBtn) closeMoreInfoModalBtn.addEventListener('click', window.closeMoreInfoModal);

        // Backdrop Clicks
        [addTeacherModal, viewTeacherModal, editTeacherModal, deleteTeacherModal,
            manageDeptsModal, manageSubjectsModal, manageRolesModal,
            deptSelectionModal, roleSelectionModal, subjectSelectionModal].forEach(modal => {
                if (modal) modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            });

        // Global Escape Key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                [addTeacherModal, viewTeacherModal, editTeacherModal, deleteTeacherModal,
                    manageDeptsModal, manageSubjectsModal, manageRolesModal,
                    deptSelectionModal, roleSelectionModal, subjectSelectionModal,
                    classesModal, moreInfoModal].forEach(m => {
                        if (m) m.classList.add('hidden');
                    });
                document.body.style.overflow = 'auto';
            }
        });

        /** ---------------------------------------------------------
         *  SELECTION LOGIC
         *  --------------------------------------------------------- */

        if (selectDeptBtn) selectDeptBtn.addEventListener('click', () => {
            debtTarget = { name: document.getElementById('selectedDepartment'), id: document.getElementById('departmentId') };
            window.openDeptSelectionModal();
        });
        if (editSelectDeptBtn) editSelectDeptBtn.addEventListener('click', () => {
            debtTarget = { name: document.getElementById('editSelectedDepartment'), id: document.getElementById('editDepartmentId') };
            window.openDeptSelectionModal();
        });

        if (selectRoleBtn) selectRoleBtn.addEventListener('click', () => {
            roleSelectionTarget = 'add';
            window.openRoleSelectionModal();
        });
        if (editSelectRoleBtn) editSelectRoleBtn.addEventListener('click', () => {
            roleSelectionTarget = 'edit';
            window.openRoleSelectionModal();
        });
        if (closeRoleSelectionBtn) closeRoleSelectionBtn.addEventListener('click', () => {
            roleSelectionModal.classList.add('hidden');
            updateSelectedRolesUI();
        });

        if (selectSubjectsBtn) selectSubjectsBtn.addEventListener('click', () => {
            window.openSubjectSelectionModal();
        });


        async function loadDeptsForSelection() {
            try {
                const response = await fetch('/api/departments');
                const data = await response.json();
                deptSelectionList.innerHTML = '';
                data.departments.forEach(dept => {
                    const isSelected = deptTarget.id && deptTarget.id.value === dept.id.toString();
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isSelected ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-slate-300'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-6 flex items-center justify-center bg-slate-100 rounded text-[8px] font-black text-slate-400 uppercase">${dept.code || 'DIV'}</div>
                            <span class="text-xs font-bold uppercase tracking-wide ${isSelected ? 'text-indigo-600' : 'text-slate-600'}">${dept.name}</span>
                        </div>
                        ${isSelected
                            ? '<i class="fas fa-check-circle text-indigo-500"></i>'
                            : '<div class="w-5 h-5 rounded-full border border-slate-200 bg-slate-50"></div>'}
                    `;
                    div.addEventListener('click', () => {
                        if (deptTarget.name) deptTarget.name.value = dept.name;
                        if (deptTarget.id) deptTarget.id.value = dept.id;
                        window.closeDeptSelectionModal();
                        if (deptTarget.id && deptTarget.id.id === 'departmentId') {
                            loadSubjectsForSelection(dept.id);
                            selectedSubjectIdsArray = [];
                            updateSelectedSubjectsUI();
                        }
                    });
                    deptSelectionList.appendChild(div);
                });
            } catch (err) { console.error('Error loading depts:', err); }
        }

        async function loadRolesForSelection() {
            try {
                const response = await fetch('/api/roles');
                const data = await response.json();
                roleSelectionList.innerHTML = '';
                data.roles.forEach(role => {
                    if (!role.is_active) return;
                    const isChecked = selectedRolesArray.includes(role.name);
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isChecked ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-slate-300'}`;
                    div.innerHTML = `
                        <span class="text-xs font-bold uppercase tracking-wide ${isChecked ? 'text-indigo-600' : 'text-slate-600'}">${role.name}</span>
                        ${isChecked
                            ? '<i class="fas fa-check-circle text-indigo-500"></i>'
                            : '<div class="w-5 h-5 rounded-full border border-slate-200 bg-slate-50"></div>'}
                    `;
                    div.addEventListener('click', () => {
                        const rname = role.name;
                        if (selectedRolesArray.includes(rname)) {
                            selectedRolesArray = selectedRolesArray.filter(r => r !== rname);
                        } else {
                            selectedRolesArray.push(rname);
                        }
                        loadRolesForSelection();
                        updateSelectedRolesUI();
                    });
                    roleSelectionList.appendChild(div);
                });
            } catch (err) { console.error('Error loading roles:', err); }
        }

        async function loadSubjectsForSelection(departmentId = '') {
            try {
                const url = departmentId ? `/api/subjects?department_id=${departmentId}` : '/api/subjects';
                const response = await fetch(url);
                const data = await response.json();
                subjectSelectionList.innerHTML = '';
                if (data.subjects.length === 0) {
                    subjectSelectionList.innerHTML = '<p class="text-[11px] text-slate-400 text-center py-4 font-bold uppercase tracking-widest">No modules available</p>';
                    return;
                }
                data.subjects.forEach(subject => {
                    cachedSubjects[subject.id] = subject.name;
                    const isChecked = selectedSubjectIdsArray.includes(subject.id.toString());
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isChecked ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-slate-300'}`;
                    div.innerHTML = `
                        <span class="text-xs font-bold uppercase tracking-wide ${isChecked ? 'text-indigo-600' : 'text-slate-600'}">${subject.name}</span>
                        ${isChecked
                            ? '<i class="fas fa-check-circle text-indigo-500"></i>'
                            : '<div class="w-5 h-5 rounded-full border border-slate-200 bg-slate-50"></div>'}
                    `;
                    div.addEventListener('click', () => {
                        const sid = subject.id.toString();
                        if (selectedSubjectIdsArray.includes(sid)) {
                            selectedSubjectIdsArray = selectedSubjectIdsArray.filter(id => id !== sid);
                        } else {
                            selectedSubjectIdsArray.push(sid);
                        }
                        loadSubjectsForSelection(departmentId);
                    });
                    subjectSelectionList.appendChild(div);
                });
            } catch (err) { console.error('Error loading subjects:', err); }
        }

        /** ---------------------------------------------------------
         *  MANAGEMENT LOGIC
         *  --------------------------------------------------------- */

        // Departments
        if (manageDeptsBtn) manageDeptsBtn.addEventListener('click', () => {
            manageDeptsModal.classList.remove('hidden');
            loadDeptsManagement();
        });
        if (closeDeptsModalBtn) closeDeptsModalBtn.addEventListener('click', () => manageDeptsModal.classList.add('hidden'));

        async function loadDeptsManagement() {
            try {
                const res = await fetch('/api/departments');
                const data = await res.json();
                deptsList.innerHTML = '';
                const subjectDeptSelect = document.getElementById('subjectDeptId');
                if (subjectDeptSelect) subjectDeptSelect.innerHTML = '<option value="">Division...</option>';

                data.departments.forEach(dept => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-6 flex items-center justify-center bg-slate-200/50 rounded text-[8px] font-black text-slate-500 uppercase">${dept.code || 'DIV'}</div>
                            <span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${dept.name}</span>
                        </div>
                        <button onclick="window.deleteDept('${dept.id}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    `;
                    deptsList.appendChild(div);
                    if (subjectDeptSelect) {
                        const opt = document.createElement('option');
                        opt.value = dept.id;
                        opt.textContent = dept.name;
                        subjectDeptSelect.appendChild(opt);
                    }
                });
            } catch (err) { console.error('Error loading depts mgmt:', err); }
        }

        window.deleteDept = async (id) => {
            if (!confirm('Warning: Deleting a division may impact associated faculty records. Proceed?')) return;
            try {
                const res = await fetch(`/api/departments/${id}`, { method: 'DELETE' });
                if (res.ok) loadDeptsManagement();
                else alert('Error deauthorizing division');
            } catch (err) { console.error(err); }
        };

        if (addDeptForm) addDeptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('deptCode').value;
            const name = document.getElementById('deptName').value;
            try {
                const res = await fetch('/api/departments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });
                if (res.ok) {
                    addDeptForm.reset();
                    loadDeptsManagement();
                } else alert('Error authorizing division');
            } catch (err) { console.error(err); }
        });

        // Subjects
        if (manageSubjectsBtn) manageSubjectsBtn.addEventListener('click', () => {
            manageSubjectsModal.classList.remove('hidden');
            loadDeptsManagement(); // To populate dropdown
            loadSubjectsManagement();
        });
        if (closeSubjectsModalBtn) closeSubjectsModalBtn.addEventListener('click', () => manageSubjectsModal.classList.add('hidden'));

        async function loadSubjectsManagement() {
            try {
                const res = await fetch('/api/subjects');
                const data = await res.json();
                subjectsManagementList.innerHTML = '';
                data.subjects.forEach(subject => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${subject.name}</span>
                            <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${subject.department_name || 'Instructional Module'}</span>
                        </div>
                        <button onclick="window.deleteSubject('${subject.id}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    `;
                    subjectsManagementList.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        window.deleteSubject = async (id) => {
            if (!confirm('Are you certain you want to decommission this module?')) return;
            try {
                const res = await fetch(`/api/subjects/${id}`, { method: 'DELETE' });
                if (res.ok) loadSubjectsManagement();
                else alert('Error decommissioning module');
            } catch (err) { console.error(err); }
        };

        if (addSubjectForm) addSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const deptId = document.getElementById('subjectDeptId').value;
            const name = document.getElementById('subjectName').value;
            try {
                const res = await fetch('/api/subjects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ department_id: deptId, name: name })
                });
                if (res.ok) {
                    addSubjectForm.reset();
                    loadSubjectsManagement();
                } else alert('Error registering module');
            } catch (err) { console.error(err); }
        });

        // Roles
        if (manageRolesBtn) manageRolesBtn.addEventListener('click', () => {
            manageRolesModal.classList.remove('hidden');
            loadRolesManagement();
        });
        if (closeRolesModalBtn) closeRolesModalBtn.addEventListener('click', () => manageRolesModal.classList.add('hidden'));

        async function loadRolesManagement() {
            try {
                const res = await fetch('/api/roles');
                const data = await res.json();
                rolesList.innerHTML = '';
                data.roles.forEach(role => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl group hover:bg-white transition-all mb-2';
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${role.name}</span>
                            <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${role.is_active ? 'Active protocol' : 'Disabled'}</span>
                        </div>
                        <button onclick="window.deleteRole('${role.name}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    `;
                    rolesList.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        window.deleteRole = async (name) => {
            if (!confirm(`Are you certain you want to decommissioning the '${name}' protocol?`)) return;
            try {
                const res = await fetch(`/api/roles/${name}`, { method: 'DELETE' });
                if (res.ok) loadRolesManagement();
                else alert('Error decommissioning protocol');
            } catch (err) { console.error(err); }
        };

        if (addRoleForm) addRoleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('roleName').value;
            try {
                const res = await fetch('/api/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    addRoleForm.reset();
                    loadRolesManagement();
                } else alert('Error indexing protocol');
            } catch (err) { console.error(err); }
        });

        // Bridge Helpers
        window.openDeptSelectionModal = () => {
            deptSelectionModal.classList.remove('hidden');
            loadDeptsForSelection();
        };
        window.closeDeptSelectionModal = () => {
            deptSelectionModal.classList.add('hidden');
        };

        window.openSubjectSelectionModal = () => {
            subjectSelectionModal.classList.remove('hidden');
            loadSubjectsForSelection(document.getElementById('departmentId').value);
        };
        window.closeSubjectSelectionModal = () => {
            subjectSelectionModal.classList.add('hidden');
            updateSelectedSubjectsUI();
        };

        window.openRoleSelectionModal = () => {
            roleSelectionModal.classList.remove('hidden');
            loadRolesForSelection();
        };
        window.closeRoleSelectionModal = () => {
            roleSelectionModal.classList.add('hidden');
            updateSelectedRolesUI();
        };
        window.openManageRoles = () => { window.closeRoleSelectionModal(); manageRolesBtn.click(); };
        window.openManageDepts = () => { window.closeDeptSelectionModal(); manageDeptsBtn.click(); };
        window.openManageSubjects = () => { window.closeSubjectSelectionModal(); manageSubjectsBtn.click(); };

        /** ---------------------------------------------------------
         *  FORM SUBMISSIONS (TEACHER)
         *  --------------------------------------------------------- */

        if (addTeacherForm) addTeacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = addTeacherForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, 'Finalize Induction');

            const formData = new FormData(addTeacherForm);
            const data = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: selectedRolesArray[0] || '',
                roles: selectedRolesArray,
                phone: formData.get('phone'),
                department_id: formData.get('department'),
                subject_ids: selectedSubjectIdsArray
            };

            try {
                const res = await fetch('/api/teachers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert('Faculty Induction Complete');
                    closeAddModal();
                    loadTeachers();
                    loadTeacherStats();
                } else alert('Error: ' + result.error);
            } catch (err) { console.error(err); } finally {
                setButtonLoading(submitBtn, false, 'Finalize Induction');
            }
        });

        if (editTeacherForm) editTeacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('editTeacherId').value;
            const submitBtn = editTeacherForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, '<i class="fas fa-save mr-2"></i>Apply Changes');

            const formData = new FormData(editTeacherForm);
            const data = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName'),
                email: formData.get('email'),
                role: selectedRolesArray[0] || '',
                roles: selectedRolesArray,
                phone: formData.get('phone'),
                department_id: formData.get('department')
            };

            try {
                const res = await fetch(`/api/teachers/${teacherId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Record Updated Successfully');
                    window.closeEditModal();
                    loadTeachers();
                } else {
                    const result = await res.json();
                    alert('Error: ' + result.error);
                }
            } catch (err) { console.error(err); } finally {
                setButtonLoading(submitBtn, false, '<i class="fas fa-save mr-2"></i>Apply Changes');
            }
        });

        if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', async () => {
            const teacherId = document.getElementById('deleteTeacherId').value;
            setButtonLoading(confirmDeleteBtn, true, '<i class="fas fa-trash mr-2"></i>Confirm Deletion');

            try {
                const res = await fetch(`/api/teachers/${teacherId}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Personnel Record Purged');
                    window.closeDeleteModal();
                    loadTeachers();
                    loadTeacherStats();
                    loadDepartmentOverview();
                } else alert('Error decommission asset');
            } catch (err) { console.error(err); } finally {
                setButtonLoading(confirmDeleteBtn, false, '<i class="fas fa-trash mr-2"></i>Confirm Deletion');
            }
        });


    });


    function updateSelectedRolesUI() {
        const container = roleSelectionTarget === 'add' ? document.getElementById('addSelectedRolesContainer') : document.getElementById('editSelectedRolesContainer');
        if (!container) return;

        if (selectedRolesArray.length === 0) {
            container.innerHTML = `<span class="text-[${roleSelectionTarget === 'add' ? '12px' : '13px'}] font-bold text-slate-400">No clearances selected</span>`;
            return;
        }

        container.innerHTML = selectedRolesArray.map(role => `
            <span class="inline-flex items-center px-2 py-1 bg-white text-indigo-600 border border-indigo-100 text-[10px] font-black uppercase tracking-widest rounded shadow-sm">
                ${role.replace('_', ' ')}
            </span>
        `).join('');
    }

    function updateSelectedSubjectsUI() {
        const selectedSubjectIdsInput = document.getElementById('selectedSubjectIds');
        const selectedSubjectsContainer = document.getElementById('selectedSubjectsContainer');
        if (!selectedSubjectIdsInput || !selectedSubjectsContainer) return;

        selectedSubjectIdsInput.value = selectedSubjectIdsArray.join(',');
        if (selectedSubjectIdsArray.length === 0) {
            selectedSubjectsContainer.innerHTML = '<span class="text-[12px] font-bold text-slate-400">No modules selected</span>';
            return;
        }
        selectedSubjectsContainer.innerHTML = selectedSubjectIdsArray.map(id => `
            <span class="px-2 py-1 bg-white text-indigo-600 border border-indigo-50 text-[9px] font-black uppercase tracking-widest rounded shadow-sm">${cachedSubjects[id] || `MOD-${id}`}</span>
        `).join('');
    }

    // Phone Uniqueness Validation (Fast Check)
    async function validatePhone(input, excludeId = '') {
        const phone = input.value.trim();
        const feedbackId = input.id + 'Feedback';
        let feedback = document.getElementById(feedbackId);

        if (!feedback) {
            feedback = document.createElement('p');
            feedback.id = feedbackId;
            feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider hidden';
            input.parentElement.appendChild(feedback);
        }

        if (!phone) {
            feedback.classList.add('hidden');
            input.classList.remove('border-rose-500', 'border-emerald-500', 'ring-rose-500/10', 'ring-emerald-500/10');
            return;
        }

        // Simple loading state
        input.classList.add('opacity-70');

        try {
            const res = await fetch(`/api/teachers/check-phone?phone=${encodeURIComponent(phone)}&exclude_id=${excludeId}`);
            const data = await res.json();

            feedback.classList.remove('hidden');
            input.classList.remove('opacity-70');

            if (data.taken) {
                feedback.textContent = 'Phone associated with another account';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-rose-500';
                input.classList.add('border-rose-500', 'ring-4', 'ring-rose-500/10');
                input.classList.remove('border-emerald-500', 'ring-emerald-500/10');
            } else {
                feedback.textContent = 'Contact number available';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-emerald-500';
                input.classList.add('border-emerald-500', 'ring-4', 'ring-emerald-500/10');
                input.classList.remove('border-rose-500', 'ring-rose-500/10');
            }
        } catch (e) {
            console.error('Fast check failed:', e);
        }
    }

    // Debounce helper
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    const addPhoneInput = document.getElementById('phone');
    if (addPhoneInput) {
        addPhoneInput.addEventListener('input', debounce(() => validatePhone(addPhoneInput), 500));
    }

    const editPhoneInput = document.getElementById('editPhone');
    if (editPhoneInput) {
        editPhoneInput.addEventListener('input', debounce(() => {
            const teacherId = document.getElementById('editTeacherId').value;
            validatePhone(editPhoneInput, teacherId);
        }, 500));
    }
</script>