<div class="p-4 lg:p-6 space-y-6 animate-fade-in-up bg-slate-50 min-h-screen relative">
    <div class="relative z-10 space-y-6">
        <!-- Premium Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div
                    class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <span class="text-2xl font-black text-indigo-600 uppercase relative z-10">{{slice .teacher.FirstName
                        0
                        1}}{{slice .teacher.LastName 0 1}}</span>
                </div>
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight uppercase">{{.teacher.FirstName}}
                            {{.teacher.LastName}}</h2>
                        <span
                            class="px-2 py-0.5 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded text-[10px] font-black uppercase tracking-widest">{{if
                            .teacher.IsActive}}Active{{else}}Inactive{{end}}</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                        <div
                            class="flex items-center gap-1.5 p-1 px-2 bg-slate-100 rounded-lg border border-slate-200/50">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Faculty
                                ID</span>
                            <span class="text-[10px] font-black text-slate-700">#{{slice .teacher.ID 0 8}}</span>
                        </div>
                        <div class="flex items-center gap-2 text-slate-400">
                            <i class="fas fa-shield-halved text-[10px]"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Faculty Profile</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.history.back()"
                    class="h-10 px-4 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 shadow-sm">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button onclick="openAssignSubjectsModal()"
                    class="h-10 px-6 bg-slate-900 hover:bg-black text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                    <i class="fas fa-plus"></i> Assign Modules
                </button>
            </div>
        </div>

        <!-- Layout Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Column: Primary Content -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Classes count -->
                    <div
                        class="p-5 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fas fa-school text-4xl"></i>
                        </div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Active
                            Classes</p>
                        <h3 id="statClassesCount" class="text-xl font-black text-slate-800 tracking-tight">0</h3>
                        <div class="mt-3 flex items-center gap-2">
                            <span
                                class="text-[9px] font-black text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-widest">Current
                                Load</span>
                        </div>
                    </div>

                    <!-- Subjects count -->
                    <div
                        class="p-5 rounded-3xl bg-gradient-to-br from-indigo-600 to-indigo-700 border-indigo-500 shadow-lg shadow-indigo-100 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i class="fas fa-layer-group text-4xl text-white"></i>
                        </div>
                        <p class="text-[10px] font-black text-indigo-100 uppercase tracking-widest mb-1 opacity-80">
                            Modules / Papers
                        </p>
                        <h3 id="statSubjectsCount" class="text-xl font-black text-white tracking-tight">0</h3>
                        <div class="mt-3 flex items-center gap-2">
                            <div class="flex-1 h-1 bg-white/20 rounded-full overflow-hidden">
                                <div id="moduleProgress" class="h-full bg-white transition-all duration-1000"
                                    style="width: 100%"></div>
                            </div>
                            <span class="text-[10px] font-black text-white uppercase tracking-widest">Active</span>
                        </div>
                    </div>

                    <!-- Duty Window -->
                    <div
                        class="p-5 rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fas fa-clock text-4xl"></i>
                        </div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Duty Window
                        </p>
                        <h3 id="statHoursCount" class="text-xl font-black text-slate-800 tracking-tight">0 hrs</h3>
                        <div class="mt-3 flex items-center gap-2">
                            <span
                                class="text-[9px] font-black text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded border border-rose-100 uppercase tracking-widest">Weekly
                                Commitment</span>
                        </div>
                    </div>
                </div>

                <!-- Base Configuration -->
                <div class="glass-card rounded-2xl border border-white p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center border border-indigo-100 shadow-inner">
                            <i class="fas fa-id-badge text-indigo-600 text-lg"></i>
                        </div>
                        <div>
                            <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">Base
                                Configuration
                            </h2>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Primary
                                Personnel Identification</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="teacherInfo">
                        <div
                            class="bg-slate-50/80 rounded-xl p-4 border border-slate-100 group hover:border-indigo-100 transition-all">
                            <label
                                class="text-[8px] font-black text-slate-400 uppercase tracking-wider block mb-1 opacity-70">Email
                                Communication</label>
                            <p class="text-xs font-black text-slate-900 truncate">{{.teacher.Email}}</p>
                        </div>
                        <div
                            class="bg-slate-50/80 rounded-xl p-4 border border-slate-100 group hover:border-indigo-100 transition-all">
                            <label
                                class="text-[8px] font-black text-slate-400 uppercase tracking-wider block mb-1 opacity-70">Security
                                Line</label>
                            <a href="tel:{{.teacher.Phone}}"
                                class="text-xs font-black text-slate-900 hover:text-indigo-600 transition-colors flex items-center gap-2">
                                {{.teacher.Phone}}
                                <i class="fas fa-external-link-alt text-[8px] text-slate-300"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Detailed Records Tabbed Section -->
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden min-h-[500px]">
                    <div
                        class="flex flex-col sm:flex-row items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50/30 gap-4">
                        <div
                            class="flex items-center gap-1 p-1 bg-slate-100 rounded-xl w-full sm:w-auto overflow-x-auto no-scrollbar">
                            <button onclick="switchTab('domains')" id="tab-button-domains"
                                class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all bg-white text-indigo-600 shadow-sm border border-slate-200/50 whitespace-nowrap">
                                Modules & Classes
                            </button>
                            <button onclick="switchTab('schedule')" id="tab-button-schedule"
                                class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-indigo-600 whitespace-nowrap">
                                Operational Window
                            </button>
                            <button onclick="switchTab('ledger')" id="tab-button-ledger"
                                class="flex-1 sm:flex-none px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all text-slate-500 hover:text-indigo-600 whitespace-nowrap">
                                Financial Ledger
                            </button>
                        </div>
                    </div>

                    <!-- Domains Tab -->
                    <div id="tab-content-domains" class="animate-fade-in space-y-8 p-6">
                        <!-- Operational Domains (Subjects) -->
                        <div class="relative overflow-hidden group/domains">
                            <div class="flex items-center justify-between mb-6 relative z-10">
                                <div
                                    class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center border border-purple-100 shadow-inner">
                                    <i class="fas fa-brain text-purple-600 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">
                                        Operational Domains</h2>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                        Assigned Academic Competencies</p>
                                </div>
                            </div>
                            <button onclick="openAssignSubjectsModal()"
                                class="px-4 py-2 bg-slate-900 text-white rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-black transition-all shadow-lg shadow-slate-200">
                                <i class="fas fa-plus mr-1.5"></i>Assign Domain
                            </button>
                            <div id="teacherSubjects" class="grid grid-cols-1 md:grid-cols-2 gap-3 relative z-10">
                                <div class="h-24 bg-slate-50 rounded-2xl animate-pulse"></div>
                                <div class="h-24 bg-slate-50 rounded-2xl animate-pulse"></div>
                            </div>
                        </div>

                        <!-- Active Deployments (Classes) -->
                        <div class="pt-8 border-t border-slate-100">
                            <div class="flex items-center gap-3 mb-6">
                                <div
                                    class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center border border-emerald-100 shadow-inner">
                                    <i class="fas fa-dharmachakra text-emerald-600 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">Active
                                        Deployments</h2>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                        Active Class Assignments</p>
                                </div>
                            </div>
                            <div id="teacherClasses" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Hydrated via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Tab -->
                    <div id="tab-content-schedule" class="hidden animate-fade-in p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-rose-50 rounded-xl flex items-center justify-center border border-rose-100 shadow-inner">
                                    <i class="fas fa-calendar-alt text-rose-600 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">
                                        Operational Window</h2>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                        Weekly Availability Configuration</p>
                                </div>
                            </div>
                            <button id="saveAvailabilityBtn"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                                <i class="fas fa-save mr-1.5"></i>Sync Timing
                            </button>
                        </div>
                        <div id="availabilityGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            <!-- Availability cards will be injected here by JavaScript -->
                        </div>
                    </div>

                    <!-- Ledger Tab -->
                    <div id="tab-content-ledger" class="hidden animate-fade-in space-y-10 p-6">
                        <!-- Base Salary Ledger -->
                        <div>
                            <div class="flex items-center gap-3 mb-6">
                                <div
                                    class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center border border-indigo-100 shadow-inner">
                                    <i class="fas fa-hand-holding-usd text-indigo-600 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">Base
                                        Salary Ledger</h2>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                        Historical Earnings & Payouts</p>
                                </div>
                            </div>

                            <div class="overflow-x-auto rounded-xl border border-slate-100">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                                Period / Date</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                                Type</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Reference</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                                Paid</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                                Amount / Balance</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Status</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="baseSalaryLedgerBody" class="text-xs">
                                        <tr class="border-b border-slate-50 last:border-none">
                                            <td class="px-4 py-6 text-center font-bold text-slate-400 italic"
                                                colspan="8">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading records...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Allowance Ledger -->
                        <div id="allowanceLedgerSection" class="hidden pt-8 border-t border-slate-100">
                            <div class="flex items-center gap-3 mb-6">
                                <div
                                    class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center border border-emerald-100 shadow-inner">
                                    <i class="fas fa-gift text-emerald-600 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">Allowance
                                        Ledger</h2>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                        Stipend & Bonus Matrix</p>
                                </div>
                            </div>

                            <div class="overflow-x-auto rounded-xl border border-slate-100">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                                Period / Date</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                                Type</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Reference</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                                Paid</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
                                                Amount / Balance</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Status</th>
                                            <th
                                                class="px-4 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">
                                                Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allowanceLedgerBody" class="text-xs">
                                        <tr class="border-b border-slate-50 last:border-none">
                                            <td class="px-4 py-6 text-center font-bold text-slate-400 italic"
                                                colspan="8">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading records...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Sidebar / Metadata -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Profile Overview Card -->
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 overflow-hidden relative group">
                    <div class="absolute top-0 right-0 p-6 opacity-0 group-hover:opacity-10 transition-opacity">
                        <i class="fas fa-shield-halved text-4xl text-indigo-600"></i>
                    </div>
                    <div class="text-center mb-8">
                        <div
                            class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl border-4 border-white">
                            <span class="text-white text-3xl font-black uppercase">{{slice .teacher.FirstName 0
                                1}}{{slice .teacher.LastName 0 1}}</span>
                        </div>
                        <h3 class="text-lg font-black text-slate-900 tracking-tight uppercase leading-tight">
                            {{.teacher.FirstName}} {{.teacher.LastName}}
                        </h3>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-1">Operational
                            ID:
                            #{{slice .teacher.ID 0 8}}</p>
                    </div>

                    <div class="space-y-3">
                        <div
                            class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status</span>
                            <span
                                class="px-2 py-0.5 {{if .teacher.IsActive}}bg-emerald-50 text-emerald-600 border-emerald-100{{else}}bg-rose-50 text-rose-600 border-rose-100{{end}} border rounded text-[8px] font-black uppercase tracking-widest">
                                {{if .teacher.IsActive}}Commissioned{{else}}Decommissioned{{end}}
                            </span>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Faculty
                                Role</span>
                            <div class="flex flex-wrap justify-end gap-1">
                                {{range .roles}}
                                <span class="text-[10px] font-black text-indigo-600 uppercase">{{.Name}}</span>
                                {{else}}
                                <span class="text-[10px] font-black text-slate-700 uppercase">INSTRUCTIONAL</span>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Contact
                            Gateway</h4>
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-xl bg-indigo-50 flex items-center justify-center shrink-0">
                                    <i class="fas fa-envelope text-indigo-500 text-xs"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] font-black text-slate-800 leading-none mb-1 truncate">
                                        {{.teacher.Email}}</p>
                                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Primary
                                        Communication</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-xl bg-emerald-50 flex items-center justify-center shrink-0">
                                    <i class="fas fa-phone-alt text-emerald-500 text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black text-slate-800 leading-none mb-1">
                                        {{.teacher.Phone}}</p>
                                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">
                                        Security Line</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button onclick="openEditModal()"
                            class="w-full py-4 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-user-edit"></i> Edit Personnel Profile
                        </button>
                    </div>
                </div>

                <!-- Payroll Configuration Card -->
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 overflow-hidden relative group">
                    <div class="absolute top-0 right-0 p-6 opacity-0 group-hover:opacity-10 transition-opacity">
                        <i class="fas fa-money-bill-wave text-4xl text-emerald-600"></i>
                    </div>
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 shadow-inner">
                            <i class="fas fa-vault text-sm"></i>
                        </div>
                        <div>
                            <h2 class="text-xs font-black text-slate-800 tracking-tight uppercase">Payroll Hub</h2>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Salary &
                                Allowance Matrix</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <!-- Base Salary -->
                        <div class="space-y-2">
                            <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest pl-1">Base
                                Salary (UGX)</label>
                            <input type="number" id="salaryAmount" placeholder="0"
                                class="w-full bg-slate-50 border border-slate-100 text-xs font-black py-4 px-4 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500/50 outline-none transition-all text-slate-900">

                            <div class="flex p-0.5 bg-slate-100 rounded-xl border border-slate-200/50">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="salaryPeriod" value="day" class="peer sr-only">
                                    <div
                                        class="text-[8px] font-black uppercase text-center py-2 rounded-lg text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                        Daily</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="salaryPeriod" value="week" class="peer sr-only">
                                    <div
                                        class="text-[8px] font-black uppercase text-center py-2 rounded-lg text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                        Weekly</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="salaryPeriod" value="month" class="peer sr-only" checked>
                                    <div
                                        class="text-[8px] font-black uppercase text-center py-2 rounded-lg text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                        Monthly</div>
                                </label>
                            </div>
                        </div>

                        <!-- Allowance Toggle -->
                        <div class="pt-4 border-t border-slate-100">
                            <div class="flex items-center justify-between mb-4">
                                <span
                                    class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Supplemental
                                    Allowance</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="hasAllowanceToggle" class="sr-only peer">
                                    <div
                                        class="w-8 h-4 bg-slate-200 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4">
                                    </div>
                                </label>
                            </div>

                            <div id="allowanceInputContainer" class="hidden space-y-3 animate-fade-in">
                                <input type="number" id="allowanceAmount" placeholder="Allowance Amount (UGX)"
                                    class="w-full bg-slate-50 border border-slate-100 text-xs font-black py-4 px-4 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500/50 outline-none transition-all text-slate-900">



                                <div class="flex p-0.5 bg-slate-100 rounded-xl border border-slate-200/50">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="allowancePeriod" value="day" class="peer sr-only">
                                        <div
                                            class="text-[8px] font-black uppercase text-center py-2 rounded-lg text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                            Daily</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="allowancePeriod" value="week" class="peer sr-only">
                                        <div
                                            class="text-[8px] font-black uppercase text-center py-2 rounded-lg text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                            Weekly</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button id="saveSalaryBtn"
                            class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-sync-alt"></i> Update Payroll Matrix
                        </button>
                    </div>
                </div>

                <!-- System Metadata Card -->
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 overflow-hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600 shadow-inner">
                            <i class="fas fa-history text-xs"></i>
                        </div>
                        <div>
                            <h3 class="text-xs font-black text-slate-800 tracking-tight uppercase">Security Log</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                Historical Event Matrix</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div
                            class="relative pl-5 before:content-[''] before:absolute before:left-0 before:top-2 before:bottom-0 before:w-0.5 before:bg-slate-100">
                            <div
                                class="absolute left-[-3.5px] top-2 w-2 h-2 rounded-full bg-emerald-500 shadow-sm ring-4 ring-white">
                            </div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Account
                                Commissioning</p>
                            <p class="text-[10px] font-bold text-slate-600 leading-relaxed">Initialized on {{slice
                                .teacher.CreatedAt.String 0 10}}</p>
                        </div>
                        {{if .teacher.UpdatedAt}}
                        <div class="relative pl-5">
                            <div
                                class="absolute left-[-3.5px] top-2 w-2 h-2 rounded-full bg-indigo-400 shadow-sm ring-4 ring-white">
                            </div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Recent
                                Operational Update</p>
                            <p class="text-[10px] font-bold text-slate-600 leading-relaxed">Modified on {{slice
                                .teacher.UpdatedAt.String 0 10}}</p>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Subjects Modal (Premium Restyled) -->
<div id="assignSubjectsModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeAssignSubjectsModal()">
    </div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative w-full max-w-md transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all animate-scale-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-indigo-50">
                <div>
                    <h3 class="text-sm font-black text-indigo-900 uppercase tracking-wide">Domain Allocation</h3>
                    <p class="text-indigo-600 text-[9px] font-bold uppercase tracking-widest mt-0.5">
                        Assigning Instructional Modules and Papers</p>
                </div>
                <button onclick="closeAssignSubjectsModal()"
                    class="text-indigo-400 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <form id="assignSubjectsForm">
                    <!-- Search Input -->
                    <div class="mb-3">
                        <div class="relative">
                            <input type="text" id="subjectSearchInput" placeholder="Search modules or papers..."
                                class="w-full text-xs font-semibold px-3 py-2.5 pl-9 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500"
                                oninput="debouncedSubjectSearch(this.value)">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-3">Institutional
                            Module Selection Matrix</label>
                        <div id="subjectsList" class="grid grid-cols-1 gap-3">
                            <!-- Skeleton -->
                            <div class="h-20 bg-slate-50 rounded-xl animate-pulse border border-slate-100"></div>
                            <div class="h-20 bg-slate-50 rounded-xl animate-pulse border border-slate-100"></div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-2">
                <button onclick="closeAssignSubjectsModal()"
                    class="px-4 py-2 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                    Abort Allocation
                </button>
                <button form="assignSubjectsForm" type="submit"
                    class="px-4 py-2 text-[10px] font-black uppercase tracking-widest text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm shadow-indigo-100 transition-all flex items-center gap-1.5">
                    <i class="fas fa-check-circle"></i>
                    <span>Sync Assigned Domains</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Teacher Modal -->
<div id="editTeacherModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeEditModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300 flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50 shrink-0">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Edit Personnel</h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editTeacherForm" class="p-6 space-y-4 overflow-y-auto custom-scrollbar">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">First Name</label>
                <input type="text" name="firstName" id="editFirstName" required
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Last Name</label>
                <input type="text" name="lastName" id="editLastName" required
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Email Address</label>
                <input type="email" name="email" id="editEmail" required
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Phone Number</label>
                <input type="tel" name="phone" id="editPhone"
                    class="w-full text-xs font-semibold px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Clearance Levels</label>
                <div class="flex flex-wrap gap-2 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[42px]"
                    id="editSelectedRolesContainer">
                    <!-- Selected Roles will appear here -->
                </div>
                <button type="button" onclick="openRoleSelectionModal()"
                    class="mt-2 w-full py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 transition-all">
                    <i class="fas fa-plus mr-1.5 opacity-50"></i>Manage Clearances
                </button>
            </div>
            <div class="pt-2">
                <button type="submit"
                    class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                    Apply Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Role Selection Modal -->
<div id="roleSelectionModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeRoleSelectionModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all duration-300">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-black text-slate-900 uppercase tracking-wide">Select Clearance Levels</h3>
            <button onclick="closeRoleSelectionModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5 max-h-[60vh] overflow-y-auto">
            <div id="rolesSelectionList" class="space-y-2">
                <!-- Roles will be loaded here -->
            </div>
        </div>
        <div class="p-5 border-t border-slate-50 bg-slate-50/50 flex justify-end">
            <button onclick="closeRoleSelectionModal()"
                class="px-6 py-2 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wide hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                Confirm Selection
            </button>
        </div>
    </div>
</div>

<!-- Disbursement Modal -->
<div id="disbursementModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[120] hidden place-items-center flex items-center justify-center transition-opacity duration-300"
    onclick="if(event.target === this) closeDisbursementModal()">
    <div
        class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform transition-all duration-300 animate-scale-up">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-emerald-50">
            <h3 class="text-sm font-black text-emerald-900 uppercase tracking-wide">Confirm Disbursement</h3>
            <button onclick="closeDisbursementModal()"
                class="text-emerald-400 hover:text-emerald-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="disbursementForm" class="p-6 space-y-4">
            <input type="hidden" id="disburseType">
            <input type="hidden" id="disbursePeriodStart">
            <input type="hidden" id="disbursePeriodEnd">

            <div class="bg-emerald-50/30 p-4 rounded-xl border border-emerald-100/50 mb-4">
                <p class="text-[9px] font-black text-emerald-400 uppercase tracking-widest mb-1">Target Period</p>
                <p id="disbursePeriodDisplay" class="text-xs font-bold text-emerald-900">-</p>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Payment Amount (UGX)</label>
                <input type="number" id="disburseAmount" required
                    class="w-full text-xs font-black px-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Reference (Cheque / Trans
                    ID)</label>
                <input type="text" id="disburseReference" placeholder="e.g. CHQ-001"
                    class="w-full text-xs font-semibold px-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Notes</label>
                <textarea id="disburseNotes" rows="2"
                    class="w-full text-xs font-semibold px-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500"></textarea>
            </div>

            <div class="pt-4">
                <button type="submit" id="disburseSubmitBtn"
                    class="w-full bg-emerald-600 text-white py-3 rounded-xl text-xs font-black uppercase tracking-wide hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100 flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> Confirm Disbursement
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const teacherID = '{{.teacherID}}';
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const displayDayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('assignSubjectsForm').addEventListener('submit', handleAssignSubjects);
        document.getElementById('editTeacherForm').addEventListener('submit', handleEditTeacher);
        document.getElementById('saveAvailabilityBtn').addEventListener('click', handleSaveAvailability);
        document.getElementById('saveSalaryBtn').addEventListener('click', handleSaveSalary);
        document.getElementById('disbursementForm').addEventListener('submit', handleDisbursement);

        loadProfileData();
        loadTeacherAvailability();
        loadAllSystemRoles();
        loadTeacherSalary();
        loadTeacherLedger();

        // Handle deep link tabs or default
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab') || 'domains';
        switchTab(tab);
    });

    // Tab Switching Logic
    function switchTab(tabId) {
        // Toggle Buttons
        document.querySelectorAll('[id^="tab-button-"]').forEach(btn => {
            const isActive = btn.id === `tab-button-${tabId}`;
            if (isActive) {
                btn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-200/50');
                btn.classList.remove('text-slate-500');
            } else {
                btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-200/50');
                btn.classList.add('text-slate-500');
            }
        });

        // Toggle Content
        document.querySelectorAll('[id^="tab-content-"]').forEach(content => {
            content.classList.toggle('hidden', content.id !== `tab-content-${tabId}`);
        });

        // Update URL without refresh
        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        window.history.pushState({}, '', url);
    }

    // Salary Logic
    async function loadTeacherSalary() {
        try {
            const res = await fetch('/api/teachers/' + teacherID + '/salary');
            const data = await res.json();

            const toggle = document.getElementById('hasAllowanceToggle');
            const container = document.getElementById('allowanceInputContainer');

            // Setup toggle listener (idempotent)
            toggle.onchange = function () {
                container.classList.toggle('hidden', !this.checked);
                if (this.checked) {
                    setTimeout(() => {
                        const input = document.getElementById('allowanceAmount');
                        input.focus();
                        input.select();
                    }, 50);
                }
            };

            // Attach complex constraints
            attachConstraintListeners();

            if (data.salary) {
                // Pre-fill form
                document.getElementById('salaryAmount').value = data.salary.amount;
                document.getElementById('allowanceAmount').value = data.salary.allowance || 0;

                // Toggle state
                const hasAllow = data.salary.has_allowance || false;
                toggle.checked = hasAllow;
                container.classList.toggle('hidden', !hasAllow);

                // Apply constraints
                if (typeof updateAllowanceConstraints === 'function') updateAllowanceConstraints();

                // Set Radio Buttons
                const salaryRadio = document.querySelector(`input[name="salaryPeriod"][value="${data.salary.period}"]`);
                if (salaryRadio) salaryRadio.checked = true;

                let allowPeriodVal = data.salary.allowance_period || 'week';
                if (allowPeriodVal === 'month') allowPeriodVal = 'week';

                const allowanceRadio = document.querySelector(`input[name="allowancePeriod"][value="${allowPeriodVal}"]`);
                if (allowanceRadio) allowanceRadio.checked = true;



            } else {
                toggle.checked = false;
                container.classList.add('hidden');

                // Apply constraints
                if (typeof updateAllowanceConstraints === 'function') updateAllowanceConstraints();
            }
        } catch (e) {
            console.error('Error loading salary:', e);
        }
    }

    async function handleSaveSalary() {
        const btn = document.getElementById('saveSalaryBtn');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

        const amount = document.getElementById('salaryAmount').value;
        const allowance = document.getElementById('allowanceAmount').value;
        const hasAllowance = document.getElementById('hasAllowanceToggle').checked;
        const period = document.querySelector('input[name="salaryPeriod"]:checked').value;
        const allowancePeriod = document.querySelector('input[name="allowancePeriod"]:checked').value;
        const effectiveDate = document.getElementById('allowance-effective-date')?.value || new Date().toISOString().split('T')[0];

        if (!amount || amount <= 0) {
            showNotification('Please enter a valid amount', 'error');
            btn.disabled = false;
            btn.innerHTML = original;
            return;
        }

        try {
            const res = await fetch('/api/teachers/' + teacherID + '/salary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: parseInt(amount),
                    allowance: parseInt(allowance || 0),
                    has_allowance: hasAllowance,
                    period: period,
                    allowance_period: allowancePeriod,
                    effective_date: effectiveDate
                })
            });

            if (res.ok) {
                showNotification('Payroll configuration updated');
                loadTeacherSalary();
            } else {
                try {
                    const errData = await res.json();
                    console.error('Salary Update Error:', errData);
                    showNotification('Update failed: ' + (errData.details || errData.error || 'Server error'), 'error');
                } catch (e) {
                    console.error('Failed to parse error response', e);
                    showNotification('Update failed: Server error', 'error');
                }
            }
        } catch (e) {
            showNotification('System connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    }

    // Complex Allowance Constraints
    function updateAllowanceConstraints() {
        const salaryPeriod = document.querySelector('input[name="salaryPeriod"]:checked')?.value;
        const toggle = document.getElementById('hasAllowanceToggle');
        const container = document.getElementById('allowanceInputContainer');
        const allowanceRadios = document.querySelectorAll('input[name="allowancePeriod"]');
        const dayRadio = document.querySelector('input[name="allowancePeriod"][value="day"]');
        const weekRadio = document.querySelector('input[name="allowancePeriod"][value="week"]');

        if (!salaryPeriod) return;

        // Reset states first
        toggle.disabled = false;
        toggle.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');

        allowanceRadios.forEach(r => {
            r.disabled = false;
            // Target the radio's container/label which has the styling
            const label = r.closest('label');
            if (label) {
                label.classList.remove('opacity-50', 'pointer-events-none');
                // Ensure the inner div text color is reset if needed, but opacity handles it mostly
            }
        });

        if (salaryPeriod === 'day') {
            // Daily Salary: No Allowance Allowed
            toggle.disabled = true;
            toggle.checked = false;
            container.classList.add('hidden');
            toggle.parentElement.classList.add('opacity-50', 'cursor-not-allowed');

        } else if (salaryPeriod === 'week') {
            // Weekly Salary: Daily Allowance ONLY
            // Disable Weekly Allowance Option
            if (weekRadio) {
                weekRadio.disabled = true;
                const weekLabel = weekRadio.closest('label');
                if (weekLabel) weekLabel.classList.add('opacity-50', 'pointer-events-none');

                if (weekRadio.checked) {
                    if (dayRadio) dayRadio.checked = true; // Force switch to day
                }
            }
        }
        // Month: All allowed (default)
    }

    function attachConstraintListeners() {
        document.querySelectorAll('input[name="salaryPeriod"]').forEach(r => {
            r.addEventListener('change', updateAllowanceConstraints);
        });
    }

    // Global teacher state
    let allRoles = [];
    let selectedRoleNames = [];
    let currentTeacher = {
        firstName: '{{.teacher.FirstName}}',
        lastName: '{{.teacher.LastName}}',
        email: '{{.teacher.Email}}',
        phone: '{{.teacher.Phone}}',
        roles: [{{range $i, $r := .roles}}{{if $i}}, {{end}}'{{$r.Name}}'{{end}}],
    id: '{{.teacher.ID}}'
    };

    async function loadAllSystemRoles() {
        try {
            const res = await fetch('/api/roles');
            const data = await res.json();
            allRoles = data.roles || [];
            updateRoleSelectionUI();
            updateSelectedRolesPreview();
        } catch (e) {
            console.error('Role Load Failed:', e);
        }
    }

    function openRoleSelectionModal() {
        document.getElementById('roleSelectionModal').classList.remove('hidden');
    }

    function closeRoleSelectionModal() {
        document.getElementById('roleSelectionModal').classList.add('hidden');
        updateSelectedRolesPreview();
    }

    function toggleRole(roleName) {
        const idx = selectedRoleNames.indexOf(roleName);
        if (idx === -1) {
            selectedRoleNames.push(roleName);
        } else {
            selectedRoleNames.splice(idx, 1);
        }
        updateRoleSelectionUI();
        updateSelectedRolesPreview();
    }

    function updateRoleSelectionUI() {
        const container = document.getElementById('roleSelectionList');
        if (!container) return;

        container.innerHTML = allRoles.map(role => {
            const isSelected = selectedRoleNames.includes(role.Name);
            return `
                    <div onclick="toggleRole('${role.Name}')" 
                        class="flex items-center justify-between p-4 mb-2 rounded-xl border-2 cursor-pointer transition-all ${isSelected ? 'border-indigo-500 bg-indigo-50/50' : 'border-slate-100 bg-white hover:border-slate-200'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center">
                                <i class="fas fa-shield text-indigo-500 text-xs"></i>
                            </div>
                            <span class="text-[11px] font-black text-slate-700 uppercase tracking-tight">${role.Name}</span>
                        </div>
                        ${isSelected ? '<i class="fas fa-check-circle text-indigo-500"></i>' : '<div class="w-5 h-5 rounded-full border-2 border-slate-100"></div>'}
                    </div>
                `;
        }).join('');
    }

    function updateSelectedRolesPreview() {
        const container = document.getElementById('editSelectedRolesContainer');
        if (!container) return;

        if (selectedRoleNames.length === 0) {
            container.innerHTML = '<span class="text-[11px] font-bold text-slate-400">No clearances selected</span>';
            return;
        }

        container.innerHTML = selectedRoleNames.map(role => `
                <span class="px-2 py-1 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded text-[9px] font-black uppercase tracking-widest">${role}</span>
            `).join('');
    }

    function openEditModal() {
        document.getElementById('editFirstName').value = currentTeacher.firstName;
        document.getElementById('editLastName').value = currentTeacher.lastName;
        document.getElementById('editEmail').value = currentTeacher.email;
        document.getElementById('editPhone').value = currentTeacher.phone;

        selectedRoleNames = [...currentTeacher.roles];
        updateRoleSelectionUI();
        updateSelectedRolesPreview();

        document.getElementById('editTeacherModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('editTeacherModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    async function handleEditTeacher(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

        const formData = new FormData(e.target);
        const data = {
            first_name: formData.get('firstName'),
            last_name: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            roles: selectedRoleNames
        };

        try {
            const res = await fetch('/api/teachers/' + teacherID, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showNotification('Personnel profile updated');
                closeEditModal();
                // Update local storage and UI
                currentTeacher.firstName = data.first_name;
                currentTeacher.lastName = data.last_name;
                currentTeacher.email = data.email;
                currentTeacher.phone = data.phone;
                currentTeacher.roles = [...data.roles];

                // Update UI elements directly
                document.getElementById('teacherName').textContent = data.first_name + ' ' + data.last_name;
                // Refresh data to be sure
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const err = await res.json();
                showNotification(err.error || 'Update failed', 'error');
            }
        } catch (e) {
            showNotification('System connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = orig;
        }
    }

    async function loadProfileData() {
        try {
            const [teacherRes, subjectsRes] = await Promise.all([
                fetch('/api/teachers/' + teacherID),
                fetch('/api/teachers/' + teacherID + '/subjects')
            ]);

            const teacherData = await teacherRes.json();
            const subjectsData = await subjectsRes.json();

            if (teacherRes.ok && teacherData.teacher) {
                const teacher = teacherData.teacher;

                // Hydrate Classes List
                const classContainer = document.getElementById('teacherClasses');
                classContainer.innerHTML = '';

                let totalStudentsCount = 0;
                if (teacher.classes && teacher.classes.length > 0) {
                    document.getElementById('statClassesCount').textContent = teacher.classes.length;

                    teacher.classes.forEach(cls => {
                        totalStudentsCount += (cls.student_count || 0);
                        const card = document.createElement('div');
                        card.className = 'group bg-slate-50/50 hover:bg-white border border-slate-100 hover:border-emerald-100 rounded-xl p-3 transition-all duration-300 shadow-sm flex items-center justify-between';
                        card.innerHTML =
                            '<div class="flex items-center gap-3">' +
                            '<div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-100 to-white border border-slate-200 flex items-center justify-center shadow-sm group-hover:scale-105 transition-transform duration-300">' +
                            '<span class="text-[10px] font-black text-slate-400 group-hover:text-indigo-500 transition-colors uppercase">' + (cls.name.charAt(0)) + '</span>' +
                            '</div>' +
                            '<div>' +
                            '<h3 class="text-[10px] font-black text-slate-800 tracking-tight uppercase group-hover:text-indigo-600 transition-colors leading-tight">' + cls.name + '</h3>' +
                            '<div class="flex items-center gap-1 mt-0.5">' +
                            '<span class="w-1 h-1 rounded-full bg-emerald-500 animate-pulse"></span>' +
                            '<p class="text-[8px] font-bold text-slate-400 uppercase tracking-wider group-hover:text-slate-500">' + (cls.student_count || 0) + ' Students</p>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="w-6 h-6 rounded-md bg-white border border-slate-100 flex items-center justify-center text-slate-300 group-hover:border-indigo-100 group-hover:text-indigo-500 transition-all shadow-sm">' +
                            '<i class="fas fa-arrow-right text-[8px]"></i>' +
                            '</div>';
                        classContainer.appendChild(card);
                    });
                } else {
                    classContainer.innerHTML = '<div class="col-span-2 py-8 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest border border-dashed border-slate-200 rounded-2xl">No Active Deployments</div>';
                }


            }

            if (subjectsRes.ok) {
                const subjects = subjectsData.subjects || [];
                document.getElementById('statSubjectsCount').textContent = subjects.length;

                const container = document.getElementById('teacherSubjects');
                container.innerHTML = '';

                if (subjects.length > 0) {
                    subjects.forEach(subject => {
                        const papers = subject.papers || [];
                        const card = document.createElement('div');
                        card.className = 'bg-slate-50/50 hover:bg-white border border-slate-100 hover:border-purple-100 rounded-xl p-3 transition-all duration-300 group shadow-sm';
                        card.innerHTML =
                            '<div class="flex items-center justify-between mb-2">' +
                            '<div class="flex items-center gap-2">' +
                            '<div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center border border-slate-100 group-hover:border-purple-50 group-hover:text-purple-600 transition-all shadow-sm font-black text-[9px] text-slate-400">' +
                            subject.code +
                            '</div>' +
                            '<h3 class="text-[12px] font-black text-slate-800 tracking-tight uppercase">' + subject.name + '</h3>' +
                            '</div>' +
                            '<button onclick="removeDomain(\'' + subject.id + '\')" class="w-6 h-6 flex items-center justify-center text-slate-300 hover:text-rose-600 hover:bg-rose-50 rounded-md transition-all">' +
                            '<i class="fas fa-trash-alt text-[9px]"></i>' +
                            '</button>' +
                            '</div>' +
                            '<div class="space-y-1">' +
                            (papers.length > 0 ? papers.map(p =>
                                '<div class="flex items-center justify-between bg-white px-2.5 py-1.5 rounded-lg border border-slate-50 shadow-sm text-[10px] font-bold text-slate-600 uppercase tracking-tight">' +
                                '<span>' + p.name + ' <span class="text-slate-300 text-[8px] ml-1">(' + p.code + ')</span></span>' +
                                '</div>'
                            ).join('') : '<p class="text-[9px] text-slate-300 font-bold italic pl-1">No specific papers assigned</p>') +
                            '</div>';
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<div class="col-span-2 py-8 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest border border-dashed border-slate-200 rounded-2xl">No Assigned Operational Domains</div>';
                }
            }
        } catch (error) {
            console.error('Core loading error:', error);
        }
    }

    async function loadTeacherAvailability() {
        try {
            const response = await fetch('/api/teachers/' + teacherID + '/availability');
            const data = await response.json();
            const grid = document.getElementById('availabilityGrid');
            grid.innerHTML = '';

            const availabilityMap = new Map();
            (data.availability || []).forEach(item => availabilityMap.set(item.day_of_week, item));

            let activeHours = 0;

            for (let i = 0; i < 7; i++) {
                const dbDay = (i + 1) % 7;
                const entry = availabilityMap.get(dbDay) || { is_available: false };
                if (entry.is_available && entry.start_time.Valid && entry.end_time.Valid) {
                    const start = entry.start_time.String.split(':');
                    const end = entry.end_time.String.split(':');
                    activeHours += (parseInt(end[0]) + parseInt(end[1]) / 60) - (parseInt(start[0]) + parseInt(start[1]) / 60);
                }

                const card = document.createElement('div');
                const available = entry.is_available;
                card.className = 'p-4 rounded-xl border transition-all duration-300 flex flex-col ' + (available ? 'bg-emerald-50/30 border-emerald-100 shadow-sm' : 'bg-slate-50/30 border-slate-100');

                card.innerHTML =
                    '<div class="flex items-center justify-between mb-4">' +
                    '<span class="text-[10px] font-black uppercase tracking-widest text-slate-800">' + displayDayNames[i] + '</span>' +
                    '<label class="relative inline-flex items-center cursor-pointer">' +
                    '<input type="checkbox" class="sr-only peer avail-check" data-day="' + dbDay + '" ' + (available ? 'checked' : '') + '>' +
                    '<div class="w-8 h-4 bg-slate-200 rounded-full peer peer-checked:bg-emerald-500 after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4"></div>' +
                    '</label>' +
                    '</div>' +
                    '<div class="space-y-2 ' + (available ? '' : 'hidden pointer-events-none opacity-40 filter grayscale') + ' inputs-area">' +
                    '<input type="time" class="start-time w-full bg-white px-2 py-1.5 rounded-lg border border-slate-100 text-[10px] font-black outline-none focus:border-indigo-500 transition-all shadow-inner" value="' + (entry.start_time?.String || '') + '">' +
                    '<input type="time" class="end-time w-full bg-white px-2 py-1.5 rounded-lg border border-slate-100 text-[10px] font-black outline-none focus:border-indigo-500 transition-all shadow-inner" value="' + (entry.end_time?.String || '') + '">' +
                    '</div>';
                grid.appendChild(card);

                const check = card.querySelector('.avail-check');
                check.addEventListener('change', function () {
                    card.querySelector('.inputs-area').classList.toggle('hidden', !this.checked);
                    card.classList.toggle('bg-emerald-50/30', this.checked);
                    card.classList.toggle('border-emerald-100', this.checked);
                });
            }

            document.getElementById('statHoursCount').textContent = Math.floor(activeHours) + 'hrs';
        } catch (e) {
            console.error('Availability load error:', e);
        }
    }

    async function handleSaveAvailability() {
        const btn = document.getElementById('saveAvailabilityBtn');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';

        const data = [];
        document.querySelectorAll('#availabilityGrid .avail-check').forEach(check => {
            const card = check.closest('div.p-4');
            data.push({
                day_of_week: parseInt(check.dataset.day),
                is_available: check.checked,
                start_time: card.querySelector('.start-time').value || null,
                end_time: card.querySelector('.end-time').value || null
            });
        });

        try {
            const res = await fetch('/api/teachers/' + teacherID + '/availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ availability: data })
            });

            if (res.ok) {
                showNotification('Timing matrix synchronized');
                loadTeacherAvailability();
            } else {
                showNotification('Synchronization failed', 'error');
            }
        } catch (e) {
            showNotification('System Error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    }

    let currentTeacherSubjectsMap = {};

    async function loadSubjectsForAssignment() {
        const list = document.getElementById('subjectsList');
        // Reset Search Input
        document.getElementById('subjectSearchInput').value = '';

        try {
            // 1. Fetch Teacher's Current Subjects
            const currentRes = await fetch('/api/teachers/' + teacherID + '/subjects');
            const current = (await currentRes.json()).subjects || [];

            // Map { subjectId: [paperId1, paperId2, ...] }
            currentTeacherSubjectsMap = {};
            current.forEach(s => {
                currentTeacherSubjectsMap[s.id] = (s.papers || []).map(p => p.id);
            });

            // 2. Initial Render (All Subjects)
            await fetchAndRenderSubjects('');

        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="col-span-1 text-center text-rose-400 p-4 text-xs font-bold uppercase">Initialization Failed</div>';
        }
    }

    async function fetchAndRenderSubjects(query) {
        const list = document.getElementById('subjectsList');
        list.innerHTML = '<div class="col-span-1 py-12 text-center text-slate-400 animate-pulse"><i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-indigo-400"></i><p class="text-[10px] font-bold uppercase tracking-widest">Searching Matrix...</p></div>';

        try {
            const url = query ? `/api/subjects/with-papers?q=${encodeURIComponent(query)}` : '/api/subjects/with-papers';
            const res = await fetch(url);
            const data = await res.json();
            const subjects = data.subjects || [];

            if (subjects.length === 0) {
                list.innerHTML = '<div class="col-span-1 py-12 text-center text-slate-400 border border-dashed border-slate-200 rounded-xl"><i class="fas fa-search text-2xl mb-3 text-slate-300"></i><p class="text-[10px] font-bold uppercase tracking-widest">No matching domains found</p></div>';
                return;
            }

            list.innerHTML = subjects.map(s => renderSubjectCard(s)).join('');

        } catch (e) {
            list.innerHTML = '<div class="col-span-1 text-center text-rose-500 font-bold p-4 text-xs uppercase">Search Connectivity Error</div>';
        }
    }

    function renderSubjectCard(s) {
        const subjectChecked = currentTeacherSubjectsMap.hasOwnProperty(s.id);
        const assignedPapers = currentTeacherSubjectsMap[s.id] || [];
        const hasPapers = s.papers && s.papers.length > 0;

        let html = `
            <div class="group relative bg-white border border-slate-100 rounded-xl p-3 transition-all duration-200 hover:border-indigo-100 hover:shadow-sm">
                <label class="flex items-start gap-3 cursor-pointer">
                    <div class="relative flex items-center">
                        <input type="checkbox" name="subjects" value="${s.id}" ${subjectChecked ? 'checked' : ''} 
                            class="peer h-4 w-4 cursor-pointer rounded border-slate-300 text-indigo-600 focus:ring-indigo-500/20 transition-all">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            <span class="inline-flex items-center justify-center px-1.5 py-0.5 rounded text-[9px] font-black bg-slate-50 text-slate-500 border border-slate-100 uppercase tracking-wider group-hover:text-indigo-600 group-hover:bg-indigo-50 group-hover:border-indigo-100 transition-colors">
                                ${s.code}
                            </span>
                            <h3 class="text-[11px] font-bold text-slate-700 uppercase tracking-tight truncate group-hover:text-slate-900 transition-colors">
                                ${s.name}
                            </h3>
                        </div>
                    </div>
                </label>`;

        if (hasPapers) {
            html += `
                <div class="mt-2 pl-7 space-y-1.5 border-l border-slate-100 ml-2">
                    ${s.papers.map(p => {
                const pChecked = subjectChecked && assignedPapers.includes(p.id);
                return `
                            <label class="flex items-center gap-2 cursor-pointer group/paper">
                                <input type="checkbox" name="papers_${s.id}" value="${p.id}" ${pChecked ? 'checked' : ''} 
                                    class="peer h-3.5 w-3.5 cursor-pointer rounded border-slate-200 text-indigo-500 focus:ring-indigo-500/20 transition-all">
                                <span class="text-[10px] font-semibold text-slate-500 group-hover/paper:text-indigo-600 transition-colors line-clamp-1">
                                    ${p.name} <span class="text-[9px] text-slate-300 ml-0.5 font-normal group-hover/paper:text-indigo-300 transition-colors">(${p.code})</span>
                                </span>
                            </label>`;
            }).join('')}
                </div>`;
        }
        html += '</div>';
        return html;
    }

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    const debouncedSubjectSearch = debounce((query) => {
        fetchAndRenderSubjects(query);
    }, 400);

    // Interactive Selection Logic
    document.getElementById('subjectsList').addEventListener('change', function (e) {
        if (e.target.name === 'subjects') {
            const subjectId = e.target.value;
            const papers = document.querySelectorAll(`input[name="papers_${subjectId}"]`);
            papers.forEach(p => p.checked = e.target.checked);
        } else if (e.target.name && e.target.name.startsWith('papers_')) {
            const subjectId = e.target.name.replace('papers_', '');
            const subjectCheck = document.querySelector(`input[name="subjects"][value="${subjectId}"]`);
            const paperChecks = document.querySelectorAll(`input[name="papers_${subjectId}"]`);
            const anyChecked = Array.from(paperChecks).some(p => p.checked);

            if (e.target.checked) {
                subjectCheck.checked = true;
            } else if (!anyChecked) {
                subjectCheck.checked = false;
            }
        }
    });

    async function handleAssignSubjects(e) {
        e.preventDefault();
        const btn = e.submitter || document.querySelector('button[form="assignSubjectsForm"][type="submit"]');
        if (!btn) return;

        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Allocating...';

        const form = new FormData(e.target);
        const subjects = form.getAll('subjects');
        const papers = {};

        // Validation: Every selected subject must have at least one paper
        let validationError = false;
        subjects.forEach(sid => {
            const paperSelection = form.getAll('papers_' + sid);
            if (paperSelection.length === 0) {
                validationError = true;
                // Highlight or focus? For now just notify
            }
            papers[sid] = paperSelection;
        });

        if (validationError) {
            showNotification('Every selected module must have at least one paper assigned', 'error');
            btn.disabled = false;
            btn.innerHTML = orig;
            return;
        }

        try {
            const res = await fetch('/api/teachers/' + teacherID + '/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject_ids: subjects, papers })
            });

            if (res.ok) {
                showNotification('Academic domains updated');
                closeAssignSubjectsModal();
                loadProfileData();
            } else {
                showNotification('Allocation failed', 'error');
            }
        } catch (e) {
            showNotification('System connectivity error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = orig;
        }
    }

    function openAssignSubjectsModal() {
        document.getElementById('assignSubjectsModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadSubjectsForAssignment();
    }

    function closeAssignSubjectsModal() {
        document.getElementById('assignSubjectsModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    async function deleteTeacher() {
        if (!confirm('Are you sure you want to decommission this personnel record? This action will set the teacher to standby status.')) return;

        try {
            const res = await fetch('/api/teachers/' + teacherID, { method: 'DELETE' });
            if (res.ok) {
                showNotification('Personnel DECOMMISSIONED');
                setTimeout(() => window.location.href = '/teachers', 1500);
            } else {
                showNotification('Decommission failed', 'error');
            }
        } catch (e) {
            showNotification('System error', 'error');
        }
    }

    async function removeDomain(subjectId) {
        if (!confirm('Remove this operational domain from the teacher?')) return;

        try {
            const res = await fetch('/api/teachers/' + teacherID + '/subjects/' + subjectId, { method: 'DELETE' });
            if (res.ok) {
                showNotification('Domain removed');
                loadProfileData();
            } else {
                showNotification('Removal failed', 'error');
            }
        } catch (e) {
            showNotification('System error', 'error');
        }
    }

    function showNotification(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-6 right-6 z-[200] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-in ' + (type === 'success' ? 'bg-indigo-600' : 'bg-rose-600') + ' text-white';
        toast.innerHTML = '<i class="fas ' + (type === 'success' ? 'fa-check' : 'fa-exclamation-triangle') + '"></i><p class="text-[10px] font-black uppercase tracking-widest">' + msg + '</p>';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Phone Uniqueness Validation (Fast Check)
    async function validatePhone(input) {
        const phone = input.value.trim();
        const feedbackId = input.id + 'Feedback';
        let feedback = document.getElementById(feedbackId);

        if (!feedback) {
            feedback = document.createElement('p');
            feedback.id = feedbackId;
            feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider hidden';
            input.parentElement.appendChild(feedback);
        }

        if (!phone) {
            feedback.classList.add('hidden');
            input.classList.remove('border-rose-500', 'border-emerald-500', 'ring-rose-500/10', 'ring-emerald-500/10');
            return;
        }

        input.classList.add('opacity-70');

        try {
            const res = await fetch('/api/teachers/check-phone?phone=' + encodeURIComponent(phone) + '&exclude_id=' + teacherID);
            const data = await res.json();

            feedback.classList.remove('hidden');
            input.classList.remove('opacity-70');

            if (data.taken) {
                feedback.textContent = 'Phone associated with another account';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-rose-500';
                input.classList.add('border-rose-500', 'ring-4', 'ring-rose-500/10');
                input.classList.remove('border-emerald-500', 'ring-emerald-500/10');
            } else {
                feedback.textContent = 'Contact number available';
                feedback.className = 'text-[9px] font-bold mt-1 uppercase tracking-wider text-emerald-500';
                input.classList.add('border-emerald-500', 'ring-4', 'ring-emerald-500/10');
                input.classList.remove('border-rose-500', 'ring-rose-500/10');
            }
        } catch (e) {
            console.error('Fast check failed:', e);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    const editPhoneInput = document.getElementById('editPhone');
    if (editPhoneInput) {
        editPhoneInput.addEventListener('input', debounce(() => validatePhone(editPhoneInput), 500));
    }

    async function loadTeacherLedger() {
        const baseBody = document.getElementById('baseSalaryLedgerBody');
        const allowanceBody = document.getElementById('allowanceLedgerBody');
        const allowanceSection = document.getElementById('allowanceLedgerSection');

        try {
            // 1. Fetch separate ledgers
            const [baseRes, allowRes] = await Promise.all([
                fetch('/api/teachers/' + teacherID + '/ledger/base-salary'),
                fetch('/api/teachers/' + teacherID + '/ledger/allowance')
            ]);

            const baseData = await baseRes.json();
            const allowData = await allowRes.json();

            const baseLedger = baseData.ledger || [];
            const allowLedger = allowData.ledger || [];

            // Helper to render a consistent row
            const renderRow = (data) => {
                const { period, type, reference, accrued, paid, balance, status, statusClass, actionHTML } = data;

                // Format Amount / Balance
                let amountDisplay = '-';
                if (accrued > 0) {
                    amountDisplay = `
                        <div class="flex flex-col items-end leading-tight">
                            <span class="text-[10px] text-slate-400 font-medium">${new Intl.NumberFormat('en-UG').format(accrued)}</span>
                            <span class="text-[11px] text-slate-700 font-bold">${new Intl.NumberFormat('en-UG').format(balance)}</span>
                        </div>`;
                } else {
                    amountDisplay = `<span class="text-[11px] text-slate-700 font-bold">${new Intl.NumberFormat('en-UG').format(balance)}</span>`;
                }

                return `
                        <tr class="border-b border-slate-50 last:border-none hover:bg-slate-50/50 transition-colors">
                            <td class="px-4 py-4 font-bold text-slate-700 whitespace-nowrap">${period}</td>
                            <td class="px-4 py-4 font-bold text-slate-500 uppercase text-[9px] tracking-wide">${type}</td>
                            <td class="px-4 py-4 text-center">
                                <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-400 text-[8px] font-black uppercase tracking-widest border border-slate-200 truncate inline-block max-w-[80px]" title="${reference}">${reference || '-'}</span>
                            </td>
                            <td class="px-4 py-4 font-bold text-emerald-600 text-right whitespace-nowrap text-[11px]">${paid > 0 ? '+' + new Intl.NumberFormat('en-UG').format(paid) : '-'}</td>
                            <td class="px-4 py-4 text-right whitespace-nowrap align-middle">
                                ${amountDisplay}
                            </td>
                            <td class="px-4 py-4 text-center">
                                <span class="px-2 py-1 rounded-md border text-[9px] font-black uppercase tracking-widest ${statusClass}">
                                    ${status}
                                </span>
                            </td>
                            <td class="px-4 py-4 text-center align-middle">
                                ${actionHTML || '<span class="text-slate-300 font-black text-[8px] uppercase tracking-widest leading-none block">Settled</span>'}
                            </td>
                        </tr>
                    `;
            };

            const processLedgerType = (typeTitle, typeKey, specificLedger) => {
                if (!specificLedger || specificLedger.length === 0) return '';

                return specificLedger.map(item => {
                    let status = item.status;
                    let statusClass = 'bg-slate-50 text-slate-400 border-slate-100';
                    let actionHTML = '';

                    // Map status to UI
                    if (status === 'pending') {
                        status = 'Unpaid';
                        statusClass = 'bg-rose-50 text-rose-600 border-rose-100';
                        actionHTML = `
                            <button onclick="openDisbursementModal('${typeKey}', ${item.accrued}, '${item.start_date}', '${item.end_date}', '${item.period_name}')"
                                class="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-[9px] font-black uppercase tracking-widest shadow-sm transition-all group overflow-hidden relative">
                                <span class="relative z-10">Pay</span>
                                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            </button>
                        `;
                    } else if (status === 'completed') {
                        status = 'Settled';
                        statusClass = 'bg-emerald-50 text-emerald-600 border-emerald-100';
                    } else if (status === 'partial') {
                        status = 'Partial';
                        statusClass = 'bg-amber-50 text-amber-600 border-amber-100';
                    }

                    return renderRow({
                        period: item.period_name,
                        type: typeTitle,
                        reference: item.reference || (item.status === 'pending' ? 'PROVISION' : 'PAID'),
                        accrued: item.accrued,
                        paid: item.paid,
                        balance: item.accrued - item.paid,
                        status: status,
                        statusClass: statusClass,
                        actionHTML: actionHTML
                    });
                }).join('');
            };

            const baseHTML = processLedgerType('Salary', 'base', baseLedger);
            const allowanceHTML = processLedgerType('Allowance', 'allowance', allowLedger);

            baseBody.innerHTML = baseHTML || '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-400 italic">No salary history recorded</td></tr>';
            allowanceBody.innerHTML = allowanceHTML || '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-400 italic">No allowance history recorded</td></tr>';
            allowanceSection.classList.remove('hidden');

        } catch (err) {
            console.error('Ledger Processing Failed:', err);
            baseBody.innerHTML = '<tr><td colspan="8" class="px-4 py-6 text-center text-rose-400 italic">Connectivity Error</td></tr>';
        }
    }




    // Disbursement Logic
    function openDisbursementModal(type, amount, start, end, label) {
        document.getElementById('disburseType').value = type === 'base' ? 'base_salary' : 'allowance';
        document.getElementById('disburseAmount').value = amount;
        document.getElementById('disbursePeriodStart').value = start;
        document.getElementById('disbursePeriodEnd').value = end;
        document.getElementById('disbursePeriodDisplay').textContent = label;
        document.getElementById('disburseReference').value = '';
        document.getElementById('disburseNotes').value = '';

        document.getElementById('disbursementModal').classList.remove('hidden');
    }

    function closeDisbursementModal() {
        document.getElementById('disbursementModal').classList.add('hidden');
    }

    async function handleDisbursement(e) {
        e.preventDefault();
        const btn = document.getElementById('disburseSubmitBtn');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        const payload = {
            amount: parseInt(document.getElementById('disburseAmount').value),
            type: document.getElementById('disburseType').value,
            period_start: new Date(document.getElementById('disbursePeriodStart').value).toISOString(),
            period_end: new Date(document.getElementById('disbursePeriodEnd').value).toISOString(),
            reference: document.getElementById('disburseReference').value,
            notes: document.getElementById('disburseNotes').value,
            status: 'completed'
        };

        try {
            const res = await fetch('/api/teachers/' + teacherID + '/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                showNotification('Disbursement successful');
                closeDisbursementModal();
                loadTeacherLedger();
            } else {
                const data = await res.json();
                showNotification(data.details || data.error || 'Payment failed', 'error');
            }
        } catch (err) {
            showNotification('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    }
</script>
<style>
    @keyframes scaleUp {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-scale-up {
        animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .animate-fade-in {
        animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .animate-slide-in {
        animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    /* Animation Refinements */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>